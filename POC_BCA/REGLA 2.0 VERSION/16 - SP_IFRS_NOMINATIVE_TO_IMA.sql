CREATE OR REPLACE PROCEDURE IFRS9_BCA.SP_IFRS_NOMINATIVE_TO_IMA_BCA (
    P_RUNID         IN VARCHAR2 DEFAULT 'S_00000_0000',
    P_DOWNLOAD_DATE IN DATE     DEFAULT NULL,
    P_SYSCODE       IN VARCHAR2 DEFAULT '0',
    P_PRC           IN VARCHAR2 DEFAULT 'S'
)
AUTHID CURRENT_USER
AS
    ----------------------------------------------------------------
    -- VARIABLES
    ----------------------------------------------------------------
    V_SP_NAME     VARCHAR2(100) := 'SP_IFRS_NOMINATIVE_TO_IMA_BCA';
    V_OWNER       VARCHAR2(30);
    V_CURRDATE      DATE;
    V_MODEL_ID      VARCHAR2(22);
    V_COUNT         NUMBER;

    -- DYNAMIC SQL (USE VARCHAR2 LARGE)
    V_STR_QUERY     VARCHAR2(32767);

    -- TABLE NAMES (UNQUALIFIED PARTS)
    V_TABLEINSERT1  VARCHAR2(100);
    V_TABLEINSERT2  VARCHAR2(100);
    V_TABLESELECT1  VARCHAR2(100);
    V_TABLESELECT2  VARCHAR2(100);
    V_TABLESELECT3  VARCHAR2(100);
    V_TABLESELECT4  VARCHAR2(100);
    V_TABLESELECT5  VARCHAR2(100);
    V_TABLECONFIG   VARCHAR2(100);


    -- CURSOR
    TYPE REF_CURSOR IS REF CURSOR;
    C_RULE        REF_CURSOR;

    -- FETCH VARIABLES
    V_RULE_ID     VARCHAR2(250);
    V_RULE_TYPE VARCHAR2(25);
    V_TABLE_NAME  VARCHAR2(100);
    V_PD_RULES_QRY_RESULT CLOB;


    -- MISC
    V_RETURNROWS    NUMBER := 0;
    V_RETURNROWS2   NUMBER := 0;
    V_TABLEDEST     VARCHAR2(100);
    V_COLUMNDEST    VARCHAR2(100);
    V_OPERATION     VARCHAR2(100);
    V_RUNID        VARCHAR2(30);
    V_SYSCODE      VARCHAR2(10);
    V_PRC         VARCHAR2(5);

    -- RESULT QUERY
    V_QUERYS        CLOB;


BEGIN

    ----------------------------------------------------------------
    -- GET OWNER
    ----------------------------------------------------------------
    SELECT USERNAME INTO V_OWNER FROM USER_USERS;

    ----------------------------------------------------------------
    -- INSERT VCURRDATE DETERMINATION IF NULL
    ----------------------------------------------------------------
    IF P_DOWNLOAD_DATE IS NULL THEN
        BEGIN
            SELECT CURRDATE INTO V_CURRDATE FROM IFRS9_BCA.IFRS_PRC_DATE_AMORT;
        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RAISE_APPLICATION_ERROR(-20010, 'IFRS_PRC_DATE_AMORT HAS NO CURRDATE ROW');
        END;
    ELSE
        V_CURRDATE := P_DOWNLOAD_DATE;
    END IF;

    V_RUNID := NVL(P_RUNID, 'P_00000_0000');
    V_SYSCODE := NVL(P_SYSCODE, '0');
    V_MODEL_ID := V_SYSCODE;
    V_PRC := NVL(P_PRC, 'P');

    ----------------------------------------------------------------
    -- TABLE DETERMINATION
    ----------------------------------------------------------------
    IF V_PRC = 'S' THEN
        V_TABLEINSERT1 := 'IFRS_MASTER_ACCOUNT_MONTHLY_' || V_RUNID;
        V_TABLESELECT1 := 'IFRS_MASTER_ACCOUNT_' || V_RUNID;
        V_TABLESELECT2 := 'IFRS_EAD_RESULT_' || V_RUNID;
        V_TABLESELECT3 := 'IFRS_ECL_RESULT_DETAIL_' || V_RUNID;
        V_TABLESELECT4 := 'TBLT_PAYMENTEXPECTED_' || V_RUNID;
        V_TABLESELECT5 := 'IFRS_ECL_RESULT_HEADER_' || V_RUNID;
    ELSE 
        V_TABLEINSERT1 := 'IFRS_MASTER_ACCOUNT_MONTHLY';
        V_TABLESELECT1 := 'IFRS_MASTER_ACCOUNT';
        V_TABLESELECT2 := 'IFRS_EAD_RESULT';
        V_TABLESELECT3 := 'IFRS_ECL_RESULT_DETAIL';
        V_TABLESELECT4 := 'TBLT_PAYMENTEXPECTED';
        V_TABLESELECT5 := 'IFRS_ECL_RESULT_HEADER';
    END IF;

    IFRS9_BCA.SP_IFRS_RUNNING_LOG(V_CURRDATE, V_SP_NAME, V_RUNID, TO_NUMBER(SYS_CONTEXT('USERENV','SESSIONID')), SYSDATE);
    COMMIT;

    ----------------------------------------------------------------
    -- PRE-PROCESSING SIMULATION TABLES
    ----------------------------------------------------------------
    IF V_PRC = 'S' THEN
        -- DROP TABLE IF EXISTS
        SELECT COUNT(*) INTO V_COUNT
        FROM ALL_TABLES
        WHERE OWNER = V_OWNER
          AND TABLE_NAME = UPPER(V_TABLEINSERT1);

        IF V_COUNT > 0 THEN
            V_STR_QUERY := 'DROP TABLE ' || V_OWNER || '.' || V_TABLEINSERT1;
            EXECUTE IMMEDIATE V_STR_QUERY;
        END IF;

        V_STR_QUERY := 'CREATE TABLE ' || V_OWNER || '.' || V_TABLEINSERT1 ||
                       ' AS SELECT * FROM ' || V_OWNER || '.IFRS_MASTER_ACCOUNT_MONTHLY WHERE DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'') AND 1=0';
        EXECUTE IMMEDIATE V_STR_QUERY;
    END IF;
    COMMIT;

    ----------------------------------------------------------------
    -- MAIN PROCESSING
    ----------------------------------------------------------------

    V_STR_QUERY := 'UPDATE ' || V_OWNER || '.' || V_TABLESELECT1 || '
	SET EAD_AMOUNT          = NULL,
		ECL_AMOUNT          = NULL,
		LIFETIME            = NULL,
		RESERVED_RATE_1     = NULL,
		RESERVED_RATE_2     = NULL,
		RESERVED_RATE_3     = NULL,
		RESERVED_RATE_4     = NULL,
		RESERVED_RATE_5     = NULL,
		RESERVED_RATE_6     = NULL,
		RESERVED_AMOUNT_14  = CASE WHEN DATA_SOURCE <> ''LIMIT'' THEN NULL ELSE RESERVED_AMOUNT_14 END,
		RESERVED_AMOUNT_15  = NULL,
		RESERVED_AMOUNT_16  = NULL,
		RESERVED_AMOUNT_18  = NULL,
		RESERVED_AMOUNT_19  = NULL,
		RESERVED_VARCHAR_25 = NULL,
		IA_UNWINDING_AMOUNT = NULL,
		IMPAIRED_FLAG       = NULL
	WHERE DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'')';

    EXECUTE IMMEDIATE V_STR_QUERY;
    COMMIT;


    V_STR_QUERY := 'MERGE INTO ' || V_OWNER || '.' || V_TABLESELECT1 || ' A
	USING (SELECT MASTERID, EAD_AMOUNT, CCF_RATE, PREPAYMENT_RATE, CCF_AMOUNT, PREPAYMENT_AMOUNT, UNUSED_AMOUNT FROM ' || V_OWNER || '.' || V_TABLESELECT2 || ' 
    WHERE COUNTER = 1 AND DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD''))B
	ON (A.MASTERID = B.MASTERID AND A.DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD''))
	WHEN MATCHED THEN UPDATE
	SET A.EAD_AMOUNT = B.EAD_AMOUNT,
		A.RESERVED_RATE_1 = CCF_RATE*100,
		A.RESERVED_RATE_2 = PREPAYMENT_RATE*100,
		A.RESERVED_RATE_3 = B.CCF_AMOUNT,
		A.RESERVED_RATE_4 = B.PREPAYMENT_AMOUNT,
        A.RESERVED_AMOUNT_14 = CASE WHEN DATA_SOURCE <> ''LIMIT'' THEN B.UNUSED_AMOUNT ELSE A.RESERVED_AMOUNT_14 END';

    EXECUTE IMMEDIATE V_STR_QUERY;
    COMMIT;


    V_STR_QUERY := 'MERGE INTO ' || V_OWNER || '.' || V_TABLESELECT1 || ' A
	USING (
		SELECT ACCOUNT_NUMBER,RESERVED_AMOUNT_13,RESERVED_AMOUNT_14,RESERVED_AMOUNT_15,RESERVED_AMOUNT_16 FROM ' || V_OWNER || '.' || V_TABLESELECT1 || ' 
        WHERE DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'') AND DATA_SOURCE = ''LIMIT''
	)B
	ON (A.FACILITY_NUMBER = B.ACCOUNT_NUMBER AND A.DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'') AND A.DATA_SOURCE IN (''ILS'',''CRD'',''KTP'',''BTRD'',''PBMM''))
	WHEN MATCHED THEN
		UPDATE SET A.RESERVED_AMOUNT_16 = B.RESERVED_AMOUNT_14 WHERE A.DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'')';

    EXECUTE IMMEDIATE V_STR_QUERY;
    COMMIT;


    V_STR_QUERY := 'MERGE INTO ' || V_OWNER || '.' || V_TABLESELECT1 || ' A
	USING (
		SELECT MASTERID, CCF_AMOUNT, PREPAYMENT_AMOUNT, LIFETIME_PERIOD, ECL_AMOUNT_ON_BS, ECL_AMOUNT_OFF_BS, ECL_AMOUNT,
               SPECIAL_REASON,UNUSED_AMOUNT,IMPAIRED_FLAG,ECL_AMOUNT_FINAL,ECL_AMOUNT_ON_BS_FINAL
        FROM ' || V_OWNER || '.' || V_TABLESELECT3 || '
        WHERE DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'')
        AND ECL_MODEL_ID = ' || V_MODEL_ID || '
    ) B
	ON (A.MASTERID = B.MASTERID AND A.DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD''))
	WHEN MATCHED THEN UPDATE
	SET A.ECL_AMOUNT = B.ECL_AMOUNT,
		A.LIFETIME = B.LIFETIME_PERIOD,
		A.RESERVED_AMOUNT_18 = B.ECL_AMOUNT_ON_BS,
		A.RESERVED_AMOUNT_19 = B.ECL_AMOUNT_OFF_BS,
		A.RESERVED_VARCHAR_25 = B.SPECIAL_REASON,
		A.IMPAIRED_FLAG = B.IMPAIRED_FLAG';

    EXECUTE IMMEDIATE V_STR_QUERY;
    COMMIT;


    V_STR_QUERY := 'MERGE INTO ' || V_OWNER || '.' || V_TABLESELECT1 || ' C
	using (
		SELECT SUM(UNWIND_BALANCE) AS UNWIND_BALANCE, A.MASTERID
		FROM (SELECT MAX(OVERRIDEID)OVERRIDE,MASTERID,UNWIND_BALANCE,EFFECTIVE_DATE,ESTIMATED_REALIZE_DATE FROM ' || V_OWNER || '.' || V_TABLESELECT4 || ' 
        GROUP BY MASTERID, UNWIND_BALANCE, EFFECTIVE_DATE,ESTIMATED_REALIZE_DATE) A
		INNER JOIN (
			SELECT MAX(EFFECTIVE_DATE) AS MAX_EFF_DATE, MASTERID
			FROM ' || V_OWNER || '.' || V_TABLESELECT4 || ' 
            WHERE EFFECTIVE_DATE <= TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'') GROUP BY MASTERID
		) B
		ON A.MASTERID = B.MASTERID
		AND A.EFFECTIVE_DATE = B.MAX_EFF_DATE WHERE ESTIMATED_REALIZE_DATE <= TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'')
		GROUP BY A.MASTERID
	) D
	ON (C.MASTERID = D.MASTERID AND C.DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'') 
    AND (C.OUTSTANDING+C.RESERVED_AMOUNT_14)>0)
	WHEN MATCHED THEN UPDATE
	SET C.IA_UNWINDING_AMOUNT = D.UNWIND_BALANCE
	WHERE C.IMPAIRED_FLAG = ''I''';

    EXECUTE IMMEDIATE V_STR_QUERY;
    COMMIT;


    V_STR_QUERY := 'MERGE INTO ' || V_OWNER || '.' || V_TABLESELECT3 || ' A
    USING (
        SELECT
            MASTERID,
            NVL(
                CASE
                    WHEN (DATA_SOURCE = ''ILS'' AND PRODUCT_CODE LIKE ''B%'')
                          OR (DATA_SOURCE IN (''PBMM'',''KTP'') AND NVL(RESERVED_FLAG_1, 0) = 0)
                          OR (DATA_SOURCE = ''BTRD'' AND NVL(RESERVED_FLAG_1, 0) = 0)
                    THEN 0
                    ELSE OUTSTANDING
                END, 0)
            + NVL(CASE WHEN NVL(UNAMORT_BENEFIT, UNAMORT_FEE_AMT)> 0 THEN 0 ELSE NVL(UNAMORT_BENEFIT, UNAMORT_FEE_AMT) END , 0)
            + NVL(IA_UNWINDING_AMOUNT, 0)  AS NJUM
        FROM ' || V_OWNER || '.' || V_TABLESELECT1 || ' WHERE DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'')
    ) B
    ON (A.MASTERID = B.MASTERID AND A.DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'') AND A.ECL_MODEL_ID = ' || V_MODEL_ID || ')
    WHEN MATCHED THEN UPDATE
    SET A.ECL_AMOUNT_ON_BS_FINAL = CASE WHEN A.ECL_AMOUNT_ON_BS < B.NJUM THEN A.ECL_AMOUNT_ON_BS ELSE B.NJUM END,
        A.ECL_AMOUNT_FINAL = (CASE WHEN A.ECL_AMOUNT_ON_BS < B.NJUM THEN A.ECL_AMOUNT_ON_BS ELSE B.NJUM END) + ECL_AMOUNT_OFF_BS
   WHERE A.DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'')';

    EXECUTE IMMEDIATE V_STR_QUERY;
    COMMIT;


    V_STR_QUERY := 'UPDATE ' || V_OWNER || '.' || V_TABLESELECT3 || '
        SET ECL_AMOUNT_ON_BS_FINAL = CASE WHEN ECL_AMOUNT_ON_BS_FINAL < 0 THEN 0 ELSE ECL_AMOUNT_ON_BS_FINAL END,
        ECL_AMOUNT_FINAL = CASE WHEN ECL_AMOUNT_FINAL < 0 THEN 0 ELSE ECL_AMOUNT_FINAL END
        WHERE DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'')
        AND ECL_MODEL_ID = ' || V_MODEL_ID || '';

    EXECUTE IMMEDIATE V_STR_QUERY;
    COMMIT;


    V_STR_QUERY := 'MERGE INTO ' || V_OWNER || '.' || V_TABLESELECT1 || ' A
    USING (
        SELECT MASTERID, CCF_AMOUNT, PREPAYMENT_AMOUNT, LIFETIME_PERIOD, ECL_AMOUNT_ON_BS, ECL_AMOUNT_OFF_BS, ECL_AMOUNT,
               SPECIAL_REASON,UNUSED_AMOUNT, IMPAIRED_FLAG,ECL_AMOUNT_FINAL,ECL_AMOUNT_ON_BS_FINAL
        FROM ' || V_OWNER || '.' || V_TABLESELECT3 || '
        WHERE DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'')
        AND ECL_MODEL_ID = ' || V_MODEL_ID || '
    ) B
    ON (A.MASTERID = B.MASTERID AND A.DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD''))
    WHEN MATCHED THEN UPDATE
        SET A.RESERVED_RATE_5 = B.ECL_AMOUNT_ON_BS_FINAL,
            A.RESERVED_RATE_6 = B.ECL_AMOUNT_FINAL WHERE A.DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'')';

    EXECUTE IMMEDIATE V_STR_QUERY;
    COMMIT;


    V_STR_QUERY := 'MERGE INTO ' || V_OWNER || '.' || V_TABLESELECT5 || ' A
   USING(
       SELECT
            DOWNLOAD_DATE, ECL_MODEL_ID, PF_SEGMENT_ID, SUB_SEGMENT,
            DATA_SOURCE, PRODUCT_CODE, BUCKET_GROUP, BUCKET_ID, CR_STAGE,
            SUM(ECL_AMOUNT_FINAL * NVL(EXCHANGE_RATE,1)) AS ECL_AMOUNT_FINAL
        FROM ' || V_OWNER || '.' || V_TABLESELECT3 || '
        WHERE DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'')
        AND ECL_MODEL_ID = ' || V_MODEL_ID || '
        GROUP BY
            DOWNLOAD_DATE, ECL_MODEL_ID, PF_SEGMENT_ID, SUB_SEGMENT,
            DATA_SOURCE, PRODUCT_CODE, BUCKET_GROUP, BUCKET_ID, CR_STAGE
   )B
   ON (
        TRIM(A.DOWNLOAD_DATE)          = TRIM(B.DOWNLOAD_DATE) AND
        TRIM(A.ECL_MODEL_ID)           = TRIM(B.ECL_MODEL_ID)  AND
        TRIM(A.PF_SEGMENT_ID)          = TRIM(B.PF_SEGMENT_ID) AND
        TRIM(A.SUB_SEGMENT)            = TRIM(B.SUB_SEGMENT)   AND
        TRIM(A.DATA_SOURCE)            = TRIM(B.DATA_SOURCE)   AND
        TRIM(A.PRODUCT_CODE)           = TRIM(B.PRODUCT_CODE)  AND
        NVL(TRIM(A.BUCKET_GROUP),'' '')  = NVL(TRIM(B.BUCKET_GROUP),'' '')  AND
        TRIM(A.BUCKET_ID)              = TRIM(B.BUCKET_ID)     AND
        TRIM(A.CR_STAGE)               = TRIM(B.CR_STAGE)
     )
    WHEN MATCHED THEN UPDATE
        SET A.ECL_AMOUNT_FINAL = B.ECL_AMOUNT_FINAL WHERE A.DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'')';

    EXECUTE IMMEDIATE V_STR_QUERY;
    COMMIT;


    V_STR_QUERY := 'DELETE FROM ' || V_OWNER || '.' || V_TABLEINSERT1 || ' WHERE DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'')';

    EXECUTE IMMEDIATE V_STR_QUERY;
    COMMIT;


    V_STR_QUERY := 'INSERT INTO ' || V_OWNER || '.' || V_TABLEINSERT1 || '
    SELECT * FROM ' || V_OWNER || '.' || V_TABLESELECT1 || '
    WHERE DOWNLOAD_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'')';

    EXECUTE IMMEDIATE V_STR_QUERY;
    COMMIT;

    ----------------------------------------------------------------
    -- MAIN PROCESSING
    ----------------------------------------------------------------

    
    DBMS_OUTPUT.PUT_LINE('PROCEDURE ' || V_SP_NAME || ' EXECUTED SUCCESSFULLY.');

    ----------------------------------------------------------------
    -- LOG: CALL EXEC_AND_LOG (ASSUMED SIGNATURE)
    ----------------------------------------------------------------
    V_TABLEDEST := V_OWNER || '.' || V_TABLEINSERT1;
    V_COLUMNDEST := '-';
    V_OPERATION := 'INSERT';

    IFRS9_BCA.SP_IFRS_EXEC_AND_LOG(V_CURRDATE, V_TABLEDEST, V_COLUMNDEST, V_SP_NAME, V_OPERATION, NVL(V_RETURNROWS2,0), V_RUNID);
    COMMIT;

    ----------------------------------------------------------------
    -- RESULT PREVIEW
    ----------------------------------------------------------------
    V_QUERYS := 'SELECT * FROM ' || V_OWNER || '.' || V_TABLEINSERT1 ||
                ' WHERE EFF_DATE = TO_DATE(''' || TO_CHAR(V_CURRDATE,'YYYY-MM-DD') || ''',''YYYY-MM-DD'')' ||
                ' AND (' || CASE WHEN V_MODEL_ID = '0' THEN '1=1' ELSE 'PD_RULE_ID = ' || V_MODEL_ID END || ')';

    IFRS9_BCA.SP_IFRS_RESULT_PREV(V_CURRDATE, V_QUERYS, V_SP_NAME, NVL(V_RETURNROWS2,0), V_RUNID);
    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        IF C_RULE%ISOPEN THEN
            CLOSE C_RULE;
        END IF;

        ROLLBACK;

        RAISE_APPLICATION_ERROR(-20001,'ERROR IN ' || V_SP_NAME || ' : ' || SQLERRM);
END;