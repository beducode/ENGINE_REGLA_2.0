CREATE OR REPLACE PROCEDURE SP_IFRS_ACCT_EIR_ECF_EVENT
AS
    V_CURRDATE DATE ;
    V_PREVDATE DATE;
    V_EFFDATEFLAG VARCHAR2(1);
BEGIN

    SELECT  MAX(CURRDATE), MAX(PREVDATE)
    INTO V_CURRDATE, V_PREVDATE
    FROM IFRS_PRC_DATE_AMORT;


    BEGIN
      SELECT COMMONUSAGE
      INTO V_EFFDATEFLAG
      FROM TBLM_COMMONCODEHEADER
      WHERE COMMONCODE = 'SCM004';
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        V_EFFDATEFLAG := NULL;
    END;


    INSERT  INTO IFRS_AMORT_LOG ( DOWNLOAD_DATE ,DTM ,OPS ,PROCNAME ,REMARK)
    VALUES  ( V_CURRDATE ,SYSTIMESTAMP ,'START' ,'SP_IFRS_ACCT_EIR_ECF_EVENT' ,'');

    COMMIT;

    -- reset
    --update PMA set EIR_STATUS='' where DOWNLOAD_DATE=v_currdate and EIR_STATUS='Y';
    UPDATE  /*+ PARALLEL(8) */ IFRS_IMA_AMORT_CURR
    SET     EIR_STATUS = '',ECF_STATUS =''
    --WHERE   DOWNLOAD_DATE = V_CURRDATE
    ;

    UPDATE  /*+ PARALLEL(8) */ IFRS_MASTER_ACCOUNT
    SET     EIR_STATUS = '',ECF_STATUS =''
    WHERE   DOWNLOAD_DATE = V_CURRDATE;

    DELETE /*+ PARALLEL(8) */ IFRS_EVENT_CHANGES WHERE DOWNLOAD_DATE = V_CURRDATE;
    DELETE /*+ PARALLEL(8) */ IFRS_EVENT_CHANGES_DETAILS WHERE DOWNLOAD_DATE = V_CURRDATE ;

    COMMIT;

    -- get active eir ecf masterid
    EXECUTE IMMEDIATE 'TRUNCATE TABLE IFRS_ACT_ECF_TMP';

    INSERT  /*+ PARALLEL(8) */ INTO IFRS_ACT_ECF_TMP ( MASTERID)
    SELECT  /*+ PARALLEL(8) */ DISTINCT MASTERID
    FROM    IFRS_ACCT_EIR_ECF
    WHERE   AMORTSTOPDATE IS NULL
    AND DOWNLOAD_DATE <= V_CURRDATE;
    --AND DOWNLOAD_DATE < @v_currdate

    COMMIT;

    --interest rate changes
    INSERT /*+ PARALLEL(8) */ INTO IFRS_EVENT_CHANGES
    ( DOWNLOAD_DATE ,
      MASTERID ,
      ACCOUNT_NUMBER ,
      EFFECTIVE_DATE ,
      BEFORE_VALUE ,
      AFTER_VALUE ,
      EVENT_ID ,
      REMARKS ,
      CREATEDBY
    )
    SELECT  /*+ PARALLEL(8) */ V_CURRDATE ,
            A.MASTERID ,
            A.ACCOUNT_NUMBER ,
            CASE WHEN V_EFFDATEFLAG = '1' THEN V_CURRDATE
                 WHEN V_EFFDATEFLAG = '2' THEN A.NEXT_PAYMENT_DATE
                 ELSE V_CURRDATE
            END ,
            C.INTEREST_RATE ,
            A.INTEREST_RATE ,
            0 ,
            'Interest Rate Changes',
            'SP_IFRS_ACCT_EIR_ECF_EVENT'
    FROM    IFRS_IMA_AMORT_CURR A
    INNER JOIN IFRS_ACT_ECF_TMP B ON A.MASTERID = B.MASTERID
    INNER JOIN IFRS_IMA_AMORT_PREV C ON A.MASTERID = C.MASTERID
    WHERE   (A.INTEREST_RATE <> C.INTEREST_RATE OR A.INTEREST_RATE_IDC <> C.INTEREST_RATE_IDC)
    AND   (ABS(A.UNAMORT_COST_AMT) <> 0 OR ABS(A.UNAMORT_FEE_AMT) <> 0)
    AND   NVL(A.INTEREST_RATE,0) > 0
    AND   A.LOAN_DUE_DATE > V_CURRDATE
    --AND   A.DOWNLOAD_DATE = V_CURRDATE
    AND   A.STAFF_LOAN_FLAG = 'N';

    COMMIT;

    --loan due date changes
    INSERT /*+ PARALLEL(8) */ INTO IFRS_EVENT_CHANGES
    ( DOWNLOAD_DATE ,
      MASTERID ,
      ACCOUNT_NUMBER ,
      EFFECTIVE_DATE ,
      BEFORE_VALUE ,
      AFTER_VALUE ,
      EVENT_ID ,
      REMARKS ,
      CREATEDBY
    )
    SELECT  /*+ PARALLEL(8) */ V_CURRDATE ,
            A.MASTERID ,
            A.ACCOUNT_NUMBER ,
            CASE WHEN V_EFFDATEFLAG = '1' THEN V_CURRDATE
                 WHEN V_EFFDATEFLAG = '2' THEN A.NEXT_PAYMENT_DATE
                 ELSE V_CURRDATE
            END ,
            C.LOAN_DUE_DATE ,
            A.LOAN_DUE_DATE ,
            1 ,
            'Loan Due Date Change',
            'SP_IFRS_ACCT_EIR_ECF_EVENT'
    FROM    IFRS_IMA_AMORT_CURR A
    INNER JOIN IFRS_ACT_ECF_TMP B ON A.MASTERID = B.MASTERID
    INNER JOIN IFRS_IMA_AMORT_PREV C ON A.MASTERID = C.MASTERID
    WHERE   A.LOAN_DUE_DATE <> C.LOAN_DUE_DATE
    AND   (ABS(A.UNAMORT_COST_AMT) <> 0 OR ABS(A.UNAMORT_FEE_AMT) <> 0)
    AND   A.LOAN_DUE_DATE > V_CURRDATE
    --AND   A.DOWNLOAD_DATE = V_CURRDATE
    AND A.STAFF_LOAN_FLAG = 'N'
    ;

    COMMIT;

    --New cost/fee
    INSERT /*+ PARALLEL(8) */ INTO IFRS_EVENT_CHANGES
    ( DOWNLOAD_DATE ,
      MASTERID ,
      ACCOUNT_NUMBER ,
      EFFECTIVE_DATE ,
      BEFORE_VALUE ,
      AFTER_VALUE ,
      EVENT_ID ,
      REMARKS ,
      CREATEDBY
    )
    SELECT  /*+ PARALLEL(8) */ V_CURRDATE ,
            A.MASTERID ,
            A.ACCOUNT_NUMBER ,
            CASE WHEN V_EFFDATEFLAG = '1' THEN V_CURRDATE
                 WHEN V_EFFDATEFLAG = '2' THEN A.NEXT_PAYMENT_DATE
            ELSE V_CURRDATE
            END ,
            0 ,
            B.AMOUNT ,
            2 ,
            CASE WHEN B.FLAG_CF='F'
                    THEN CASE WHEN B.FLAG_REVERSE='N' THEN 'Additional/New Fee ' || B.TRX_CODE
                              WHEN B.FLAG_REVERSE='Y' THEN 'Reversal Fee ' || B.TRX_CODE
                        END
                 WHEN B.FLAG_CF='C'
                    THEN CASE WHEN B.FLAG_REVERSE='N' THEN 'Additional/New Cost ' || B.TRX_CODE
                              WHEN B.FLAG_REVERSE='Y' THEN 'Reversal Cost ' || B.TRX_CODE
                        END
            END AS REMARKS,
            'SP_IFRS_ACCT_EIR_ECF_EVENT'
    FROM    IFRS_IMA_AMORT_CURR A
    INNER JOIN IFRS_ACCT_COST_FEE B
      ON A.MASTERID = B.MASTERID
      AND A.DOWNLOAD_DATE = B.DOWNLOAD_DATE
    WHERE   B.STATUS = 'ACT' AND B.METHOD = 'EIR'
    AND   A.LOAN_DUE_DATE > V_CURRDATE
    --AND   A.DOWNLOAD_DATE = V_CURRDATE
    AND A.STAFF_LOAN_FLAG = 'N'
    ;

    COMMIT;

    -- NEW RESTRUCT EVENT
    INSERT /*+ PARALLEL(8) */ INTO IFRS_EVENT_CHANGES
    ( DOWNLOAD_DATE ,
      MASTERID ,
      ACCOUNT_NUMBER ,
      EFFECTIVE_DATE ,
      BEFORE_VALUE ,
      AFTER_VALUE ,
      EVENT_ID ,
      REMARKS ,
      CREATEDBY
    )
    SELECT  /*+ PARALLEL(8) */ V_CURRDATE ,
            A.MASTERID ,
            A.ACCOUNT_NUMBER ,
            V_CURRDATE ,
            B.PREV_ACCTNO ,
            B.ACCTNO ,
            5 ,
            'Account Restructure' ,
            'SP_IFRS_ACCT_EIR_ECF_EVENT'
    FROM    IFRS_IMA_AMORT_CURR A
    INNER JOIN IFRS_ACCT_SWITCH B
      ON A.DOWNLOAD_DATE = B.DOWNLOAD_DATE
      AND A.ACCOUNT_NUMBER = B.ACCTNO
    AND B.ACCTNO <> B.PREV_ACCTNO
    AND A.STAFF_LOAN_FLAG = 'N'
    --WHERE   A.DOWNLOAD_DATE = V_CURRDATE
    ;

    COMMIT;

    -- PARTIAL PAYMENT EVENT
    INSERT /*+ PARALLEL(8) */ INTO IFRS_EVENT_CHANGES
    ( DOWNLOAD_DATE ,
      MASTERID ,
      ACCOUNT_NUMBER ,
      EFFECTIVE_DATE ,
      BEFORE_VALUE ,
      AFTER_VALUE ,
      EVENT_ID ,
      REMARKS ,
      CREATEDBY
    )
    SELECT  /*+ PARALLEL(8) */ V_CURRDATE ,
            A.MASTERID ,
            A.ACCOUNT_NUMBER ,
            V_CURRDATE ,
            0 ,
            B.ORG_CCY_AMT,
            6 ,
            'Partial Payment' ,
            'SP_IFRS_ACCT_EIR_ECF_EVENT'
    FROM    IFRS_IMA_AMORT_CURR A
    INNER JOIN IFRS_TRANSACTION_DAILY B
      ON A.MASTERID = B.MASTERID
      AND A.DOWNLOAD_DATE = B.DOWNLOAD_DATE
      AND B.TRX_CODE = 'PP'
    WHERE --A.DOWNLOAD_DATE = V_CURRDATE AND
        A.ACCOUNT_STATUS = 'A'
        AND A.OUTSTANDING > 0
        AND A.STAFF_LOAN_FLAG = 'N';

    COMMIT;

    /******************************************************************************
    ADD BY VIVI - 11 FEB 2019 - FOR CHANGES PAYMENT SETTING AND MULTIDISBURST
    *******************************************************************************/
    --MULTIDISBURST, PENAMBAHAN OUTSTANDING

    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_ACCT';

    INSERT /*+ PARALLEL(8) */ INTO TMP_ACCT(
    MASTERID
    )
    SELECT /*+ PARALLEL(8) */ DISTINCT MASTERID FROM IFRS_EVENT_CHANGES
    WHERE DOWNLOAD_DATE=V_CURRDATE;

    COMMIT;

    INSERT /*+ PARALLEL(8) */ INTO IFRS_EVENT_CHANGES
    ( DOWNLOAD_DATE ,
      MASTERID ,
      ACCOUNT_NUMBER ,
      EFFECTIVE_DATE ,
      BEFORE_VALUE ,
      AFTER_VALUE ,
      EVENT_ID ,
      REMARKS ,
      CREATEDBY
    )
    SELECT  /*+ PARALLEL(8) */ V_CURRDATE ,
            A.MASTERID ,
            A.ACCOUNT_NUMBER ,
            CASE WHEN V_EFFDATEFLAG = '1' THEN V_CURRDATE
                 WHEN V_EFFDATEFLAG = '2' THEN A.NEXT_PAYMENT_DATE
                 ELSE V_CURRDATE
            END ,
            C.OUTSTANDING ,
            A.OUTSTANDING ,
            8 ,
            'Additional Outstanding',
            'SP_IFRS_ACCT_EIR_ECF_EVENT'
    FROM    IFRS_IMA_AMORT_CURR A
    INNER JOIN IFRS_ACT_ECF_TMP B ON A.MASTERID = B.MASTERID
    INNER JOIN IFRS_IMA_AMORT_PREV C ON A.MASTERID = C.MASTERID
    WHERE   A.OUTSTANDING > C.OUTSTANDING
    AND   (ABS(A.UNAMORT_COST_AMT) <> 0 OR ABS(A.UNAMORT_FEE_AMT) <> 0)
    AND   A.LOAN_DUE_DATE > V_CURRDATE
    AND NOT EXISTS (SELECT * FROM TMP_ACCT D WHERE D.MASTERID=A.MASTERID)
    AND A.STAFF_LOAN_FLAG = 'N'
    ;
    COMMIT;

    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_ACCT';

    INSERT /*+ PARALLEL(8) */ INTO TMP_ACCT(
    MASTERID
    )
    SELECT /*+ PARALLEL(8) */ DISTINCT MASTERID FROM IFRS_EVENT_CHANGES
    WHERE DOWNLOAD_DATE=V_CURRDATE;

    COMMIT;


    -- HAS PAYMENT SETTING AT CURRENT DATE
    INSERT /*+ PARALLEL(8) */ INTO IFRS_EVENT_CHANGES
    ( DOWNLOAD_DATE ,
      MASTERID ,
      ACCOUNT_NUMBER ,
      EFFECTIVE_DATE ,
      BEFORE_VALUE ,
      AFTER_VALUE ,
      EVENT_ID ,
      REMARKS ,
      CREATEDBY
    )
    SELECT  /*+ PARALLEL(8) */ V_CURRDATE ,
            A.MASTERID ,
            A.ACCOUNT_NUMBER ,
            CASE WHEN V_EFFDATEFLAG = '1' THEN V_CURRDATE
                 WHEN V_EFFDATEFLAG = '2' THEN A.NEXT_PAYMENT_DATE
                 ELSE V_CURRDATE
            END ,
            0,
            0,
            7 ,
            'Payment Setting Change',
            'SP_IFRS_ACCT_EIR_ECF_EVENT'
    FROM    IFRS_IMA_AMORT_CURR A
    INNER JOIN IFRS_ACT_ECF_TMP B ON A.MASTERID = B.MASTERID
    INNER JOIN (SELECT DISTINCT MASTERID FROM IFRS_MASTER_PAYMENT_SETTING  WHERE DOWNLOAD_DATE=V_CURRDATE) C ON A.MASTERID = C.MASTERID
    WHERE  A.ACCOUNT_STATUS='A'
    AND   A.LOAN_DUE_DATE > V_CURRDATE
    AND A.AMORT_TYPE='EIR'
    AND NOT EXISTS (SELECT * FROM TMP_ACCT D WHERE D.MASTERID=A.MASTERID) --NOT PROCESS IF HAS ANOTHER EVENT
    AND A.STAFF_LOAN_FLAG = 'N'
    ;
    COMMIT;
    /******************************************************************************
    END BY VIVI - 11 FEB 2019 - FOR CHANGES PAYMENT SETTING AND MULTIDISBURST
    *******************************************************************************/


    MERGE INTO IFRS_IMA_AMORT_CURR A
    USING (SELECT DISTINCT EFFECTIVE_DATE,MASTERID FROM IFRS_EVENT_CHANGES) B
    ON (B.MASTERID = A.MASTERID
        AND A.MASTERID NOT IN (SELECT DISTINCT MASTERID FROM IFRS_ACCT_CLOSED WHERE DOWNLOAD_DATE = V_CURRDATE)
        AND A.DOWNLOAD_DATE = V_CURRDATE
        AND B.EFFECTIVE_DATE = V_CURRDATE
       )
    WHEN MATCHED THEN
    UPDATE
    SET A.EIR_STATUS='Y'
      , A.ECF_STATUS='Y';
    COMMIT;


    INSERT  INTO IFRS_AMORT_LOG( DOWNLOAD_DATE ,DTM ,OPS ,PROCNAME ,REMARK)
    VALUES  ( V_CURRDATE ,SYSTIMESTAMP ,'END' ,'SP_IFRS_ACCT_EIR_ECF_EVENT' ,'');
    COMMIT;
END;