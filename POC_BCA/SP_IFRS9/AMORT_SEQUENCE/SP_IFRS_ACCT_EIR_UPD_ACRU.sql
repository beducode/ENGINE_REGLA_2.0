CREATE OR REPLACE PROCEDURE SP_IFRS_ACCT_EIR_UPD_ACRU
AS
  V_CURRDATE    DATE;
  V_PREVDATE    DATE;

BEGIN

    SELECT MAX(CURRDATE),MAX(PREVDATE)
    INTO V_CURRDATE, V_PREVDATE
    FROM IFRS_PRC_DATE_AMORT;


    INSERT INTO IFRS_AMORT_LOG(DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'START','SP_IFRS_ACCT_EIR_UPD_ACRU','');

    COMMIT;


    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_AP';

    INSERT /*+ PARALLEL(12) */ INTO TMP_AP(MASTERID, FLAG_CF,AMOUNT)
    SELECT /*+ PARALLEL(12) */ MASTERID, FLAG_CF,
           SUM(CASE WHEN FLAG_REVERSE='Y' THEN -1 * AMOUNT ELSE AMOUNT END) AS AMOUNT
    FROM IFRS_ACCT_EIR_ACCRU_PREV
    WHERE STATUS='ACT'
    GROUP BY MASTERID, FLAG_CF;

    COMMIT;


    MERGE INTO IFRS_ACCT_EIR_ACF A
    USING (SELECT X.*,V_CURRDATE CURRDATE FROM TMP_AP X) B
    ON (A.MASTERID=B.MASTERID
              AND A.DOWNLOAD_DATE=B.CURRDATE
              AND B.FLAG_CF='C'
       )
    WHEN MATCHED THEN
    UPDATE SET A.N_ACCRU_PREV_COST=B.AMOUNT;
    COMMIT;



    MERGE INTO IFRS_ACCT_EIR_ACF A
    USING (SELECT X.*,V_CURRDATE CURRDATE FROM TMP_AP X) B
    ON (A.MASTERID=B.MASTERID
              AND A.DOWNLOAD_DATE=B.CURRDATE
              AND B.FLAG_CF='F'
       )
    WHEN MATCHED THEN
    UPDATE SET A.N_ACCRU_PREV_FEE=B.AMOUNT;
    COMMIT;


    INSERT INTO IFRS_AMORT_LOG(DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'END','SP_IFRS_ACCT_EIR_UPD_ACRU','');

    COMMIT;

END;