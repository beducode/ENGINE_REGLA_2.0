CREATE OR REPLACE PROCEDURE SP_IFRS_LBM_ACCT_EIR_UPD_ACRU
AS
  V_CURRDATE DATE;
  V_PREVDATE DATE;

BEGIN
    SELECT MAX(CURRDATE)
        , MAX(PREVDATE) INTO V_CURRDATE, V_PREVDATE
    FROM IFRS_PRC_DATE_AMORT;

    INSERT INTO IFRS_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(  V_CURRDATE,SYSTIMESTAMP,'START','SP_IFRS_LBM_ACCT_EIR_UPD_ACRU_ACF','');

    COMMIT;

    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_AP';

    INSERT /*+ PARALLEL(12) */ INTO TMP_AP (
        MASTERID
        ,FLAG_CF
        ,AMOUNT
        )
    SELECT /*+ PARALLEL(12) */ MASTERID
        ,FLAG_CF
        ,SUM(CASE WHEN FLAG_REVERSE = 'Y' THEN - 1 * AMOUNT ELSE AMOUNT END) AS AMOUNT
    FROM IFRS_LBM_ACCT_EIR_ACCRU_PREV
    WHERE STATUS = 'ACT'
    GROUP BY MASTERID
        ,FLAG_CF;

    COMMIT;


    MERGE INTO IFRS_LBM_ACCT_EIR_ACF B
    USING (
        SELECT X.*
            ,V_CURRDATE CURRDATE
        FROM TMP_AP X
        ) A
    ON (A.MASTERID = B.MASTERID
        AND B.DOWNLOAD_DATE = A.CURRDATE
        AND A.FLAG_CF = 'C'
       )
    WHEN MATCHED THEN
    UPDATE
    SET B.N_ACCRU_PREV_COST = A.AMOUNT;


    MERGE INTO IFRS_LBM_ACCT_EIR_ACF B
    USING (
        SELECT X.*
            ,V_CURRDATE CURRDATE
        FROM TMP_AP X
        ) A
    ON (A.MASTERID = B.MASTERID
        AND B.DOWNLOAD_DATE = A.CURRDATE
        AND A.FLAG_CF = 'F'
       )
    WHEN MATCHED THEN
    UPDATE
    SET N_ACCRU_PREV_FEE = A.AMOUNT;

    INSERT INTO IFRS_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(  V_CURRDATE,SYSTIMESTAMP,'END','SP_IFRS_LBM_ACCT_EIR_UPD_ACRU_ACF','');

    COMMIT;

END;