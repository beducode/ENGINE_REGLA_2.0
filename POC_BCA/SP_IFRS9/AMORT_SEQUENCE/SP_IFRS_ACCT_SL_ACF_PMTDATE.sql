CREATE OR REPLACE PROCEDURE SP_IFRS_ACCT_SL_ACF_PMTDATE
AS
  V_CURRDATE	DATE;
	V_PREVDATE	DATE;


BEGIN

    SELECT MAX(CURRDATE),MAX(PREVDATE)
    INTO V_CURRDATE, V_PREVDATE
    FROM IFRS_PRC_DATE_AMORT ;


    INSERT INTO IFRS_AMORT_LOG(DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES( V_CURRDATE,SYSTIMESTAMP,'START','SP_IFRS_ACCT_SL_ACF_PMTDATE','' );


    -- insert acf
    INSERT /*+ PARALLEL(12) */ INTO IFRS_ACCT_SL_ACF
    (DOWNLOAD_DATE
    ,FACNO
    ,CIFNO
    ,DATASOURCE
    ,N_UNAMORT_COST
    ,N_UNAMORT_FEE
    ,N_AMORT_COST
    ,N_AMORT_FEE
    ,N_ACCRU_COST
    ,N_ACCRU_FEE
    ,N_ACCRUFULL_COST
    ,N_ACCRUFULL_FEE
    ,ECFDATE
    ,CREATEDDATE
    ,CREATEDBY
    ,MASTERID
    ,ACCTNO
    ,DO_AMORT
    ,BRANCH
    ,ACF_CODE
    )
    SELECT /*+ PARALLEL(12) */ M.DOWNLOAD_DATE
          ,M.FACILITY_NUMBER
          ,M.CUSTOMER_NUMBER
          ,M.DATA_SOURCE
          ,A.N_UNAMORT_COST
          ,A.N_UNAMORT_FEE
          ,A.N_AMORT_COST
          ,A.N_AMORT_FEE
          ,A.N_UNAMORT_COST-A.UNAMORT_COST_PREV - COALESCE(A.SW_ADJ_COST,0)
          ,A.N_UNAMORT_FEE-A.UNAMORT_FEE_PREV - COALESCE(A.SW_ADJ_FEE,0)
          ,A.N_UNAMORT_COST-A.UNAMORT_COST_PREV  - COALESCE(A.SW_ADJ_COST,0) AS N_ACCRUFULL_COST
          ,A.N_UNAMORT_FEE-A.UNAMORT_FEE_PREV  - COALESCE(A.SW_ADJ_FEE,0) AS N_ACCRUFULL_FEE
          ,A.DOWNLOAD_DATE
          ,SYSTIMESTAMP
          ,'SP_ACCT_SL_ACF_PMTDATE 1'
          ,M.MASTERID
          ,M.ACCOUNT_NUMBER
          ,'Y' DO_AMORT
          ,M.BRANCH_CODE
          ,'1' ACFCODE
    FROM IFRS_ACCT_SL_ECF A
    JOIN (SELECT M.DOWNLOAD_DATE
                ,M.MASTERID
                ,M.ACCOUNT_NUMBER
                ,M.DATA_SOURCE
                ,M.BRANCH_CODE
                ,M.FACILITY_NUMBER
                ,M.CUSTOMER_NUMBER
            FROM IFRS_IMA_AMORT_CURR M
            LEFT JOIN (SELECT DISTINCT DOWNLOAD_DATE,MASTERID
                       FROM IFRS_ACCT_CLOSED WHERE DOWNLOAD_DATE = V_CURRDATE
                      ) D
            ON M.DOWNLOAD_DATE = D.DOWNLOAD_DATE
            AND M.MASTERID = D.MASTERID
            WHERE M.DOWNLOAD_DATE = V_CURRDATE
            AND D.MASTERID IS NULL
          ) M
    ON M.MASTERID = A.MASTERID
    WHERE A.PMTDATE=V_CURRDATE
    AND A.PMTDATE<>A.PREVDATE
    AND A.AMORTSTOPDATE IS NULL;
    /* Remarks.. Tunning script 20160602
    from IMA_AMORT_CURR  m
    join IFRS_ACCT_SL_ECF a on a.amortstopdate is null
      and a.masterid=m.masterid
      and a.pmtdate=@v_currdate
        and a.pmtdate<>a.prevdate
    where
    --dont do if closed
    m.masterid not in (select masterid from IFRS_ACCT_CLOSED where DOWNLOAD_DATE=@v_currdate);
    end Remarks.. Tunning script 20160602*/
    COMMIT;

    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_P1';

    INSERT /*+ PARALLEL(12) */ INTO TMP_P1(ID)
    SELECT /*+ PARALLEL(12) */ MAX(ID) AS ID
    FROM IFRS_ACCT_SL_ACF WHERE DOWNLOAD_DATE=V_CURRDATE
    -- exclude acct registered @ stop rev 20160619
    AND MASTERID NOT IN (SELECT MASTERID FROM IFRS_ACCT_SL_STOP_REV WHERE DOWNLOAD_DATE=V_CURRDATE)
    GROUP BY MASTERID;
    COMMIT;

    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_T1';
    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_T2';

    -- FEE SUMM
    INSERT /*+ PARALLEL(12) */ INTO TMP_T1(
    SUM_AMT,
    DOWNLOAD_DATE,
    FACNO,
    CIFNO,
    DATASOURCE,
    ACCTNO,
    MASTERID
    )
    SELECT /*+ PARALLEL(12) */ SUM(A.N_AMOUNT) AS SUM_AMT,
           A.DOWNLOAD_DATE,
           A.FACNO,
           A.CIFNO,
           A.DATASOURCE,
           A.ACCTNO,
           A.MASTERID
    FROM(SELECT CASE WHEN A.FLAG_REVERSE='Y' THEN -1 * A.AMOUNT ELSE A.AMOUNT END AS N_AMOUNT
               ,A.ECFDATE DOWNLOAD_DATE
               ,A.FACNO
               ,A.CIFNO
               ,A.DATASOURCE
               ,A.ACCTNO
               ,A.MASTERID
          FROM IFRS_ACCT_SL_COST_FEE_ECF A
          WHERE A.FLAG_CF='F'
        ) A
    GROUP BY A.DOWNLOAD_DATE,A.FACNO,A.CIFNO,A.DATASOURCE,A.ACCTNO,A.MASTERID;
    COMMIT;

    -- fee detail unamort
    INSERT /*+ PARALLEL(12) */ INTO IFRS_ACCT_SL_COST_FEE_PREV
    (FACNO
    ,CIFNO
    ,DOWNLOAD_DATE
    ,ECFDATE
    ,DATASOURCE
    ,PRDCODE
    ,TRXCODE
    ,CCY
    ,AMOUNT
    ,STATUS
    ,CREATEDDATE
    ,ACCTNO
    ,MASTERID
    ,FLAG_CF
    ,FLAG_REVERSE
    ,BRCODE
    ,SRCPROCESS
    ,CREATEDBY
    ,METHOD
    ,SEQ
    ,AMOUNT_ORG
    ,ORG_CCY
    ,ORG_CCY_EXRATE
    ,PRDTYPE
    ,CF_ID
    )
    SELECT /*+ PARALLEL(12) */ A.FACNO
          ,A.CIFNO
          ,A.DOWNLOAD_DATE
          ,A.ECFDATE
          ,A.DATASOURCE
          ,B.PRDCODE
          ,B.TRXCODE
          ,B.CCY
          ,CAST(CAST(B.AMOUNT AS BINARY_DOUBLE)/CAST(C.SUM_AMT AS BINARY_DOUBLE) AS NUMBER(32,20)) * A.N_UNAMORT_FEE AS N_AMOUNT
          ,B.STATUS
          ,SYSTIMESTAMP
          ,A.ACCTNO
          ,A.MASTERID
          ,B.FLAG_CF
          ,B.FLAG_REVERSE
          ,B.BRCODE
          ,B.SRCPROCESS
          ,'SLACF01'
          ,'SL'
          ,'1'
          ,B.AMOUNT_ORG
          ,B.ORG_CCY
          ,B.ORG_CCY_EXRATE
          ,B.PRDTYPE
          ,B.CF_ID
    FROM IFRS_ACCT_SL_ACF  A
    JOIN IFRS_ACCT_SL_COST_FEE_ECF B
      ON B.ECFDATE=A.ECFDATE
      AND	A.MASTERID=B.MASTERID
      AND B.FLAG_CF='F'
      AND B.STATUS='ACT'
      AND B.METHOD='SL'
    JOIN TMP_T1 C
      ON C.DOWNLOAD_DATE=A.ECFDATE
      AND C.MASTERID=A.MASTERID
    WHERE A.DOWNLOAD_DATE=V_CURRDATE
    --and a.n_unamort_fee<0 ----CTBC 20180528
    AND A.ID IN (SELECT ID FROM TMP_P1);
     COMMIT;

    -- COST SUMM
    INSERT /*+ PARALLEL(12) */ INTO TMP_T2
    (SUM_AMT
    , DOWNLOAD_DATE
    ,FACNO
    ,CIFNO
    ,DATASOURCE
    ,ACCTNO
    ,MASTERID
    )
    SELECT /*+ PARALLEL(12) */ SUM(A.N_AMOUNT) AS SUM_AMT
          ,A.DOWNLOAD_DATE
          ,A.FACNO
          ,A.CIFNO
          ,A.DATASOURCE
          ,A.ACCTNO
          ,A.MASTERID
    FROM(SELECT CASE WHEN A.FLAG_REVERSE='Y' THEN -1 * A.AMOUNT ELSE A.AMOUNT END AS N_AMOUNT
              , A.ECFDATE DOWNLOAD_DATE
              , A.FACNO
              , A.CIFNO
              , A.DATASOURCE
              , A.ACCTNO
              , A.MASTERID
         FROM IFRS_ACCT_SL_COST_FEE_ECF A
         WHERE A.FLAG_CF='C'
        ) A
    GROUP BY A.DOWNLOAD_DATE,A.FACNO,A.CIFNO,A.DATASOURCE,A.ACCTNO,A.MASTERID;
    COMMIT;

    -- COST DETAIL
    INSERT /*+ PARALLEL(12) */ INTO IFRS_ACCT_SL_COST_FEE_PREV
    (FACNO
    ,CIFNO
    ,DOWNLOAD_DATE
    ,ECFDATE
    ,DATASOURCE
    ,PRDCODE
    ,TRXCODE
    ,CCY
    ,AMOUNT
    ,STATUS
    ,CREATEDDATE
    ,ACCTNO
    ,MASTERID
    ,FLAG_CF
    ,FLAG_REVERSE
    ,BRCODE
    ,SRCPROCESS
    ,CREATEDBY
    ,METHOD
    ,SEQ
    ,AMOUNT_ORG
    ,ORG_CCY
    ,ORG_CCY_EXRATE
    ,PRDTYPE
    ,CF_ID)
    SELECT /*+ PARALLEL(12) */ A.FACNO
          ,A.CIFNO
          ,A.DOWNLOAD_DATE
          ,A.ECFDATE
          ,A.DATASOURCE
          ,B.PRDCODE
          ,B.TRXCODE
          ,B.CCY
          ,CAST(CAST(B.AMOUNT AS BINARY_DOUBLE)/CAST(C.SUM_AMT AS BINARY_DOUBLE) AS NUMBER(32,20)) * A.N_UNAMORT_COST AS N_AMOUNT
          ,B.STATUS
          ,SYSTIMESTAMP
          ,A.ACCTNO
          ,A.MASTERID
          ,B.FLAG_CF
          ,B.FLAG_REVERSE
          ,B.BRCODE
          ,B.SRCPROCESS
          ,'SLACF01'
          ,'SL'
          ,'1'
          ,B.AMOUNT_ORG
          ,B.ORG_CCY
          ,B.ORG_CCY_EXRATE
          ,B.PRDTYPE
          ,B.CF_ID
    FROM IFRS_ACCT_SL_ACF  A
    JOIN IFRS_ACCT_SL_COST_FEE_ECF B ON B.ECFDATE=A.ECFDATE
      AND A.MASTERID=B.MASTERID
      AND B.FLAG_CF='C' AND B.STATUS='ACT'
    JOIN TMP_T2 C ON C.DOWNLOAD_DATE=A.ECFDATE AND C.MASTERID=A.MASTERID
    WHERE A.DOWNLOAD_DATE=V_CURRDATE
    --and a.n_unamort_cost>0 ----CTBC 20180528
    AND A.ID IN (SELECT ID FROM TMP_P1);
    COMMIT;

    -- amort acru --journal should do the rest
    UPDATE /*+ PARALLEL(12) */ IFRS_ACCT_SL_ACCRU_PREV
    SET STATUS=TO_CHAR(V_CURRDATE,'YYYYMMDD')
    WHERE STATUS='ACT'
    AND MASTERID IN (SELECT DISTINCT MASTERID FROM IFRS_ACCT_SL_ACF WHERE DOWNLOAD_DATE=V_CURRDATE AND DO_AMORT='Y');
    COMMIT;

    -- stop sl ecf end today
    UPDATE /*+ PARALLEL(12) */ IFRS_ACCT_SL_ECF
    SET AMORTSTOPDATE=V_CURRDATE,AMORTSTOPREASON='END_ACF'
    WHERE AMORTENDDATE=V_CURRDATE AND AMORTSTOPDATE IS NULL
    AND MASTERID NOT IN (SELECT DISTINCT MASTERID FROM IFRS_ACCT_CLOSED WHERE DOWNLOAD_DATE=V_CURRDATE);
    COMMIT;

    INSERT INTO IFRS_AMORT_LOG(DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'END','SP_IFRS_ACCT_SL_ACF_PMTDATE','');

END;