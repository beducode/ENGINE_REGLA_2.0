CREATE OR REPLACE PROCEDURE SP_IFRS_ECL_IA_CALC(v_ECLID NUMBER DEFAULT(0), v_DOWNLOADDATE DATE DEFAULT('1-JAN-1900'))
AS
    V_ECLMODELID  NUMBER(18);
    V_CURRDATE  DATE;
    V_UPLOADID NUMBER(18);
BEGIN
    IF v_ECLID = 0 THEN
        SELECT PKID INTO V_ECLMODELID FROM IFRS_ECL_MODEL_HEADER WHERE ACTIVE_FLAG = 1;
    ELSE
        v_ECLMODELID := v_ECLID;
    END IF;

    IF v_DOWNLOADDATE = '1-JAN-1900' THEN
        SELECT CURRDATE INTO V_CURRDATE FROM IFRS_PRC_DATE;
    ELSE
        V_CURRDATE := v_DOWNLOADDATE;
    END IF;

    SELECT MAX(UPLOADID)
    INTO V_UPLOADID
    FROM TBLU_DCF_BULK
    WHERE EFFECTIVE_DATE = V_CURRDATE;

    --Revert CA to IA if IA customers already moved to CA in previous run
    SP_IFRS_ECL_IA_INITIAL_RUN(v_DOWNLOADDATE);

    --Recalculate IA using latest eom data
    SP_IFRS_IA_SEQUENCE(V_UPLOADID, v_DOWNLOADDATE);

    --Removing CA customers from IA
    SP_IFRS_ECL_IA_TO_CA(V_CURRDATE);

    SP_IFRS_ECL_UNPROCESSED_IA(v_ECLID, v_DOWNLOADDATE);

    EXECUTE IMMEDIATE 'TRUNCATE TABLE GTMP_IFRS_MASTER_ACCOUNT';

    INSERT INTO GTMP_IFRS_MASTER_ACCOUNT
    (
        PKID,
        DOWNLOAD_DATE,
        MASTERID,
        MASTER_ACCOUNT_CODE,
        CUSTOMER_NUMBER,
        ACCOUNT_NUMBER,
        IMPAIRED_FLAG,
        ECL_AMOUNT
    )
    SELECT A.PKID,
        A.DOWNLOAD_DATE,
        A.MASTERID,
        ' ' MASTER_ACCOUNT_CODE,
        A.CUSTOMER_NUMBER,
        A.ACCOUNT_NUMBER,
        'I' AS IMPAIRED_FLAG,
        C.ECL_AMOUNT
    FROM IFRS_ECL_RESULT_DETAIL A
    JOIN
    (   SELECT CUSTOMER_NUMBER, MAX(PKID) MAX_OVERRIDEID
        FROM IFRS_IA_OVERRIDEH
        WHERE EFFECTIVE_DATE <= V_CURRDATE
        GROUP BY CUSTOMER_NUMBER
    ) B
    ON A.DOWNLOAD_DATE = V_CURRDATE
    AND A.ECL_MODEL_ID = v_ECLID
    AND A.CUSTOMER_NUMBER = B.CUSTOMER_NUMBER
    JOIN TBLT_PAYMENTEXPECTEDH C
    ON B.MAX_OVERRIDEID = C.OVERRIDEID
    AND A.ACCOUNT_NUMBER = C.ACCOUNT_NUMBER;

    COMMIT;

    DELETE IFRS_ECL_RESULT_DETAIL_CALC
    WHERE DOWNLOAD_DATE = V_CURRDATE
    AND ECL_MODEL_ID = v_ECLID
    AND MASTERID IN
    (SELECT MASTERID FROM GTMP_IFRS_MASTER_ACCOUNT)
    AND COUNTER_PAYSCHD > 1;

    COMMIT;

    MERGE INTO IFRS_ECL_RESULT_DETAIL_CALC A
    USING GTMP_IFRS_MASTER_ACCOUNT B
    ON (A.DOWNLOAD_DATE = V_CURRDATE
    AND A.ECL_MODEL_ID = v_ECLID
    AND A.MASTERID = B.MASTERID)
    WHEN MATCHED THEN
    UPDATE SET
        A.PD_RATE = 1,
        A.LGD_RATE = 1,
        A.DISCOUNT_RATE = 1,
        A.ECL_AMOUNT = B.ECL_AMOUNT;

    COMMIT;

    MERGE INTO IFRS_ECL_RESULT_DETAIL A
    USING
    (   SELECT A2.MASTERID, B2.ECL_AMOUNT, A2.IMPAIRED_FLAG
        FROM GTMP_IFRS_MASTER_ACCOUNT A2
        JOIN IFRS_ECL_RESULT_DETAIL_CALC B2
        ON B2.DOWNLOAD_DATE = V_CURRDATE
        AND B2.ECL_MODEL_ID = v_ECLID
        AND A2.MASTERID = B2.MASTERID
    ) B
    ON (A.DOWNLOAD_DATE = V_CURRDATE
    AND A.ECL_MODEL_ID = v_ECLID
    AND A.MASTERID = B.MASTERID)
    WHEN MATCHED THEN
    UPDATE SET
        A.ECL_AMOUNT = B.ECL_AMOUNT,
        A.IMPAIRED_FLAG = B.IMPAIRED_FLAG,
        A.SPECIAL_REASON = 'INDIVIDUAL';

    COMMIT;
END;