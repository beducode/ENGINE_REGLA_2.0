CREATE OR REPLACE PROCEDURE SP_IFRS_ASMR_RATING
IS
BEGIN
    DELETE FROM IFRS.IFRS_ASMR_RATING
           WHERE DOWNLOAD_DATE = (SELECT CURRDATE FROM IFRS.IFRS_PRC_DATE);
    COMMIT;

    INSERT INTO IFRS.IFRS_ASMR_RATING M (
        DOWNLOAD_DATE,
        CUSTOMER_NUMBER,
        RATING_CODE,
        RATING_SOURCE,
        GOL_DEB,
        CREATED_BY,
        CREATED_DATE,
        CREATED_HOST,
        UPDATED_BY,
        UPDATED_DATE,
        UPDATED_HOST
    )
    SELECT
        DOWNLOAD_DATE,
        CUSTOMER_NUMBER,
        RATING_CODE,
        RATING_SOURCE,
        GOL_DEB,
        'SYSTEM',
        SYSDATE,
        'LOCALHOST',
        NULL,
        NULL,
        NULL
    FROM IFRS.IFRS_STG_ASMR_RATING S
        WHERE 1=1
        AND S.RATING_TYPE = 1
        AND S.RATING_SOURCE IN ('ICOS', 'CRRS')
        AND S.DOWNLOAD_DATE = (SELECT CURRDATE FROM IFRS.IFRS_PRC_DATE)
    ;
    COMMIT;
END;