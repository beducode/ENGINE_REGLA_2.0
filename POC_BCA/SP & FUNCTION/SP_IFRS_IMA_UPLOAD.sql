CREATE OR REPLACE PROCEDURE SP_IFRS_IMA_UPLOAD
    AS

    V_CURRDATE DATE;
    V_PREVDATE DATE;

    BEGIN

    SELECT CURRDATE INTO V_CURRDATE FROM IFRS_PRC_DATE;
    SELECT PREVDATE INTO V_PREVDATE FROM IFRS_PRC_DATE;


DELETE IFRS_MASTER_ACCOUNT_UPLOAD
WHERE DOWNLOAD_DATE >= V_CURRDATE;COMMIT;

INSERT INTO IFRS_MASTER_ACCOUNT_UPLOAD
SELECT * FROM TBLU_IMA_LENDING WHERE DOWNLOAD_DATE = V_CURRDATE;COMMIT;

DELETE IFRS_MASTER_ACCOUNT_UPLOAD
WHERE V_CURRDATE NOT BETWEEN LOAN_START_DATE AND LOAN_DUE_DATE;COMMIT;


DELETE IFRS_MASTER_ACCOUNT
 WHERE     DOWNLOAD_DATE = V_CURRDATE
       AND ACCOUNT_NUMBER IN (SELECT ACCOUNT_NUMBER
                                FROM IFRS_MASTER_ACCOUNT_UPLOAD WHERE DOWNLOAD_DATE = V_CURRDATE);

COMMIT;


INSERT INTO IFRS_MASTER_ACCOUNT (DOWNLOAD_DATE,
                                 MASTERID,
                                 MASTER_ACCOUNT_CODE,
                                 PRODUCT_ENTITY,
                                 DATA_SOURCE,
                                 PRODUCT_CODE,
                                 BRANCH_CODE,
                                 CURRENCY,
                                 ACCOUNT_NUMBER,
                                 CUSTOMER_NUMBER,
                                 CUSTOMER_NAME,
                                 INITIAL_OUTSTANDING,
                                 OUTSTANDING,
                                 INTEREST_RATE,
                                 LOAN_START_DATE,
                                 LOAN_DUE_DATE,
                                 NEXT_PAYMENT_DATE,
                                 DPD_START_DATE,
                                 BI_COLLECTABILITY,
                                 INTEREST_ACCRUED,
                                 RESERVED_VARCHAR_2,
                                 RESERVED_VARCHAR_3,
                                 PRODUCT_GROUP,
                                 PRODUCT_TYPE,
                                 AMORT_TYPE,
                                 IS_IMPAIRED,
                                 ACCOUNT_STATUS,
                                 INTEREST_CALCULATION_CODE,
                                 IMPAIRED_FLAG,
                                 IAS_CLASS,
                                 IFRS9_CLASS,
                                 CREATEDBY,
                                 CREATEDHOST,
                                 CREATEDDATE)
   SELECT V_CURRDATE,
          0,
          A.MASTER_ACCOUNT_CODE,
          A.PRODUCT_ENTITY,
          A.DATA_SOURCE,
          A.PRODUCT_CODE,
          A.BRANCH_CODE,
          A.CURRENCY,
          A.ACCOUNT_NUMBER,
          A.CUSTOMER_NUMBER,
          A.CUSTOMER_NAME,
          A.INITIAL_OUTSTANDING,
          A.OUTSTANDING,
          A.INTEREST_RATE,
          A.LOAN_START_DATE,
          A.LOAN_DUE_DATE,
          A.NEXT_PAYMENT_DATE,
          A.DPD_START_DATE,
          A.BI_COLLECTABILITY,
          A.INTEREST_ACCRUED,
          A.GOL_DEB,
          A.NOREK_LBU,
          B.PRD_GROUP,
          B.PRD_TYPE,
          B.AMORT_TYPE,
          B.IS_IMPAIRED,
          A.ACCOUNT_STATUS,
          A.INTEREST_CALCULATION_CODE,
          'C',
          'A',
          'AMORT',
          'ADMIN',
          'HOST',
          SYSDATE
     FROM IFRS_MASTER_ACCOUNT_UPLOAD A
     LEFT JOIN IFRS_MASTER_PRODUCT_PARAM B
     ON     A.DATA_SOURCE = B.DATA_SOURCE
     AND    A.PRODUCT_CODE = B.PRD_CODE
     WHERE  A.DOWNLOAD_DATE = V_CURRDATE;

COMMIT;

INSERT INTO IFRS_MASTER_ACCOUNT
(
DOWNLOAD_DATE                   ,
MASTERID                        ,
MASTER_ACCOUNT_CODE             ,
DATA_SOURCE                     ,
GLOBAL_CUSTOMER_NUMBER          ,
CUSTOMER_NUMBER                 ,
CUSTOMER_NAME                   ,
FACILITY_NUMBER                 ,
ACCOUNT_NUMBER                  ,
PREVIOUS_ACCOUNT_NUMBER         ,
ACCOUNT_STATUS                  ,
INTEREST_RATE                   ,
MARKET_RATE                     ,
PRODUCT_GROUP                   ,
PRODUCT_TYPE                    ,
PRODUCT_CODE                    ,
PRODUCT_ENTITY                  ,
GL_CONSTNAME                    ,
BRANCH_CODE                     ,
BRANCH_CODE_OPEN                ,
CURRENCY                        ,
EXCHANGE_RATE                   ,
INITIAL_OUTSTANDING             ,
OUTSTANDING                     ,
OUTSTANDING_IDC                 ,
OUTSTANDING_JF                  ,
OUTSTANDING_BANK                ,
OUTSTANDING_PASTDUE             ,
PLAFOND                         ,
PLAFOND_CASH                    ,
INTEREST_ACCRUED                ,
INSTALLMENT_AMOUNT              ,
UNUSED_AMOUNT                   ,
DOWN_PAYMENT_AMOUNT             ,
JF_FLAG                         ,
LOAN_START_DATE                 ,
LOAN_DUE_DATE                   ,
LOAN_START_AMORTIZATION         ,
LOAN_END_AMORTIZATION           ,
INSTALLMENT_GRACE_PERIOD        ,
NEXT_PAYMENT_DATE               ,
NEXT_INT_PAYMENT_DATE           ,
LAST_PAYMENT_DATE               ,
FIRST_INSTALLMENT_DATE          ,
TENOR                           ,
REMAINING_TENOR                 ,
PAYMENT_CODE                    ,
PAYMENT_TERM                    ,
INTEREST_CALCULATION_CODE       ,
INTEREST_PAYMENT_TERM           ,
RESTRUCTURE_DATE                ,
RESTRUCTURE_FLAG                ,
POCI_FLAG                       ,
STAFF_LOAN_FLAG                 ,
BELOW_MARKET_FLAG               ,
BTB_FLAG                        ,
COMMITTED_FLAG                  ,
REVOLVING_FLAG                  ,
IAS_CLASS                       ,
IFRS9_CLASS                     ,
BM_RESULT                       ,
SPPI_RESULT                     ,
AMORT_TYPE                      ,
EIR_STATUS                      ,
ECF_STATUS                      ,
EIR                             ,
EIR_AMOUNT                      ,
FAIR_VALUE_AMOUNT               ,
INITIAL_UNAMORT_TXN_COST        ,
INITIAL_UNAMORT_ORG_FEE         ,
UNAMORT_COST_AMT                ,
UNAMORT_FEE_AMT                 ,
DAILY_AMORT_AMT                 ,
UNAMORT_BENEFIT                 ,
UNAMORT_AMT_TOTAL_JF            ,
UNAMORT_FEE_AMT_JF              ,
UNAMORT_COST_AMT_JF             ,
ORIGINAL_COLLECTABILITY         ,
BI_COLLECTABILITY               ,
ORIGINAL_DAY_PAST_DUE           ,
DAY_PAST_DUE                    ,
DPD_START_DATE                  ,
DPD_ZERO_COUNTER                ,
NPL_DATE                        ,
NPL_FLAG                        ,
DEFAULT_DATE                    ,
DEFAULT_FLAG                    ,
WRITEOFF_FLAG                   ,
WRITEOFF_DATE                   ,
OUTSTANDING_WO                  ,
IMPAIRED_FLAG                   ,
IS_IMPAIRED                     ,
GROUP_SEGMENT                   ,
SEGMENT                         ,
SUB_SEGMENT                     ,
CR_STAGE                        ,
CCF_RULE_ID                     ,
CCF_SEGMENT                     ,
LIFETIME_RULE_ID                ,
LIFETIME_SEGMENT                ,
LIFETIME                        ,
EAD_RULE_ID                     ,
EAD_SEGMENT                     ,
EAD_AMOUNT                      ,
LGD_RULE_ID                     ,
LGD_SEGMENT                     ,
PD_RULE_ID                      ,
PD_SEGMENT                      ,
RATING_CODE                     ,
BUCKET_GROUP                    ,
BUCKET_ID                       ,
ECL_12_AMOUNT                   ,
ECL_LIFETIME_AMOUNT             ,
ECL_AMOUNT                      ,
CA_UNWINDING_AMOUNT             ,
IA_UNWINDING_AMOUNT             ,
IA_UNWINDING_SUM_AMOUNT         ,
BEGINNING_BALANCE               ,
ENDING_BALANCE                  ,
WRITEBACK_AMOUNT                ,
CHARGE_AMOUNT                   ,
RESERVED_VARCHAR_1              ,
RESERVED_VARCHAR_2              ,
RESERVED_VARCHAR_3              ,
RESERVED_VARCHAR_4              ,
RESERVED_VARCHAR_5              ,
RESERVED_VARCHAR_6              ,
RESERVED_VARCHAR_7              ,
RESERVED_VARCHAR_8              ,
RESERVED_VARCHAR_9              ,
RESERVED_VARCHAR_10             ,
RESERVED_VARCHAR_11             ,
RESERVED_VARCHAR_12             ,
RESERVED_VARCHAR_13             ,
RESERVED_VARCHAR_14             ,
RESERVED_VARCHAR_15             ,
RESERVED_VARCHAR_16             ,
RESERVED_VARCHAR_17             ,
RESERVED_VARCHAR_18             ,
RESERVED_VARCHAR_19             ,
RESERVED_VARCHAR_20             ,
RESERVED_VARCHAR_21             ,
RESERVED_VARCHAR_22             ,
RESERVED_VARCHAR_23             ,
RESERVED_VARCHAR_24             ,
RESERVED_VARCHAR_25             ,
RESERVED_VARCHAR_26             ,
RESERVED_VARCHAR_27             ,
RESERVED_VARCHAR_28             ,
RESERVED_VARCHAR_29             ,
RESERVED_VARCHAR_30             ,
RESERVED_AMOUNT_1               ,
RESERVED_AMOUNT_2               ,
RESERVED_AMOUNT_3               ,
RESERVED_AMOUNT_4               ,
RESERVED_AMOUNT_5               ,
RESERVED_AMOUNT_6               ,
RESERVED_AMOUNT_7               ,
RESERVED_AMOUNT_8               ,
RESERVED_AMOUNT_9               ,
RESERVED_AMOUNT_10              ,
RESERVED_AMOUNT_11              ,
RESERVED_AMOUNT_12              ,
RESERVED_AMOUNT_13              ,
RESERVED_AMOUNT_14              ,
RESERVED_AMOUNT_15              ,
RESERVED_AMOUNT_16              ,
RESERVED_AMOUNT_17              ,
RESERVED_AMOUNT_18              ,
RESERVED_AMOUNT_19              ,
RESERVED_AMOUNT_20              ,
RESERVED_RATE_1                 ,
RESERVED_RATE_2                 ,
RESERVED_RATE_3                 ,
RESERVED_RATE_4                 ,
RESERVED_RATE_5                 ,
RESERVED_RATE_6                 ,
RESERVED_RATE_7                 ,
RESERVED_RATE_8                 ,
RESERVED_RATE_9                 ,
RESERVED_RATE_10                ,
RESERVED_FLAG_1                 ,
RESERVED_FLAG_2                 ,
RESERVED_FLAG_3                 ,
RESERVED_FLAG_4                 ,
RESERVED_FLAG_5                 ,
RESERVED_FLAG_6                 ,
RESERVED_FLAG_7                 ,
RESERVED_FLAG_8                 ,
RESERVED_FLAG_9                 ,
RESERVED_FLAG_10                ,
RESERVED_DATE_1                 ,
RESERVED_DATE_2                 ,
RESERVED_DATE_3                 ,
RESERVED_DATE_4                 ,
RESERVED_DATE_5                 ,
RESERVED_DATE_6                 ,
RESERVED_DATE_7                 ,
RESERVED_DATE_8                 ,
RESERVED_DATE_9                 ,
RESERVED_DATE_10                ,
CREATEDBY                       ,
CREATEDDATE                     ,
CREATEDHOST                     ,
UPDATEDBY                       ,
UPDATEDDATE                     ,
UPDATEDHOST                     ,
SEGMENT_RULE_ID                 ,
PREPAYMENT_SEGMENT              ,
PREPAYMENT_RULE_ID
)
SELECT
V_CURRDATE                      ,
A.MASTERID                        ,
A.MASTER_ACCOUNT_CODE             ,
A.DATA_SOURCE                     ,
A.GLOBAL_CUSTOMER_NUMBER          ,
A.CUSTOMER_NUMBER                 ,
A.CUSTOMER_NAME                   ,
A.FACILITY_NUMBER                 ,
A.ACCOUNT_NUMBER                  ,
A.PREVIOUS_ACCOUNT_NUMBER         ,
A.ACCOUNT_STATUS                  ,
A.INTEREST_RATE                   ,
A.MARKET_RATE                     ,
A.PRODUCT_GROUP                   ,
A.PRODUCT_TYPE                    ,
A.PRODUCT_CODE                    ,
A.PRODUCT_ENTITY                  ,
A.GL_CONSTNAME                    ,
A.BRANCH_CODE                     ,
A.BRANCH_CODE_OPEN                ,
A.CURRENCY                        ,
A.EXCHANGE_RATE                   ,
A.INITIAL_OUTSTANDING             ,
A.OUTSTANDING                     ,
A.OUTSTANDING_IDC                 ,
A.OUTSTANDING_JF                  ,
A.OUTSTANDING_BANK                ,
A.OUTSTANDING_PASTDUE             ,
A.PLAFOND                         ,
A.PLAFOND_CASH                    ,
A.INTEREST_ACCRUED                ,
A.INSTALLMENT_AMOUNT              ,
A.UNUSED_AMOUNT                   ,
A.DOWN_PAYMENT_AMOUNT             ,
A.JF_FLAG                         ,
A.LOAN_START_DATE                 ,
A.LOAN_DUE_DATE                   ,
A.LOAN_START_AMORTIZATION         ,
A.LOAN_END_AMORTIZATION           ,
A.INSTALLMENT_GRACE_PERIOD        ,
A.NEXT_PAYMENT_DATE               ,
A.NEXT_INT_PAYMENT_DATE           ,
A.LAST_PAYMENT_DATE               ,
A.FIRST_INSTALLMENT_DATE          ,
A.TENOR                           ,
A.REMAINING_TENOR                 ,
A.PAYMENT_CODE                    ,
A.PAYMENT_TERM                    ,
A.INTEREST_CALCULATION_CODE       ,
A.INTEREST_PAYMENT_TERM           ,
A.RESTRUCTURE_DATE                ,
A.RESTRUCTURE_FLAG                ,
A.POCI_FLAG                       ,
A.STAFF_LOAN_FLAG                 ,
A.BELOW_MARKET_FLAG               ,
A.BTB_FLAG                        ,
A.COMMITTED_FLAG                  ,
A.REVOLVING_FLAG                  ,
A.IAS_CLASS                       ,
A.IFRS9_CLASS                     ,
A.BM_RESULT                       ,
A.SPPI_RESULT                     ,
A.AMORT_TYPE                      ,
A.EIR_STATUS                      ,
A.ECF_STATUS                      ,
A.EIR                             ,
A.EIR_AMOUNT                      ,
A.FAIR_VALUE_AMOUNT               ,
A.INITIAL_UNAMORT_TXN_COST        ,
A.INITIAL_UNAMORT_ORG_FEE         ,
A.UNAMORT_COST_AMT                ,
A.UNAMORT_FEE_AMT                 ,
A.DAILY_AMORT_AMT                 ,
A.UNAMORT_BENEFIT                 ,
A.UNAMORT_AMT_TOTAL_JF            ,
A.UNAMORT_FEE_AMT_JF              ,
A.UNAMORT_COST_AMT_JF             ,
A.ORIGINAL_COLLECTABILITY         ,
A.BI_COLLECTABILITY               ,
A.ORIGINAL_DAY_PAST_DUE           ,
A.DAY_PAST_DUE                    ,
A.DPD_START_DATE                  ,
A.DPD_ZERO_COUNTER                ,
A.NPL_DATE                        ,
A.NPL_FLAG                        ,
A.DEFAULT_DATE                    ,
A.DEFAULT_FLAG                    ,
A.WRITEOFF_FLAG                   ,
A.WRITEOFF_DATE                   ,
A.OUTSTANDING_WO                  ,
A.IMPAIRED_FLAG                   ,
A.IS_IMPAIRED                     ,
A.GROUP_SEGMENT                   ,
A.SEGMENT                         ,
A.SUB_SEGMENT                     ,
A.CR_STAGE                        ,
A.CCF_RULE_ID                     ,
A.CCF_SEGMENT                     ,
A.LIFETIME_RULE_ID                ,
A.LIFETIME_SEGMENT                ,
A.LIFETIME                        ,
A.EAD_RULE_ID                     ,
A.EAD_SEGMENT                     ,
A.EAD_AMOUNT                      ,
A.LGD_RULE_ID                     ,
A.LGD_SEGMENT                     ,
A.PD_RULE_ID                      ,
A.PD_SEGMENT                      ,
A.RATING_CODE                     ,
A.BUCKET_GROUP                    ,
A.BUCKET_ID                       ,
A.ECL_12_AMOUNT                   ,
A.ECL_LIFETIME_AMOUNT             ,
A.ECL_AMOUNT                      ,
A.CA_UNWINDING_AMOUNT             ,
A.IA_UNWINDING_AMOUNT             ,
A.IA_UNWINDING_SUM_AMOUNT         ,
A.BEGINNING_BALANCE               ,
A.ENDING_BALANCE                  ,
A.WRITEBACK_AMOUNT                ,
A.CHARGE_AMOUNT                   ,
A.RESERVED_VARCHAR_1              ,
A.RESERVED_VARCHAR_2              ,
A.RESERVED_VARCHAR_3              ,
A.RESERVED_VARCHAR_4              ,
A.RESERVED_VARCHAR_5              ,
A.RESERVED_VARCHAR_6              ,
A.RESERVED_VARCHAR_7              ,
A.RESERVED_VARCHAR_8              ,
A.RESERVED_VARCHAR_9              ,
A.RESERVED_VARCHAR_10             ,
A.RESERVED_VARCHAR_11             ,
A.RESERVED_VARCHAR_12             ,
A.RESERVED_VARCHAR_13             ,
A.RESERVED_VARCHAR_14             ,
A.RESERVED_VARCHAR_15             ,
A.RESERVED_VARCHAR_16             ,
A.RESERVED_VARCHAR_17             ,
A.RESERVED_VARCHAR_18             ,
A.RESERVED_VARCHAR_19             ,
A.RESERVED_VARCHAR_20             ,
A.RESERVED_VARCHAR_21             ,
A.RESERVED_VARCHAR_22             ,
A.RESERVED_VARCHAR_23             ,
A.RESERVED_VARCHAR_24             ,
A.RESERVED_VARCHAR_25             ,
A.RESERVED_VARCHAR_26             ,
A.RESERVED_VARCHAR_27             ,
A.RESERVED_VARCHAR_28             ,
A.RESERVED_VARCHAR_29             ,
A.RESERVED_VARCHAR_30             ,
A.RESERVED_AMOUNT_1               ,
A.RESERVED_AMOUNT_2               ,
A.RESERVED_AMOUNT_3               ,
A.RESERVED_AMOUNT_4               ,
A.RESERVED_AMOUNT_5               ,
A.RESERVED_AMOUNT_6               ,
A.RESERVED_AMOUNT_7               ,
A.RESERVED_AMOUNT_8               ,
A.RESERVED_AMOUNT_9               ,
A.RESERVED_AMOUNT_10              ,
A.RESERVED_AMOUNT_11              ,
A.RESERVED_AMOUNT_12              ,
A.RESERVED_AMOUNT_13              ,
A.RESERVED_AMOUNT_14              ,
A.RESERVED_AMOUNT_15              ,
A.RESERVED_AMOUNT_16              ,
A.RESERVED_AMOUNT_17              ,
A.RESERVED_AMOUNT_18              ,
A.RESERVED_AMOUNT_19              ,
A.RESERVED_AMOUNT_20              ,
A.RESERVED_RATE_1                 ,
A.RESERVED_RATE_2                 ,
A.RESERVED_RATE_3                 ,
A.RESERVED_RATE_4                 ,
A.RESERVED_RATE_5                 ,
A.RESERVED_RATE_6                 ,
A.RESERVED_RATE_7                 ,
A.RESERVED_RATE_8                 ,
A.RESERVED_RATE_9                 ,
A.RESERVED_RATE_10                ,
A.RESERVED_FLAG_1                 ,
A.RESERVED_FLAG_2                 ,
A.RESERVED_FLAG_3                 ,
A.RESERVED_FLAG_4                 ,
A.RESERVED_FLAG_5                 ,
A.RESERVED_FLAG_6                 ,
A.RESERVED_FLAG_7                 ,
A.RESERVED_FLAG_8                 ,
A.RESERVED_FLAG_9                 ,
A.RESERVED_FLAG_10                ,
A.RESERVED_DATE_1                 ,
A.RESERVED_DATE_2                 ,
A.RESERVED_DATE_3                 ,
A.RESERVED_DATE_4                 ,
A.RESERVED_DATE_5                 ,
A.RESERVED_DATE_6                 ,
A.RESERVED_DATE_7                 ,
A.RESERVED_DATE_8                 ,
A.RESERVED_DATE_9                 ,
A.RESERVED_DATE_10                ,
A.CREATEDBY                       ,
A.CREATEDDATE                     ,
A.CREATEDHOST                     ,
A.UPDATEDBY                       ,
A.UPDATEDDATE                     ,
A.UPDATEDHOST                     ,
A.SEGMENT_RULE_ID                 ,
A.PREPAYMENT_SEGMENT              ,
A.PREPAYMENT_RULE_ID
FROM IFRS_MASTER_ACCOUNT A
JOIN (SELECT A.* FROM IFRS_MASTER_ACCOUNT_UPLOAD A
        JOIN (SELECT MAX(DOWNLOAD_DATE)DOWNLOAD_DATE,ACCOUNT_NUMBER,DATA_SOURCE,PRODUCT_CODE FROM IFRS_MASTER_ACCOUNT_UPLOAD
        GROUP BY ACCOUNT_NUMBER,DATA_SOURCE,PRODUCT_CODE) B
        ON A.DOWNLOAD_DATE = B.DOWNLOAD_DATE AND A.ACCOUNT_NUMBER = B.ACCOUNT_NUMBER)C
ON (A.ACCOUNT_NUMBER = C.ACCOUNT_NUMBER AND C.DOWNLOAD_DATE = V_CURRDATE)
WHERE A.DOWNLOAD_DATE = V_PREVDATE;
COMMIT;

END;