CREATE OR REPLACE PROCEDURE USPS_LOANMODULEEIRCURRENTCHART
(
    V_DDATE_MAID VARCHAR2 DEFAULT ' ',
	Cur_out OUT SYS_REFCURSOR
)
AS
 v_DATE DATE;
 v_DATE2 DATE;
 v_MASTERID NUMBER(18);
BEGIN
    v_DATE := TO_DATE(SUBSTR(V_DDATE_MAID,1,10),'yyyy/MM/dd');
    v_MASTERID := TO_NUMBER(SUBSTR(V_DDATE_MAID,11,INSTR(V_DDATE_MAID,'*',1)-11));

    SELECT MAX(DOWNLOAD_DATE) INTO v_DATE2
    FROM IFRS_ACCT_EIR_ECF
    WHERE MASTERID = v_MASTERID
    AND DOWNLOAD_DATE <= v_DATE;

    IF (v_DATE2 IS NULL) THEN
        v_DATE2 := '01-JAN-1900';
    END IF;

    OPEN Cur_out FOR
    SELECT TO_CHAR(PMT_DATE, 'dd-MON-yyyy') AS EFFDATE,
        N_INT_PAYMENT AS INTEREST,
        N_EFF_INT_AMT AS EIR_AMOUNT,
        NOCF_EFF_INT_AMT,
        N_COST_AMORT_AMT AS AMORT_TXN_COST,
        N_FEE_AMORT_AMT AS AMORT_ORG_FEE
    FROM IFRS_ACCT_EIR_ECF
    WHERE MASTERID = v_MASTERID
    AND DOWNLOAD_DATE = v_DATE2
    ORDER BY PMT_DATE ASC;

END;