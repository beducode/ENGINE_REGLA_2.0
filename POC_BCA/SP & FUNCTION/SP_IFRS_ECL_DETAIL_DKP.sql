CREATE OR REPLACE PROCEDURE SP_IFRS_ECL_DETAIL_DKP (v_DOWNLOADDATE DATE DEFAULT('1-JAN-1900'),v_DOWNLOADDATEPREV DATE DEFAULT('1-JAN-1900'))
AS
V_CURRDATE DATE;
V_PREVDATE DATE;

BEGIN

EXECUTE IMMEDIATE 'alter session enable parallel dml';

  IF V_DOWNLOADDATE = '1-JAN-1900'
  THEN
    SELECT CURRDATE INTO V_CURRDATE FROM IFRS_PRC_DATE;
  ELSE
    V_CURRDATE := v_DOWNLOADDATE;
  END IF;

  IF v_DOWNLOADDATEPREV = '1-JAN-1900'
  THEN
    SELECT PREVDATE INTO V_PREVDATE FROM IFRS_PRC_DATE;
  ELSE
    V_PREVDATE := v_DOWNLOADDATEPREV;
  END IF;



			EXECUTE IMMEDIATE 'TRUNCATE TABLE IFRS_ECL_DKP';

			INSERT /*+ PARALLEL(8) */ INTO IFRS_ECL_DKP
			SELECT /*+ PARALLEL(8) */ A.DOWNLOAD_DATE, B.DATA_SOURCE, A.ECL_MODEL_ID, B.ACCOUNT_NUMBER, B.PRODUCT_CODE, B.CUSTOMER_NUMBER, B.CUSTOMER_NAME,
       B.SUB_SEGMENT, B.BI_COLLECTABILITY, B.CURRENCY, B.EXCHANGE_RATE, A.CR_STAGE, A.BUCKET_GROUP, B.BUCKET_ID, B.OUTSTANDING, A.FAIR_VALUE_AMOUNT,
       ABS(C.UNAMORT_FEE_COST) AS UNAMORT_FEE_COST, A.FL_YEAR, A.INTEREST_ACCRUED, A.CCF_RATE, A.CCF_AMOUNT, A.PREPAYMENT_RATE, A.PREPAYMENT_AMOUNT,
       A.EAD_AMOUNT, A.LIFETIME_PERIOD, A.PD_RATE, A.LGD_RATE, A.DISCOUNT_RATE, B.DAY_PAST_DUE, B.IMPAIRED_FLAG, B.RESERVED_VARCHAR_25, D.ECL_AMOUNT_FINAL, B.RESERVED_AMOUNT_14,B.INTEREST_RATE,B.EIR, A.COUNTER_PAYSCHD, CASE WHEN B.DATA_SOURCE IN ('KTP','RKN') THEN RESERVED_VARCHAR_1 ELSE RESERVED_VARCHAr_15 END SWIFT_CODE
       FROM (SELECT * FROM IFRS_ECL_RESULT_DETAIL_CALC WHERE DOWNLOAD_DATE = V_CURRDATE) A
            JOIN IFRS_ECL_RESULT_DETAIL D
            ON A.MASTERID = D.MASTERID AND A.DOWNLOAD_DATE = D.DOWNLOAD_DATE
            JOIN (SELECT * FROM IFRS_MASTER_ACCOUNT WHERE DOWNLOAD_DATE = V_CURRDATE)B
            ON A.MASTERID = B.MASTERID
            LEFT JOIN (SELECT * FROM IFRS_EAD_RESULT WHERE DOWNLOAD_DATE = V_CURRDATE)C
            ON (A.MASTERID = C.MASTERID AND A.ECL_MODEL_ID = C.ECL_MODEL_ID AND C.COUNTER = A.COUNTER_PAYSCHD)
            ORDER BY A.MASTERID, A.COUNTER_PAYSCHD;COMMIT;
END;