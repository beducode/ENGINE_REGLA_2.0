CREATE OR REPLACE PROCEDURE SP_IFRS_PD_MIG_LOGIT_ODR(V_EFF_DATE DATE)
AS
BEGIN
    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_IFRS_PD_RUNNING_DATE';

    INSERT INTO TMP_IFRS_PD_RUNNING_DATE
    (
        EFF_DATE,
        BASE_DATE,
        PD_RULE_ID,
        BUCKET_GROUP,
        MIG_LOSS_BUCKET
    )
    SELECT
        V_EFF_DATE AS EFF_DATE,
        LAST_DAY(ADD_MONTHS(V_EFF_DATE, A.INCREMENT_PERIOD * -1)) AS BASE_DATE,
        A.PKID AS PD_RULE_ID,
        A.BUCKET_GROUP,
        A.MIG_LOSS_BUCKET
    FROM IFRS_PD_RULES_CONFIG A
    WHERE NVL(A.ACTIVE_FLAG,0) = 1
    AND IS_DELETED = 0
    AND PD_METHOD ='MIG'
    AND A.DERIVED_PD_MODEL IS NULL;

    COMMIT;

    DELETE IFRS_PD_MIG_LOGIT_ODR
    WHERE EFF_DATE = V_EFF_DATE
    AND PD_RULE_ID IN (SELECT PD_RULE_ID FROM TMP_IFRS_PD_RUNNING_DATE);

    COMMIT;

    INSERT INTO IFRS_PD_MIG_LOGIT_ODR
    (
        EFF_DATE,
        BASE_DATE,
        PD_RULE_ID,
        LOGIT_ODR,
        LOGIT_DIFF_ODR
    )
    SELECT A.EFF_DATE,
        A.BASE_DATE,
        A.PD_RULE_ID,
        CASE WHEN A.ODR > 0 THEN LN(A.ODR / (case when (1-A.ODR) = 0 then 1 else (1-A.ODR) end)) ELSE 0 END,
        0
    FROM IFRS_PD_MIG_ODR A
    JOIN TMP_IFRS_PD_RUNNING_DATE B
    ON A.PD_RULE_ID = B.PD_RULE_ID
        AND A.EFF_DATE = V_EFF_DATE;

    COMMIT;

    MERGE INTO IFRS_PD_MIG_LOGIT_ODR A
    USING
    (
        SELECT PD_RULE_ID,
            LOGIT_ODR
        FROM IFRS_PD_MIG_LOGIT_ODR
        WHERE EFF_DATE = ADD_MONTHS(V_EFF_DATE, -12)
    ) B
    ON (A.EFF_DATE = V_EFF_DATE AND A.PD_RULE_ID = B.PD_RULE_ID)
    WHEN MATCHED THEN
    UPDATE SET
    A.LOGIT_DIFF_ODR = A.LOGIT_ODR - B.LOGIT_ODR;

    COMMIT;

END;