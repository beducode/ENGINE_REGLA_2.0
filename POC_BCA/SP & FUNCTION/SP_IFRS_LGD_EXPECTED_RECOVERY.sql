CREATE OR REPLACE PROCEDURE SP_IFRS_LGD_EXPECTED_RECOVERY(V_EFF_DATE DATE)
AS
    V_DATE DATE;
BEGIN
    DELETE FROM IFRS_LGD_EXPECTED_RECOVERY
    WHERE EFF_DATE = V_EFF_DATE;

    COMMIT;

    V_DATE := '31 OCT 2006';

    WHILE V_DATE <= V_EFF_DATE LOOP
        INSERT INTO IFRS_LGD_EXPECTED_RECOVERY
        (
            EFF_DATE,
            DOWNLOAD_DATE,
            LGD_RULE_ID,
            LGD_RULE_NAME,
            SEGMENTATION_ID,
            CALC_METHOD,
            OUTSTANDING_NPL,
            RECOVERY_AMOUNT,
            PV_RECOVERY_AMOUNT,
            RECOVERY_RATE,
            LGD_EXPECTED_RECOVERY
        )
        SELECT V_EFF_DATE EFF_DATE,
              V_DATE DOWNLOAD_DATE,
              B.PKID LGD_RULE_ID,
              B.LGD_RULE_NAME,
              A.SEGMENTATION_ID,
              B.CALC_METHOD,
              SUM(NVL(A.TOTAL_LOSS_AMT,0)) OUTSTANDING_NPL,
              SUM(NVL(A.RECOV_AMT_BF_NPV,0)) RECOVERY_AMOUNT,
              SUM(NVL(A.RECOVERY_AMOUNT,0)) PV_RECOVERY_AMOUNT,
              ROUND(SUM(NVL(A.RECOVERY_AMOUNT,0))/SUM(NVL(A.TOTAL_LOSS_AMT,0)),4) RECOVERY_RATE,
              1-ROUND(SUM(NVL(A.RECOVERY_AMOUNT,0))/SUM(NVL(A.TOTAL_LOSS_AMT,0)),4) LGD_EXPECTED_RECOVERY
        FROM IFRS_LGD A
            LEFT JOIN IFRS_LGD_RULES_CONFIG B ON A.LGD_RULE_ID = B.PKID
        WHERE EFF_DATE = V_EFF_DATE
             AND DOWNLOAD_DATE BETWEEN B.CUT_OFF_DATE AND V_DATE
    --         AND LGD_RULE_ID > 10 --<= 10
        GROUP BY A.SEGMENTATION_ID,
              A.SEGMENTATION_NAME,
              B.PKID,
              B.LGD_RULE_NAME,
              B.CALC_METHOD;COMMIT;
        COMMIT;

        V_DATE := ADD_MONTHS(V_DATE,1);
    END LOOP;
END;