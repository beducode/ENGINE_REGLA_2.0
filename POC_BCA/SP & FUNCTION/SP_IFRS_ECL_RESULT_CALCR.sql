CREATE OR REPLACE PROCEDURE SP_IFRS_ECL_RESULT_CALCR(v_ECLID NUMBER DEFAULT(0), v_DOWNLOADDATE DATE DEFAULT('1-JAN-1900'))
AS
    v_CALCMODE VARCHAR2(50);
    v_INTERPOLATIONNMETHOD   NUMBER(10);
BEGIN

    DELETE FROM IFRS_ECL_RESULT_DETAIL_CALC WHERE ECL_MODEL_ID = v_ECLID AND DOWNLOAD_DATE = v_DOWNLOADDATE;
    COMMIT;
    DELETE FROM IFRS_ECL_RESULT_DETAIL WHERE ECL_MODEL_ID = v_ECLID AND DOWNLOAD_DATE = v_DOWNLOADDATE;
    COMMIT;

    BEGIN
        SELECT COMMONUSAGE INTO v_CALCMODE
        FROM TBLM_COMMONCODEHEADER WHERE COMMONCODE = 'B140';
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
        v_CALCMODE := 'YEAR';
    END;

    BEGIN
        /*CommonUsage : 1 => PD/12, 2 => (1- (1- PD)^n) - (1- (1- PD)^n-1)*/
        SELECT COMMONUSAGE INTO v_INTERPOLATIONNMETHOD
        FROM TBLM_COMMONCODEHEADER WHERE COMMONCODE = 'B141';
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
        v_INTERPOLATIONNMETHOD := 1;
    END;

    SP_IFRS_INSERT_GTMP_FROM_IMA(v_DOWNLOADDATE);

    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_PD_TERM_STRUCTURE';
    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_IFRS_EAD_RESULT';
    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_MASTER_PAYMENT_SETTING';

    INSERT INTO TMP_PD_TERM_STRUCTURE
    SELECT
    TS.EFF_DATE, TS.BASE_DATE, TS.PD_RULE_ID, TS.MODEL_ID, TS.BUCKET_GROUP, TS.BUCKET_ID,
    TS.FL_SEQ, TS.FL_YEAR, TS.FL_DATE, 12 AS FL_MONTH, TS.OVERRIDE_PD AS PD
    FROM IFRS_PD_TERM_STRUCTURE TS
    WHERE TM_TYPE = 'YEAR'
    AND EXISTS
    (
        SELECT 1 FROM IFRS_ECL_MODEL_CONFIG CF
        WHERE TS.PD_RULE_ID = CF.PD_MODEL_ID
        AND CF.ECL_MODEL_ID = v_ECLID AND CF.DOWNLOAD_DATE = v_DOWNLOADDATE AND CF.PD_EFF_DATE = TS.EFF_DATE
        AND TS.MODEL_ID = CASE WHEN CF.PD_FL_FLAG = 1 THEN CF.PD_FL_MODEL ELSE 0  END   --MODEL_ID '0' = TTC PD = NO FORWARD LOOKING
    )
    UNION ALL
    --Duplicate PD for max bucket
    SELECT
    TS.EFF_DATE, TS.BASE_DATE, TS.PD_RULE_ID, TS.MODEL_ID, TS.BUCKET_GROUP, C.BUCKET_ID,
    TS.FL_SEQ, TS.FL_YEAR, TS.FL_DATE, 12 AS FL_MONTH, TS.OVERRIDE_PD AS PD
    FROM IFRS_PD_TERM_STRUCTURE TS
    JOIN VW_IFRS_MAX_BUCKET B
    ON TS.BUCKET_GROUP = B.BUCKET_GROUP
    AND TS.BUCKET_ID = B.MAX_BUCKET_ID
    JOIN
    (
        SELECT A2.BUCKET_GROUP, C2.BUCKET_ID
        FROM
        (
            SELECT BUCKET_GROUP, COUNT(BUCKET_ID) TOTAL_BUCKET_ID
            FROM IFRS_BUCKET_DETAIL
            GROUP BY BUCKET_GROUP
        ) A2
        JOIN VW_IFRS_MAX_BUCKET B2
        ON A2.BUCKET_GROUP = B2.BUCKET_GROUP
        AND A2.TOTAL_BUCKET_ID != B2.MAX_BUCKET_ID
        JOIN IFRS_BUCKET_DETAIL C2
        ON A2.BUCKET_GROUP = C2.BUCKET_GROUP
        AND C2.BUCKET_ID > B2.MAX_BUCKET_ID
        AND C2.BUCKET_NAME != 'BR12'
    ) C
    ON TS.BUCKET_GROUP = C.BUCKET_GROUP
    WHERE TM_TYPE = 'YEAR'
    AND EXISTS
    (
        SELECT 1 FROM IFRS_ECL_MODEL_CONFIG CF
        WHERE TS.PD_RULE_ID = CF.PD_MODEL_ID
        AND CF.ECL_MODEL_ID = v_ECLID AND CF.DOWNLOAD_DATE = v_DOWNLOADDATE AND CF.PD_EFF_DATE = TS.EFF_DATE
        AND TS.MODEL_ID = CASE WHEN CF.PD_FL_FLAG = 1 THEN CF.PD_FL_MODEL ELSE 0  END   --MODEL_ID '0' = TTC PD = NO FORWARD LOOKING
    );

    COMMIT;

        INSERT INTO TMP_MASTER_PAYMENT_SETTING
                    (
                        DOWNLOAD_DATE,
                        MASTERID,
                        ACCOUNT_NUMBER,
                        COMPONENT_TYPE,
                        FREQUENCY,
                        INCREMENTS,
                        AMOUNT,
                        TIMES_ORG,
                        TIMES_USED,
                        DATE_START,
                        DATE_END,
                        PMT_DATE
                    )
                    SELECT DOWNLOAD_DATE,
                        MASTERID,
                        ACCOUNT_NUMBER,
                        COMPONENT_TYPE,
                        FREQUENCY,
                        INCREMENTS,
                        AMOUNT,
                        TIMES_ORG,
                        TIMES_USED,
                        DATE_START,
                        DATE_END,
                        PMT_DATE
                    FROM IFRS_MASTER_PAYMENT_SETTING
                    WHERE COMPONENT_TYPE = 0
                    AND MASTERID <> 0;
                    COMMIT;

    INSERT INTO TMP_IFRS_EAD_RESULT
    (
        DOWNLOAD_DATE,
        MASTERID,
        CURRENCY,
        EXCHANGE_RATE,
        ECL_MODEL_ID,
        CR_STAGE,
        EAD_RULE_ID,
        EAD_SEGMENT,
        CCF_RULE_ID,
        PREPAYMENT_RULE_ID,
        UNUSED_AMOUNT,
        REVOLVING_FLAG,
        MARKET_AMOUNT,
        INTEREST_ACCRUED,
        CCF_RATE,
        CCF_AMOUNT,
        PREPAYMENT_RATE,
        PREPAYMENT_AMOUNT,
        OUTSTANDING,
        UNAMORT_FEE_COST,
        FAIRVALUE,
        PMTDATE,
        EAD_AMOUNT,
        COUNTER,
        MAX_COUNTER,
        SOURCE
    )
    SELECT
        DOWNLOAD_DATE,
        MASTERID,
        CURRENCY,
        EXCHANGE_RATE,
        ECL_MODEL_ID,
        CR_STAGE,
        EAD_RULE_ID,
        EAD_SEGMENT,
        CCF_RULE_ID,
        PREPAYMENT_RULE_ID,
        UNUSED_AMOUNT,
        REVOLVING_FLAG,
        MARKET_AMOUNT,
        INTEREST_ACCRUED,
        CCF_RATE,
        CCF_AMOUNT,
        PREPAYMENT_RATE,
        PREPAYMENT_AMOUNT,
        OUTSTANDING,
        UNAMORT_FEE_COST,
        FAIRVALUE,
        PMTDATE,
        EAD_AMOUNT,
        COUNTER,
        MAX_COUNTER,
        SOURCE
    FROM IFRS_EAD_RESULT
    WHERE DOWNLOAD_DATE = v_DOWNLOADDATE
    AND ECL_MODEL_ID = v_ECLID
    AND MOD(COUNTER,12) = 1;

    COMMIT;


    MERGE INTO TMP_IFRS_EAD_RESULT A
    USING (    SELECT  A.MASTERID,
                    A.DOWNLOAD_DATE,
                    A.DATE_START,
                    B.INCREMENTS
            FROM (
                    SELECT  A.MASTERID,
                            A.DOWNLOAD_DATE,
                            MIN(DATE_START)DATE_sTART
                    FROM (
                            SELECT  MASTERID,
                                    MAX(DOWNLOAD_DATE)DOWNLOAD_DATE
                            FROM TMP_MASTER_PAYMENT_SETTING
                            GROUP BY MASTERID)A
                    JOIN (  SELECT DISTINCT
                            DOWNLOAD_DATE,
                            MASTERID,
                            DATE_START
                    FROM TMP_MASTER_PAYMENT_SETTING
                    ) B
                    ON A.MASTERID = B.MASTERID AND A.DOWNLOAD_DATE = B.DOWNLOAD_DATE
                    GROUP BY A.MASTERID,A.DOWNLOAD_DATE)A
            JOIN (
                    SELECT DISTINCT
                            DOWNLOAD_DATE,
                            MASTERID,
                            DATE_START,
                            INCREMENTS
                    FROM TMP_MASTER_PAYMENT_SETTING
                    ) B
                    ON A.MASTERID = B.MASTERID AND A.DATE_START = B.DATE_sTART AND A.DOWNLOAD_DATE = B.DOWNLOAD_DATE)B
    ON (A.MASTERID = B.MASTERID)
    WHEN MATCHED THEN UPDATE
    SET A.INCREMENTS = B.INCREMENTS;

    /*****************************************************
    CALCULATE ECL AS YEARLY FOR FULL YEAR
    ******************************************************/
    INSERT INTO IFRS_ECL_RESULT_DETAIL_CALC (
        DOWNLOAD_DATE,
        ECL_MODEL_ID,
        MASTERID,
        BUCKET_GROUP,
        BUCKET_ID,
        CR_STAGE,
        LIFETIME_PERIOD,
        FL_YEAR,
        FL_MONTH,
        FL_SEQ,
        PD_RATE,
        LGD_RATE,
        DISCOUNT_RATE,
        COUNTER_PAYSCHD,
        EAD_AMOUNT,
        FAIR_VALUE_AMOUNT,
        INTEREST_ACCRUED,
        UNUSED_AMOUNT,
        PREPAYMENT_RATE,
        PREPAYMENT_AMOUNT,
        CCF_RATE,
        CCF_AMOUNT,
        ECL_AMOUNT
    )

    SELECT
        A.DOWNLOAD_DATE,
        G.ECL_MODEL_ID,
        A.MASTERID,
        B.BUCKET_GROUP,
        B.BUCKET_ID,
        A.CR_STAGE,
        CASE WHEN (A.CR_STAGE = '1' AND (NVL(A.REVOLVING_FLAG,0) = 1 OR A.SEGMENT_RULE_ID = 448)) OR A.DATA_SOURCE = 'LIMIT' THEN
           12
        ELSE
           LEAST(NVL(C.MAX_COUNTER,120), NVL(L.LIFETIME_PERIOD,120))
        END AS LIFETIME_PERIOD,
        B.FL_YEAR,
        B.FL_MONTH,
        B.FL_SEQ,
        CASE WHEN (A.CR_STAGE = '1' AND (NVL(A.REVOLVING_FLAG,0) = 1 OR A.SEGMENT_RULE_ID = 448)) OR A.DATA_SOURCE = 'LIMIT' THEN NVL(B.PD,0)
             WHEN A.CR_STAGE = '3' AND B.FL_YEAR = 1 THEN 1
             WHEN A.CR_STAGE = '3' AND B.FL_YEAR > 1 THEN 0
             WHEN B.FL_YEAR = CEIL( LEAST((NVL(C.MAX_COUNTER,120)/12), (NVL(L.LIFETIME_PERIOD,120)/12)) ) THEN
                NVL(B.PD,0)
                * CASE WHEN MOD(LEAST(NVL(C.MAX_COUNTER,120), NVL(L.LIFETIME_PERIOD,120)),12) = 0 THEN 12
                  ELSE MOD(LEAST(NVL(C.MAX_COUNTER,120), NVL(L.LIFETIME_PERIOD,120)),12) END / 12
            ELSE NVL(B.PD,0)
        END AS PD_RATE,
        D.OVERRIDE_LGD  AS LGD_RATE,
        CASE WHEN B.FL_YEAR = 1 --OR (A.DATA_SOURCE IN ('BTRD', 'RKN'))
             THEN 1
             WHEN A.EIR < 0 THEN (1/POWER(1+NVL((INTEREST_RATE/100), A.INTEREST_RATE)/100, B.FL_YEAR - 1))
             ELSE (1/POWER(1+NVL(A.EIR, A.INTEREST_RATE)/100, B.FL_YEAR - 1)) END AS DISCOUNT_RATE,
        C.COUNTER       AS COUNTER_PAYSCHD,
        C.EAD_AMOUNT,
        C.FAIRVALUE,
        C.INTEREST_ACCRUED,
        C.UNUSED_AMOUNT,
        C.PREPAYMENT_RATE,
        C.PREPAYMENT_AMOUNT,
        C.CCF_RATE,
        C.CCF_AMOUNT,
        C.EAD_AMOUNT * (CASE WHEN B.FL_YEAR = 1 --OR (A.DATA_SOURCE IN ('BTRD', 'RKN'))
                             THEN 1
                             WHEN A.EIR < 0 THEN (1/POWER(1+NVL((INTEREST_RATE/100), A.INTEREST_RATE)/100, B.FL_YEAR - 1))
                             ELSE (1/POWER(1+NVL(A.EIR, A.INTEREST_RATE)/100, B.FL_YEAR - 1)) END)
        * CASE WHEN (A.CR_STAGE = '1' AND (NVL(A.REVOLVING_FLAG,0) = 1 OR A.SEGMENT_RULE_ID = 448)) OR A.DATA_SOURCE = 'LIMIT' THEN NVL(B.PD,0)
               WHEN A.CR_STAGE = '3' AND B.FL_YEAR = 1 THEN 1
               WHEN A.CR_STAGE = '3' AND B.FL_YEAR > 1 THEN 0
               WHEN B.FL_YEAR = CEIL( LEAST((NVL(C.MAX_COUNTER,120)/12), (NVL(L.LIFETIME_PERIOD,120)/12)) ) THEN
                    NVL(B.PD,0)
                    * CASE WHEN MOD(LEAST(NVL(C.MAX_COUNTER,120), NVL(L.LIFETIME_PERIOD,120)),12) = 0 THEN 12
                      ELSE MOD(LEAST(NVL(C.MAX_COUNTER,120), NVL(L.LIFETIME_PERIOD,120)),12) END / 12
               ELSE NVL(B.PD,0)
          END
        * NVL(D.OVERRIDE_LGD,1) AS ECL_AMOUNT
     FROM GTMP_IFRS_MASTER_ACCOUNT A
     INNER JOIN IFRS_ECL_MODEL_CONFIG G
        ON A.DOWNLOAD_DATE = G.DOWNLOAD_DATE
       AND A.SEGMENT_RULE_ID = G.PF_SEGMENT_ID
     LEFT JOIN IFRS_LIFETIME_HEADER L
        ON G.LT_RULE_ID = L.LIFETIME_CONFIG_ID
       AND L.DOWNLOAD_DATE = G.LT_EFF_DATE
     LEFT JOIN
     (
        SELECT DOWNLOAD_DATE, ACCOUNT_NUMBER, NVL(BUCKET_ID,1) BUCKET_ID
        FROM TBLU_SBLC_OVERRIDE A2
        LEFT JOIN IFRS_BUCKET_DETAIL B2
        ON B2.BUCKET_GROUP = 'BR9_1'
        AND A2.RATING = B2.IMPAIRMENT_BUCKET
        WHERE A2.DOWNLOAD_DATE = v_DOWNLOADDATE
     ) E
        ON A.DOWNLOAD_DATE = E.DOWNLOAD_DATE
        AND A.ACCOUNT_NUMBER = E.ACCOUNT_NUMBER
     INNER JOIN TMP_PD_TERM_STRUCTURE B
        ON B.PD_RULE_ID = CASE WHEN NVL(E.BUCKET_ID,0) = 0 AND A.BUCKET_GROUP != 'BR9_1' THEN
                            G.PD_MODEL_ID
                          ELSE
                            23
                          END
       AND B.BUCKET_ID = NVL(E.BUCKET_ID,A.BUCKET_ID)
       AND B.EFF_DATE = G.PD_EFF_DATE --YTA: PERLU DIUPDATE DENGAN LOGIC EFFECTIVE DATE HASIL ECL CONFIG
     INNER JOIN TMP_IFRS_EAD_RESULT C
        ON A.MASTERID = C.MASTERID
       AND A.DOWNLOAD_DATE = C.DOWNLOAD_DATE
       AND C.ECL_MODEL_ID = G.ECL_MODEL_ID
       AND B.FL_YEAR = CEIL(C.COUNTER/12)
       AND B.FL_YEAR <= CASE WHEN A.CR_STAGE = 1 OR A.CR_STAGE IS NULL OR A.DATA_SOURCE = 'LIMIT' THEN 1 ELSE CEIL( LEAST((NVL(C.MAX_COUNTER,120)/12), (NVL(L.LIFETIME_PERIOD,120)/12)) ) END
--           AND MOD(C.COUNTER,12) = 1
     LEFT JOIN IFRS_LGD_TERM_STRUCTURE D
       ON G.LGD_MODEL_ID = D.LGD_RULE_ID
      AND D.EFF_DATE = G.LGD_EFF_DATE   --YTA: PERLU DIUPDATE DENGAN LOGIC EFFECTIVE DATE HASIL ECL CONFIG
      AND B.FL_SEQ = D.FL_SEQ
      AND D.FL_YEAR <= CASE WHEN A.CR_STAGE = 1 OR A.CR_STAGE IS NULL OR A.DATA_SOURCE = 'LIMIT' THEN 1 ELSE CEIL( LEAST((NVL(C.MAX_COUNTER,120)/12), (NVL(L.LIFETIME_PERIOD,120)/12)) ) END
      --AND CASE WHEN G.LGD_FL_FLAG = 1 THEN G.LGD_FL_MODEL ELSE 1 END = CASE WHEN G.LGD_FL_FLAG = 1 THEN D.LGD_RULE_ID ELSE 1 END
      --YTA: SAAT INI BELUM ADA KOLOM MODEL_ID DI TERM STRUCTURE, SEHARUSNYA ADA
     WHERE --A.DOWNLOAD_DATE = v_DOWNLOADDATE AND
      G.ECL_MODEL_ID = v_ECLID
      AND NVL(A.IFRS9_CLASS,' ') != 'FVTPL'
--          AND A.ACCOUNT_STATUS = 'A'
      ;

    COMMIT;

    /*****************************************************
    SUMMARY ECL_AMOUNT IN ACCOUNT LEVEL
    ******************************************************/
    INSERT INTO IFRS_ECL_RESULT_DETAIL(
        DOWNLOAD_DATE,
        ECL_MODEL_ID,
        MASTERID,
        PF_SEGMENT_ID,
        GROUP_SEGMENT,
        SEGMENT,
        SUB_SEGMENT,
        ACCOUNT_NUMBER,
        CUSTOMER_NUMBER,
        CUSTOMER_NAME,
        DATA_SOURCE,
        PRODUCT_GROUP,
        PRODUCT_TYPE,
        PRODUCT_CODE,
        CURRENCY,
        EXCHANGE_RATE,
        EIR,
        INTEREST_RATE,
        OUTSTANDING,
        FAIR_VALUE_AMOUNT,
        INTEREST_ACCRUED,
        UNUSED_AMOUNT,
        BI_COLLECTABILITY,
        DAY_PAST_DUE,
        BUCKET_GROUP,
        BUCKET_ID,
        CR_STAGE,
        IMPAIRED_FLAG,
        LIFETIME_PERIOD,
        PREPAYMENT_AMOUNT,
        CCF_AMOUNT,
        ECL_AMOUNT,
        SPECIAL_REASON
    )
     SELECT
        A.DOWNLOAD_DATE,
        B.ECL_MODEL_ID,
        B.MASTERID,
        A.SEGMENT_RULE_ID AS PF_SEGMENT_ID,
        A.GROUP_SEGMENT,
        A.SEGMENT,
        A.SUB_SEGMENT,
        A.ACCOUNT_NUMBER,
        A.CUSTOMER_NUMBER,
        A.CUSTOMER_NAME,
        A.DATA_SOURCE,
        A.PRODUCT_GROUP,
        A.PRODUCT_TYPE,
        A.PRODUCT_CODE,
        A.CURRENCY,
        A.EXCHANGE_RATE,
        A.EIR,
        A.INTEREST_RATE,
        NVL(A.OUTSTANDING,0)        AS OUTSTANDING,
        NVL(B.FAIR_VALUE_AMOUNT, 0) AS FAIR_VALUE_AMOUNT,
        NVL(A.INTEREST_ACCRUED, 0)  AS INTEREST_ACCRUED,
        B.UNUSED_AMOUNT,
        A.BI_COLLECTABILITY,
        A.DAY_PAST_DUE,
        A.BUCKET_GROUP,
        B.BUCKET_ID,
        B.CR_STAGE,
        'C' AS IMPAIRED_FLAG,
        B.LIFETIME_PERIOD,
        B.PREPAYMENT_AMOUNT,
        B.CCF_AMOUNT,
        CASE WHEN NVL(B.EAD_AMOUNT,0) > 0 AND NVL(B.ECL_AMOUNT,0) > NVL(B.EAD_AMOUNT,0) THEN NVL(B.EAD_AMOUNT,0) ELSE NVL(B.ECL_AMOUNT,0) END AS ECL_AMOUNT,
        ''              AS SPECIAL_REASON
     FROM GTMP_IFRS_MASTER_ACCOUNT A
     JOIN
     (
        SELECT
            DOWNLOAD_DATE, ECL_MODEL_ID, MASTERID, BUCKET_ID, CR_STAGE, LIFETIME_PERIOD, MAX(FAIR_VALUE_AMOUNT) FAIR_VALUE_AMOUNT, UNUSED_AMOUNT,
            SUM(CASE WHEN COUNTER_PAYSCHD = 1 THEN NVL(EAD_AMOUNT,0) ELSE 0 END) AS EAD_AMOUNT,
            SUM(CASE WHEN COUNTER_PAYSCHD = 1 THEN NVL(PREPAYMENT_AMOUNT,0) ELSE 0 END)  AS PREPAYMENT_AMOUNT,
            SUM(CASE WHEN COUNTER_PAYSCHD = 1 THEN NVL(CCF_AMOUNT,0) ELSE 0 END) AS CCF_AMOUNT,
            SUM(NVL(ECL_AMOUNT,0)) AS ECL_AMOUNT
         FROM IFRS_ECL_RESULT_DETAIL_CALC
         WHERE DOWNLOAD_DATE = v_DOWNLOADDATE
           AND ECL_MODEL_ID = v_ECLID
         GROUP BY DOWNLOAD_DATE, ECL_MODEL_ID, MASTERID, BUCKET_ID, CR_STAGE, LIFETIME_PERIOD, UNUSED_AMOUNT
     ) B
      ON A.MASTERID = B.MASTERID;
     --AND A.DOWNLOAD_DATE = v_DOWNLOADDATE;

    COMMIT;

END;