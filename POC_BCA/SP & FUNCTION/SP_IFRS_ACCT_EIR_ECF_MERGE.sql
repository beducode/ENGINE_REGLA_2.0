CREATE OR REPLACE PROCEDURE SP_IFRS_ACCT_EIR_ECF_MERGE
AS
  V_CURRDATE   DATE;
  V_PREVDATE   DATE;
  V_ROUND NUMBER(10);
  V_FUNCROUND NUMBER(10);
BEGIN

    SELECT MAX (CURRDATE) INTO V_CURRDATE FROM IFRS_PRC_DATE_AMORT;
    SELECT MAX (PREVDATE) INTO V_PREVDATE FROM IFRS_PRC_DATE_AMORT;

    INSERT INTO IFRS_AMORT_LOG (DOWNLOAD_DATE ,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'START','SP_IFRS_ACCT_EIR_ECF_MERGE','');

    COMMIT;
    BEGIN
      SELECT CAST(VALUE1 AS NUMBER(10))
           , CAST(VALUE2 AS NUMBER(10))
      INTO V_ROUND, V_FUNCROUND
      FROM TBLM_COMMONCODEDETAIL
      WHERE COMMONCODE = 'SCM003';
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        V_ROUND := 2;
        V_FUNCROUND:=0;
    END;


    EXECUTE IMMEDIATE 'truncate table TMP_NOCF';
    EXECUTE IMMEDIATE 'truncate table TMP_T1';

    COMMIT;

    INSERT /*+ PARALLEL(12) */ INTO TMP_T1 (MASTERID)
    SELECT /*+ PARALLEL(12) */ DISTINCT MASTERID FROM IFRS_ACCT_EIR_ECF_NOCF WHERE DOWNLOAD_DATE = V_CURRDATE;COMMIT;

    --nominate masterid to be merged (only merged when have ecfnocf) 20160518
    INSERT /*+ PARALLEL(12) */ INTO TMP_NOCF (MASTERID, DOWNLOAD_DATE)
    SELECT /*+ PARALLEL(12) */ A.MASTERID, A.DOWNLOAD_DATE
    FROM IFRS_ACCT_EIR_ECF A
    JOIN TMP_T1 B ON A.MASTERID = B.MASTERID
    WHERE A.DOWNLOAD_DATE = V_CURRDATE
    GROUP BY A.MASTERID, A.DOWNLOAD_DATE
    HAVING MIN (A.N_AMORT_AMT) < 0 AND MAX (A.N_AMORT_AMT) > 0; -- amort amt have both values negtv and postv

    COMMIT;

    DELETE /*+ PARALLEL(12) */ FROM IFRS_ACCT_NOCF
    WHERE DOWNLOAD_DATE = V_CURRDATE;

    COMMIT;

    INSERT /*+ PARALLEL(12) */ INTO IFRS_ACCT_NOCF (MASTERID, DOWNLOAD_DATE)
    SELECT /*+ PARALLEL(12) */ MASTERID, DOWNLOAD_DATE FROM TMP_NOCF;

    COMMIT;

    EXECUTE IMMEDIATE 'TRUNCATE TABLE IFRS_ACCT_EIR_ECF_NOCF';

    INSERT /*+ PARALLEL(12) */ INTO TMP_IFRS_ACCT_EIR_ECF_NOCF
    SELECT /*+ PARALLEL(12) */ E.*
    FROM IFRS_ACCT_EIR_ECF_NOCF E
    JOIN TMP_NOCF F ON F.DOWNLOAD_DATE = E.DOWNLOAD_DATE AND F.MASTERID = E.MASTERID;

    COMMIT;

    -- update nocf amort and unamort amt from nocf ecf
    MERGE /*+ PARALLEL(12) */ INTO IFRS_ACCT_EIR_ECF A
    USING TMP_IFRS_ACCT_EIR_ECF_NOCF B
    ON (A.DOWNLOAD_DATE = B.DOWNLOAD_DATE
        AND A.MASTERID = B.MASTERID
        AND A.PMT_DATE = B.PMT_DATE
       )
    WHEN MATCHED THEN
    UPDATE
    SET NOCF_OSPRN = B.N_FAIRVALUE,
        NOCF_OSPRN_PREV = B.N_FAIRVALUE_PREV,
        NOCF_INT_RATE = B.N_EFF_INT_RATE,
        NOCF_PRN_PAYMENT = B.N_INSTALLMENT,
        NOCF_EFF_INT_AMT = B.N_EFF_INT_AMT,
        NOCF_UNAMORT_AMT = B.N_UNAMORT_AMT,
        NOCF_AMORT_AMT = B.N_AMORT_AMT,
        NOCF_UNAMORT_AMT_PREV = B.N_UNAMORT_AMT_PREV   ;

    COMMIT;


    -- update unamort and amort amt merged
    UPDATE /*+ PARALLEL(12) */ IFRS_ACCT_EIR_ECF
    SET N_UNAMORT_AMT = N_UNAMORT_AMT - NVL(NOCF_UNAMORT_AMT,0),
        N_AMORT_AMT = N_AMORT_AMT - NVL(NOCF_AMORT_AMT,0),
        N_UNAMORT_AMT_PREV = N_UNAMORT_AMT_PREV - NVL(NOCF_UNAMORT_AMT_PREV,0)
    WHERE DOWNLOAD_DATE = V_CURRDATE
    AND MASTERID IN (SELECT MASTERID FROM TMP_NOCF);

    COMMIT;

    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_IFRS_ACCT_EIR_ECF';

    INSERT /*+ PARALLEL(12) */ INTO TMP_IFRS_ACCT_EIR_ECF
    (
        DOWNLOAD_DATE,
        MASTERID,
        PMT_DATE,
        FEE_AMT,
        COST_AMT,
        BENEFIT
    )
    SELECT /*+ PARALLEL(12) */ E.DOWNLOAD_DATE,
           E.MASTERID,
           E.PMT_DATE,
           G.FEE_AMT,
           G.COST_AMT,
           COALESCE(G.BENEFIT, 0) AS BENEFIT
    FROM IFRS_ACCT_EIR_ECF E
    JOIN TMP_NOCF F ON F.DOWNLOAD_DATE = E.DOWNLOAD_DATE AND F.MASTERID = E.MASTERID
    JOIN IFRS_ACCT_EIR_CF_ECF G ON G.MASTERID = E.MASTERID;

    COMMIT;

    -- update cf amort unamort
    MERGE /*+ PARALLEL(12) */ INTO IFRS_ACCT_EIR_ECF A
    USING TMP_IFRS_ACCT_EIR_ECF B
    ON (A.DOWNLOAD_DATE = B.DOWNLOAD_DATE
        AND A.MASTERID = B.MASTERID
        AND A.PMT_DATE = B.PMT_DATE
       )
    WHEN MATCHED THEN
    UPDATE
    SET N_FEE_UNAMORT_AMT =N_UNAMORT_AMT * (B.FEE_AMT + CASE WHEN B.BENEFIT < 0 THEN B.BENEFIT ELSE 0 END) / (B.FEE_AMT + B.COST_AMT + B.BENEFIT),
         N_FEE_AMORT_AMT =N_AMORT_AMT * (B.FEE_AMT + CASE WHEN B.BENEFIT < 0 THEN B.BENEFIT ELSE 0 END) / (B.FEE_AMT + B.COST_AMT + B.BENEFIT),
         N_FEE_UNAMORT_AMT_PREV =N_UNAMORT_AMT_PREV * (B.FEE_AMT + CASE WHEN B.BENEFIT < 0 THEN B.BENEFIT ELSE 0 END) / (B.FEE_AMT + B.COST_AMT + B.BENEFIT),
         N_COST_UNAMORT_AMT =N_UNAMORT_AMT * (B.COST_AMT + CASE WHEN B.BENEFIT > 0 THEN B.BENEFIT ELSE 0 END) / (B.FEE_AMT + B.COST_AMT + B.BENEFIT),
         N_COST_AMORT_AMT =N_AMORT_AMT * (B.COST_AMT + CASE WHEN B.BENEFIT > 0 THEN B.BENEFIT ELSE 0 END) / (B.FEE_AMT + B.COST_AMT + B.BENEFIT),
         N_COST_UNAMORT_AMT_PREV =N_UNAMORT_AMT_PREV * (B.COST_AMT + CASE WHEN B.BENEFIT > 0 THEN B.BENEFIT ELSE 0 END) / (B.FEE_AMT + B.COST_AMT + B.BENEFIT) ;

    COMMIT;

   -- update fairvalue amt merged
    UPDATE /*+ PARALLEL(12) */ IFRS_ACCT_EIR_ECF
    SET N_FAIRVALUE_PREV = NOCF_OSPRN_PREV + N_UNAMORT_AMT_PREV ,--N_OSPRN_PREV + n_unamort_amt_prev ,
        N_FAIRVALUE = NOCF_OSPRN + N_UNAMORT_AMT, --N_OSPRN + n_unamort_amt
        N_DAILY_AMORT_COST = ROUND(CASE WHEN I_DAYS2 = 0 THEN 0 ELSE N_COST_AMORT_AMT / CAST(I_DAYS2 AS NUMBER(32, 6))END,V_ROUND),
        N_DAILY_AMORT_FEE = ROUND(CASE WHEN I_DAYS2 = 0 THEN 0 ELSE N_FEE_AMORT_AMT / CAST(I_DAYS2 AS NUMBER(32, 6))END,V_ROUND)
    WHERE DOWNLOAD_DATE = V_CURRDATE
    AND MASTERID IN (SELECT MASTERID FROM TMP_NOCF);
    COMMIT;

    INSERT INTO IFRS_AMORT_LOG (DOWNLOAD_DATE ,DTM,OPS,PROCNAME,REMARK)
    VALUES (V_CURRDATE,SYSTIMESTAMP,'END','SP_IFRS_ACCT_EIR_ECF_MERGE','');

    COMMIT;

END;