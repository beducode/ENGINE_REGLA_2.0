CREATE OR REPLACE PROCEDURE SP_CCF
AS


        V_YEAR1 NUMBER;
        V_YEAR2 NUMBER;

        BEGIN
        FOR LOOP_COUNTER IN 1..6
        LOOP

            SELECT YEAR1 INTO V_YEAR1 FROM TEST_COUNT;
            SELECT YEAR2 INTO V_YEAR2 FROM TEST_COUNT;

INSERT INTO TEST_CCF_DATA
SELECT DISTINCT
  Z.DOWNLOAD_DATE,Z.RESERVED_VARCHAR_3,
  B.ACCOUNT_STATUS,
  B.RESERVED_DATE_3, B."OS[T]", B."OS[T-1]",
  Z."LIMIT [T]", Z."LIMIT [T-1]", Z."RESERVED_AMOUNT_13 [T]",
  Z."RESERVED_AMOUNT_13 [T-1]",Z."RESERVED_AMOUNT_15[T]",Z."RESERVED_AMOUNT_15[T-1]",B.RESERVED_VARCHAR_2
FROM
  (
    SELECT X.DOWNLOAD_DATE, X.CUSTOMER_NUMBER, X.RESERVED_VARCHAR_3, X.INITIAL_OUTSTANDING AS "LIMIT [T]",
      Y.INITIAL_OUTSTANDING AS "LIMIT [T-1]", X.RESERVED_AMOUNT_13 AS "RESERVED_AMOUNT_13 [T]", Y.RESERVED_AMOUNT_13 AS "RESERVED_AMOUNT_13 [T-1]",
      X.RESERVED_AMOUNT_15 AS "RESERVED_AMOUNT_15[T]",Y.RESERVED_AMOUNT_15 AS "RESERVED_AMOUNT_15[T-1]"
      FROM
      (
        SELECT DOWNLOAD_DATE, CUSTOMER_NUMBER, RESERVED_VARCHAR_3, SUM(INITIAL_OUTSTANDING)INITIAL_OUTSTANDING,SUM(RESERVED_AMOUNT_13)RESERVED_AMOUNT_13,
                SUM(RESERVED_AMOUNT_14)RESERVED_AMOUNT_14,SUM(RESERVED_AMOUNT_15)RESERVED_AMOUNT_15
        FROM
        IFRS_MASTER_ACCOUNT
        WHERE EXTRACT(YEAR FROM DOWNLOAD_DATE) = V_YEAR1 AND DATA_SOURCE = 'LIMIT'
        GROUP BY DOWNLOAD_DATE, CUSTOMER_NUMBER, RESERVED_VARCHAR_3
      )X
      JOIN
      (
        SELECT DOWNLOAD_DATE, CUSTOMER_NUMBER, RESERVED_VARCHAR_3, SUM(INITIAL_OUTSTANDING)INITIAL_OUTSTANDING,SUM(RESERVED_AMOUNT_13)RESERVED_AMOUNT_13,
                SUM(RESERVED_AMOUNT_14)RESERVED_AMOUNT_14,SUM(RESERVED_AMOUNT_15)RESERVED_AMOUNT_15
        FROM IFRS_MASTER_ACCOUNT
        WHERE EXTRACT(YEAR FROM DOWNLOAD_DATE) = V_YEAR2 AND DATA_SOURCE = 'LIMIT'
        GROUP BY DOWNLOAD_DATE, CUSTOMER_NUMBER, RESERVED_VARCHAR_3
      )Y
      ON X.RESERVED_VARCHAR_3 = Y.RESERVED_VARCHAR_3
      AND EXTRACT(MONTH FROM X.DOWNLOAD_DATE) = EXTRACT(MONTH FROM Y.DOWNLOAD_DATE)
  )Z
JOIN
(
  SELECT XX.RESERVED_DATE_3, XX.OUTSTANDING AS "OS[T]", XX.ACCOUNT_STATUS, XX.RESERVED_VARCHAR_3, YY.OUTSTANDING AS "OS[T-1]", YY.RESERVED_VARCHAR_2
    FROM
    (
      SELECT DOWNLOAD_DATE, RESERVED_DATE_3, OUTSTANDING, ACCOUNT_STATUS, RESERVED_VARCHAR_3, PRODUCT_CODE, RESERVED_VARCHAR_2
      FROM GTMP_IFRS_MASTER_ACCOUNT
      WHERE RESERVED_VARCHAR_2 = 'M' AND DATA_SOURCE = 'ILS'
      AND
      PRODUCT_CODE IN ('100','200','101','KLK','KTL')
      AND
      (EXTRACT(YEAR FROM RESERVED_DATE_3) = V_YEAR1)
      AND (EXTRACT(YEAR FROM RESERVED_DATE_3) || EXTRACT(MONTH FROM RESERVED_DATE_3)) = (EXTRACT(YEAR FROM DOWNLOAD_DATE) || EXTRACT(MONTH FROM DOWNLOAD_DATE))
      GROUP BY DOWNLOAD_DATE, RESERVED_DATE_3, OUTSTANDING, ACCOUNT_STATUS, RESERVED_VARCHAR_3, PRODUCT_CODE, RESERVED_VARCHAR_2
    )XX
    JOIN
    (
      SELECT DOWNLOAD_DATE, RESERVED_DATE_3, OUTSTANDING, ACCOUNT_STATUS, RESERVED_VARCHAR_3, PRODUCT_CODE, RESERVED_VARCHAR_2
      FROM GTMP_IFRS_MASTER_ACCOUNT
      WHERE RESERVED_VARCHAR_2 = 'M' AND DATA_SOURCE = 'ILS'
      AND
      PRODUCT_CODE IN ('100','200','101','KLK','KTL')
      AND
      (EXTRACT(YEAR FROM DOWNLOAD_DATE) = V_YEAR2)
      GROUP BY DOWNLOAD_DATE, RESERVED_DATE_3, OUTSTANDING, ACCOUNT_STATUS, RESERVED_VARCHAR_3, PRODUCT_CODE, RESERVED_VARCHAR_2
    )YY
    ON XX.RESERVED_VARCHAR_3 = YY.RESERVED_VARCHAR_3
    AND EXTRACT(MONTH FROM XX.RESERVED_DATE_3) = EXTRACT(MONTH FROM YY.DOWNLOAD_DATE)
)B
ON Z.RESERVED_VARCHAR_3 = B.RESERVED_VARCHAR_3
AND EXTRACT(MONTH FROM B.RESERVED_DATE_3) =  EXTRACT(MONTH FROM Z.DOWNLOAD_DATE)
ORDER BY Z.DOWNLOAD_DATE;
COMMIT;

UPDATE TEST_COUNT
SET YEAR1 = YEAR1+1,
    YEAR2 = YEAR2+1;
    COMMIT;
END LOOP;
END;