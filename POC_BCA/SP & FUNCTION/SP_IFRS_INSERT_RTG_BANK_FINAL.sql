CREATE OR REPLACE PROCEDURE SP_IFRS_INSERT_RTG_BANK_FINAL(v_uploadId number)
AS
BEGIN

-------------------RATING VALAS-----------------------------

EXECUTE IMMEDIATE 'TRUNCATE TABLE IFRS_TEMP_RTG_BANK_VL';

INSERT INTO IFRS_TEMP_RTG_BANK_VL
   SELECT *
     FROM (SELECT A.SWIFT_CODE,
                  A.RATING_SOURCE,
                  A.RATING,
                  B.PKID SCORE
             FROM TBLU_RATING_BANK A
                  LEFT JOIN IFRS_MASTER_RATING_BANK B
                     ON A.RATING = B.STANDARD_AND_POORS
            WHERE A.UPLOADID = v_uploadId
                  AND A.RATING_SOURCE IN ('SNP', 'FRS')
           UNION ALL
           SELECT A.SWIFT_CODE,
                  A.RATING_SOURCE,
                  A.RATING,
                  B.PKID SCORE
             FROM TBLU_RATING_BANK A
                  LEFT JOIN IFRS_MASTER_RATING_BANK B ON A.RATING = B.MOODYS
            WHERE A.UPLOADID = v_uploadId
                  AND A.RATING_SOURCE IN ('MOD'))
    WHERE 1 = 1 AND SCORE IS NOT NULL;

COMMIT;

EXECUTE IMMEDIATE 'TRUNCATE TABLE IFRS_TEMP_RTG_BANK_VL_UPD';

INSERT INTO IFRS_TEMP_RTG_BANK_VL_UPD
SELECT Z.*
FROM (
    SELECT A.*, B.PKID HIRARKI
    FROM IFRS_TEMP_RTG_BANK_VL A, IFRS_MASTER_RATING_HIERARCHY B
    WHERE 1 = 1
    AND A.RATING_SOURCE = B.RATING_SOURCE
    AND A.SCORE = (SELECT MAX(B.score) FROM IFRS_TEMP_RTG_BANK_VL B WHERE A.SWIFT_CODE = B.SWIFT_CODE)) Z
WHERE 1 = 1
AND Z.HIRARKI = (SELECT MIN(Y.HIRARKI)
                 FROM (
                    SELECT A.*, B.PKID HIRARKI
                    FROM IFRS_TEMP_RTG_BANK_VL A, IFRS_MASTER_RATING_HIERARCHY B
                    WHERE 1 = 1
                    AND A.RATING_SOURCE = B.RATING_SOURCE
                    AND A.SCORE = (SELECT MAX(B.SCORE) FROM IFRS_TEMP_RTG_BANK_VL B WHERE A.SWIFT_CODE = B.SWIFT_CODE)) Y
                 WHERE 1 = 1
                 AND Z.SWIFT_CODE = Y.SWIFT_CODE);

COMMIT;

MERGE INTO TBLU_RATING_BANK TBLU
USING (
    SELECT A.UPLOADID, A.DOWNLOAD_DATE, A.SWIFT_CODE, A.RATING_SOURCE, B.RATING
    FROM TBLU_RATING_BANK A
    LEFT JOIN IFRS_TEMP_RTG_BANK_VL_UPD B
    ON A.SWIFT_CODE = B.SWIFT_CODE
    WHERE 1 = 1
    AND A.UPLOADID = v_uploadId
    AND A.RATING_SOURCE in ('SNP','MOD','FRS')
    AND NVL(A.RATING_FINAL, ' ') <> NVL(B.RATING, ' ')
) VAL
ON (TBLU.UPLOADID = VAL.UPLOADID
    AND TBLU.DOWNLOAD_DATE = VAL.DOWNLOAD_DATE
    AND TBLU.SWIFT_CODE = VAL.SWIFT_CODE
    AND TBLU.RATING_SOURCE = VAL.RATING_SOURCE)
WHEN MATCHED THEN
    UPDATE SET TBLU.RATING_FINAL = VAL.RATING;

COMMIT;

-------------------RATING IDR-----------------------------

EXECUTE IMMEDIATE 'TRUNCATE TABLE IFRS_TEMP_RTG_BANK_IDR';

INSERT INTO IFRS_TEMP_RTG_BANK_IDR
SELECT *
FROM (
    SELECT A.SWIFT_CODE, A.RATING_SOURCE, A.RATING, B.PKID SCORE
    FROM TBLU_RATING_BANK A
    LEFT JOIN  IFRS_MASTER_RATING_BANK B
    ON A.RATING = B.PEFINDO
    WHERE 1 = 1
    AND A.uploadid = v_uploadId
    AND A.RATING_SOURCE IN ('PEF','FRS_IND'))
 WHERE 1 = 1
 AND SCORE IS NOT NULL;

COMMIT;

EXECUTE IMMEDIATE 'TRUNCATE TABLE IFRS_TEMP_RTG_BANK_IDR_UPD';

INSERT INTO IFRS_TEMP_RTG_BANK_IDR_UPD
SELECT Z.*
FROM (
    SELECT A.*, B.PKID HIRARKI
    FROM IFRS_TEMP_RTG_BANK_IDR A, IFRS_MASTER_RATING_HIERARCHY B
    WHERE 1 = 1
    AND A.RATING_SOURCE = B.RATING_SOURCE
    AND A.score = (SELECT MAX(B.SCORE) FROM IFRS_TEMP_RTG_BANK_IDR B WHERE A.SWIFT_CODE = B.SWIFT_CODE)) Z
WHERE 1 = 1
AND Z.HIRARKI = (SELECT MIN(Y.HIRARKI)
                 FROM (
                    SELECT A.*, B.PKID HIRARKI
                    FROM IFRS_TEMP_RTG_BANK_IDR A, IFRS_MASTER_RATING_HIERARCHY B
                    WHERE 1 = 1
                    AND A.RATING_SOURCE = B.RATING_SOURCE
                    AND A.SCORE = (SELECT MAX(B.SCORE) FROM IFRS_TEMP_RTG_BANK_IDR B WHERE A.SWIFT_CODE = B.SWIFT_CODE)) Y
                 WHERE 1 = 1
                 AND Z.SWIFT_CODE = Y.SWIFT_CODE);

COMMIT;

MERGE INTO TBLU_RATING_BANK TBLU
USING (
    SELECT A.UPLOADID, A.DOWNLOAD_DATE, A.SWIFT_CODE, A.RATING_SOURCE, B.RATING
    FROM TBLU_RATING_BANK A
    LEFT JOIN IFRS_TEMP_RTG_BANK_IDR_UPD B
    ON A.SWIFT_CODE = B.SWIFT_CODE
    WHERE 1 = 1
    AND A.UPLOADID = v_uploadId
    AND A.RATING_SOURCE IN ('PEF','FRS_IND')
    AND NVL(A.RATING_FINAL, ' ') <> NVL(B.RATING, ' ')
) VAL
ON (TBLU.UPLOADID = VAL.UPLOADID
    AND TBLU.DOWNLOAD_DATE = VAL.DOWNLOAD_DATE
    AND TBLU.SWIFT_CODE = VAL.SWIFT_CODE
    AND TBLU.RATING_SOURCE = VAL.RATING_SOURCE)
WHEN MATCHED THEN
    UPDATE SET TBLU.RATING_FINAL = VAL.RATING;

COMMIT;

------------------------ SYNC TO DOC TABLE ------------------------------

MERGE INTO TBLU_DOC_TEMP_DETAIL A
USING (SELECT * FROM TBLU_RATING_BANK WHERE UPLOADID = v_uploadId) B
ON (A.UPLOADID = B.UPLOADID
AND A.COLUMN_2 = B.SWIFT_CODE
AND A.COLUMN_5 = B.RATING_SOURCE
AND TO_DATE(A.COLUMN_1, 'YYYYMMDD') = B.DOWNLOAD_DATE)
WHEN MATCHED THEN
    UPDATE SET A.COLUMN_7 = B.RATING_FINAL;

COMMIT;

END;