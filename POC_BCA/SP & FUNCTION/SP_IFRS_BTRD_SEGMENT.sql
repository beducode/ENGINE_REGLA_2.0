CREATE OR REPLACE PROCEDURE SP_IFRS_BTRD_SEGMENT
    AS

    V_CURRDATE DATE;
    V_PREVDATE DATE;

    BEGIN

    SELECT CURRDATE INTO V_CURRDATE FROM TEST_DATE;
    SELECT PREVDATE INTO V_PREVDATE FROM TEST_DATE;

INSERT INTO IFRS_BTRD_SEGMENT
(
PKID,
CUSTOMER_NUMBER
)
SELECT DISTINCT 0,CUSTOMER_NUMBER FROM IFRS_STG_BTRD_IMA
WHERE LAST_DAY(DOWNLOAD_DATE) = V_CURRDATE
AND CUSTOMER_NUMBER NOT IN (SELECT CUSTOMER_NUMBER FROM IFRS_BTRD_SEGMENT);
COMMIT;

MERGE INTO IFRS_BTRD_SEGMENT A
USING (SELECT DISTINCT DOWNLOAD_DATE, CUSTOMER_NUMBER,SEGMENT FROM IFRS_MASTER_ACCOUNT_MONTHLY WHERE DOWNLOAD_dATE = V_CURRDATE AND DATA_SOURCE = 'ILS')B
ON (A.CUSTOMER_NUMBER = B.CUSTOMER_NUMBER)
WHEN MATCHED THEN UPDATE
SET A.SEGMENTASI = B.SEGMENT;COMMIT;

END;