CREATE OR REPLACE PROCEDURE  USPS_R_SCALING_FACTOR_SUMMARY
(
    v_MODEL_ID NUMBER,
    v_MODEL_SEQ NUMBER,
    v_FL_YEAR NUMBER,
    Cur_out OUT SYS_REFCURSOR
)
AS
    v_status NUMBER(10);
BEGIN

    SELECT STATUS
    INTO v_status
    FROM IFRS_FL_MODEL_VAR
    WHERE PKID = v_MODEL_ID;

    IF v_status = 1 THEN
        OPEN Cur_out FOR
        SELECT ROUND(SUM(B.CALC_AMOUNT * E.PIT) / SUM(D.CALC_AMOUNT), 28) AS "PortofolioPD",
            ROUND(SUM(B.CALC_AMOUNT * E.PIT) / SUM(D.CALC_AMOUNT) - F.FITTED_ODR, 28) AS "Target",
            ROUND(G.SCALING_FACTOR, 28) AS "Scaling"
        FROM IFRS_FL_MODEL_VAR A
        JOIN IFRS_PD_MIG_ENR B
        ON A.PKID = v_MODEL_ID
            AND A.DEPENDENT_VAR_VALUE = B.PD_RULE_ID
        JOIN VW_IFRS_MAX_BUCKET C
        ON B.BUCKET_GROUP = C.BUCKET_GROUP
        AND B.BUCKET_FROM < C.MAX_BUCKET_ID
        JOIN IFRS_PD_MIG_ENR D
        ON B.EFF_DATE = D.EFF_DATE
        AND B.PD_RULE_ID = D.PD_RULE_ID
        AND B.BUCKET_FROM = D.BUCKET_FROM
        JOIN R_PD_PIT E
        ON A.PKID = E.MODEL_ID
            AND B.EFF_DATE = E.EFF_DATE
            AND B.PD_RULE_ID = E.PD_RULE_ID
            AND B.BUCKET_FROM = E.BUCKET_ID
            AND E.MODEL_SEQ = v_MODEL_SEQ
            AND E.FL_YEAR = v_FL_YEAR
        JOIN R_FITTED_ODR F
        ON E.MODEl_ID = F.MODEL_ID
        AND E.MODEL_SEQ = F.MODEL_SEQ
        AND E.FL_YEAR = F.FL_YEAR
        JOIN R_SCALING_FACTOR G
        ON E.MODEl_ID = G.MODEL_ID
        AND E.MODEL_SEQ = G.MODEL_SEQ
        AND E.FL_YEAR = G.FL_YEAR
        GROUP BY F.FITTED_ODR,
            G.SCALING_FACTOR;
    ELSE
        OPEN Cur_out FOR
        SELECT ROUND(SUM(B.CALC_AMOUNT * E.PIT) / SUM(D.CALC_AMOUNT), 28) AS "PortofolioPD",
            ROUND(SUM(B.CALC_AMOUNT * E.PIT) / SUM(D.CALC_AMOUNT) - F.FITTED_ODR, 28) AS "Target",
            ROUND(G.SCALING_FACTOR, 28) AS "Scaling"
        FROM IFRS_FL_MODEL_VAR A
        JOIN IFRS_PD_MIG_ENR B
        ON A.PKID = v_MODEL_ID
            AND A.DEPENDENT_VAR_VALUE = B.PD_RULE_ID
        JOIN VW_IFRS_MAX_BUCKET C
        ON B.BUCKET_GROUP = C.BUCKET_GROUP
        AND B.BUCKET_FROM < C.MAX_BUCKET_ID
        JOIN IFRS_PD_MIG_ENR D
        ON B.EFF_DATE = D.EFF_DATE
        AND B.PD_RULE_ID = D.PD_RULE_ID
        AND B.BUCKET_FROM = D.BUCKET_FROM
        JOIN R_PD_PIT_PEN E
        ON A.PKID = E.MODEL_ID
            AND B.EFF_DATE = E.EFF_DATE
            AND B.PD_RULE_ID = E.PD_RULE_ID
            AND B.BUCKET_FROM = E.BUCKET_ID
            AND E.MODEL_SEQ = v_MODEL_SEQ
            AND E.FL_YEAR = v_FL_YEAR
        JOIN R_FITTED_ODR_PEN F
        ON E.MODEl_ID = F.MODEL_ID
        AND E.MODEL_SEQ = F.MODEL_SEQ
        AND E.FL_YEAR = F.FL_YEAR
        JOIN R_SCALING_FACTOR_PEN G
        ON E.MODEl_ID = G.MODEL_ID
        AND E.MODEL_SEQ = G.MODEL_SEQ
        AND E.FL_YEAR = G.FL_YEAR
        GROUP BY F.FITTED_ODR,
            G.SCALING_FACTOR;
    END IF;

END;