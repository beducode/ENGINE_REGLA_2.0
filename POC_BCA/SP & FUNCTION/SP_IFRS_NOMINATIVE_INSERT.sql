CREATE OR REPLACE PROCEDURE SP_IFRS_NOMINATIVE_INSERT
AS
BEGIN

EXECUTE IMMEDIATE 'TRUNCATE TABLE IFRS_NOMINATIVE_ILS';
EXECUTE IMMEDIATE 'TRUNCATE TABLE IFRS_NOMINATIVE_LIMIT';
EXECUTE IMMEDIATE 'TRUNCATE TABLE IFRS_NOMINATIVE_BTRD';
EXECUTE IMMEDIATE 'TRUNCATE TABLE IFRS_NOMINATIVE_KTP';
EXECUTE IMMEDIATE 'TRUNCATE TABLE IFRS_NOMINATIVE_RKN';


INSERT INTO IFRS_NOMINATIVE_BTRD
SELECT REPORT_DATE,
                     SOURCE_TYPE,
                     DATA_SOURCE,
                     BRANCH_CODE,
                     LBU_FORM,
                     NOREK_LBU,
                     FACILITY_NUMBER,
                     ACCOUNT_NUMBER,
                     CUSTOMER_NUMBER,
                     CUSTOMER_NAME,
                     BS_FLAG,
                     BI_CODE,
                     GOL_DEB,
                     PRODUCT_GROUP,
                     PRODUCT_TYPE,
                     PRODUCT_CODE,
                     PRODUCT_DESC,
                     START_DATE,
                     MATURITY_DATE,
                     RATING_CODE,
                     EXTERNAL_RATING,
                     SWIFT_CODE,
                     IMP_RATING,
                     GROUP_SEGMENT,
                     SEGMENT,
                     SUB_SEGMENT,
                     BUCKET_NAME,
                     BI_COLLECTABILITY,
                     STAGE,
                     ASSESSMENT_IMP,
                     IFRS9_CLASS,
                     CURRENCY,
                     EXCHANGE_RATE,
                     CONTRACTUAL_INTEREST_RATE,
                     OUTSTANDING_ON_BS_CCY,
                     OUTSTANDING_ON_BS_LCL,
                     OUTSTANDING_OFF_BS_CCY,
                     OUTSTANDING_OFF_BS_LCL,
                     CARRYING_AMOUNT_CCY,
                     CARRYING_AMOUNT_LCL,
                     INTEREST_RECEIVABLE_CCY   INTEREST_ACCRUED_CCY,
                     INTEREST_RECEIVABLE_LCL   INTEREST_ACCRUED_LCL,
                     PV_EXPECTED_CF_IA_CCY,
                     PV_EXPECTED_CF_IA_LCL,
                     IA_UNWINDING_INTEREST_CCY,
                     IA_UNWINDING_INTEREST_LCL,
                     CCF_RATE,
                     CCF_AMOUNT_CCY,
                     CCF_AMOUNT_LCL,
                     PREPAYMENT_RATE,
                     PREPAYMENT_AMOUNT_CCY,
                     PREPAYMENT_AMOUNT_LCL,
                     EAD_AMOUNT_CCY,
                     EAD_AMOUNT_LCL,
                     ECL_ON_BS_CCY,
                     ECL_ON_BS_LCL,
                     ECL_OFF_BS_CCY,
                     ECL_OFF_BS_LCL,
                     ECL_TOTAL_CCY,
                     ECL_TOTAL_LCL,
                     RESERVED_AMOUNT_2 AS ECL_ON_BS_FINAL_CCY,
                     RESERVED_AMOUNT_3 AS ECL_ON_BS_FINAL_LCL,
                     RESERVED_AMOUNT_4 AS ECL_TOTAL_FINAL_CCY,
                     RESERVED_AMOUNT_5 AS ECL_TOTAL_FINAL_LCL,
                     SPECIAL_REASON
                FROM IFRS_NOMINATIVE A
               WHERE REPORT_DATE = '31-may-2020'
                 AND DATA_SOURCE = 'BTRD'
                 AND ACCOUNT_STATUS = 'A'
                 AND NVL(BI_CODE,' ') <> '0'
                 ;COMMIT;

INSERT INTO IFRS_NOMINATIVE_ILS
SELECT REPORT_DATE,
                     SOURCE_TYPE,
                     DATA_SOURCE,
                     BRANCH_CODE,
                     LBU_FORM,
                     NOREK_LBU,
                     FACILITY_NUMBER,
                     ACCOUNT_NUMBER,
                     CUSTOMER_NUMBER,
                     CUSTOMER_NAME,
                     SECTOR_ECONOMIC,
                     SECTOR_COMMODITY,
                     GOL_DEB,
                     PRODUCT_GROUP,
                     PRODUCT_TYPE,
                     PRODUCT_CODE,
                     PRODUCT_DESC,
                     PRODUCT_CODE_GL,
                     START_DATE,
                     MATURITY_DATE AS LOAN_DUE_DATE,
                     NEXT_PAYMENT_DATE,
                     DAY_PAST_DUE,
                     RATING_CODE,
                     EXTERNAL_RATING,
                     SWIFT_CODE,
                     IMP_RATING,
                     GROUP_SEGMENT,
                     SEGMENT,
                     SUB_SEGMENT,
                     BUCKET_NAME,
                     BI_COLLECTABILITY,
                     STAGE,
                     LIFETIME_PERIOD,
                     ASSESSMENT_IMP,
                     NPL_FLAG,
                     POCI_FLAG,
                     BTB_FLAG,
                     REVOLVING_FLAG,
                     COMMITMENT_FLAG,
                     IFRS9_CLASS,
                     CURRENCY,
                     EXCHANGE_RATE,
                     MARKET_RATE,
                     INTEREST_CALCULATION_CODE,
                     CONTRACTUAL_INTEREST_RATE,
                     EIR,
                     OUTSTANDING_ON_BS_CCY,
                     OUTSTANDING_ON_BS_LCL,
                     OUTSTANDING_OFF_BS_CCY,
                     OUTSTANDING_OFF_BS_LCL,
                     CARRYING_AMOUNT_CCY,
                     CARRYING_AMOUNT_LCL,
                     SALDO_YADIT_CCY,
                     SALDO_YADIT_LCL,
                     INITIAL_FEE_CCY,
                     INITIAL_FEE_LCL,
                     INITIAL_COST_CCY,
                     INITIAL_COST_LCL,
                     AMORT_FEE_CCY,
                     AMORT_FEE_LCL,
                     AMORT_COST_CCY,
                     AMORT_COST_LCL,
                     UNAMORT_FEE_AMT_CCY,
                     UNAMORT_FEE_AMT_LCL,
                     UNAMORT_COST_AMT_CCY,
                     UNAMORT_COST_AMT_LCL,
                     PV_EXPECTED_CF_IA_CCY,
                     PV_EXPECTED_CF_IA_LCL,
                     IA_UNWINDING_INTEREST_CCY,
                     IA_UNWINDING_INTEREST_LCL,
                     CCF_RATE,
                     CCF_AMOUNT_CCY,
                     CCF_AMOUNT_LCL,
                     PREPAYMENT_RATE,
                     PREPAYMENT_AMOUNT_CCY,
                     PREPAYMENT_AMOUNT_LCL,
                     EAD_AMOUNT_CCY,
                     EAD_AMOUNT_LCL,
                     --ECL_COLLECTIVE_CCY,
                     --ECL_COLLECTIVE_LCL,
                     --ECL_INDIVIDUAL_CCY,
                     --ECL_INDIVIDUAL_LCL,
                     --ECL_WORSTCASE_CCY,
                     --ECL_WORTCASE_LCL,
                     ECL_ON_BS_CCY,
                     ECL_ON_BS_LCL,
                     ECL_OFF_BS_CCY,
                     ECL_OFF_BS_LCL,
                     ECL_TOTAL_CCY,
                     ECL_TOTAL_LCL,
                     RESERVED_AMOUNT_2 AS ECL_ON_BS_FINAL_CCY,
                     RESERVED_AMOUNT_3 AS ECL_ON_BS_FINAL_LCL,
                     RESERVED_AMOUNT_4 AS ECL_TOTAL_FINAL_CCY,
                     RESERVED_AMOUNT_5 AS ECL_TOTAL_FINAL_LCL,
                     SPECIAL_REASON,
                     --AVAILABLE_BI_AMT_CCY,
                     --AVAILABLE_BI_AMT_LCL,
                     AMORT_FEE_AMT_ILS_CCY,
                     AMORT_FEE_AMT_ILS_LCL,
                     UNAMORT_FEE_AMT_ILS_CCY,
                     UNAMORT_FEE_AMT_ILS_LCL
                     --,CASE WHEN NVL(reserved_flag_1,0) = 0 THEN 'N' ELSE 'Y' END FLAG_COVID
                     --,RESERVED_VARCHAR_4 AS ORIGINAL_STAGE
                FROM IFRS_NOMINATIVE A
               WHERE DATA_SOURCE = 'ILS'
                 and REPORT_DATE = '31-MAY-2020'
                 and account_status = 'A'
                 --and SEGMENT IN 'KKB AUTOMOBIL'
                 AND NOT EXISTS (SELECT 1 FROM IFRS_NOMINATIVE L
                 WHERE L.REPORT_DATE = A.REPORT_DATE
                 AND L.DATA_SOURCE = 'ILS'  -- MOHON JANGAN DIUBAH
                 AND L.ACCOUNT_STATUS = 'A' -- MOHON JANGAN DIUBAH
                 AND A.DATA_SOURCE = 'LIMIT' -- MOHON JANGAN DIUBAH
                 AND A.ACCOUNT_NUMBER = L.FACILITY_NUMBER)
                 ;COMMIT;

INSERT INTO IFRS_NOMINATIVE_KTP
SELECT REPORT_DATE,
                     SOURCE_TYPE,
                     DATA_SOURCE,
                     BRANCH_CODE,
                     LBU_FORM,
                     NOREK_LBU,
                     ACCOUNT_NUMBER,
                     CUSTOMER_NUMBER,
                     CUSTOMER_NAME,
                     GOL_DEB,
                     PRODUCT_GROUP,
                     PRODUCT_TYPE,
                     PRODUCT_CODE,
                     PRODUCT_DESC,
                     INSTRUMENT,
                     INV_TYPE,
                     SEC_NAME,
                     PORTFOLIO,
                     CONTRACT_ID,
                     START_DATE,
                     MATURITY_DATE,
                     SETTLE_DATE,
                     RATING_CODE,
                     SWIFT_CODE,
                     IMP_RATING,
                     GROUP_SEGMENT,
                     SEGMENT,
                     SUB_SEGMENT,
                     BUCKET_NAME,
                     BI_COLLECTABILITY,
                     STAGE,
                     ASSESSMENT_IMP,
                     IFRS9_CLASS,
                     CURRENCY,
                     EXCHANGE_RATE,
                     CONTRACTUAL_INTEREST_RATE,
                     EIR,
                     COA_BAL,
                     PRINCIPAL_AMOUNT_CCY NOTIONAL_AMOUNT_CCY,
                     PRINCIPAL_AMOUNT_LCL NOTIONAL_AMOUNT_LCL,
                     INTEREST_RECEIVABLE_CCY,
                     INTEREST_RECEIVABLE_LCL,
                     PREMI_DISCOUNT_AMOUNT_CCY,
                     PREMI_DISCOUNT_AMOUNT_LCL,
                     CARRYING_AMOUNT_CCY,
                     CARRYING_AMOUNT_LCL,
                     NVL(MARKET_RATE,
                         0) MARKET_VALUE_CCY,
                     NVL(MARKET_RATE,
                         0) * NVL(EXCHANGE_RATE,
                                  1) MARKET_VALUE_LCL,
                     NVL(UNAMORT_FEE_AMT_CCY,0) AS UNAMORTIZED_DISC_PREMIUM_CCY,
                     NVL(UNAMORT_FEE_AMT_LCL,0) AS UNAMORTIZED_DISC_PREMIUM_LCL,
                     IA_UNWINDING_INTEREST_CCY,
                     IA_UNWINDING_INTEREST_LCL,
                     CCF_RATE,
                     CCF_AMOUNT_CCY,
                     CCF_AMOUNT_LCL,
                     PREPAYMENT_RATE,
                     PREPAYMENT_AMOUNT_CCY,
                     PREPAYMENT_AMOUNT_LCL,
                     EAD_AMOUNT_CCY,
                     EAD_AMOUNT_LCL,
                     ECL_ON_BS_CCY,
                     ECL_ON_BS_LCL,
                     ECL_OFF_BS_CCY,
                     ECL_OFF_BS_LCL,
                     ECL_TOTAL_CCY,
                     ECL_TOTAL_LCL,
                     RESERVED_AMOUNT_2 AS ECL_ON_BS_FINAL_CCY,
                     RESERVED_AMOUNT_3 AS ECL_ON_BS_FINAL_LCL,
                     RESERVED_AMOUNT_4 AS ECL_TOTAL_FINAL_CCY,
                     RESERVED_AMOUNT_5 AS ECL_TOTAL_FINAL_LCL,
                     SPECIAL_REASON
                FROM IFRS_NOMINATIVE A
               WHERE DATA_SOURCE = 'KTP'
                 and account_status = 'A'
                 AND UPPER(PRODUCT_CODE) <> 'BORROWING'
                 AND REPORT_DATE = '31-MAY-2020';
                 COMMIT;

INSERT INTO IFRS_NOMINATIVE_RKN
SELECT REPORT_DATE,
                     SOURCE_TYPE,
                     DATA_SOURCE,
                     BRANCH_CODE,
                     LBU_FORM,
                     NOREK_LBU,
                     ACCOUNT_NUMBER,
                     CUSTOMER_NUMBER,
                     CUSTOMER_NAME,
                     GOL_DEB,
                     PRODUCT_GROUP,
                     PRODUCT_TYPE,
                     PRODUCT_CODE,
                     PRODUCT_DESC,
                     START_DATE,
                     MATURITY_DATE,
                     DAY_PAST_DUE,
                     GROUP_SEGMENT,
                     SEGMENT,
                     SUB_SEGMENT,
                     BUCKET_NAME,
                     BI_COLLECTABILITY,
                     STAGE,
                     ASSESSMENT_IMP,
                     IFRS9_CLASS,
                     CURRENCY,
                     EXCHANGE_RATE,
                     CONTRACTUAL_INTEREST_RATE,
                     OUTSTANDING_PRINCIPAL_CCY,
                     OUTSTANDING_PRINCIPAL_LCL,
                     EAD_AMOUNT_CCY,
                     EAD_AMOUNT_LCL,
                     ECL_TOTAL_CCY,
                     ECL_TOTAL_LCL,
                     RESERVED_AMOUNT_2 AS ECL_ON_BS_FINAL_CCY,
                     RESERVED_AMOUNT_3 AS ECL_ON_BS_FINAL_LCL,
                     RESERVED_AMOUNT_4 AS ECL_TOTAL_FINAL_CCY,
                     RESERVED_AMOUNT_5 AS ECL_TOTAL_FINAL_LCL,
                     SPECIAL_REASON
                FROM IFRS_NOMINATIVE
               WHERE REPORT_DATE = '31-MAY-2020'
                 AND DATA_SOURCE = 'RKN'
                 AND ACCOUNT_STATUS = 'A'
                 AND NVL(OUTSTANDING_PRINCIPAL_CCY,0) >=0;
                 COMMIT;

INSERT INTO IFRS_NOMINATIVE_LIMIT
SELECT REPORT_DATE,
                     SOURCE_TYPE,
                     DATA_SOURCE,
                     BRANCH_CODE,
                     LBU_FORM,
                     NOREK_LBU,
                     FACILITY_NUMBER,
                     ACCOUNT_NUMBER,
                     CUSTOMER_NUMBER,
                     CUSTOMER_NAME,
                     SECTOR_ECONOMIC,
                     SECTOR_COMMODITY,
                     GOL_DEB,
                     PRODUCT_GROUP,
                     PRODUCT_TYPE,
                     PRODUCT_CODE,
                     PRODUCT_DESC,
                     PRODUCT_CODE_GL,
                     START_DATE,
                     MATURITY_DATE AS LOAN_DUE_DATE,
                     NEXT_PAYMENT_DATE,
                     DAY_PAST_DUE,
                     RATING_CODE,
                     EXTERNAL_RATING,
                     SWIFT_CODE,
                     IMP_RATING,
                     GROUP_SEGMENT,
                     SEGMENT,
                     SUB_SEGMENT,
                     BUCKET_NAME,
                     BI_COLLECTABILITY,
                     STAGE,
                     LIFETIME_PERIOD,
                     ASSESSMENT_IMP,
                     NPL_FLAG,
                     POCI_FLAG,
                     BTB_FLAG,
                     REVOLVING_FLAG,
                     COMMITMENT_FLAG,
                     IFRS9_CLASS,
                     CURRENCY,
                     EXCHANGE_RATE,
                     MARKET_RATE,
                     INTEREST_CALCULATION_CODE,
                     CONTRACTUAL_INTEREST_RATE,
                     EIR,
                     OUTSTANDING_ON_BS_CCY,
                     OUTSTANDING_ON_BS_LCL,
                     OUTSTANDING_OFF_BS_CCY,
                     OUTSTANDING_OFF_BS_LCL,
                     CARRYING_AMOUNT_CCY,
                     CARRYING_AMOUNT_LCL,
                     SALDO_YADIT_CCY,
                     SALDO_YADIT_LCL,
                     INITIAL_FEE_CCY,
                     INITIAL_FEE_LCL,
                     INITIAL_COST_CCY,
                     INITIAL_COST_LCL,
                     AMORT_FEE_CCY,
                     AMORT_FEE_LCL,
                     AMORT_COST_CCY,
                     AMORT_COST_LCL,
                     UNAMORT_FEE_AMT_CCY,
                     UNAMORT_FEE_AMT_LCL,
                     UNAMORT_COST_AMT_CCY,
                     UNAMORT_COST_AMT_LCL,
                     PV_EXPECTED_CF_IA_CCY,
                     PV_EXPECTED_CF_IA_LCL,
                     IA_UNWINDING_INTEREST_CCY,
                     IA_UNWINDING_INTEREST_LCL,
                     CCF_RATE,
                     CCF_AMOUNT_CCY,
                     CCF_AMOUNT_LCL,
                     PREPAYMENT_RATE,
                     PREPAYMENT_AMOUNT_CCY,
                     PREPAYMENT_AMOUNT_LCL,
                     EAD_AMOUNT_CCY,
                     EAD_AMOUNT_LCL,
                     --ECL_COLLECTIVE_CCY,
                     --ECL_COLLECTIVE_LCL,
                     --ECL_INDIVIDUAL_CCY,
                     --ECL_INDIVIDUAL_LCL,
                     --ECL_WORSTCASE_CCY,
                     --ECL_WORTCASE_LCL,
                     ECL_ON_BS_CCY,
                     ECL_ON_BS_LCL,
                     ECL_OFF_BS_CCY,
                     ECL_OFF_BS_LCL,
                     ECL_TOTAL_CCY,
                     ECL_TOTAL_LCL,
                     RESERVED_AMOUNT_2 AS ECL_ON_BS_FINAL_CCY,
                     RESERVED_AMOUNT_3 AS ECL_ON_BS_FINAL_LCL,
                     RESERVED_AMOUNT_4 AS ECL_TOTAL_FINAL_CCY,
                     RESERVED_AMOUNT_5 AS ECL_TOTAL_FINAL_LCL,
                     SPECIAL_REASON,
                     --AVAILABLE_BI_AMT_CCY,
                     --AVAILABLE_BI_AMT_LCL,
                     AMORT_FEE_AMT_ILS_CCY,
                     AMORT_FEE_AMT_ILS_LCL,
                     UNAMORT_FEE_AMT_ILS_CCY,
                     UNAMORT_FEE_AMT_ILS_LCL
                     --,CASE WHEN NVL(reserved_flag_1,0) = 0 THEN 'N' ELSE 'Y' END FLAG_COVID
                     --,RESERVED_VARCHAR_4 AS ORIGINAL_STAGE
                FROM IFRS_NOMINATIVE a
               WHERE DATA_SOURCE = 'LIMIT'
                 and REPORT_DATE = '31-MAY-2020'
                 and account_status = 'A'
				 AND NOT EXISTS (SELECT 1 FROM IFRS_NOMINATIVE L
                 WHERE L.REPORT_DATE = A.REPORT_DATE
                 AND L.DATA_SOURCE = 'ILS'  -- MOHON JANGAN DIUBAH
                 AND L.ACCOUNT_STATUS = 'A' -- MOHON JANGAN DIUBAH
                 AND A.DATA_SOURCE = 'LIMIT' -- MOHON JANGAN DIUBAH
                 AND A.ACCOUNT_NUMBER = L.FACILITY_NUMBER);
                 COMMIT;

END;