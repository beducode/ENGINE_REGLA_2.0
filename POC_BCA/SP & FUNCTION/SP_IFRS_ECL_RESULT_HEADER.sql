CREATE OR REPLACE PROCEDURE SP_IFRS_ECL_RESULT_HEADER (v_ECLID NUMBER DEFAULT(0), v_DOWNLOADDATE DATE DEFAULT('1-JAN-1900'))
AS
BEGIN
    MERGE INTO IFRS_ECL_RESULT_DETAIL A
    USING
    (
        SELECT MASTERID,
            SUM (CASE WHEN EAD_AMOUNT > 0 THEN CCF_AMOUNT / EAD_AMOUNT ELSE 0 END * ECL_AMOUNT) ECL_AMOUNT_OFF_BS,
            SUM (ECL_AMOUNT - CASE WHEN EAD_AMOUNT > 0 THEN CCF_AMOUNT / EAD_AMOUNT ELSE 0 END * ECL_AMOUNT) ECL_AMOUNT_ON_BS
        FROM IFRS_ECL_RESULT_DETAIL_CALC
        WHERE DOWNLOAD_DATE = v_DOWNLOADDATE
        AND ECL_MODEL_ID = v_ECLID
        GROUP BY MASTERID
    ) B
    ON (A.DOWNLOAD_DATE = v_DOWNLOADDATE
        AND A.ECL_MODEL_ID = v_ECLID
        AND A.MASTERID = B.MASTERID)
    WHEN MATCHED THEN
    UPDATE SET
    A.ECL_AMOUNT_OFF_BS = B.ECL_AMOUNT_OFF_BS,
    A.ECL_AMOUNT_ON_BS = B.ECL_AMOUNT_ON_BS;

    COMMIT;

    MERGE INTO IFRS_ECL_RESULT_DETAIL A
    USING (SELECT DOWNLOAD_DATE,MASTERID, RESERVED_RATE_7 FROM IFRS_MASTER_ACCOUNT WHERE DOWNLOAD_DATE = V_DOWNLOADDATE AND RESERVED_VARCHAR_26 = 'MUTFUND')B
    ON (A.MASTERID = B.MASTERID AND A.DOWNLOAD_DATE = V_DOWNLOADDATE AND A.DOWNLOAD_DATE = B.DOWNLOAD_DATE AND A.ECL_MODEL_ID = v_ECLID)
    WHEN MATCHED THEN UPDATE
    SET A.ECL_AMOUNT = A.ECL_AMOUNT * NVL(B.RESERVED_RATE_7,100)/100,
        A.ECL_AMOUNT_ON_BS = A.ECL_AMOUNT_ON_BS * NVL(RESERVED_RATE_7,100)/100,
        A.ECL_AMOUNT_OFF_BS = A.ECL_AMOUNT_OFF_BS * NVL(RESERVED_RATE_7,100)/100;COMMIT;


    MERGE INTO IFRS_ECL_RESULT_DETAIL A
    USING (SELECT DOWNLOAD_DATE,MASTERID, RESERVED_RATE_8 FROM IFRS_MASTER_ACCOUNT WHERE DOWNLOAD_DATE = V_DOWNLOADDATE )B
    ON (A.MASTERID = B.MASTERID AND A.DOWNLOAD_DATE = V_DOWNLOADDATE AND A.DOWNLOAD_DATE = B.DOWNLOAD_DATE AND A.ECL_MODEL_ID = v_ECLID)
    WHEN MATCHED THEN UPDATE
    SET A.ECL_AMOUNT = A.ECL_AMOUNT * NVL(B.RESERVED_RATE_8,1),
        A.ECL_AMOUNT_ON_BS = A.ECL_AMOUNT_ON_BS * NVL(RESERVED_RATE_8,1),
        A.ECL_AMOUNT_OFF_BS = A.ECL_AMOUNT_OFF_BS * NVL(RESERVED_RATE_8,1)
    WHERE SPECIAL_REASON IS NULL
       ;
    COMMIT;



    UPDATE /*+ PARALLEL(8) */ IFRS_ECL_RESULT_DETAIL
    SET ECL_AMOUNT_OFF_BS = CASE WHEN ECL_AMOUNT_OFF_BS > ECL_AMOUNT THEN ECL_AMOUNT ELSE ECL_AMOUNT_OFF_BS END,
        ECL_AMOUNT_ON_BS = CASE WHEN ECL_AMOUNT_OFF_BS > ECL_AMOUNT THEN 0 ELSE ECL_AMOUNT_ON_BS END
        WHERE DOWNLOAD_DATE = V_DOWNLOADDATE;
        COMMIT;

    DELETE /*+ PARALLEL(8) */ FROM IFRS_ECL_RESULT_DETAIL WHERE DOWNLOAD_DATE = V_DOWNLOADDATE AND OUTSTANDING < 0;COMMIT;
    DELETE /*+ PARALLEL(8) */ FROM IFRS_ECL_RESULT_HEADER WHERE ECL_MODEL_ID = v_ECLID AND DOWNLOAD_DATE = v_DOWNLOADDATE;
    COMMIT;

    /*****************************************************
    SUMMARY ECL_AMOUNT BY PORTFOLIO-STAGE-BUCKET
    ******************************************************/
    INSERT /*+ PARALLEL(8) */ INTO IFRS_ECL_RESULT_HEADER (
        DOWNLOAD_DATE,
        ECL_MODEL_ID,
        PF_SEGMENT_ID,
        GROUP_SEGMENT,
        SEGMENT,
        SUB_SEGMENT,
        DATA_SOURCE,
        PRODUCT_GROUP,
        PRODUCT_TYPE,
        PRODUCT_CODE,
        BUCKET_GROUP,
        BUCKET_ID,
        CR_STAGE,
        OUTSTANDING,
        PREPAYMENT_AMOUNT,
        CCF_AMOUNT,
        ECL_AMOUNT
    )
    SELECT  /*+ PARALLEL(8) */
        DOWNLOAD_DATE,
        ECL_MODEL_ID,
        PF_SEGMENT_ID,
        GROUP_SEGMENT,
        SEGMENT,
        SUB_SEGMENT,
        DATA_SOURCE,
        PRODUCT_GROUP,
        PRODUCT_TYPE,
        PRODUCT_CODE,
        BUCKET_GROUP,
        BUCKET_ID,
        CR_STAGE,
        SUM(OUTSTANDING * NVL(EXCHANGE_RATE,1))         AS OUTSTANDING,
        SUM(PREPAYMENT_AMOUNT * NVL(EXCHANGE_RATE,1))   AS PREPAYMENT_AMOUNT,
        SUM(CCF_AMOUNT * NVL(EXCHANGE_RATE,1))          AS CCF_AMOUNT,
        SUM(ECL_AMOUNT * NVL(EXCHANGE_RATE,1))          AS ECL_AMOUNT
     FROM IFRS_ECL_RESULT_DETAIL
    WHERE DOWNLOAD_DATE = v_DOWNLOADDATE AND OUTSTANDING >= 0
    AND ECL_MODEL_ID = v_ECLID
    GROUP BY
        DOWNLOAD_DATE,
        ECL_MODEL_ID,
        PF_SEGMENT_ID,
        GROUP_SEGMENT,
        SEGMENT,
        SUB_SEGMENT,
        DATA_SOURCE,
        PRODUCT_GROUP,
        PRODUCT_TYPE,
        PRODUCT_CODE,
        BUCKET_GROUP,
        BUCKET_ID,
        CR_STAGE;

    COMMIT;

END;