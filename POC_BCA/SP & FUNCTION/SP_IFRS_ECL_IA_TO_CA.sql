CREATE OR REPLACE PROCEDURE SP_IFRS_ECL_IA_TO_CA(v_DOWNLOADDATE DATE DEFAULT('1-JAN-1900'))
AS
    V_CURRDATE  DATE;
    V_QUERY VARCHAR2(32000);
    V_STR_SQL_RULE VARCHAR2(32000);
BEGIN
    IF v_DOWNLOADDATE = '1-JAN-1900' THEN
        SELECT CURRDATE INTO V_CURRDATE FROM IFRS_PRC_DATE;
    ELSE
        V_CURRDATE := v_DOWNLOADDATE;
    END IF;

    --Start removing CA customers from IA
    SP_IFRS_GENERATE_RULE('THRESHOLD');

    SELECT PD_RULES_QRY_RESULT
    INTO v_STR_SQL_RULE
    FROM GTMP_IFRS_SCENARIO_GEN_QUERY;

    --Get list of customer number that is changed to CA
    EXECUTE IMMEDIATE 'TRUNCATE TABLE GTMP_IFRS_MASTER_ACCOUNT';

    v_QUERY := 'INSERT INTO GTMP_IFRS_MASTER_ACCOUNT
                (
                    PKID,
                    DOWNLOAD_DATE,
                    MASTERID,
                    MASTER_ACCOUNT_CODE,
                    CUSTOMER_NUMBER,
                    ACCOUNT_NUMBER,
                    IMPAIRED_FLAG
                )
                SELECT DISTINCT A.PKID,
                    A.DOWNLOAD_DATE,
                    A.MASTERID,
                    '' '' MASTER_ACCOUNT_CODE,
                    A.CUSTOMER_NUMBER,
                    A.ACCOUNT_NUMBER,
                    ''C'' AS IMPAIRED_FLAG
                FROM IFRS_MASTER_ACCOUNT A
                JOIN IFRS_IA_OVERRIDEH B
                ON A.DOWNLOAD_DATE = ''' || TO_DATE(V_CURRDATE,'dd MON yyyy') || '''
                AND B.EFFECTIVE_DATE <= A.DOWNLOAD_DATE
                AND A.CUSTOMER_NUMBER = B.CUSTOMER_NUMBER';

    EXECUTE IMMEDIATE v_QUERY;

    COMMIT;

	v_QUERY := 'DELETE GTMP_IFRS_MASTER_ACCOUNT
                WHERE CUSTOMER_NUMBER IN
                (SELECT CUSTOMER_NUMBER FROM IFRS_MASTER_ACCOUNT A
                 WHERE A.DOWNLOAD_DATE = ''' || TO_DATE(V_CURRDATE,'dd MON yyyy') || '''
                 AND A.OUTSTANDING > 0
                 AND A.ACCOUNT_STATUS = ''A''
                 AND (' || v_STR_SQL_RULE || '))';

    EXECUTE IMMEDIATE v_QUERY;

    COMMIT;

    MERGE INTO IFRS_IA_OVERRIDEH_HIST A
    USING
    (
        SELECT DISTINCT A2.PKID FROM IFRS_IA_OVERRIDEH A2
        JOIN GTMP_IFRS_MASTER_ACCOUNT B2
        ON A2.CUSTOMER_NUMBER = B2.CUSTOMER_NUMBER
        AND A2.EFFECTIVE_DATE <= V_CURRDATE
    ) B
    ON (A.PKID = B.PKID)
    WHEN MATCHED THEN
    UPDATE SET
        A.RESERVED_VARCHAR_1 = 'C',
        A.RESERVED_DATE_1 = SYSDATE,
        A.RESERVED_DATE_2 = V_CURRDATE;

    COMMIT;

    DELETE TBLT_PAYMENTEXPECTED
    WHERE OVERRIDEID IN
    (
        SELECT DISTINCT A2.PKID FROM IFRS_IA_OVERRIDEH A2
        JOIN GTMP_IFRS_MASTER_ACCOUNT B2
        ON A2.CUSTOMER_NUMBER = B2.CUSTOMER_NUMBER
        AND A2.EFFECTIVE_DATE <= V_CURRDATE
    );

    COMMIT;

    DELETE TBLT_PAYMENTEXPECTEDH
    WHERE OVERRIDEID IN
    (
        SELECT DISTINCT A2.PKID FROM IFRS_IA_OVERRIDEH A2
        JOIN GTMP_IFRS_MASTER_ACCOUNT B2
        ON A2.CUSTOMER_NUMBER = B2.CUSTOMER_NUMBER
        AND A2.EFFECTIVE_DATE <= V_CURRDATE
    );

    COMMIT;

    DELETE IFRS_IA_OVERRIDED
    WHERE OVERRIDEID IN
    (
        SELECT DISTINCT A2.PKID FROM IFRS_IA_OVERRIDEH A2
        JOIN GTMP_IFRS_MASTER_ACCOUNT B2
        ON A2.CUSTOMER_NUMBER = B2.CUSTOMER_NUMBER
        AND A2.EFFECTIVE_DATE <= V_CURRDATE
    );

    COMMIT;

    DELETE FROM IFRS_IA_OVERRIDEH A
    WHERE CUSTOMER_NUMBER IN
    (SELECT CUSTOMER_NUMBER FROM GTMP_IFRS_MASTER_ACCOUNT)
    AND EFFECTIVE_DATE <= V_CURRDATE;

    COMMIT;

    --End removing CA customers from IA
END;