CREATE OR REPLACE PROCEDURE SP_IFRS_LI_COST_FEE_STATUS
AS
  V_CURRDATE DATE;
  V_PREVDATE DATE;
  V_PARAM_MAT_LEVEL INT;
  V_EXISTS INT;
  V_CX INT;
BEGIN
    V_PARAM_MAT_LEVEL := 0;

    SELECT COMMONUSAGE
    INTO V_PARAM_MAT_LEVEL
	 FROM TBLM_COMMONCODEHEADER
	 WHERE COMMONCODE = 'SCM001';

    SELECT MAX(CURRDATE)
        , MAX(PREVDATE) INTO V_CURRDATE, V_PREVDATE
    FROM IFRS_LI_PRC_DATE_AMORT;

    INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'START','SP_IFRS_LI_COST_FEE_STATUS','');

    COMMIT;

    --RESET
    UPDATE IFRS_LI_ACCT_COST_FEE
    SET STATUS = 'FRZNF'
        ,METHOD = 'X'
    WHERE DOWNLOAD_DATE = V_CURRDATE
        AND STATUS <> 'PARAM';-- TRAN PARAM NOT MATCH

    COMMIT;

    INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_COST_FEE_STATUS','1');

    -- UPDATE FROM CURR DATE
    -- CHECK CURRENCY AND DUE DATE
    MERGE INTO IFRS_LI_ACCT_COST_FEE A
    USING IFRS_LI_IMA_AMORT_CURR B
    ON (B.MASTERID = A.MASTERID
        AND A.DOWNLOAD_DATE = B.DOWNLOAD_DATE
       )
    WHEN MATCHED THEN
    UPDATE
    SET A.STATUS = CASE WHEN A.STATUS = 'PARAM' THEN 'PARAM'
                        WHEN A.CCY != B.CURRENCY THEN 'FRZCCY'
                        WHEN (B.LOAN_DUE_DATE <= A.DOWNLOAD_DATE OR B.ACCOUNT_STATUS IN ('W','C','E','CE','CT','CN')--AND IFRS_LI_ACCT_COST_FEE.METHOD <> 'SL'
                        )
                        THEN 'PNL'
                        ELSE 'ACT'
                        END
        ,A.POS_AMOUNT = CASE WHEN B.OUTSTANDING = 0 THEN 100 ELSE A.AMOUNT / B.OUTSTANDING END
        ,A.MASTERID = B.MASTERID
        ,A.DATASOURCE = B.DATA_SOURCE
        ,A.PRD_TYPE = B.PRODUCT_TYPE
        ,A.PRD_CODE = B.PRODUCT_CODE;


    INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_COST_FEE_STATUS','2');

    COMMIT;

    -- CLOSED WILL GO PNL
    UPDATE IFRS_LI_ACCT_COST_FEE
    SET STATUS = 'PNL'
        ,CREATEDBY = 'CLOSED'
    WHERE DOWNLOAD_DATE = V_CURRDATE
        AND MASTERID IN (
            SELECT DISTINCT MASTERID
            FROM IFRS_LI_ACCT_CLOSED
            WHERE DOWNLOAD_DATE = V_CURRDATE
            )
        AND STATUS <> 'PARAM';

    INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_COST_FEE_STATUS','3');

    -----------------------------INI DI REMARK---------------------------------------------------
    --20171129 UNTUK FEE TURUN DULUAN TAPI PAYMSCHD, BELOM TURUN.
    /*
  SELECT DISTINCT MASTERID INTO #PAYM_COMBINE FROM IFRS_LI_PAYM_SCHD_COMBINE WHERE DOWNLOAD_DATE = @V_CURRDATE

  UPDATE IFRS_LI_ACCT_COST_FEE
  SET STATUS = 'NPRCD'
  WHERE DOWNLOAD_DATE = @V_CURRDATE
  AND
  MASTERID NOT IN (SELECT MASTERID FROM IFRS_LI_IMA_AMORT_CURR)

  UPDATE IFRS_LI_ACCT_COST_FEE
  SET STATUS = 'NPRCD'
  WHERE DOWNLOAD_DATE = @V_CURRDATE
  AND
  MASTERID NOT IN (SELECT DISTINCT MASTERID FROM #PAYM_COMBINE)

    INSERT  INTO IFRS_LI_AMORT_LOG
            ( DOWNLOAD_DATE ,
              DTM ,
              OPS ,
              PROCNAME ,
              REMARK
            )
    VALUES  ( @V_CURRDATE ,
              CURRENT_TIMESTAMP ,
              'DEBUG' ,
              'SP_IFRS_LI_COST_FEE_STATUS' ,
              '4'
            ) ;

*/
    -- MARK AMORT METHOD BASED ON TRANS PARAM
    MERGE INTO IFRS_LI_ACCT_COST_FEE A
    USING (SELECT X.DATA_SOURCE, X.PRD_TYPE, X.PRD_CODE, Y.TRX_CODE, Y.AMORT_TYPE, Y.CCY , V_CURRDATE CURRDATE
          FROM IFRS_LI_PRODUCT_PARAM X
		INNER JOIN IFRS_LI_TRANSACTION_PARAM Y
			ON X.PRD_CODE = Y.PRD_CODE AND X.DATA_SOURCE = Y.DATA_SOURCE
				AND X.PRD_TYPE = Y.PRD_TYPE
				AND (X.CCY = Y.CCY OR X.CCY = 'ALL' OR Y.CCY = 'ALL')
          ) B
    ON (A.DATASOURCE = B.DATA_SOURCE
        AND A.PRD_TYPE = B.PRD_TYPE
        AND A.PRD_CODE = B.PRD_CODE
	AND A.TRX_CODE = B.TRX_CODE
        AND (A.CCY = B.CCY OR B.CCY = 'ALL')
        AND A.DOWNLOAD_DATE = V_CURRDATE
       )
    WHEN MATCHED THEN
    UPDATE
    SET A.METHOD = B.AMORT_TYPE;


    COMMIT;

    -- UPDATE AMORT TYPE FROM IMA LIMIT
    MERGE INTO IFRS_LI_ACCT_COST_FEE A
    USING IFRS_IMA_LIMIT B
    ON (A.FACNO = B.NO_REK_LBU
        AND A.DOWNLOAD_DATE = B.DOWNLOAD_DATE
        AND A.DOWNLOAD_DATE = V_CURRDATE
        AND A.DATASOURCE <> 'ACCEPTANCE'
       )
    WHEN MATCHED THEN
    UPDATE
    SET A.METHOD = CASE WHEN B.REVOLVING_FLAG = 1 THEN 'SL' ELSE 'EIR' END;

    INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_COST_FEE_STATUS','5');

    COMMIT;

    -- EIR WITH ZERO OS WILL GO PNL
    UPDATE IFRS_LI_ACCT_COST_FEE
    SET STATUS = 'PNL'
        ,CREATEDBY = 'EIR_ZERO_OS'
    WHERE STATUS = 'ACT'
        AND METHOD = 'EIR'
        AND DOWNLOAD_DATE = V_CURRDATE
        AND MASTERID IN (
            SELECT MASTERID
            FROM IFRS_LI_IMA_AMORT_CURR
            WHERE COALESCE(OUTSTANDING, 0) <= 0);

    INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_COST_FEE_STATUS','5');

    COMMIT;

    IF (V_PARAM_MAT_LEVEL = 0) THEN
	BEGIN
		-- ABS MATERIALITY FEE BY PRODUCT
	    MERGE INTO IFRS_LI_ACCT_COST_FEE A
		USING
		( SELECT A.ID
		  FROM IFRS_LI_ACCT_COST_FEE A
		  JOIN
			(
		  SELECT X.*
		   , V_CURRDATE CURRDATE
		  FROM IFRS_LI_PRODUCT_PARAM X
		  ) B
		ON (A.DATASOURCE = B.DATA_SOURCE OR B.DATA_SOURCE = 'ALL')
				AND (A.PRD_TYPE = B.PRD_TYPE OR B.PRD_TYPE = 'ALL')
				AND (A.PRD_CODE = B.PRD_CODE OR B.PRD_CODE = 'ALL')
				AND (A.CCY = B.CCY OR B.CCY = 'ALL')
				AND A.DOWNLOAD_DATE = B.CURRDATE
				AND A.FLAG_CF = 'F'
				AND A.STATUS = 'ACT'
				AND B.FEE_MAT_TYPE IN ('','ABS')
				AND ABS(A.AMOUNT) < B.FEE_MAT_AMT
		) B ON (A.ID = B.ID)
		WHEN MATCHED THEN
		UPDATE SET A.CREATEDBY = 'ABS_MAT_FEE'
					,STATUS = 'PNL';

		COMMIT;
	END;
	ELSE
	BEGIN
		-- ABS MATERIALITY FEE BY TRANSACTION
		MERGE INTO IFRS_LI_ACCT_COST_FEE A
		USING
		( SELECT A.ID
		  FROM IFRS_LI_ACCT_COST_FEE A
		        JOIN
			(
			SELECT X.*
				, V_CURRDATE CURRDATE
			FROM IFRS_LI_TRANSACTION_PARAM X
			) B
		ON (A.DATASOURCE = B.DATA_SOURCE OR B.DATA_SOURCE = 'ALL')
				AND (A.PRD_TYPE = B.PRD_TYPE OR B.PRD_TYPE = 'ALL')
				AND (A.PRD_CODE = B.PRD_CODE OR B.PRD_CODE = 'ALL')
				AND (A.TRX_CODE = B.TRX_CODE OR B.TRX_CODE = 'ALL')
				AND (A.CCY = B.CCY OR B.CCY = 'ALL')
				AND A.DOWNLOAD_DATE = B.CURRDATE
				AND A.FLAG_CF = 'F'
				AND A.STATUS = 'ACT'
				AND B.FEE_MAT_TYPE IN ('','ABS')
				AND ABS(A.AMOUNT) < B.FEE_MAT_AMT
		) B ON (A.ID = B.ID)
		WHEN MATCHED THEN
		UPDATE SET A.CREATEDBY = 'ABS_MAT_FEE'
					,STATUS = 'PNL';

		COMMIT;
	END;
	END IF;

    INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_COST_FEE_STATUS','6');

    COMMIT;

    /*
    UPDATE  IFRS_LI_ACCT_COST_FEE
    SET     STATUS = 'PNL'
    WHERE   DOWNLOAD_DATE = @V_CURRDATE
            AND CREATEDBY = 'ABS_MAT_FEE'


    INSERT  INTO IFRS_LI_AMORT_LOG
            ( DOWNLOAD_DATE ,
              DTM ,
              OPS ,
              PROCNAME ,
              REMARK
            )
    VALUES  ( @V_CURRDATE ,
              CURRENT_TIMESTAMP ,
              'DEBUG' ,
              'SP_IFRS_LI_COST_FEE_STATUS' ,
              '7'
            ) ;
*/
    IF (V_PARAM_MAT_LEVEL = 0) THEN
	BEGIN
		-- ABS MATERIALITY COST BY PRODUCT
	    MERGE INTO IFRS_LI_ACCT_COST_FEE A
		USING
		( SELECT A.ID
		  FROM IFRS_LI_ACCT_COST_FEE A
		  JOIN
			(
		  SELECT X.*
		   ,V_CURRDATE CURRDATE
		  FROM IFRS_LI_PRODUCT_PARAM X
		  ) B
		 ON (A.DATASOURCE = B.DATA_SOURCE OR B.DATA_SOURCE = 'ALL')
			AND (A.PRD_TYPE = B.PRD_TYPE OR B.PRD_TYPE = 'ALL')
			AND (A.PRD_CODE = B.PRD_CODE OR B.PRD_CODE = 'ALL')
			AND (A.CCY = B.CCY OR B.CCY = 'ALL')
			AND A.DOWNLOAD_DATE = B.CURRDATE
			AND A.FLAG_CF = 'C'
			AND A.STATUS = 'ACT'
			AND B.COST_MAT_TYPE IN ('','ABS')
			AND ABS(A.AMOUNT) < B.COST_MAT_AMT
		) B ON (A.ID = B.ID)
		WHEN MATCHED THEN
		UPDATE SET A.CREATEDBY = 'ABS_MAT_COST'
					,STATUS = 'PNL';

		COMMIT;
	END;
	ELSE
	BEGIN
		-- ABS MATERIALITY COST BY TRANSACTION
		MERGE INTO IFRS_LI_ACCT_COST_FEE A
		USING
		( SELECT A.ID
		  FROM IFRS_LI_ACCT_COST_FEE A
		        JOIN
			(
			SELECT X.*
				, V_CURRDATE CURRDATE
			FROM IFRS_LI_TRANSACTION_PARAM X
			) B
		ON (A.DATASOURCE = B.DATA_SOURCE OR B.DATA_SOURCE = 'ALL')
				AND (A.PRD_TYPE = B.PRD_TYPE OR B.PRD_TYPE = 'ALL')
				AND (A.PRD_CODE = B.PRD_CODE OR B.PRD_CODE = 'ALL')
				AND (A.TRX_CODE = B.TRX_CODE OR B.TRX_CODE = 'ALL')
				AND (A.CCY = B.CCY OR B.CCY = 'ALL')
				AND A.DOWNLOAD_DATE = B.CURRDATE
				AND A.FLAG_CF = 'C'
				AND A.STATUS = 'ACT'
				AND B.FEE_MAT_TYPE IN ('','ABS')
				AND ABS(A.AMOUNT) < B.COST_MAT_AMT
		) B ON (A.ID = B.ID)
		WHEN MATCHED THEN
		UPDATE SET A.CREATEDBY = 'ABS_MAT_COST'
					,STATUS = 'PNL';

		COMMIT;
	END;
	END IF;

    INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_COST_FEE_STATUS','7');

    COMMIT;

    /*
    UPDATE  IFRS_LI_ACCT_COST_FEE
    SET     STATUS = 'PNL'
    WHERE   EFFDATE = @V_CURRDATE
            AND CREATEDBY = 'ABS_MAT_COST'


    INSERT  INTO IFRS_LI_AMORT_LOG
            ( DOWNLOAD_DATE ,
              DTM ,
              OPS ,
              PROCNAME ,
              REMARK
            )
    VALUES  ( @V_CURRDATE ,
              CURRENT_TIMESTAMP ,
              'DEBUG' ,
              'SP_IFRS_LI_COST_FEE_STATUS' ,
              '9'
            ) ;
*/
    -- PERCENT OF OS FEE
    MERGE INTO IFRS_LI_ACCT_COST_FEE A
    USING (SELECT X.*, V_CURRDATE CURRDATE
          FROM IFRS_LI_PRODUCT_PARAM X
          ) B
    ON (A.DATASOURCE = B.DATA_SOURCE
        AND A.PRD_TYPE = B.PRD_TYPE
        AND A.PRD_CODE = B.PRD_CODE
        AND (A.CCY = B.CCY OR B.CCY = 'ALL')
        AND A.DOWNLOAD_DATE = B.CURRDATE
        AND A.FLAG_CF = 'F'
        AND A.STATUS = 'ACT'
        AND B.FEE_MAT_TYPE = 'POS'
        AND ABS(A.POS_AMOUNT) < B.FEE_MAT_AMT
       )
    WHEN MATCHED THEN
    UPDATE
    SET CREATEDBY = 'POS_MAT_FEE'
        ,STATUS = 'PNL';

    INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_COST_FEE_STATUS','8');

    COMMIT;

    /*
    UPDATE  IFRS_LI_ACCT_COST_FEE
    SET     STATUS = 'PNL'
    WHERE   EFFDATE = @V_CURRDATE
            AND CREATEDBY = 'POS_MAT_FEE'


    INSERT  INTO IFRS_LI_AMORT_LOG
            ( DOWNLOAD_DATE ,
              DTM ,
              OPS ,
              PROCNAME ,
              REMARK
            )
    VALUES  ( @V_CURRDATE ,
              CURRENT_TIMESTAMP ,
              'DEBUG' ,
              'SP_IFRS_LI_COST_FEE_STATUS' ,
              '11'
            ) ;
*/
    -- PERCENT OF OS COST
    MERGE INTO IFRS_LI_ACCT_COST_FEE A
    USING (SELECT X.*, V_CURRDATE CURRDATE
          FROM IFRS_LI_PRODUCT_PARAM X
          ) B
    ON (A.DATASOURCE = B.DATA_SOURCE
        AND A.PRD_TYPE = B.PRD_TYPE
        AND A.PRD_CODE = B.PRD_CODE
        AND (A.CCY = B.CCY OR B.CCY = 'ALL')
        AND A.DOWNLOAD_DATE = B.CURRDATE
        AND A.FLAG_CF = 'C'
        AND A.STATUS = 'ACT'
        AND B.COST_MAT_TYPE = 'POS'
        AND ABS(A.POS_AMOUNT) < B.COST_MAT_AMT
       )
    WHEN MATCHED THEN
    UPDATE
    SET CREATEDBY = 'POS_MAT_COST'
        ,STATUS = 'PNL';

    INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_COST_FEE_STATUS','9');

    COMMIT;

    /*
    UPDATE  IFRS_LI_ACCT_COST_FEE
    SET     STATUS = 'PNL'
    WHERE   EFFDATE = @V_CURRDATE
            AND CREATEDBY = 'POS_MAT_COST'


    INSERT  INTO IFRS_LI_AMORT_LOG
            ( DOWNLOAD_DATE ,
              DTM ,
              OPS ,
              PROCNAME ,
              REMARK
            )
    VALUES  ( @V_CURRDATE ,
              CURRENT_TIMESTAMP ,
              'DEBUG' ,
              'SP_IFRS_LI_COST_FEE_STATUS' ,
              '13'
            ) ;
*/
    /*
--20151012 ICBC CHANGES : UPDATE SL METHOD FROM PMA.REVOLVING_FLAG=Y
    UPDATE  IFRS_LI_ACCT_COST_FEE
    SET     METHOD = 'SL'
    WHERE   DOWNLOAD_DATE = @V_CURRDATE
            AND MASTERID IN ( SELECT    MASTERID
                              FROM      IFRS_LI_IMA_AMORT_CURR
                              WHERE     DOWNLOAD_DATE = @V_CURRDATE
                                        AND REVOLVING_FLAG = 'Y' )


    INSERT  INTO IFRS_LI_AMORT_LOG
            ( DOWNLOAD_DATE ,
              DTM ,
              OPS ,
              PROCNAME ,
              REMARK
            )
    VALUES  ( @V_CURRDATE ,
              CURRENT_TIMESTAMP ,
              'DEBUG' ,
              'SP_IFRS_LI_COST_FEE_STATUS' ,
              '14'
            ) ;
*/
    /* REMARKS DULU 20160524
--20151012 ICBC CHANGES : UPDATE STATUS TO PNL IF ACT SL DONT HAVE PSAK_PAYM_SCHED
    UPDATE  IFRS_LI_ACCT_COST_FEE
    SET     STATUS = 'PNL'
    WHERE   EFFDATE = @V_CURRDATE
            AND STATUS = 'ACT'
            AND METHOD = 'SL'
            AND MASTERID IN (
            SELECT DISTINCT
                    A.MASTERID
            FROM    PSAK_MASTER_ACCOUNT A
                    LEFT JOIN PSAK_PAYM_SCHD B ON B.MASTERID = A.MASTERID
            WHERE   A.DOWNLOAD_DATE = @V_CURRDATE
                    AND A.REVOLVING_FLAG = 'Y'
                    AND B.MASTERID IS NULL )
REMARKS DULU 20160524 */
    /* REMARKS DULU 20160524
--20151202 ICBC CHANGES : UPDATE STATUS TO PNL IF SL ACCOUNT MAX PAYMENT DATE <= CURRDATE
    TRUNCATE TABLE TMP_LI_T1

    INSERT  INTO TMP_LI_T1
            ( MASTERID
            )
            SELECT  MASTERID
            FROM    PSAK_PAYM_SCHD
            GROUP BY MASTERID
            HAVING  MAX(PMTDATE) <= @V_CURRDATE


    UPDATE  IFRS_LI_ACCT_COST_FEE
    SET     STATUS = 'PNL'
    WHERE   EFFDATE = @V_CURRDATE
            AND STATUS = 'ACT'
            AND METHOD = 'SL'
            AND MASTERID IN ( SELECT    MASTERID
                              FROM      TMP_LI_T1 )

REMARKS DULU 20160524 */
    ----CTBC_20180525: ACT BUT DONT HAVE PAYMENT SETTING WILL GO TO FRZPYM
    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_LI_T1';

    INSERT INTO TMP_LI_T1 (MASTERID)
    SELECT MASTERID
    FROM IFRS_LI_MASTER_PAYMENT_SETTING
    WHERE DOWNLOAD_DATE = V_CURRDATE
    GROUP BY MASTERID;

    COMMIT;

    UPDATE IFRS_LI_ACCT_COST_FEE
    SET STATUS = 'FRZPYM'
    WHERE DOWNLOAD_DATE = V_CURRDATE
        AND STATUS = 'ACT'
        AND METHOD = 'EIR'
        AND FLAG_AL = 'A'
        AND MASTERID NOT IN (SELECT MASTERID FROM TMP_LI_T1);

    COMMIT;

    ----CTBC_20180525: ACT WITH METHOD SL BUT LOAN_START_DATE OR LOAN_DUE DATE IS NULL WILL GO TO PNL
    UPDATE IFRS_LI_ACCT_COST_FEE
    SET STATUS = 'PNL'
        ,CREATEDBY = 'SL_START_ENDDT_NULL'
    WHERE DOWNLOAD_DATE = V_CURRDATE
        AND STATUS = 'ACT'
        AND METHOD = 'SL'
        AND FLAG_AL = 'A'
        AND MASTERID IN (SELECT ACCOUNT_NUMBER FROM IFRS_LI_IMA_AMORT_CURR
                         WHERE AMORT_TYPE = 'SL'
                         AND DOWNLOAD_DATE = V_CURRDATE
                         AND (LOAN_START_DATE IS NULL OR LOAN_DUE_DATE IS NULL OR (LOAN_START_DATE > LOAN_DUE_DATE))
                         );

    COMMIT;


    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_LI_T1';

    -- ACT BUT NO METHOD WILL GO TO FRZMTD
    UPDATE IFRS_LI_ACCT_COST_FEE
    SET STATUS = 'FRZMTD'
    WHERE DOWNLOAD_DATE = V_CURRDATE
        AND STATUS = 'ACT'
        AND METHOD NOT IN ('SL','EIR');

    INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_COST_FEE_STATUS','10');

    COMMIT;

    -- CAN NOT PROCESS ACT REVERSE FEE/COST IF NO PREV COST FEE FOR THAT ACCOUNT
    UPDATE IFRS_LI_ACCT_COST_FEE
    SET STATUS = 'FRZREV'
    WHERE ID IN (
            SELECT A.ID
            FROM IFRS_LI_ACCT_COST_FEE A
            LEFT JOIN IFRS_LI_ACCT_COST_FEE B ON B.DOWNLOAD_DATE <= V_CURRDATE
                AND B.FLAG_REVERSE = 'N'
                AND B.AMOUNT = A.AMOUNT
                AND A.MASTERID = B.MASTERID
                -- 20160411 ONLY GET DATA BEFORE PRORATE
                AND B.ID = B.CF_ID
            -- 20160411 STATUS FILTER NOT NEEDED
            -- AND B.STATUS='ACT'
            WHERE A.DOWNLOAD_DATE = V_CURRDATE
                AND A.FLAG_REVERSE = 'Y'
                AND A.STATUS = 'ACT'
                AND B.MASTERID IS NULL
            );

    INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_COST_FEE_STATUS','11');

    COMMIT;

    -- FILL CF ID
    UPDATE IFRS_LI_ACCT_COST_FEE
    SET CF_ID = ID
    WHERE STATUS IN ('ACT','PNL')
        -- 20160411 UPDATE CURRDATE DATA
        AND DOWNLOAD_DATE = V_CURRDATE;

    --DROP TABLE #PAYM_COMBINE

    -- DANIEL SISWANTO 2018 FOR CTBC, UPDATE CF_ID_REV
    -- START : PAIRING TODAY NEW REVERSAL, IF NOT FOUND THEN REJECT FROM PRORATE PROCESSING
    -- INSERT LOG DEBUG
    INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_COST_FEE_STATUS','REVERSAL-PAIRING');

    COMMIT;


    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_LI_REV_PAIR';

    INSERT INTO TMP_LI_REV_PAIR(ID,CF_ID,PAIR_ID)
    SELECT A.ID
        ,A.CF_ID
        ,MIN(B.ID) AS PAIR_ID
    FROM IFRS_LI_ACCT_COST_FEE A
    LEFT JOIN IFRS_LI_ACCT_COST_FEE B ON --B.ACCRU_DATE=@V_CURRDATE AND
        B.FLAG_REVERSE = 'N'
        AND B.CF_ID_REV IS NULL
        AND B.MASTERID = A.MASTERID
        AND B.AMOUNT = A.AMOUNT
        AND B.CCY = A.CCY
        AND B.FLAG_CF = A.FLAG_CF
        AND B.TRX_CODE = A.TRX_CODE
    WHERE A.DOWNLOAD_DATE = V_CURRDATE
        AND A.FLAG_REVERSE = 'Y'
    GROUP BY A.ID
        ,A.CF_ID;

    COMMIT;

    --IF MORE THAN ONE PAIR_ID ON TABLE TMP_LI_REV_PAIR THEN ONLY ALLOW ONE AND REJECT THE OTHERS
    MERGE INTO TMP_LI_REV_PAIR Z
    USING (SELECT PAIR_ID
          ,MIN(ID) AS ALLOWED_ID
          FROM TMP_LI_REV_PAIR
          GROUP BY PAIR_ID
          HAVING COUNT(PAIR_ID) > 1
          ) A
    ON (Z.PAIR_ID = A.PAIR_ID
        AND Z.ID <> A.ALLOWED_ID
       )
    WHEN MATCHED THEN
    UPDATE
    SET Z.PAIR_ID = NULL;

    COMMIT;

    V_CX := 1;

    BEGIN
      SELECT 1 INTO V_EXISTS FROM TMP_LI_REV_PAIR WHERE PAIR_ID IS NULL;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        V_EXISTS :=NULL;
    END;

    --LOOP 5X MAX
    WHILE ( V_CX<=5 AND V_EXISTS=1 )
    LOOP
        -- 2ND PASS PAIRING
        DELETE FROM TMP_LI_REV_PAIR2;

        INSERT INTO TMP_LI_REV_PAIR2 (ID2,CF_ID2,PAIR_ID2)
        SELECT A.ID,A.CF_ID,MIN(B.ID) AS PAIR_ID
        FROM IFRS_LI_ACCT_COST_FEE A
        LEFT JOIN IFRS_LI_ACCT_COST_FEE B ON B.FLAG_REVERSE = 'N'
            AND B.CF_ID_REV IS NULL
            AND B.MASTERID = A.MASTERID
            AND B.AMOUNT = A.AMOUNT
            AND B.CCY = A.CCY
            AND B.FLAG_CF = A.FLAG_CF
            AND B.TRX_CODE = A.TRX_CODE
            AND B.ID NOT IN (SELECT PAIR_ID FROM TMP_LI_REV_PAIR WHERE PAIR_ID IS NOT NULL)
        WHERE A.DOWNLOAD_DATE = V_CURRDATE
            AND A.FLAG_REVERSE = 'Y'
            AND A.ID IN (SELECT ID FROM TMP_LI_REV_PAIR WHERE PAIR_ID IS NULL)
        GROUP BY A.ID
            ,A.CF_ID;

        --20180305 2ND PASS : IF MORE THAN ONE PAIR_ID ON TABLE TMP_LI_REV_PAIR THEN ONLY ALLOW ONE AND REJECT THE OTHERS
        MERGE INTO TMP_LI_REV_PAIR2 Z
        USING (
            SELECT PAIR_ID2 AS PAIR_ID
                ,MIN(ID2) AS ALLOWED_ID
            FROM TMP_LI_REV_PAIR2
            GROUP BY PAIR_ID2
            HAVING COUNT(PAIR_ID2) > 1
            ) A
        ON (Z.PAIR_ID2 = A.PAIR_ID
            AND Z.ID2 <> A.ALLOWED_ID
           )
        WHEN MATCHED THEN
        UPDATE
        SET PAIR_ID2 = NULL;


        --20180305 2ND PASS UPDATE BACK TO TMP_LI_REV_PAIR
        MERGE INTO TMP_LI_REV_PAIR A
        USING TMP_LI_REV_PAIR2 B
        ON (B.ID2=A.ID
            AND B.PAIR_ID2 IS NOT NULL
           )
        WHEN MATCHED THEN
        UPDATE
        SET A.PAIR_ID=B.PAIR_ID2;

        --INC CX
        V_CX := V_CX + 1;
    END LOOP;

    COMMIT;

    -- IF PAIR_ID IS NULL THEN PAIR NOT FOUND THEN REJECT : MARK ON COST_FEE TABLE AS FRZ AND DELETE FROM FAC_CF

    MERGE INTO IFRS_LI_ACCT_COST_FEE A
    USING TMP_LI_REV_PAIR B
    ON (B.CF_ID=A.CF_ID
        AND A.DOWNLOAD_DATE=V_CURRDATE
        AND B.PAIR_ID IS NULL
       )
    WHEN MATCHED THEN UPDATE
    SET A.STATUS='FRZREVPRO';
    COMMIT;


    DELETE FROM TMP_LI_REV_PAIR WHERE PAIR_ID IS NULL;

    COMMIT;

    --update cf_id_rev of pair_id
    MERGE INTO  IFRS_LI_ACCT_COST_FEE A
    USING TMP_LI_REV_PAIR B
    ON (B.CF_ID=A.CF_ID
        AND A.DOWNLOAD_DATE=V_CURRDATE
       )
    WHEN MATCHED THEN
    UPDATE
    SET A.CF_ID_REV =B.PAIR_ID;
    COMMIT;


    --END   : PAIRING TODAY NEW REVERSAL
    INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE,SYSTIMESTAMP,'END','SP_IFRS_LI_COST_FEE_STATUS','');

    COMMIT;
END;