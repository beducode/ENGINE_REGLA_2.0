CREATE OR REPLACE PROCEDURE SP_IFRS_LI_INITIAL_UPDATE
AS
    V_CURRDATE DATE;
    V_PREVDATE DATE;


BEGIN
    SELECT MAX(CURRDATE)
         , MAX(PREVDATE)
     INTO V_CURRDATE, V_PREVDATE
     FROM IFRS_LI_PRC_DATE_AMORT;

     INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM ,OPS,PROCNAME,REMARK)
     VALUES (V_CURRDATE,SYSTIMESTAMP,'START','SP_IFRS_LI_INITIAL_UPDATE','');

     COMMIT;

     INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM ,OPS,PROCNAME,REMARK)
     VALUES (V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_INITIAL_UPDATE','UPDATE IMP FIELD FROM PREVDATE');


     MERGE INTO IFRS_LI_MASTER_ACCOUNT A
     USING  (
             SELECT MASTERID AS MASTERID
                 ,PRODUCT_GROUP
                 ,ECL_AMOUNT
                 ,CA_UNWINDING_AMOUNT
                 ,IA_UNWINDING_AMOUNT
                 ,BEGINNING_BALANCE
                 ,CHARGE_AMOUNT
                 ,WRITEBACK_AMOUNT
                 ,ENDING_BALANCE
                 ,IS_IMPAIRED
                 ,STAFF_LOAN_FLAG
                 ,IMPAIRED_FLAG
                 ,INITIAL_UNAMORT_ORG_FEE
                 ,INITIAL_UNAMORT_TXN_COST
                 ,UNAMORT_FEE_AMT
                 ,UNAMORT_COST_AMT
                 ,FIRST_INSTALLMENT_DATE
                /*    BCA DISABLE BPI    ,SPECIAL_FLAG    */
                FROM IFRS_LI_MASTER_ACCOUNT
                WHERE DOWNLOAD_DATE = V_PREVDATE
                ) B
     ON (A.MASTERID = B.MASTERID
         AND A.DOWNLOAD_DATE = V_CURRDATE
        )
     WHEN MATCHED THEN
     UPDATE
     SET   A.ECL_AMOUNT = B.ECL_AMOUNT
          ,A.CA_UNWINDING_AMOUNT = B.CA_UNWINDING_AMOUNT
          ,A.IA_UNWINDING_AMOUNT = B.IA_UNWINDING_AMOUNT
          ,A.BEGINNING_BALANCE = B.BEGINNING_BALANCE
          ,A.CHARGE_AMOUNT = B.CHARGE_AMOUNT
          ,A.WRITEBACK_AMOUNT = B.WRITEBACK_AMOUNT
          ,A.ENDING_BALANCE = B.ENDING_BALANCE
          ,A.IS_IMPAIRED = B.IS_IMPAIRED
          ,A.IMPAIRED_FLAG = B.IMPAIRED_FLAG
          ,A.INITIAL_UNAMORT_ORG_FEE = B.INITIAL_UNAMORT_ORG_FEE
          ,A.INITIAL_UNAMORT_TXN_COST = B.INITIAL_UNAMORT_TXN_COST
          ,A.UNAMORT_FEE_AMT = B.UNAMORT_FEE_AMT
          ,A.UNAMORT_COST_AMT = B.UNAMORT_COST_AMT
          ,A.FIRST_INSTALLMENT_DATE = NVL(B.FIRST_INSTALLMENT_DATE, A.NEXT_PAYMENT_DATE);

     COMMIT;

     --INSERT INTO IFRS_LI_AMORT_LOG (
     -- DOWNLOAD_DATE
     -- ,DTM
     -- ,OPS
     -- ,PROCNAME
     -- ,REMARK
     -- )
     --VALUES (
     -- @V_CURRDATE
     -- ,CURRENT_TIMESTAMP
     -- ,'DEBUG'
     -- ,'SP_IFRS_LI_INITIAL_UPDATE'
     -- ,'UPDATE IFRS_LI_DAY_PAST_DUE'
     -- )

     --TRUNCATE TABLE TMP_LI_T1

     --INSERT INTO TMP_LI_T1 (
     -- DOWNLOAD_DATE
     -- ,CIFNO
     -- ,ICC
     -- )
     --SELECT @V_CURRDATE
     -- ,CUSTOMER_NUMBER
     -- ,MAX(DAY_PAST_DUE)
     --FROM IFRS_LI_MASTER_ACCOUNT
     --WHERE DOWNLOAD_DATE = @V_CURRDATE
     --GROUP BY CUSTOMER_NUMBER

     ----UPDATE DAY PAST DUE CIF LEVEL
     --UPDATE IFRS_LI_MASTER_ACCOUNT
     --SET IFRS_DAY_PAST_DUE = B.ICC
     --FROM TMP_LI_T1 B
     --WHERE IFRS_LI_MASTER_ACCOUNT.CUSTOMER_NUMBER = B.CIFNO
     -- --AND IFRS_LI_MASTER_ACCOUNT.DOWNLOAD_DATE = B.DOWNLOAD_DATE
     -- AND IFRS_LI_MASTER_ACCOUNT.DOWNLOAD_DATE = @V_CURRDATE

     INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM ,OPS,PROCNAME,REMARK)
     VALUES (V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_INITIAL_UPDATE','UPDATE LAST AND NEXT PAYMENT DATE');

     EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_LI_T1';

     INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM ,OPS,PROCNAME,REMARK)
     VALUES (V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_INITIAL_UPDATE','UPDATE AMORT TYPE AND PRODUCT NAME');

     COMMIT;


     MERGE INTO IFRS_LI_MASTER_ACCOUNT A
     USING (SELECT X.*,Y.*
            FROM IFRS_LI_PRODUCT_PARAM X
            CROSS JOIN IFRS_LI_PRC_DATE_AMORT Y
            ) B
     ON (A.DATA_SOURCE = B.DATA_SOURCE
        AND A.PRODUCT_TYPE = B.PRD_TYPE
        AND A.PRODUCT_CODE = B.PRD_CODE
        AND (A.CURRENCY = B.CCY OR B.CCY = 'ALL')
        AND A.DOWNLOAD_DATE = V_CURRDATE
        AND A.ACCOUNT_STATUS = 'A'
       )
     WHEN MATCHED THEN
     UPDATE
     SET A.AMORT_TYPE = B.AMORT_TYPE;

     COMMIT;

     --UPDATE AMORT TYPE FROM IMA LIMIT
     MERGE INTO IFRS_LI_MASTER_ACCOUNT A
     USING IFRS_LI_PRODUCT_PARAM B
     ON (A.DATA_SOURCE = B.DATA_SOURCE
        AND A.PRODUCT_TYPE = B.PRD_TYPE
        AND A.PRODUCT_CODE = B.PRD_CODE
        AND A.DOWNLOAD_DATE = V_CURRDATE
        )
     WHEN MATCHED THEN
     UPDATE
     SET  A.AMORT_TYPE = B.AMORT_TYPE;

    COMMIT;

     INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM ,OPS,PROCNAME,REMARK)
     VALUES (V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_INITIAL_UPDATE','EXCHANGE RATE CURR AND PREV');

     /* FRANS 04052018
        ADD STEP TO UPDATE SPPI RESULT INTO IFRS9 CLASS
     */
     INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM ,OPS,PROCNAME,REMARK)
     VALUES (V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_INITIAL_UPDATE','UPDATE IFRS9 CLASS BASED ON SPPI AND BUSINESS MODEL TEST');

     COMMIT;

     /*UPDATE LEVEL PRODUCT GROUP */
	 MERGE INTO IFRS_LI_MASTER_ACCOUNT A
	 USING IFRS_LI_PRODUCT_PARAM B
	 ON (A.PRODUCT_CODE = B.PRD_CODE
	     AND A.PRODUCT_TYPE = B.PRD_TYPE
	     AND A.DATA_SOURCE = B.DATA_SOURCE
	     AND A.DOWNLOAD_DATE = V_CURRDATE
	     )
	 WHEN MATCHED THEN
	 UPDATE SET IFRS9_CLASS = B.LIABILITES_CLASSIFICATION;

	 COMMIT;

     /* FRANS 07052018
    ADD STEP TO RELOAD CURRENCY TABLE
    */
     INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM ,OPS,PROCNAME,REMARK)
     VALUES (V_CURRDATE,SYSTIMESTAMP,'DEBUG','SP_IFRS_LI_INITIAL_UPDATE','RELOAD MASTER CURRENCY TABLE');

     EXECUTE IMMEDIATE  'TRUNCATE TABLE TBLM_CURRENCY';

     INSERT INTO TBLM_CURRENCY (
        CCY
        ,CCY_TYPE
        ,CCY_DESC
        ,CREATEDBY
        ,CREATEDDATE
        )
     SELECT CURRENCY
        ,CURRENCY
        ,COALESCE(CURRENCY_DESC, 'N/A') --CURRENCY_DESC
        ,'SP_IFRS_LI_INITIAL_UPDATE'
        ,SYSTIMESTAMP
     FROM IFRS_MASTER_EXCHANGE_RATE
     WHERE DOWNLOAD_DATE = V_CURRDATE;

     INSERT INTO IFRS_LI_AMORT_LOG (DOWNLOAD_DATE,DTM ,OPS,PROCNAME,REMARK)
     VALUES (V_CURRDATE,SYSTIMESTAMP,'END','SP_IFRS_LI_INITIAL_UPDATE','');

     COMMIT;
    END;