CREATE OR REPLACE PROCEDURE SP_IFRS_ACCOUNT_MATURE IS
  V_CURRDATE DATE;
  V_PREVDATE DATE;
BEGIN

SELECT MAX(CURRDATE),
       LAST_DAY(ADD_MONTHS(MAX(PREVDATE), -1))
--MAX(PREVDATE)
  INTO V_CURRDATE,
       V_PREVDATE
  FROM IFRS_PRC_DATE;

DELETE IFRS_ACCOUNT_MATURE WHERE DOWNLOAD_DATE = V_CURRDATE;

INSERT INTO IFRS_ACCOUNT_MATURE
  (DOWNLOAD_DATE,
   MASTERID,
   ACCOUNT_NUMBER,
   DATA_SOURCE,
   SEGMENT,
   ACCOUNT_STATUS)
  SELECT NVL(CURR.DOWNLOAD_DATE, LAST_DAY(ADD_MONTHS(PREV.DOWNLOAD_DATE, 1))) AS DOWNLOAD_DATE,
         PREV.MASTERID                                                        AS MASTERID,
         PREV.ACCOUNT_NUMBER                                                  AS ACCOUNT_NUMBER,
         NVL(CURR.DATA_SOURCE, PREV.DATA_SOURCE)                              AS DATA_SOURCE,
         NVL(CURR.SEGMENT, PREV.SEGMENT)                                      AS SEGMENT,
         NVL(CURR.ACCOUNT_STATUS, PREV.ACCOUNT_STATUS)                        AS ACCOUNT_STATUS
    FROM IFRS_MASTER_ACCOUNT PREV
    FULL JOIN IFRS_MASTER_ACCOUNT CURR
      ON CURR.DATA_SOURCE = PREV.DATA_SOURCE
     AND CURR.MASTERID = PREV.MASTERID
     AND CURR.DOWNLOAD_DATE = V_CURRDATE
   WHERE PREV.DOWNLOAD_DATE = V_PREVDATE
     AND PREV.ACCOUNT_STATUS = 'A'
     AND NVL(CURR.ACCOUNT_STATUS, 'C') <> 'A';
     AND PREV.DATA_SOURCE = 'ILS'

END;