CREATE OR REPLACE PROCEDURE USPS_BGMODULECONTRACTATTR
(
    V_DDATE_MAID VARCHAR2 DEFAULT ' ',
    Cur_out OUT SYS_REFCURSOR
    --@MASTER_ACCOUNT_ID VARCHAR(100)=''
)
AS
BEGIN

OPEN Cur_out FOR
    SELECT
        --CONVERT(VARCHAR(20),DOWNLOAD_DATE,106) AS DOWNLOAD_DATE,
       NVL(TO_CHAR (IMA.DOWNLOAD_DATE, 'dd-MON-yyyy'), '-') DOWNLOAD_DATE,
       IMA.AMORT_TYPE,
        IMA.PRODUCT_ENTITY ,
        IMA.DATA_SOURCE,
        CUSTOMER_NAME,
        CUSTOMER_NUMBER,
        FACILITY_NUMBER,
        ACCOUNT_NUMBER ,
        --MASTER_ACCOUNT_ID AS DEAL_NUMBER,
        NVL(ACCOUNT_STATUS, '') || ' - ' || TC.DESCRIPTION AS ACCOUNT_STATUS,
        NVL(TO_CHAR (IMA.LOAN_START_DATE, 'dd-MON-yyyy'), '-') LOAN_START_DATE,
            NVL(TO_CHAR (IMA.LOAN_DUE_DATE, 'dd-MON-yyyy'), '-') LOAN_DUE_DATE,
            NVL(TO_CHAR (IMA.NEXT_PAYMENT_DATE, 'dd-MON-yyyy'), '-') NEXT_PAYMENT_DATE,
            NVL(TO_CHAR (IMA.LOAN_START_AMORTIZATION, 'dd-MON-yyyy'), '-') LOAN_START_AMORTIZATION,
            NVL(TO_CHAR (IMA.LOAN_END_AMORTIZATION, 'dd-MON-yyyy'), '-') LOAN_END_AMORTIZATION,
            IMA.BRANCH_CODE,
            B.BRANCH_NAME,
             PRODUCT_GROUP,
             PRODUCT_CODE,
             PRODUCT_TYPE,
             P.PRD_DESC,
             CURRENCY,
             EXCHANGE_RATE,
             IMA.IFRS9_CLASS,
             INTEREST_RATE,
              NVL(PLAFOND,0) AS PLAFOND,
            NVL(PLAFOND_CASH,0) AS PLAFOND_CASH,
            NVL(INITIAL_OUTSTANDING,0) AS INITIAL_OUTSTANDING,
            NVL(OUTSTANDING,0) AS OUTSTANDING,
            NVL(FAIR_VALUE_AMOUNT,0) AS FAIR_VALUE_AMOUNT,
             NVL(EAD_AMOUNT,0) AS EAD_AMOUNT,
            NVL(ECL_AMOUNT,0) AS ECL_AMOUNT,
            IMA.CR_STAGE,
             TENOR,
             REMAINING_TENOR,
               BI_COLLECTABILITY,
               NVL(IMA.RESERVED_VARCHAR_12,'') AS RESERVED_VARCHAR_12,
               NVL(INITIAL_UNAMORT_TXN_COST,0) AS INITIAL_UNAMORT_TXN_COST,
            NVL(INITIAL_UNAMORT_ORG_FEE,0) AS INITIAL_UNAMORT_ORG_FEE,
            NVL(UNAMORT_COST_AMT,0) AS UNAMORT_COST_AMT,
            NVL(UNAMORT_FEE_AMT,0) AS UNAMORT_FEE_AMT,
            NVL(IMA.RESERVED_VARCHAR_2,'') || ' - ' || TC1.DESCRIPTION  as RESERVED_VARCHAR_2,
             INTEREST_ACCRUED
   FROM IFRS_MASTER_ACCOUNT IMA
   LEFT JOIN IFRS_MASTER_PRODUCT_PARAM P ON IMA.PRODUCT_CODE=P.PRD_CODE
   LEFT JOIN IFRS_MASTER_BRANCH B  ON IMA.BRANCH_CODE = B.BRANCH_NUM  AND IMA.DOWNLOAD_DATE = B.DOWNLOAD_DATE
   LEFT JOIN (SELECT * FROM TBLM_COMMONCODEDETAIL WHERE COMMONCODE = 'B95')TC ON TC.VALUE1 = IMA.ACCOUNT_STATUS
   LEFT JOIN (SELECT * FROM TBLM_COMMONCODEDETAIL WHERE COMMONCODE = 'B202')TC1 ON TC1.VALUE1 = IMA.RESERVED_VARCHAR_2
    WHERE
     IMA.MASTERID = SUBSTR(V_DDATE_MAID,11,INSTR(V_DDATE_MAID,'*',1)-11)
    --IMA.MASTERID = SUBSTR(V_DDATE_MAID, 11, LENGTH(RTRIM(V_DDATE_MAID)))
        AND IMA.DOWNLOAD_DATE = TO_DATE(SUBSTR(V_DDATE_MAID, 1, 10),'yyyy/MM/dd');
END;