CREATE OR REPLACE PROCEDURE SP_IFRS_ECL_RESULT_HEADER_PR (v_ECLID NUMBER DEFAULT(0), v_DOWNLOADDATE DATE DEFAULT('1-JAN-1900'))
AS
BEGIN
    MERGE INTO IFRS_ECL_RESULT_DETAIL_PR A
    USING
    (
        SELECT MASTERID,
            SUM (CASE WHEN EAD_AMOUNT > 0 THEN CCF_AMOUNT / EAD_AMOUNT ELSE 0 END * ECL_AMOUNT) ECL_AMOUNT_OFF_BS,
            SUM (ECL_AMOUNT - CASE WHEN EAD_AMOUNT > 0 THEN CCF_AMOUNT / EAD_AMOUNT ELSE 0 END * ECL_AMOUNT) ECL_AMOUNT_ON_BS
        FROM IFRS_ECL_RESULT_DETAIL_CALC_PR
        WHERE DOWNLOAD_DATE = v_DOWNLOADDATE
        AND ECL_MODEL_ID = v_ECLID
        GROUP BY MASTERID
    ) B
    ON (A.DOWNLOAD_DATE = v_DOWNLOADDATE
        AND A.ECL_MODEL_ID = v_ECLID
        AND A.MASTERID = B.MASTERID)
    WHEN MATCHED THEN
    UPDATE SET
    A.ECL_AMOUNT_OFF_BS = B.ECL_AMOUNT_OFF_BS,
    A.ECL_AMOUNT_ON_BS = B.ECL_AMOUNT_ON_BS;

    COMMIT;

    MERGE INTO IFRS_ECL_RESULT_DETAIL_PR A
    USING (SELECT DOWNLOAD_DATE,MASTERID, RESERVED_RATE_7 FROM TMP_IMA_PARTIAL WHERE DOWNLOAD_DATE = V_DOWNLOADDATE AND RESERVED_VARCHAR_26 = 'MUTFUND')B
    ON (A.MASTERID = B.MASTERID AND A.DOWNLOAD_DATE = V_DOWNLOADDATE AND A.DOWNLOAD_DATE = B.DOWNLOAD_DATE)
    WHEN MATCHED THEN UPDATE
    SET A.ECL_AMOUNT = A.ECL_AMOUNT * NVL(B.RESERVED_RATE_7,100)/100,
        A.ECL_AMOUNT_ON_BS = A.ECL_AMOUNT_ON_BS * NVL(RESERVED_RATE_7,100)/100,
        A.ECL_AMOUNT_OFF_BS = A.ECL_AMOUNT_OFF_BS * NVL(RESERVED_RATE_7,100)/100;COMMIT;

    MERGE INTO IFRS_ECL_RESULT_DETAIL_PR A
    USING (SELECT DOWNLOAD_DATE,MASTERID, RESERVED_RATE_8 FROM TMP_IMA_PARTIAL WHERE DOWNLOAD_DATE = V_DOWNLOADDATE )B
    ON (A.MASTERID = B.MASTERID AND A.DOWNLOAD_DATE = V_DOWNLOADDATE AND A.DOWNLOAD_DATE = B.DOWNLOAD_DATE)
    WHEN MATCHED THEN UPDATE
    SET A.ECL_AMOUNT = A.ECL_AMOUNT * NVL(B.RESERVED_RATE_8,1),
        A.ECL_AMOUNT_ON_BS = A.ECL_AMOUNT_ON_BS * NVL(RESERVED_RATE_8,1),
        A.ECL_AMOUNT_OFF_BS = A.ECL_AMOUNT_OFF_BS * NVL(RESERVED_RATE_8,1)
    WHERE SPECIAL_REASON IS NULL;COMMIT;

    UPDATE IFRS_ECL_RESULT_DETAIL_PR
    SET ECL_AMOUNT_OFF_BS = CASE WHEN ECL_AMOUNT_OFF_BS > ECL_AMOUNT THEN ECL_AMOUNT ELSE ECL_AMOUNT_OFF_BS END,
        ECL_AMOUNT_ON_BS = CASE WHEN ECL_AMOUNT_OFF_BS > ECL_AMOUNT THEN 0 ELSE ECL_AMOUNT_ON_BS END
        WHERE DOWNLOAD_DATE = V_DOWNLOADDATE;
        COMMIT;

    DELETE FROM IFRS_ECL_RESULT_DETAIL_PR WHERE DOWNLOAD_DATE = V_DOWNLOADDATE AND OUTSTANDING < 0;COMMIT;

    ------------------ MERGE PARTIAL RUN TO PROD TABLE
    DELETE IFRS_ECL_RESULT_DETAIL_CALC
    WHERE DOWNLOAD_DATE = V_DOWNLOADDATE
    AND MASTERID IN (SELECT MASTERID FROM TMP_IMA_PARTIAL);
    COMMIT;

	INSERT INTO IFRS_ECL_RESULT_DETAIL_CALC
	(
		PKID,
        DOWNLOAD_DATE,
        ECL_MODEL_ID,
        MASTERID,
        BUCKET_GROUP,
        BUCKET_ID,
        CR_STAGE,
        LIFETIME_PERIOD,
        FL_YEAR,
        FL_MONTH,
        FL_SEQ,
        PD_RATE,
        LGD_RATE,
        DISCOUNT_RATE,
        COUNTER_PAYSCHD,
        EAD_AMOUNT,
        FAIR_VALUE_AMOUNT,
        INTEREST_ACCRUED,
        UNUSED_AMOUNT,
        PREPAYMENT_RATE,
        PREPAYMENT_AMOUNT,
        CCF_RATE,
        CCF_AMOUNT,
        ECL_AMOUNT,
        CREATEDBY,
        CREATEDDATE,
        CREATEDHOST,
        UPDATEDBY,
        UPDATEDDATE,
        UPDATEDHOST
    )
    SELECT
		PKID,
        DOWNLOAD_DATE,
        ECL_MODEL_ID,
        MASTERID,
        BUCKET_GROUP,
        BUCKET_ID,
        CR_STAGE,
        LIFETIME_PERIOD,
        FL_YEAR,
        FL_MONTH,
        FL_SEQ,
        PD_RATE,
        LGD_RATE,
        DISCOUNT_RATE,
        COUNTER_PAYSCHD,
        EAD_AMOUNT,
        FAIR_VALUE_AMOUNT,
        INTEREST_ACCRUED,
        UNUSED_AMOUNT,
        PREPAYMENT_RATE,
        PREPAYMENT_AMOUNT,
        CCF_RATE,
        CCF_AMOUNT,
        ECL_AMOUNT,
        CREATEDBY,
        CREATEDDATE,
        CREATEDHOST,
        UPDATEDBY,
        UPDATEDDATE,
        UPDATEDHOST
    FROM IFRS_ECL_RESULT_DETAIL_CALC_PR;
    COMMIT;

    DELETE IFRS_ECL_RESULT_DETAIL
    WHERE DOWNLOAD_DATE = V_DOWNLOADDATE
    AND MASTERID IN (SELECT MASTERID FROM TMP_IMA_PARTIAL);
    COMMIT;

	INSERT INTO IFRS_ECL_RESULT_DETAIL
	(
		PKID,
        DOWNLOAD_DATE,
        ECL_MODEL_ID,
        MASTERID,
        PF_SEGMENT_ID,
        GROUP_SEGMENT,
        SEGMENT,
        SUB_SEGMENT,
        ACCOUNT_NUMBER,
        CUSTOMER_NUMBER,
        CUSTOMER_NAME,
        DATA_SOURCE,
        PRODUCT_GROUP,
        PRODUCT_TYPE,
        PRODUCT_CODE,
        CURRENCY,
        EXCHANGE_RATE,
        EIR,
        INTEREST_RATE,
        OUTSTANDING,
        FAIR_VALUE_AMOUNT,
        INTEREST_ACCRUED,
        UNUSED_AMOUNT,
        BI_COLLECTABILITY,
        DAY_PAST_DUE,
        BUCKET_GROUP,
        BUCKET_ID,
        CR_STAGE,
        IMPAIRED_FLAG,
        LIFETIME_PERIOD,
        PREPAYMENT_AMOUNT,
        CCF_AMOUNT,
        ECL_AMOUNT_ON_BS,
        ECL_AMOUNT_OFF_BS,
        ECL_AMOUNT,
        SPECIAL_REASON,
        CREATEDBY,
        CREATEDDATE,
        CREATEDHOST,
        UPDATEDBY,
        UPDATEDDATE,
        UPDATEDHOST,
        ECL_AMOUNT_ON_BS_FINAL,
        ECL_AMOUNT_FINAL,
        MULTIPLIER
	)
	SELECT
        PKID,
        DOWNLOAD_DATE,
        ECL_MODEL_ID,
        MASTERID,
        PF_SEGMENT_ID,
        GROUP_SEGMENT,
        SEGMENT,
        SUB_SEGMENT,
        ACCOUNT_NUMBER,
        CUSTOMER_NUMBER,
        CUSTOMER_NAME,
        DATA_SOURCE,
        PRODUCT_GROUP,
        PRODUCT_TYPE,
        PRODUCT_CODE,
        CURRENCY,
        EXCHANGE_RATE,
        EIR,
        INTEREST_RATE,
        OUTSTANDING,
        FAIR_VALUE_AMOUNT,
        INTEREST_ACCRUED,
        UNUSED_AMOUNT,
        BI_COLLECTABILITY,
        DAY_PAST_DUE,
        BUCKET_GROUP,
        BUCKET_ID,
        CR_STAGE,
        IMPAIRED_FLAG,
        LIFETIME_PERIOD,
        PREPAYMENT_AMOUNT,
        CCF_AMOUNT,
        ECL_AMOUNT_ON_BS,
        ECL_AMOUNT_OFF_BS,
        ECL_AMOUNT,
        SPECIAL_REASON,
        CREATEDBY,
        CREATEDDATE,
        CREATEDHOST,
        UPDATEDBY,
        UPDATEDDATE,
        UPDATEDHOST,
        ECL_AMOUNT_ON_BS_FINAL,
        ECL_AMOUNT_FINAL,
        MULTIPLIER
    FROM IFRS_ECL_RESULT_DETAIL_PR
	COMMIT;

	------------------ END MERGE PARTIAL RUN


    DELETE FROM IFRS_ECL_RESULT_HEADER WHERE ECL_MODEL_ID = v_ECLID AND DOWNLOAD_DATE = v_DOWNLOADDATE;
    COMMIT;

    /*****************************************************
    SUMMARY ECL_AMOUNT BY PORTFOLIO-STAGE-BUCKET
    ******************************************************/
    INSERT INTO IFRS_ECL_RESULT_HEADER (
        DOWNLOAD_DATE,
        ECL_MODEL_ID,
        PF_SEGMENT_ID,
        GROUP_SEGMENT,
        SEGMENT,
        SUB_SEGMENT,
        DATA_SOURCE,
        PRODUCT_GROUP,
        PRODUCT_TYPE,
        PRODUCT_CODE,
        BUCKET_GROUP,
        BUCKET_ID,
        CR_STAGE,
        OUTSTANDING,
        PREPAYMENT_AMOUNT,
        CCF_AMOUNT,
        ECL_AMOUNT
    )
    SELECT
        DOWNLOAD_DATE,
        ECL_MODEL_ID,
        PF_SEGMENT_ID,
        GROUP_SEGMENT,
        SEGMENT,
        SUB_SEGMENT,
        DATA_SOURCE,
        PRODUCT_GROUP,
        PRODUCT_TYPE,
        PRODUCT_CODE,
        BUCKET_GROUP,
        BUCKET_ID,
        CR_STAGE,
        SUM(OUTSTANDING * NVL(EXCHANGE_RATE,1))         AS OUTSTANDING,
        SUM(PREPAYMENT_AMOUNT * NVL(EXCHANGE_RATE,1))   AS PREPAYMENT_AMOUNT,
        SUM(CCF_AMOUNT * NVL(EXCHANGE_RATE,1))          AS CCF_AMOUNT,
        SUM(ECL_AMOUNT * NVL(EXCHANGE_RATE,1))          AS ECL_AMOUNT
     FROM IFRS_ECL_RESULT_DETAIL
    WHERE DOWNLOAD_DATE = v_DOWNLOADDATE AND OUTSTANDING >= 0
    AND ECL_MODEL_ID = v_ECLID
    GROUP BY
        DOWNLOAD_DATE,
        ECL_MODEL_ID,
        PF_SEGMENT_ID,
        GROUP_SEGMENT,
        SEGMENT,
        SUB_SEGMENT,
        DATA_SOURCE,
        PRODUCT_GROUP,
        PRODUCT_TYPE,
        PRODUCT_CODE,
        BUCKET_GROUP,
        BUCKET_ID,
        CR_STAGE;

    COMMIT;

END;