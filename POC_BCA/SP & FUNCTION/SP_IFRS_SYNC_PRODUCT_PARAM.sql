CREATE OR REPLACE PROCEDURE SP_IFRS_SYNC_PRODUCT_PARAM
IS
    V_CURRDATE DATE ;
    V_PREVDATE DATE;
BEGIN

    SELECT  MAX(CURRDATE)
          , MAX(PREVDATE)
    INTO V_CURRDATE, V_PREVDATE
    FROM IFRS_PRC_DATE_AMORT  ;

    INSERT INTO IFRS_AMORT_LOG ( DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
    VALUES(V_CURRDATE ,SYSTIMESTAMP ,'START' ,'SP_IFRS_SYNC_PRODUCT_PARAM' ,'')  ;
    COMMIT;

    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_MARKETRATE';

    INSERT INTO TMP_MARKETRATE
    (
        EFFECTIVE_DATE,
        PRODUCT_CODE,
        MARKET_RATE
    )
    SELECT EFF_DATE, PRD_CODE, MKT_RATE
    FROM ( SELECT PKID,PRD_CODE, EFF_DATE, MKT_RATE
       ,ROW_NUMBER() OVER (PARTITION BY PRD_CODE ORDER BY CREATEDDATE DESC) RN
       FROM IFRS_MASTER_MARKETRATE_PARAM
       WHERE EFF_DATE <= V_CURRDATE
     ) A
    WHERE RN = 1;

    COMMIT;

    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_TRANS_PARAM';

    INSERT INTO TMP_TRANS_PARAM
    (
        DATA_SOURCE,
        PRD_TYPE,
        PRD_CODE,
        AMORT_TYPE
    )
    SELECT  DATA_SOURCE,PRD_TYPE,PRD_CODE, AMORT_TYPE
    FROM ( SELECT  DATA_SOURCE,PRD_TYPE,PRD_CODE, AMORT_TYPE
       ,ROW_NUMBER() OVER (PARTITION BY DATA_SOURCE,PRD_TYPE,PRD_CODE ORDER BY AMORT_TYPE) RN
       FROM IFRS_MASTER_TRANSACTION_PARAM
       WHERE AMORTIZATION_FLAG = 1 AND INST_CLS_VALUE = 'A'
     ) A
    WHERE RN = 1;

    COMMIT;

    EXECUTE IMMEDIATE 'TRUNCATE TABLE IFRS_PRODUCT_PARAM';

    INSERT  INTO IFRS_PRODUCT_PARAM
    ( DATA_SOURCE ,
      PRD_TYPE ,
      PRD_CODE ,
      PRD_GROUP ,
      MARKET_RATE ,
      CCY ,
      AMORT_TYPE ,
      IS_STAF_LOAN ,
      IS_IMPAIRED ,
      PRODUCT_DESCRIPTION ,
      FEE_MAT_AMT ,
      COST_MAT_AMT ,
      EXPECTED_LIFE ,
      FEE_MAT_TYPE ,
      COST_MAT_TYPE ,
      FLAG_AL ,
      REPAY_TYPE_VALUE ,
      WORKING_PERIOD ,
      TENOR_TYPE
    )
    SELECT  A.DATA_SOURCE ,
        A.PRD_TYPE ,
        A.PRD_CODE ,
        A.PRD_GROUP ,
        NVL(B.MARKET_RATE,A.MKT_INT_RATE) AS MARKET_RATE ,
        A.CCY ,
        A.AMORT_TYPE ,
        CASE WHEN  A.STAFF_LOAN_IND = 1 THEN 'Y' ELSE 'N' END ,  ----ADD CTBC
        A.IS_IMPAIRED ,
        A.PRD_DESC ,
        A.ORG_FEE_MAT_AMT ,
        A.TXN_COST_MAT_AMT ,
        CASE WHEN A.STAFF_LOAN_IND = 1 THEN A.WORKING_PERIOD ELSE A.EXP_LIFE END EXP_LIFE ,
        A.ORG_FEE_MAT_TYPE ,
        A.TXN_COST_MAT_TYPE ,
        A.INST_CLS_VALUE ,
        A.REPAY_TYPE_VALUE ,
        A.WORKING_PERIOD ,
        A.TENOR_TYPE
    FROM IFRS_MASTER_PRODUCT_PARAM A
    LEFT JOIN TMP_TRANS_PARAM C
    ON A.PRD_CODE = C.PRD_CODE
    AND A.DATA_SOURCE = C.DATA_SOURCE
    AND A.PRD_TYPE = C.PRD_TYPE
    LEFT JOIN TMP_MARKETRATE B
    ON A.PRD_CODE = B.PRODUCT_CODE
    WHERE A.INST_CLS_VALUE = 'A';
--    AND A.IS_DELETE = 0;

    COMMIT;

    INSERT  INTO IFRS_AMORT_LOG( DOWNLOAD_DATE , DTM ,OPS ,PROCNAME ,REMARK )
    VALUES  ( V_CURRDATE ,SYSTIMESTAMP,'END','SP_IFRS_SYNC_PRODUCT_PARAM','');

    COMMIT;
END;