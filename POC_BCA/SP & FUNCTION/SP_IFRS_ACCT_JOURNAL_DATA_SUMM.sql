CREATE OR REPLACE PROCEDURE SP_IFRS_ACCT_JOURNAL_DATA_SUMM
AS
  V_CURRDATE DATE;
  V_PREVDATE DATE;
BEGIN

  SELECT  MAX(CURRDATE), MAX(PREVDATE)
  INTO V_CURRDATE, V_PREVDATE
  FROM    IFRS_PRC_DATE_AMORT;

  INSERT INTO IFRS_AMORT_LOG(DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
  VALUES(V_CURRDATE,CURRENT_TIMESTAMP,'START','SP_IFRS_ACCT_JOURNAL_DATA_SUMM','START');


  --delete first
  DELETE /*+ PARALLEL(12) */ FROM IFRS_ACCT_JOURNAL_DATA_SUMM WHERE DOWNLOAD_DATE>=V_CURRDATE;
  EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_IFRS_ACCT_JRNL_DATA_SUMM';

  COMMIT;

  --temp
  INSERT /*+ PARALLEL(12) */ INTO TMP_IFRS_ACCT_JRNL_DATA_SUMM (
   MASTERID
	,FACNO
	,CIFNO
	,ACCTNO
	,DATASOURCE
	,PRDTYPE
	,PRDCODE
  ,BRANCH
	,METHOD
  ,CCY
	,JOURNALCODE2
	,FLAG_CF
	,GLNO
	,N_AMOUNT
  )
  SELECT /*+ PARALLEL(12) */ MASTERID
        ,FACNO
        ,CIFNO
        ,ACCTNO
        ,DATASOURCE
        ,PRDTYPE
        ,PRDCODE
        ,BRANCH
        ,METHOD
        ,CCY
        ,JOURNALCODE2
        ,FLAG_CF
        ,GLNO
        ,N_AMOUNT
  FROM IFRS_ACCT_JOURNAL_DATA_SUMM
  WHERE DOWNLOAD_DATE=V_PREVDATE;


  COMMIT;

  INSERT /*+ PARALLEL(12) */ INTO TMP_IFRS_ACCT_JRNL_DATA_SUMM(
  MASTERID,FACNO,CIFNO,ACCTNO,DATASOURCE,PRDTYPE,PRDCODE,BRANCH,METHOD,CCY,JOURNALCODE2,FLAG_CF,GLNO,N_AMOUNT
  )
  SELECT /*+ PARALLEL(12) */ MASTERID,FACNO,CIFNO,ACCTNO,DATASOURCE,PRDTYPE,PRDCODE,BRANCH,METHOD,CCY,JOURNALCODE2,FLAG_CF,GLNO
        ,CASE WHEN DRCR IN ('D','DR','DB') THEN N_AMOUNT ELSE -1 * N_AMOUNT END AS AMOUNT
  FROM IFRS_ACCT_JOURNAL_DATA
  WHERE DOWNLOAD_DATE=V_CURRDATE;

  COMMIT;

  INSERT INTO IFRS_AMORT_LOG(DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
  VALUES(V_CURRDATE,CURRENT_TIMESTAMP,'DEBUG','SP_IFRS_ACCT_JOURNAL_DATA_SUMM','JDATA TMP INSERT');



  COMMIT;

  --insert
  INSERT /*+ PARALLEL(12) */ INTO IFRS_ACCT_JOURNAL_DATA_SUMM
  (DOWNLOAD_DATE
  ,MASTERID,FACNO,CIFNO,ACCTNO,DATASOURCE,PRDTYPE,PRDCODE,BRANCH,METHOD,CCY,JOURNALCODE2,FLAG_CF,GLNO,N_AMOUNT
  ,CREATEDBY,CREATEDDATE
  )
  SELECT /*+ PARALLEL(12) */ V_CURRDATE AS DOWNLOAD_DATE
        ,MASTERID,FACNO,CIFNO,ACCTNO,DATASOURCE,PRDTYPE,PRDCODE,BRANCH,METHOD,CCY,JOURNALCODE2,FLAG_CF,GLNO,SUM(N_AMOUNT)
        ,'JDATASUMM',SYSTIMESTAMP
  FROM TMP_IFRS_ACCT_JRNL_DATA_SUMM
  GROUP BY MASTERID,FACNO,CIFNO,ACCTNO,DATASOURCE,PRDTYPE,PRDCODE,BRANCH,METHOD,CCY,JOURNALCODE2,FLAG_CF,GLNO;


  COMMIT;

  INSERT INTO IFRS_AMORT_LOG(DOWNLOAD_DATE,DTM,OPS,PROCNAME,REMARK)
  VALUES(V_CURRDATE,CURRENT_TIMESTAMP,'END','SP_IFRS_ACCT_JOURNAL_DATA_SUMM','END');

  COMMIT;

END;