CREATE OR REPLACE PROCEDURE USPS_ECL_RESULT_DETAIL_DESC
(
    V_ECL_MASTERID NUMBER DEFAULT 0,
    V_ECL_PERIOD DATE DEFAULT '1900-01-01',
    V_ECL_MODEL_ID NUMBER DEFAULT 0,
    Cur_out OUT SYS_REFCURSOR
)
AS
BEGIN


    OPEN Cur_out FOR

    SELECT
        A.DOWNLOAD_DATE,
        A.DATA_SOURCE,
        A.IMPAIRED_FLAG,
        A.CURRENCY,
        A.EXCHANGE_RATE,
        D.ECL_MODEL_NAME,
        A.LIFETIME_PERIOD                           AS LIFETIME,
        A.SUB_SEGMENT                               AS SUB_SEGMENT,
        A.PRODUCT_CODE || ' - ' || C.PRD_DESC       AS PRODUCT_CODE,
        NVL(E.EAD_BALANCE, ' ')                     AS EAD_BALANCE,
        NVL(X.EAD_AMOUNT, 0)                        AS EAD_AMOUNT,
        A.ACCOUNT_NUMBER,
        NVL(ROUND(A.OUTSTANDING,6), 0)              AS OUTSTANDING,
        NVL(ROUND(A.FAIR_VALUE_AMOUNT,6), 0)        AS FAIR_VALUE_AMOUNT,
        A.CUSTOMER_NUMBER,
        A.CUSTOMER_NAME,
        NVL(ROUND(A.INTEREST_ACCRUED, 6), 0)        AS ACCRUED_INTEREST,
        NVL(G.BUCKET_NAME, 'BR12') BUCKET_NAME,
        NVL(A.CR_STAGE, ' ')                        AS CR_STAGE,
        DAY_PAST_DUE,
        BI_COLLECTABILITY,
        NVL(ROUND(H.PREPAYMENT_RATE * 100, 6), 0)   AS PREPAYMENT_RATE,
        NVL(A.PREPAYMENT_AMOUNT, 0)                 AS PREPAYMENT_AMOUNT,
        NVL(A.UNUSED_AMOUNT, 0)                     AS UNUSED_AMOUNT,
        NVL(ROUND(I.CCF_RATE * 100, 6), 0)          AS CCF_RATE,
        NVL(A.CCF_AMOUNT, 0)                        AS CCF_AMOUNT,
        NVL(ROUND(A.INTEREST_RATE,6), 0)            AS INTEREST_RATE,
        NVL(ROUND(A.EIR,6), A.INTEREST_RATE)        AS EIR,
        NVL(ROUND(A.ECL_AMOUNT_ON_BS,6), 0)         AS ECL_AMOUNT_ON_BS,
        NVL(ROUND(A.ECL_AMOUNT_ON_BS_FINAL,6), 0)   AS ECL_AMOUNT_ON_BS_FINAL,
        NVL(ROUND(A.ECL_AMOUNT_OFF_BS,6), 0)        AS ECL_AMOUNT_OFF_BS,
        NVL(ROUND(A.ECL_AMOUNT,6), 0)               AS ECL_AMOUNT,
        NVL(ROUND(A.ECL_AMOUNT_FINAL,6), 0)         AS ECL_AMOUNT_FINAL,
        NVL(A.SPECIAL_REASON, '-')                  AS SPECIAL_REASON
    FROM IFRS_ECL_RESULT_DETAIL A
    INNER JOIN IFRS_ECL_MODEL_CONFIG B
    ON A.ECL_MODEL_ID = B.ECL_MODEL_ID
    AND A.DOWNLOAD_DATE = B.DOWNLOAD_DATE
    AND A.PF_SEGMENT_ID = B.PF_SEGMENT_ID
    INNER JOIN IFRS_ECL_RESULT_DETAIL_CALC X
    ON A.ECL_MODEL_ID = X.ECL_MODEL_ID
    AND A.DOWNLOAD_DATE = X.DOWNLOAD_DATE
    AND A.MASTERID = X.MASTERID
    AND X.COUNTER_PAYSCHD = 1
    LEFT JOIN IFRS_MASTER_PRODUCT_PARAM C
    ON NVL(A.DATA_SOURCE, ' ') = NVL(C.DATA_SOURCE, ' ')
    AND NVL(A.PRODUCT_CODE, ' ') = NVL(C.PRD_CODE, ' ')
    LEFT JOIN IFRS_BUCKET_DETAIL G
    ON A.BUCKET_ID = G.BUCKET_ID
    AND A.BUCKET_GROUP = G.BUCKET_GROUP
    JOIN IFRS_ECL_MODEL_HEADER D
    ON A.ECL_MODEL_ID = D.PKID
    LEFT JOIN IFRS_ECL_MODEL_DETAIL_EAD F
    ON A.ECL_MODEL_ID = F.ECL_MODEL_ID
    AND A.PF_SEGMENT_ID = F.PF_SEGMENT_ID
    LEFT JOIN IFRS_EAD_RULES_CONFIG E
    ON B.EAD_MODEL_ID = E.PKID
    LEFT JOIN IFRS_PREPAYMENT_HEADER H
    ON  H.PREPAYMENT_RULE_ID = B.PREPAYMENT_RULES_ID
    AND H.DOWNLOAD_DATE = B.PREPAYMENT_EFF_DATE
    LEFT JOIN IFRS_CCF_HEADER I
    ON I.CCF_RULE_ID = B.CCF_RULES_ID
    AND I.DOWNLOAD_DATE = B.CCF_EFF_DATE
    WHERE A.DOWNLOAD_DATE = V_ECL_PERIOD
    AND A.ECL_MODEL_ID = V_ECL_MODEL_ID
    AND A.MASTERID = V_ECL_MASTERID;

END;