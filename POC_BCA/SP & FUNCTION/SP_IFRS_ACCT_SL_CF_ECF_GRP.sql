CREATE OR REPLACE PROCEDURE SP_IFRS_ACCT_SL_CF_ECF_GRP
AS
  -- 20160412 group by cf_id for multiple rows with same cf_id
  V_CURRDATE    DATE;
  V_PREVDATE    DATE;

BEGIN


    SELECT MAX(CURRDATE),MAX(PREVDATE)
    INTO V_CURRDATE, V_PREVDATE
    FROM IFRS_PRC_DATE_AMORT;

    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_CF_ECF_SL';

    INSERT /*+ PARALLEL(8) */ INTO TMP_CF_ECF_SL(ID1,CF_ID,FLAG_REV_ORI,AMT)
    SELECT /*+ PARALLEL(8) */ MIN(A.ID) AS ID1
         , A.CF_ID
         , B.FLAG_REVERSE AS FLAG_REV_ORI
         , SUM(CASE WHEN A.FLAG_REVERSE='N' THEN A.AMOUNT ELSE -1 * A.AMOUNT END) AMT
    FROM IFRS_ACCT_SL_COST_FEE_ECF A
    JOIN IFRS_ACCT_COST_FEE B ON B.ID=A.CF_ID
    WHERE A.ECFDATE=V_CURRDATE
    AND A.CREATEDBY <> 'SL_SWITCH'
	AND A.STATUS = 'ACT'
    GROUP BY A.CF_ID,B.FLAG_REVERSE
    HAVING COUNT(*) > 1;

    COMMIT;

    MERGE /*+ PARALLEL(8) */ INTO IFRS_ACCT_SL_COST_FEE_ECF Z
    USING TMP_CF_ECF_SL A
    ON (Z.ECFDATE=V_CURRDATE
        AND Z.CF_ID=A.CF_ID
       )
    WHEN MATCHED THEN
    UPDATE
    SET AMOUNT =CASE WHEN A.FLAG_REV_ORI='N' THEN CASE WHEN A.ID1=Z.ID THEN A.AMT ELSE 0 END
                     ELSE CASE WHEN A.ID1=Z.ID THEN -1 * A.AMT ELSE 0 END
                     END
       ,AMOUNT_ORG = CASE WHEN A.FLAG_REV_ORI='N' THEN CASE WHEN A.ID1=Z.ID THEN A.AMT ELSE 0 END
                     ELSE CASE WHEN A.ID1=Z.ID THEN -1 * A.AMT ELSE 0 END
                     END
       ,FLAG_REVERSE=A.FLAG_REV_ORI
    ;

    COMMIT;


    DELETE FROM IFRS_ACCT_SL_COST_FEE_ECF
    WHERE ECFDATE=V_CURRDATE
    AND AMOUNT=0;

    COMMIT;
END;