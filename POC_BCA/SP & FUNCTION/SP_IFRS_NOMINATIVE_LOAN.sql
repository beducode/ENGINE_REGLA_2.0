CREATE OR REPLACE PROCEDURE SP_IFRS_NOMINATIVE_LOAN
AS
    v_CURRDATE      DATE;
    v_LASTMONTH     DATE;
    v_SESSIONID     VARCHAR2(100);
    v_SOURCETYPE    VARCHAR2(100):= 'LOAN';
    v_DATASOURCE    VARCHAR2(100):= 'ILS';

BEGIN

    SELECT LAST_DAY(CURRDATE), ADD_MONTHS(LAST_DAY(CURRDATE),-1), SESSIONID
    INTO v_CURRDATE, v_LASTMONTH, v_SESSIONID
    FROM IFRS_PRC_DATE;

    DELETE FROM IFRS_NOMINATIVE_MONTHLY
    WHERE REPORT_DATE = v_CURRDATE
    AND SOURCE_TYPE = v_SOURCETYPE;
    COMMIT;

    EXECUTE IMMEDIATE 'TRUNCATE TABLE GTMP_IFRS_MASTER_ACCOUNT';

    --INSERT IMA CURRDATE INTO GTMP
    INSERT INTO GTMP_IFRS_MASTER_ACCOUNT(
        PKID,
        DOWNLOAD_DATE,
        MASTERID,
        MASTER_ACCOUNT_CODE,
        DATA_SOURCE,
        GLOBAL_CUSTOMER_NUMBER,
        CUSTOMER_NUMBER,
        CUSTOMER_NAME,
        FACILITY_NUMBER,
        ACCOUNT_NUMBER,
        PREVIOUS_ACCOUNT_NUMBER,
        ACCOUNT_STATUS,
        INTEREST_RATE,
        MARKET_RATE,
        PRODUCT_GROUP,
        PRODUCT_TYPE,
        PRODUCT_CODE,
        PRODUCT_ENTITY,
        GL_CONSTNAME,
        BRANCH_CODE,
        BRANCH_CODE_OPEN,
        CURRENCY,
        EXCHANGE_RATE,
        INITIAL_OUTSTANDING,
        OUTSTANDING,
        OUTSTANDING_IDC,
        OUTSTANDING_JF,
        OUTSTANDING_BANK,
        OUTSTANDING_PASTDUE,
        PLAFOND,
        PLAFOND_CASH,
        INTEREST_ACCRUED,
        INSTALLMENT_AMOUNT,
        UNUSED_AMOUNT,
        DOWN_PAYMENT_AMOUNT,
        JF_FLAG,
        LOAN_START_DATE,
        LOAN_DUE_DATE,
        LOAN_START_AMORTIZATION,
        LOAN_END_AMORTIZATION,
        INSTALLMENT_GRACE_PERIOD,
        NEXT_PAYMENT_DATE,
        NEXT_INT_PAYMENT_DATE,
        LAST_PAYMENT_DATE,
        FIRST_INSTALLMENT_DATE,
        TENOR,
        REMAINING_TENOR,
        PAYMENT_CODE,
        PAYMENT_TERM,
        INTEREST_CALCULATION_CODE,
        INTEREST_PAYMENT_TERM,
        RESTRUCTURE_DATE,
        RESTRUCTURE_FLAG,
        POCI_FLAG,
        STAFF_LOAN_FLAG,
        BELOW_MARKET_FLAG,
        BTB_FLAG,
        COMMITTED_FLAG,
        REVOLVING_FLAG,
        IAS_CLASS,
        IFRS9_CLASS,
        BM_RESULT,
        SPPI_RESULT,
        AMORT_TYPE,
        EIR_STATUS,
        ECF_STATUS,
        EIR,
        EIR_AMOUNT,
        FAIR_VALUE_AMOUNT,
        INITIAL_UNAMORT_TXN_COST,
        INITIAL_UNAMORT_ORG_FEE,
        UNAMORT_COST_AMT,
        UNAMORT_FEE_AMT,
        UNAMORT_BENEFIT,
        DAILY_AMORT_AMT,
        UNAMORT_AMT_TOTAL_JF,
        UNAMORT_FEE_AMT_JF,
        UNAMORT_COST_AMT_JF,
        ORIGINAL_COLLECTABILITY,
        BI_COLLECTABILITY,
        DAY_PAST_DUE,
        DPD_START_DATE,
        DPD_ZERO_COUNTER,
        NPL_DATE,
        NPL_FLAG,
        DEFAULT_DATE,
        DEFAULT_FLAG,
        WRITEOFF_FLAG,
        WRITEOFF_DATE,
        OUTSTANDING_WO,
        IMPAIRED_FLAG,
        IS_IMPAIRED,
        GROUP_SEGMENT,
        SEGMENT,
        SUB_SEGMENT,
        CR_STAGE,
        LIFETIME,
        EAD_RULE_ID,
        EAD_SEGMENT,
        EAD_AMOUNT,
        LGD_RULE_ID,
        LGD_SEGMENT,
        PD_RULE_ID,
        PD_SEGMENT,
        BUCKET_GROUP,
        BUCKET_ID,
        RATING_CODE,
        ECL_12_AMOUNT,
        ECL_LIFETIME_AMOUNT,
        ECL_AMOUNT,
        CA_UNWINDING_AMOUNT,
        IA_UNWINDING_AMOUNT,
        IA_UNWINDING_SUM_AMOUNT,
        BEGINNING_BALANCE,
        ENDING_BALANCE,
        WRITEBACK_AMOUNT,
        CHARGE_AMOUNT,
        RESERVED_VARCHAR_1,
        RESERVED_VARCHAR_2,
        RESERVED_VARCHAR_3,
        RESERVED_VARCHAR_4,
        RESERVED_VARCHAR_5,
        RESERVED_VARCHAR_6,
        RESERVED_VARCHAR_7,
        RESERVED_VARCHAR_8,
        RESERVED_VARCHAR_9,
        RESERVED_VARCHAR_10,
        RESERVED_VARCHAR_11,
        RESERVED_VARCHAR_12,
        RESERVED_VARCHAR_13,
        RESERVED_VARCHAR_14,
        RESERVED_VARCHAR_15,
        RESERVED_VARCHAR_16,
        RESERVED_VARCHAR_17,
        RESERVED_VARCHAR_18,
        RESERVED_VARCHAR_19,
        RESERVED_VARCHAR_20,
        RESERVED_VARCHAR_21,
        RESERVED_VARCHAR_22,
        RESERVED_VARCHAR_23,
        RESERVED_VARCHAR_24,
        RESERVED_VARCHAR_25,
        RESERVED_VARCHAR_26,
        RESERVED_VARCHAR_27,
        RESERVED_VARCHAR_28,
        RESERVED_VARCHAR_29,
        RESERVED_VARCHAR_30,
        RESERVED_AMOUNT_1,
        RESERVED_AMOUNT_2,
        RESERVED_AMOUNT_3,
        RESERVED_AMOUNT_4,
        RESERVED_AMOUNT_5,
        RESERVED_AMOUNT_6,
        RESERVED_AMOUNT_7,
        RESERVED_AMOUNT_8,
        RESERVED_AMOUNT_9,
        RESERVED_AMOUNT_10,
        RESERVED_AMOUNT_11,
        RESERVED_AMOUNT_12,
        RESERVED_AMOUNT_13,
        RESERVED_AMOUNT_14,
        RESERVED_AMOUNT_15,
        RESERVED_AMOUNT_16,
        RESERVED_AMOUNT_17,
        RESERVED_AMOUNT_18,
        RESERVED_AMOUNT_19,
        RESERVED_AMOUNT_20,
        RESERVED_RATE_1,
        RESERVED_RATE_2,
        RESERVED_RATE_3,
        RESERVED_RATE_4,
        RESERVED_RATE_5,
        RESERVED_RATE_6,
        RESERVED_RATE_7,
        RESERVED_RATE_8,
        RESERVED_RATE_9,
        RESERVED_RATE_10,
        RESERVED_FLAG_1,
        RESERVED_FLAG_2,
        RESERVED_FLAG_3,
        RESERVED_FLAG_4,
        RESERVED_FLAG_5,
        RESERVED_FLAG_6,
        RESERVED_FLAG_7,
        RESERVED_FLAG_8,
        RESERVED_FLAG_9,
        RESERVED_FLAG_10,
        RESERVED_DATE_1,
        RESERVED_DATE_2,
        RESERVED_DATE_3,
        RESERVED_DATE_4,
        RESERVED_DATE_5,
        RESERVED_DATE_6,
        RESERVED_DATE_7,
        RESERVED_DATE_8,
        RESERVED_DATE_9,
        RESERVED_DATE_10
    )
    SELECT
        PKID,
        DOWNLOAD_DATE,
        MASTERID,
        MASTER_ACCOUNT_CODE,
        DATA_SOURCE,
        GLOBAL_CUSTOMER_NUMBER,
        CUSTOMER_NUMBER,
        CUSTOMER_NAME,
        FACILITY_NUMBER,
        ACCOUNT_NUMBER,
        PREVIOUS_ACCOUNT_NUMBER,
        ACCOUNT_STATUS,
        INTEREST_RATE,
        MARKET_RATE,
        PRODUCT_GROUP,
        PRODUCT_TYPE,
        PRODUCT_CODE,
        PRODUCT_ENTITY,
        GL_CONSTNAME,
        BRANCH_CODE,
        BRANCH_CODE_OPEN,
        CURRENCY,
        EXCHANGE_RATE,
        INITIAL_OUTSTANDING,
        OUTSTANDING,
        OUTSTANDING_IDC,
        OUTSTANDING_JF,
        OUTSTANDING_BANK,
        OUTSTANDING_PASTDUE,
        PLAFOND,
        PLAFOND_CASH,
        INTEREST_ACCRUED,
        INSTALLMENT_AMOUNT,
        UNUSED_AMOUNT,
        DOWN_PAYMENT_AMOUNT,
        JF_FLAG,
        LOAN_START_DATE,
        LOAN_DUE_DATE,
        LOAN_START_AMORTIZATION,
        LOAN_END_AMORTIZATION,
        INSTALLMENT_GRACE_PERIOD,
        NEXT_PAYMENT_DATE,
        NEXT_INT_PAYMENT_DATE,
        LAST_PAYMENT_DATE,
        FIRST_INSTALLMENT_DATE,
        TENOR,
        REMAINING_TENOR,
        PAYMENT_CODE,
        PAYMENT_TERM,
        INTEREST_CALCULATION_CODE,
        INTEREST_PAYMENT_TERM,
        RESTRUCTURE_DATE,
        RESTRUCTURE_FLAG,
        POCI_FLAG,
        STAFF_LOAN_FLAG,
        BELOW_MARKET_FLAG,
        BTB_FLAG,
        COMMITTED_FLAG,
        REVOLVING_FLAG,
        IAS_CLASS,
        IFRS9_CLASS,
        BM_RESULT,
        SPPI_RESULT,
        AMORT_TYPE,
        EIR_STATUS,
        ECF_STATUS,
        EIR,
        EIR_AMOUNT,
        FAIR_VALUE_AMOUNT,
        INITIAL_UNAMORT_TXN_COST,
        INITIAL_UNAMORT_ORG_FEE,
        UNAMORT_COST_AMT,
        UNAMORT_FEE_AMT,
        UNAMORT_BENEFIT,
        DAILY_AMORT_AMT,
        UNAMORT_AMT_TOTAL_JF,
        UNAMORT_FEE_AMT_JF,
        UNAMORT_COST_AMT_JF,
        ORIGINAL_COLLECTABILITY,
        BI_COLLECTABILITY,
        DAY_PAST_DUE,
        DPD_START_DATE,
        DPD_ZERO_COUNTER,
        NPL_DATE,
        NPL_FLAG,
        DEFAULT_DATE,
        DEFAULT_FLAG,
        WRITEOFF_FLAG,
        WRITEOFF_DATE,
        OUTSTANDING_WO,
        IMPAIRED_FLAG,
        IS_IMPAIRED,
        GROUP_SEGMENT,
        SEGMENT,
        SUB_SEGMENT,
        CR_STAGE,
        LIFETIME,
        EAD_RULE_ID,
        EAD_SEGMENT,
        EAD_AMOUNT,
        LGD_RULE_ID,
        LGD_SEGMENT,
        PD_RULE_ID,
        PD_SEGMENT,
        BUCKET_GROUP,
        BUCKET_ID,
        RATING_CODE,
        ECL_12_AMOUNT,
        ECL_LIFETIME_AMOUNT,
        ECL_AMOUNT,
        CA_UNWINDING_AMOUNT,
        IA_UNWINDING_AMOUNT,
        IA_UNWINDING_SUM_AMOUNT,
        BEGINNING_BALANCE,
        ENDING_BALANCE,
        WRITEBACK_AMOUNT,
        CHARGE_AMOUNT,
        RESERVED_VARCHAR_1,
        RESERVED_VARCHAR_2,
        RESERVED_VARCHAR_3,
        RESERVED_VARCHAR_4,
        RESERVED_VARCHAR_5,
        RESERVED_VARCHAR_6,
        RESERVED_VARCHAR_7,
        RESERVED_VARCHAR_8,
        RESERVED_VARCHAR_9,
        RESERVED_VARCHAR_10,
        RESERVED_VARCHAR_11,
        RESERVED_VARCHAR_12,
        RESERVED_VARCHAR_13,
        RESERVED_VARCHAR_14,
        RESERVED_VARCHAR_15,
        RESERVED_VARCHAR_16,
        RESERVED_VARCHAR_17,
        RESERVED_VARCHAR_18,
        RESERVED_VARCHAR_19,
        RESERVED_VARCHAR_20,
        RESERVED_VARCHAR_21,
        RESERVED_VARCHAR_22,
        RESERVED_VARCHAR_23,
        RESERVED_VARCHAR_24,
        RESERVED_VARCHAR_25,
        RESERVED_VARCHAR_26,
        RESERVED_VARCHAR_27,
        RESERVED_VARCHAR_28,
        RESERVED_VARCHAR_29,
        RESERVED_VARCHAR_30,
        RESERVED_AMOUNT_1,
        RESERVED_AMOUNT_2,
        RESERVED_AMOUNT_3,
        RESERVED_AMOUNT_4,
        RESERVED_AMOUNT_5,
        RESERVED_AMOUNT_6,
        RESERVED_AMOUNT_7,
        RESERVED_AMOUNT_8,
        RESERVED_AMOUNT_9,
        RESERVED_AMOUNT_10,
        RESERVED_AMOUNT_11,
        RESERVED_AMOUNT_12,
        RESERVED_AMOUNT_13,
        RESERVED_AMOUNT_14,
        RESERVED_AMOUNT_15,
        RESERVED_AMOUNT_16,
        RESERVED_AMOUNT_17,
        RESERVED_AMOUNT_18,
        RESERVED_AMOUNT_19,
        RESERVED_AMOUNT_20,
        RESERVED_RATE_1,
        RESERVED_RATE_2,
        RESERVED_RATE_3,
        RESERVED_RATE_4,
        RESERVED_RATE_5,
        RESERVED_RATE_6,
        RESERVED_RATE_7,
        RESERVED_RATE_8,
        RESERVED_RATE_9,
        RESERVED_RATE_10,
        RESERVED_FLAG_1,
        RESERVED_FLAG_2,
        RESERVED_FLAG_3,
        RESERVED_FLAG_4,
        RESERVED_FLAG_5,
        RESERVED_FLAG_6,
        RESERVED_FLAG_7,
        RESERVED_FLAG_8,
        RESERVED_FLAG_9,
        RESERVED_FLAG_10,
        RESERVED_DATE_1,
        RESERVED_DATE_2,
        RESERVED_DATE_3,
        RESERVED_DATE_4,
        RESERVED_DATE_5,
        RESERVED_DATE_6,
        RESERVED_DATE_7,
        RESERVED_DATE_8,
        RESERVED_DATE_9,
        RESERVED_DATE_10
     FROM IFRS_MASTER_ACCOUNT WHERE DOWNLOAD_DATE = v_CURRDATE AND DATA_SOURCE = v_DATASOURCE;

    --INSERT IMA LASTMONTH INTO GTMP
    INSERT INTO GTMP_IFRS_MASTER_ACCOUNT(
        PKID,
        DOWNLOAD_DATE,
        MASTERID,
        MASTER_ACCOUNT_CODE,
        DATA_SOURCE,
        GLOBAL_CUSTOMER_NUMBER,
        CUSTOMER_NUMBER,
        CUSTOMER_NAME,
        FACILITY_NUMBER,
        ACCOUNT_NUMBER,
        PREVIOUS_ACCOUNT_NUMBER,
        ACCOUNT_STATUS,
        INTEREST_RATE,
        MARKET_RATE,
        PRODUCT_GROUP,
        PRODUCT_TYPE,
        PRODUCT_CODE,
        PRODUCT_ENTITY,
        GL_CONSTNAME,
        BRANCH_CODE,
        BRANCH_CODE_OPEN,
        CURRENCY,
        EXCHANGE_RATE,
        INITIAL_OUTSTANDING,
        OUTSTANDING,
        OUTSTANDING_IDC,
        OUTSTANDING_JF,
        OUTSTANDING_BANK,
        OUTSTANDING_PASTDUE,
        PLAFOND,
        PLAFOND_CASH,
        INTEREST_ACCRUED,
        INSTALLMENT_AMOUNT,
        UNUSED_AMOUNT,
        DOWN_PAYMENT_AMOUNT,
        JF_FLAG,
        LOAN_START_DATE,
        LOAN_DUE_DATE,
        LOAN_START_AMORTIZATION,
        LOAN_END_AMORTIZATION,
        INSTALLMENT_GRACE_PERIOD,
        NEXT_PAYMENT_DATE,
        NEXT_INT_PAYMENT_DATE,
        LAST_PAYMENT_DATE,
        FIRST_INSTALLMENT_DATE,
        TENOR,
        REMAINING_TENOR,
        PAYMENT_CODE,
        PAYMENT_TERM,
        INTEREST_CALCULATION_CODE,
        INTEREST_PAYMENT_TERM,
        RESTRUCTURE_DATE,
        RESTRUCTURE_FLAG,
        POCI_FLAG,
        STAFF_LOAN_FLAG,
        BELOW_MARKET_FLAG,
        BTB_FLAG,
        COMMITTED_FLAG,
        REVOLVING_FLAG,
        IAS_CLASS,
        IFRS9_CLASS,
        BM_RESULT,
        SPPI_RESULT,
        AMORT_TYPE,
        EIR_STATUS,
        ECF_STATUS,
        EIR,
        EIR_AMOUNT,
        FAIR_VALUE_AMOUNT,
        INITIAL_UNAMORT_TXN_COST,
        INITIAL_UNAMORT_ORG_FEE,
        UNAMORT_COST_AMT,
        UNAMORT_FEE_AMT,
        UNAMORT_BENEFIT,
        DAILY_AMORT_AMT,
        UNAMORT_AMT_TOTAL_JF,
        UNAMORT_FEE_AMT_JF,
        UNAMORT_COST_AMT_JF,
        ORIGINAL_COLLECTABILITY,
        BI_COLLECTABILITY,
        DAY_PAST_DUE,
        DPD_START_DATE,
        DPD_ZERO_COUNTER,
        NPL_DATE,
        NPL_FLAG,
        DEFAULT_DATE,
        DEFAULT_FLAG,
        WRITEOFF_FLAG,
        WRITEOFF_DATE,
        OUTSTANDING_WO,
        IMPAIRED_FLAG,
        IS_IMPAIRED,
        GROUP_SEGMENT,
        SEGMENT,
        SUB_SEGMENT,
        CR_STAGE,
        LIFETIME,
        EAD_RULE_ID,
        EAD_SEGMENT,
        EAD_AMOUNT,
        LGD_RULE_ID,
        LGD_SEGMENT,
        PD_RULE_ID,
        PD_SEGMENT,
        BUCKET_GROUP,
        BUCKET_ID,
        RATING_CODE,
        ECL_12_AMOUNT,
        ECL_LIFETIME_AMOUNT,
        ECL_AMOUNT,
        CA_UNWINDING_AMOUNT,
        IA_UNWINDING_AMOUNT,
        IA_UNWINDING_SUM_AMOUNT,
        BEGINNING_BALANCE,
        ENDING_BALANCE,
        WRITEBACK_AMOUNT,
        CHARGE_AMOUNT,
        RESERVED_VARCHAR_1,
        RESERVED_VARCHAR_2,
        RESERVED_VARCHAR_3,
        RESERVED_VARCHAR_4,
        RESERVED_VARCHAR_5,
        RESERVED_VARCHAR_6,
        RESERVED_VARCHAR_7,
        RESERVED_VARCHAR_8,
        RESERVED_VARCHAR_9,
        RESERVED_VARCHAR_10,
        RESERVED_VARCHAR_11,
        RESERVED_VARCHAR_12,
        RESERVED_VARCHAR_13,
        RESERVED_VARCHAR_14,
        RESERVED_VARCHAR_15,
        RESERVED_VARCHAR_16,
        RESERVED_VARCHAR_17,
        RESERVED_VARCHAR_18,
        RESERVED_VARCHAR_19,
        RESERVED_VARCHAR_20,
        RESERVED_VARCHAR_21,
        RESERVED_VARCHAR_22,
        RESERVED_VARCHAR_23,
        RESERVED_VARCHAR_24,
        RESERVED_VARCHAR_25,
        RESERVED_VARCHAR_26,
        RESERVED_VARCHAR_27,
        RESERVED_VARCHAR_28,
        RESERVED_VARCHAR_29,
        RESERVED_VARCHAR_30,
        RESERVED_AMOUNT_1,
        RESERVED_AMOUNT_2,
        RESERVED_AMOUNT_3,
        RESERVED_AMOUNT_4,
        RESERVED_AMOUNT_5,
        RESERVED_AMOUNT_6,
        RESERVED_AMOUNT_7,
        RESERVED_AMOUNT_8,
        RESERVED_AMOUNT_9,
        RESERVED_AMOUNT_10,
        RESERVED_AMOUNT_11,
        RESERVED_AMOUNT_12,
        RESERVED_AMOUNT_13,
        RESERVED_AMOUNT_14,
        RESERVED_AMOUNT_15,
        RESERVED_AMOUNT_16,
        RESERVED_AMOUNT_17,
        RESERVED_AMOUNT_18,
        RESERVED_AMOUNT_19,
        RESERVED_AMOUNT_20,
        RESERVED_RATE_1,
        RESERVED_RATE_2,
        RESERVED_RATE_3,
        RESERVED_RATE_4,
        RESERVED_RATE_5,
        RESERVED_RATE_6,
        RESERVED_RATE_7,
        RESERVED_RATE_8,
        RESERVED_RATE_9,
        RESERVED_RATE_10,
        RESERVED_FLAG_1,
        RESERVED_FLAG_2,
        RESERVED_FLAG_3,
        RESERVED_FLAG_4,
        RESERVED_FLAG_5,
        RESERVED_FLAG_6,
        RESERVED_FLAG_7,
        RESERVED_FLAG_8,
        RESERVED_FLAG_9,
        RESERVED_FLAG_10,
        RESERVED_DATE_1,
        RESERVED_DATE_2,
        RESERVED_DATE_3,
        RESERVED_DATE_4,
        RESERVED_DATE_5,
        RESERVED_DATE_6,
        RESERVED_DATE_7,
        RESERVED_DATE_8,
        RESERVED_DATE_9,
        RESERVED_DATE_10
    )
    SELECT
        PKID,
        DOWNLOAD_DATE,
        MASTERID,
        MASTER_ACCOUNT_CODE,
        DATA_SOURCE,
        GLOBAL_CUSTOMER_NUMBER,
        CUSTOMER_NUMBER,
        CUSTOMER_NAME,
        FACILITY_NUMBER,
        ACCOUNT_NUMBER,
        PREVIOUS_ACCOUNT_NUMBER,
        ACCOUNT_STATUS,
        INTEREST_RATE,
        MARKET_RATE,
        PRODUCT_GROUP,
        PRODUCT_TYPE,
        PRODUCT_CODE,
        PRODUCT_ENTITY,
        GL_CONSTNAME,
        BRANCH_CODE,
        BRANCH_CODE_OPEN,
        CURRENCY,
        EXCHANGE_RATE,
        INITIAL_OUTSTANDING,
        OUTSTANDING,
        OUTSTANDING_IDC,
        OUTSTANDING_JF,
        OUTSTANDING_BANK,
        OUTSTANDING_PASTDUE,
        PLAFOND,
        PLAFOND_CASH,
        INTEREST_ACCRUED,
        INSTALLMENT_AMOUNT,
        UNUSED_AMOUNT,
        DOWN_PAYMENT_AMOUNT,
        JF_FLAG,
        LOAN_START_DATE,
        LOAN_DUE_DATE,
        LOAN_START_AMORTIZATION,
        LOAN_END_AMORTIZATION,
        INSTALLMENT_GRACE_PERIOD,
        NEXT_PAYMENT_DATE,
        NEXT_INT_PAYMENT_DATE,
        LAST_PAYMENT_DATE,
        FIRST_INSTALLMENT_DATE,
        TENOR,
        REMAINING_TENOR,
        PAYMENT_CODE,
        PAYMENT_TERM,
        INTEREST_CALCULATION_CODE,
        INTEREST_PAYMENT_TERM,
        RESTRUCTURE_DATE,
        RESTRUCTURE_FLAG,
        POCI_FLAG,
        STAFF_LOAN_FLAG,
        BELOW_MARKET_FLAG,
        BTB_FLAG,
        COMMITTED_FLAG,
        REVOLVING_FLAG,
        IAS_CLASS,
        IFRS9_CLASS,
        BM_RESULT,
        SPPI_RESULT,
        AMORT_TYPE,
        EIR_STATUS,
        ECF_STATUS,
        EIR,
        EIR_AMOUNT,
        FAIR_VALUE_AMOUNT,
        INITIAL_UNAMORT_TXN_COST,
        INITIAL_UNAMORT_ORG_FEE,
        UNAMORT_COST_AMT,
        UNAMORT_FEE_AMT,
        UNAMORT_BENEFIT,
        DAILY_AMORT_AMT,
        UNAMORT_AMT_TOTAL_JF,
        UNAMORT_FEE_AMT_JF,
        UNAMORT_COST_AMT_JF,
        ORIGINAL_COLLECTABILITY,
        BI_COLLECTABILITY,
        DAY_PAST_DUE,
        DPD_START_DATE,
        DPD_ZERO_COUNTER,
        NPL_DATE,
        NPL_FLAG,
        DEFAULT_DATE,
        DEFAULT_FLAG,
        WRITEOFF_FLAG,
        WRITEOFF_DATE,
        OUTSTANDING_WO,
        IMPAIRED_FLAG,
        IS_IMPAIRED,
        GROUP_SEGMENT,
        SEGMENT,
        SUB_SEGMENT,
        CR_STAGE,
        LIFETIME,
        EAD_RULE_ID,
        EAD_SEGMENT,
        EAD_AMOUNT,
        LGD_RULE_ID,
        LGD_SEGMENT,
        PD_RULE_ID,
        PD_SEGMENT,
        BUCKET_GROUP,
        BUCKET_ID,
        RATING_CODE,
        ECL_12_AMOUNT,
        ECL_LIFETIME_AMOUNT,
        ECL_AMOUNT,
        CA_UNWINDING_AMOUNT,
        IA_UNWINDING_AMOUNT,
        IA_UNWINDING_SUM_AMOUNT,
        BEGINNING_BALANCE,
        ENDING_BALANCE,
        WRITEBACK_AMOUNT,
        CHARGE_AMOUNT,
        RESERVED_VARCHAR_1,
        RESERVED_VARCHAR_2,
        RESERVED_VARCHAR_3,
        RESERVED_VARCHAR_4,
        RESERVED_VARCHAR_5,
        RESERVED_VARCHAR_6,
        RESERVED_VARCHAR_7,
        RESERVED_VARCHAR_8,
        RESERVED_VARCHAR_9,
        RESERVED_VARCHAR_10,
        RESERVED_VARCHAR_11,
        RESERVED_VARCHAR_12,
        RESERVED_VARCHAR_13,
        RESERVED_VARCHAR_14,
        RESERVED_VARCHAR_15,
        RESERVED_VARCHAR_16,
        RESERVED_VARCHAR_17,
        RESERVED_VARCHAR_18,
        RESERVED_VARCHAR_19,
        RESERVED_VARCHAR_20,
        RESERVED_VARCHAR_21,
        RESERVED_VARCHAR_22,
        RESERVED_VARCHAR_23,
        RESERVED_VARCHAR_24,
        RESERVED_VARCHAR_25,
        RESERVED_VARCHAR_26,
        RESERVED_VARCHAR_27,
        RESERVED_VARCHAR_28,
        RESERVED_VARCHAR_29,
        RESERVED_VARCHAR_30,
        RESERVED_AMOUNT_1,
        RESERVED_AMOUNT_2,
        RESERVED_AMOUNT_3,
        RESERVED_AMOUNT_4,
        RESERVED_AMOUNT_5,
        RESERVED_AMOUNT_6,
        RESERVED_AMOUNT_7,
        RESERVED_AMOUNT_8,
        RESERVED_AMOUNT_9,
        RESERVED_AMOUNT_10,
        RESERVED_AMOUNT_11,
        RESERVED_AMOUNT_12,
        RESERVED_AMOUNT_13,
        RESERVED_AMOUNT_14,
        RESERVED_AMOUNT_15,
        RESERVED_AMOUNT_16,
        RESERVED_AMOUNT_17,
        RESERVED_AMOUNT_18,
        RESERVED_AMOUNT_19,
        RESERVED_AMOUNT_20,
        RESERVED_RATE_1,
        RESERVED_RATE_2,
        RESERVED_RATE_3,
        RESERVED_RATE_4,
        RESERVED_RATE_5,
        RESERVED_RATE_6,
        RESERVED_RATE_7,
        RESERVED_RATE_8,
        RESERVED_RATE_9,
        RESERVED_RATE_10,
        RESERVED_FLAG_1,
        RESERVED_FLAG_2,
        RESERVED_FLAG_3,
        RESERVED_FLAG_4,
        RESERVED_FLAG_5,
        RESERVED_FLAG_6,
        RESERVED_FLAG_7,
        RESERVED_FLAG_8,
        RESERVED_FLAG_9,
        RESERVED_FLAG_10,
        RESERVED_DATE_1,
        RESERVED_DATE_2,
        RESERVED_DATE_3,
        RESERVED_DATE_4,
        RESERVED_DATE_5,
        RESERVED_DATE_6,
        RESERVED_DATE_7,
        RESERVED_DATE_8,
        RESERVED_DATE_9,
        RESERVED_DATE_10
     FROM IFRS_MASTER_ACCOUNT_MONTHLY WHERE DOWNLOAD_DATE = v_LASTMONTH AND DATA_SOURCE = v_DATASOURCE;

    --INSERT CURRDATE INTO TABLE IFRS_NOMINAIVE_MONTHLY
    INSERT INTO IFRS_NOMINATIVE_MONTHLY(
        SESSIONID,
        MASTERID,
        REPORT_DATE,
        SOURCE_TYPE,
        DATA_SOURCE,
        BRANCH_CODE,
        --LBU_FORM,
        NOREK_LBU,
        FACILITY_NUMBER,
        ACCOUNT_NUMBER,
        CUSTOMER_NUMBER,
        CUSTOMER_NAME,
        SECTOR_ECONOMIC,
        SECTOR_COMMODITY,
        GOL_DEB,
        PRODUCT_GROUP,
        PRODUCT_TYPE,
        PRODUCT_CODE,
        --PRODUCT_DESC,
        START_DATE,
        MATURITY_DATE,
        NEXT_PAYMENT_DATE,
        DAY_PAST_DUE,
        RATING_CODE,
        WORSTCASE_RATING,
        IMP_RATING,
        SEGMENTATION,
        BUCKET_NAME,
        BI_COLLECTABILITY,
        NPL_FLAG,
        WRITEOFF_FLAG,
        BTB_FLAG,
        STAGE,
        ASSESSMENT_IMP,
        IMP_CHANGE_REASON,
        IMP_100PERCENT_REASON,
        CONTRACTUAL_INTEREST_RATE,
        EIR,
        INTEREST_CALCULATION_CODE,
        IFRS9_CLASS,
        CURRENCY,
        EXCHANGE_RATE,
        MARKET_RATE,
        OUTSTANDING_PRINCIPAL_CCY,
        OUTSTANDING_PRINCIPAL_LCL,
        OUTSTANDING_PRINCIPAL_DIFF,
        CARRYING_AMOUNT_CCY,
        CARRYING_AMOUNT_LCL,
        EAD_AMOUNT_CCY,
        EAD_AMOUNT_LCL,
        SALDO_YADIT_CCY,
        SALDO_YADIT_LCL,
        INITIAL_FEE_COST_CCY,
        INITIAL_FEE_COST_LCL,
        UNAMORT_FEE_AMT_CCY,
        UNAMORT_FEE_AMT_LCL,
        UNAMORT_COST_AMT_CCY,
        UNAMORT_COST_AMT_LCL,
        STAGE_1_CCY,
        STAGE_1_LCL,
        STAGE_2_CCY,
        STAGE_2_LCL,
        STAGE_3_CCY,
        STAGE_3_LCL,
        ECL_INDIVIDUAL_CCY,
        ECL_INDIVIDUAL_LCL,
        ECL_WORSTCASE_CCY,
        ECL_WORTCASE_LCL,
        ECL_COLLECTIVE_CCY,
        ECL_COLLECTIVE_LCL,
        ECL_TOTAL_CCY,
        ECL_TOTAL_LCL,
        ECL_TOTAL_DIFF,
        PV_EXPECTED_CF_IA_CCY,
        PV_EXPECTED_CF_IA_LCL,
        IA_UNWINDING_INTEREST_CCY,
        IA_UNWINDING_INTEREST_LCL
    )
    SELECT
        v_SESSIONID             AS "SESSIONID",
        IMA.MASTERID            AS "MASTERID",
        IMA.DOWNLOAD_DATE       AS "REPORT_DATE",
        v_SOURCETYPE            AS "SOURCE_TYPE",
        IMA.DATA_SOURCE         AS "DATA_SOURCE",
        IMA.BRANCH_CODE         AS "BRANCH_CODE",
        --PRD.RESERVED_VARCHAR_1  AS "LBU_FORM",
        IMA.RESERVED_VARCHAR_3  AS "NOREK_LBU",
        IMA.FACILITY_NUMBER     AS "FACILITY_NUMBER",
        IMA.ACCOUNT_NUMBER      AS "ACCOUNT_NUMBER",
        IMA.CUSTOMER_NUMBER     AS "CUSTOMER_NUMBER",
        IMA.CUSTOMER_NAME       AS "CUSTOMER_NAME",
        IMA.RESERVED_VARCHAR_10 AS "SECTOR_ECONOMIC",
        IMA.RESERVED_VARCHAR_11 AS "SECTOR_COMMODITY",
        IMA.RESERVED_VARCHAR_2  AS "GOL_DEB",
        IMA.PRODUCT_GROUP       AS "PRODUCT_GROUP",
        IMA.PRODUCT_TYPE        AS "PRODUCT_TYPE",
        IMA.PRODUCT_CODE        AS "PRODUCT_CODE",
        --PRD.PRD_DESC            AS "PRODUCT_DESC",
        IMA.LOAN_START_DATE     AS "START_DATE",
        IMA.LOAN_DUE_DATE       AS "MATURITY_DATE",
        IMA.NEXT_PAYMENT_DATE   AS "NEXT_PAYMENT_DATE",
        IMA.DAY_PAST_DUE        AS "DAY_PAST_DUE",
        IMA.RESERVED_VARCHAR_12 AS "RATING_CODE",
        ''                      AS "WORSTCASE_RATING",
        ''                      AS "IMP_RATING",
        ''                      AS "SEGMENTATION",
        IMA.BUCKET_ID                           AS "BUCKET_NAME",
        IMA.BI_COLLECTABILITY                   AS "BI_COLLECTABILITY",
        DECODE(IMA.NPL_FLAG,1, 'Y', 0, 'N')     AS "NPL_FLAG",
        DECODE(IMA.WRITEOFF_FLAG,1,'Y',0,'N')   AS "WRITEOFF_FLAG",
        DECODE(IMA.BTB_FLAG,1,'Y',0,'N')        AS "BTB_FLAG",
        IMA.CR_STAGE                            AS "STAGE",
        DECODE(IMA.RESERVED_VARCHAR_22,'WC','WC',IMA.IMPAIRED_FLAG) AS "ASSESSMENT_IMP",
        ''  AS IMP_CHANGE_REASON,
        ''  AS IMP_100PERCENT_REASON,
        IMA.INTEREST_RATE       AS "CONTRACTUAL_INTEREST_RATE",
        IMA.EIR                 AS "EIR",
        ICC.DESCRIPTION         AS "INTEREST_CALCULATION_CODE",
        IMA.IFRS9_CLASS         AS "IFRS9_CLASS",
        IMA.CURRENCY            AS "CURRENCY",
        IMA.EXCHANGE_RATE       AS "EXCHANGE_RATE",
        IMA.MARKET_RATE         AS "MARKET_RATE",
        NVL(IMA.OUTSTANDING,0)  AS "OUTSTANDING_PRINCIPAL_CCY",
        NVL(IMA.OUTSTANDING,0) * NVL(IMA.EXCHANGE_RATE,1)                               AS "OUTSTANDING_PRINCIPAL_LCL",
        (NVL(IMA.OUTSTANDING,0) - NVL(PREV.OUTSTANDING,0)) * NVL(IMA.EXCHANGE_RATE,1)   AS "OUTSTANDING_PRINCIPAL_DIFF",
        NVL(IMA.FAIR_VALUE_AMOUNT,0)                                AS "CARRYING_AMOUNT_CCY",
        NVL(IMA.FAIR_VALUE_AMOUNT,0) * NVL(IMA.EXCHANGE_RATE,1)     AS "CARRYING_AMOUNT_LCL",
        NVL(IMA.EAD_AMOUNT,0)                                       AS "EAD_AMOUNT_CCY",
        NVL(IMA.EAD_AMOUNT,0) * NVL(IMA.EXCHANGE_RATE,1)            AS "EAD_AMOUNT_LCL",
        NVL(IMA.RESERVED_AMOUNT_1,0)                                                AS "SALDO_YADIT_CCY",
        NVL(IMA.RESERVED_AMOUNT_1,0) * NVL(IMA.EXCHANGE_RATE,1)                     AS "SALDO_YADIT_LCL",
        NVL(IMA.INITIAL_UNAMORT_TXN_COST,0) + NVL(IMA.INITIAL_UNAMORT_ORG_FEE,0)    AS "INITIAL_FEE_COST_CCY",
        (NVL(IMA.INITIAL_UNAMORT_TXN_COST,0) + NVL(IMA.INITIAL_UNAMORT_ORG_FEE,0)) * NVL(IMA.EXCHANGE_RATE,1)  AS "INITIAL_FEE_COST_LCL",
        NVL(IMA.UNAMORT_FEE_AMT,0)                                                AS "UNAMORT_FEE_AMT_CCY",
        NVL(IMA.UNAMORT_FEE_AMT,0) * NVL(IMA.EXCHANGE_RATE,1)                     AS "UNAMORT_FEE_AMT_LCL",
        NVL(IMA.UNAMORT_COST_AMT,0)                                               AS "UNAMORT_COST_AMT_CCY",
        NVL(IMA.UNAMORT_COST_AMT,0) * NVL(IMA.EXCHANGE_RATE,1)                    AS "UNAMORT_COST_AMT_LCL",
        NVL(IMA.ECL_12_AMOUNT,0)                                    AS "STAGE_1_CCY",
        NVL(IMA.ECL_12_AMOUNT,0) * NVL(IMA.EXCHANGE_RATE,1)         AS "STAGE_1_LCL",
        NVL(IMA.ECL_LIFETIME_AMOUNT,0)                              AS "STAGE_2_CCY",
        NVL(IMA.ECL_LIFETIME_AMOUNT,0) * NVL(IMA.EXCHANGE_RATE,1)   AS "STAGE_2_LCL",
        NVL(IMA.ECL_AMOUNT,0)                                       AS "STAGE_3_CCY",
        NVL(IMA.ECL_AMOUNT,0) * NVL(IMA.EXCHANGE_RATE,1)            AS "STAGE_3_LCL",
        DECODE(DECODE(IMA.RESERVED_VARCHAR_22,'WC','WC',IMA.IMPAIRED_FLAG),'I', IMA.ECL_AMOUNT,0)                                   AS "ECL_INDIVIDUAL_CCY",
        DECODE(DECODE(IMA.RESERVED_VARCHAR_22,'WC','WC',IMA.IMPAIRED_FLAG),'I', NVL(IMA.ECL_AMOUNT,0) * NVL(IMA.EXCHANGE_RATE,1),0) AS "ECL_INDIVIDUAL_LCL",
        DECODE(DECODE(IMA.RESERVED_VARCHAR_22,'WC','WC',' '),'WC', IMA.ECL_AMOUNT,0)                                                AS "ECL_WORSTCASE_CCY",
        DECODE(DECODE(IMA.RESERVED_VARCHAR_22,'WC','WC',' '),'WC', NVL(IMA.ECL_AMOUNT,0) * NVL(IMA.EXCHANGE_RATE,1),0)              AS "ECL_WORSTCASE_LCL",
        DECODE(DECODE(IMA.RESERVED_VARCHAR_22,'WC','WC',IMA.IMPAIRED_FLAG),'C', IMA.ECL_AMOUNT,0)                                   AS "ECL_INDIVIDUAL_CCY",
        DECODE(DECODE(IMA.RESERVED_VARCHAR_22,'WC','WC',IMA.IMPAIRED_FLAG),'C', NVL(IMA.ECL_AMOUNT,0) * NVL(IMA.EXCHANGE_RATE,1),0) AS "ECL_INDIVIDUAL_LCL",
        NVL(IMA.ECL_AMOUNT,0)                                                       AS "ECL_TOTAL_CCY",
        NVL(IMA.ECL_AMOUNT,0) * NVL(IMA.EXCHANGE_RATE,1)                            AS "ECL_TOTAL_LCL",
        (NVL(IMA.ECL_AMOUNT,0) - NVL(PREV.ECL_AMOUNT,0)) * NVL(IMA.EXCHANGE_RATE,1) AS "ECL_TOTAL_DIFF",
        PAYM.SUM_PV_AMOUNT                                          AS "PV_EXPECTED_CF_IA_CCY",
        PAYM.SUM_PV_AMOUNT * NVL(IMA.EXCHANGE_RATE, 1)              AS "PV_EXPECTED_CF_IA_LCL",
        NVL(IMA.IA_UNWINDING_AMOUNT,0)                              AS "IA_UNWINDING_INTEREST_CCY",
        NVL(IMA.IA_UNWINDING_AMOUNT,0) * NVL(IMA.EXCHANGE_RATE,1)   AS "IA_UNWINDING_INTERST_LCL"
    FROM GTMP_IFRS_MASTER_ACCOUNT IMA
    LEFT JOIN GTMP_IFRS_MASTER_ACCOUNT PREV
        ON IMA.MASTERID = PREV.MASTERID
       AND PREV.DOWNLOAD_DATE = v_LASTMONTH
    LEFT JOIN TBLM_COMMONCODEDETAIL ICC
        ON IMA.INTEREST_CALCULATION_CODE = ICC.VALUE1
       AND ICC.COMMONCODE = 'AP_ICC'
    LEFT JOIN (
        SELECT SUM(NVL(A.PV_AMOUNT,0)) AS SUM_PV_AMOUNT, A.MASTERID FROM TBLT_PAYMENTEXPECTED A
        INNER JOIN (
            SELECT MAX(EFFECTIVE_DATE) AS MAX_EFF_DATE, MASTERID
            FROM TBLT_PAYMENTEXPECTED WHERE EFFECTIVE_DATE <= v_CURRDATE GROUP BY MASTERID
        ) B
        ON A.MASTERID = B.MASTERID
        AND A.EFFECTIVE_DATE = B.MAX_EFF_DATE
        GROUP BY A.MASTERID
    ) PAYM
        ON IMA.MASTERID = PAYM.MASTERID
    WHERE IMA.DOWNLOAD_DATE = v_CURRDATE;
    COMMIT;

    --UPDATE LBU_FORM AND PRODUCT_DESC
    MERGE INTO IFRS_NOMINATIVE_MONTHLY NOM
    USING (
        SELECT
            NVL(DATA_SOURCE, 'ALL') AS DATA_SOURCE,
            NVL(PRD_TYPE, 'ALL')    AS PRD_TYPE,
            NVL(PRD_CODE, 'ALL')    AS PRD_CODE,
            NVL(CCY, 'ALL')         AS CCY,
            PRD_DESC,
            RESERVED_VARCHAR_1      AS LBU_FORM
         FROM IFRS_MASTER_PRODUCT_PARAM
    ) PRD
    ON (
       (PRD.DATA_SOURCE = NOM.DATA_SOURCE   OR PRD.DATA_SOURCE = 'ALL')
       AND (PRD.PRD_TYPE = NOM.PRODUCT_TYPE     OR PRD.PRD_TYPE = 'ALL')
       AND (PRD.PRD_CODE = NOM.PRODUCT_CODE     OR PRD.PRD_CODE = 'ALL')
       AND (PRD.CCY = NOM.CURRENCY              OR PRD.CCY = 'ALL')
       AND NOM.REPORT_DATE = V_CURRDATE
       AND NOM.SOURCE_TYPE = V_SOURCETYPE
    )
    WHEN MATCHED THEN
        UPDATE SET  NOM.LBU_FORM = PRD.LBU_FORM,
                    NOM.PRODUCT_DESC = PRD.PRD_DESC;

END;