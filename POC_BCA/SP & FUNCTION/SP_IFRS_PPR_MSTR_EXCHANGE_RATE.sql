CREATE OR REPLACE PROCEDURE SP_IFRS_PPR_MSTR_EXCHANGE_RATE
AS
    V_CURRDATE DATE;
BEGIN
   SELECT CURRDATE INTO V_CURRDATE FROM IFRS_PRC_DATE_LGD;


/*
4. SELECT * FROM IFRS_MASTER_EXCHANGE_RATE WHERE DOWNLOAD_DATE = IFRS_MASTER_ACCOUNT_MONTHLY.DOWNLOAD_DATE;
*/

    MERGE INTO IFRS_PPR_MASTER_EXCHANGE_RATE D
    USING (
            SELECT DISTINCT A.DOWNLOAD_DATE,
                A.CURRENCY,
                CURRENCY_DESC,
                RATE_AMOUNT,
                MAINTAIN_DATE
            FROM IFRS_MASTER_EXCHANGE_RATE A
                INNER JOIN IFRS_PPR_IMA_MONTHLY B ON A.DOWNLOAD_DATE=B.DOWNLOAD_DATE
                    AND A.CURRENCY	= B.CURRENCY
            WHERE B.DOWNLOAD_DATE = LAST_DAY(V_CURRDATE)
          ) S ON (D.DOWNLOAD_DATE=S.DOWNLOAD_DATE)
    WHEN NOT MATCHED THEN
    INSERT (DOWNLOAD_DATE,
            CURRENCY,
            CURRENCY_DESC,
            RATE_AMOUNT,
            MAINTAIN_DATE)
    VALUES (S.DOWNLOAD_DATE,
            S.CURRENCY,
            S.CURRENCY_DESC,
            S.RATE_AMOUNT,
            S.MAINTAIN_DATE);
    COMMIT;
END;