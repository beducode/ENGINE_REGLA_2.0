CREATE OR REPLACE PROCEDURE SP_IFRS_PPR_IMA_MONTHLY
AS
    V_CURRDATE DATE;
BEGIN

    SELECT CURRDATE INTO V_CURRDATE FROM IFRS_PRC_DATE_LGD;*
1. SELECT DOWNLOAD_DATE, MASTERID, ACCOUNT_NUMBER, OUTSTANDING, CURRENCY, BI_COLLECTABILITY, REVOLVING_FLAG, PREPAYMENT_SEGMENT, EXCHANGE_RATE
   FROM IFRS_MASTER_ACCOUNT_MONTHLY
   WHERE PREPAYMENT_SEGMENT = [SESUAI PREPAYMENT_SEGMENT]
   AND MASTERID NOT IN IFRS_PPR_BI_COLLECTABILITY
   AND REVOLVING_FLAG = 0
	AND ACCOUNT_STATUS!=C;
	*/

    MERGE INTO IFRS_PPR_IMA_MONTHLY D
    USING (
            SELECT
                A.DOWNLOAD_DATE,
                A.MASTERID,
                A.ACCOUNT_NUMBER,
                A.CUSTOMER_NUMBER,
                A.CUSTOMER_NAME,
                A.OUTSTANDING,
                A.CURRENCY,
                A.BI_COLLECTABILITY,
                A.REVOLVING_FLAG,
                A.RESERVED_VARCHAR_2 PREPAYMENT_SEGMENT,
                A.PREPAYMENT_RULE_ID,
                A.EXCHANGE_RATE,
                A.DATA_SOURCE
            FROM IFRS_MASTER_ACCOUNT_MONTHLY A
                LEFT JOIN IFRS_PPR_BI_COLLECTABILITY B ON A.DOWNLOAD_DATE = B.DOWNLOAD_DATE
                    AND A.ACCOUNT_NUMBER = B.ACCOUNT_NUMBER
                    AND A.MASTERID = B.MASTERID
            WHERE A.REVOLVING_FLAG = 0
                AND A.ACCOUNT_STATUS != 'C'
                AND A.DOWNLOAD_DATE = LAST_DAY(V_CURRDATE)
                AND B.MASTERID IS NULL
                AND A.DATA_SOURCE='ILS'
           ) S ON (D.DOWNLOAD_DATE = S.DOWNLOAD_DATE
                   AND D.ACCOUNT_NUMBER = S.ACCOUNT_NUMBER)
    WHEN NOT MATCHED THEN
    INSERT (DOWNLOAD_DATE,
            MASTERID,
            ACCOUNT_NUMBER,
            CUSTOMER_NUMBER,
            CUSTOMER_NAME,
            OUTSTANDING,
            CURRENCY,
            BI_COLLECTABILITY,
            REVOLVING_FLAG,
            PREPAYMENT_SEGMENT,
            PREPAYMENT_RULE_ID,
            EXCHANGE_RATE,
            IDR_OUTSTANDING,
            DATA_SOURCE)
    VALUES (S.DOWNLOAD_DATE,
            S.MASTERID,
            S.ACCOUNT_NUMBER,
            S.CUSTOMER_NUMBER,
            S.CUSTOMER_NAME,
            S.OUTSTANDING,
            S.CURRENCY,
            S.BI_COLLECTABILITY,
            S.REVOLVING_FLAG,
            S.PREPAYMENT_SEGMENT,
            S.PREPAYMENT_RULE_ID,
            S.EXCHANGE_RATE,
            0,
            S.DATA_SOURCE) ;
    COMMIT;
END;