create view IFRS9_BCA.VW_AC_PRODUCT_CLASS as
SELECT VALUE AS PRD_CODE,
          ASSET_CLASS,
          A.SPPI_RSLT,
          BM_RSLT
     FROM (
            SELECT * FROM
            (
                SELECT COALESCE(B3.SPPIID, A3.SPPIID) SPPIID,
                        COALESCE (B3.ASSET_CLASS, A3.ASSETCLASSOVERRIDE, A3.ASSETCLASS) AS ASSET_CLASS,
                        COALESCE (B3.SPPIRESULT,A3.SPPIRESULT)                          AS SPPI_RSLT,
                        COALESCE (B3.BMRESULT,A3.BMRESULT)                              AS BM_RSLT,
                        COALESCE (B3.EFFECTIVE_DATE,A3.EFFECTIVE_DATE)                  AS EFFECTIVE_DATE
                FROM IFRS_AC_RESULT A3
                LEFT JOIN 
                (
                    SELECT A4.REFPKID,
                          SPPIID,
                          NVL (ASSETCLASSOVERRIDE, ASSETCLASS) AS ASSET_CLASS,
                          SPPIRESULT,
                          BMRESULT,
                          EFFECTIVE_DATE 
                    FROM IFRS_AC_RESULT_HIST A4
                    JOIN (
                        SELECT REFPKID, MAX(PKID) AS PKID
                        FROM IFRS_AC_RESULT_HIST A5
                        JOIN IFRS_PRC_DATE_AMORT B5
                        ON TRUNC(A5.REVIEWEDDATE) <= B5.CURRDATE
                        AND A5.EFFECTIVE_DATE <= B5.CURRDATE
                        GROUP BY REFPKID
                    ) B4
                    ON A4.PKID = B4.PKID
                ) B3 ON A3.PKID = B3.REFPKID
            ) A2
              JOIN IFRS_PRC_DATE_AMORT B2
              ON A2.EFFECTIVE_DATE <= B2.CURRDATE
          ) A
          JOIN IFRS_AC_SPPI_HEADER B ON A.SPPIID = B.PKID
          CROSS APPLY (    SELECT REGEXP_SUBSTR (B.PRODUCT_CODE,
                                                 '[^,]+',
                                                 1,
                                                 LEVEL)
                                     AS VALUE
                             FROM DUAL
                       CONNECT BY REGEXP_SUBSTR (B.PRODUCT_CODE,
                                                 '[^,]+',
                                                 1,
                                                 LEVEL)
                                     IS NOT NULL);

create view IFRS9_BCA.VW_LAST_EIR_CF_PREV as
SELECT MASTERID, DOWNLOAD_DATE, SEQ
     FROM IFRS_ACCT_EIR_COST_FEE_PREV
    WHERE ID IN (  SELECT MAX (ID) ID
                     FROM IFRS_ACCT_EIR_COST_FEE_PREV
                 GROUP BY MASTERID);

create view IFRS9_BCA.VW_LAST_EIR_CF_PREV_YEST as
SELECT MASTERID, DOWNLOAD_DATE, SEQ
     FROM IFRS_ACCT_EIR_COST_FEE_PREV
    WHERE ID IN (  SELECT MAX (ID) ID
                     FROM IFRS_ACCT_EIR_COST_FEE_PREV
                    WHERE DOWNLOAD_DATE IN (SELECT PREVDATE
                                              FROM IFRS_PRC_DATE_AMORT)
                 GROUP BY MASTERID);

create view IFRS9_BCA.VW_LAST_EIR_COST_FEE_PREV as
SELECT DOWNLOAD_DATE, MASTERID, SEQ
    FROM IFRS_ACCT_EIR_COST_FEE_PREV
    WHERE ID IN 
    (  
        SELECT MAX (ID) ID
        FROM IFRS_ACCT_EIR_COST_FEE_PREV
        GROUP BY MASTERID
    );

create view IFRS9_BCA.VW_LAST_EIR_COST_FEE_PREV_YES as
SELECT MASTERID, DOWNLOAD_DATE, SEQ
     FROM IFRS_ACCT_EIR_COST_FEE_PREV
    WHERE ID IN (  SELECT MAX (ID) ID
                     FROM IFRS_ACCT_EIR_COST_FEE_PREV
                    WHERE DOWNLOAD_DATE IN (SELECT PREVDATE
                                              FROM IFRS_PRC_DATE_AMORT)
                 GROUP BY MASTERID);

create view IFRS9_BCA.VW_LAST_SL_COST_FEE_PREV as
SELECT MASTERID, DOWNLOAD_DATE, SEQ
     FROM IFRS_ACCT_SL_COST_FEE_PREV
    WHERE id IN (  SELECT MAX (id) id
                     FROM IFRS_acct_sl_cost_fee_prev
                 GROUP BY masterid);

create view IFRS9_BCA.VW_LBM_LAST_EIR_CF_PREV as
SELECT MASTERID, DOWNLOAD_DATE, SEQ
     FROM IFRS_LBM_ACCT_EIR_CF_PREV
    WHERE ID IN (  SELECT MAX (ID) ID
                     FROM IFRS_LBM_ACCT_EIR_CF_PREV
                 GROUP BY MASTERID);

create view IFRS9_BCA.VW_LBM_LAST_EIR_CF_PREV_YEST as
SELECT MASTERID, DOWNLOAD_DATE, SEQ
     FROM IFRS_LBM_ACCT_EIR_CF_PREV
    WHERE ID IN (  SELECT MAX (ID) ID
                     FROM IFRS_LBM_ACCT_EIR_CF_PREV
                    WHERE DOWNLOAD_DATE IN (SELECT PREVDATE
                                              FROM IFRS_PRC_DATE_AMORT)
                 GROUP BY MASTERID);

create view IFRS9_BCA.VW_LI_LAST_EIR_CF_PREV as
SELECT MASTERID, DOWNLOAD_DATE, SEQ
     FROM IFRS_ACCT_EIR_COST_FEE_PREV
    WHERE id IN (  SELECT MAX (id) id
                     FROM IFRS_acct_eir_cost_fee_prev
                 GROUP BY MASTERID);

create view IFRS9_BCA.VW_LI_LAST_EIR_CF_PREV_YEST as
SELECT MASTERID, DOWNLOAD_DATE, SEQ
     FROM IFRS_ACCT_EIR_COST_FEE_PREV
    WHERE ID IN (  SELECT MAX (ID) ID
                     FROM IFRS_ACCT_EIR_COST_FEE_PREV
                    WHERE DOWNLOAD_DATE IN (SELECT PREVDATE
                                              FROM IFRS_PRC_DATE_AMORT)
                 GROUP BY MASTERID);

create view IFRS9_BCA.VW_LI_LAST_SL_CF_PREV as
SELECT MASTERID, DOWNLOAD_DATE, SEQ
     FROM IFRS_ACCT_SL_COST_FEE_PREV
    WHERE id IN (  SELECT MAX (id) id
                     FROM IFRS_acct_sl_cost_fee_prev
                 GROUP BY MASTERID);

create view IFRS9_BCA.VW_LI_LAST_SL_CF_PREV_YEST as
SELECT MASTERID, DOWNLOAD_DATE, SEQ
     FROM IFRS_ACCT_SL_COST_FEE_PREV
    WHERE ID IN (  SELECT MAX (ID) ID
                     FROM IFRS_ACCT_SL_COST_FEE_PREV
                    WHERE DOWNLOAD_DATE IN (SELECT PREVDATE
                                              FROM IFRS_PRC_DATE_AMORT)
                 GROUP BY MASTERID);

create view IFRS9_BCA.VW_AC_UNPROCESS_PRODUCT as
SELECT ROW_NUMBER () OVER (ORDER BY DATA_SOURCE, PRD_CODE) AS "PKID",
          A."DATA_SOURCE",
          A."PRD_GROUP",
          A."PRD_TYPE",
          A."PRD_CODE",
          A."PRD_DESC",
          A."CCY"
     FROM (SELECT DATA_SOURCE,
                  PRD_GROUP,
                  PRD_TYPE,
                  PRD_CODE,
                  PRD_DESC,
                  CCY
             FROM IFRS_MASTER_PRODUCT_PARAM
           UNION
           SELECT DATA_SOURCE,
                  ' '      PRD_GROUP,
                  ' '      PRD_TYPE,
                  SEC_ID   AS PRD_CODE,
                  SEC_NAME PRD_DESC,
                  'ALL'    CCY
             FROM IFRS_MASTER_SECID) A
    WHERE A.PRD_CODE NOT IN (SELECT PRODUCTCODE
                               FROM IFRS_AC_SPPI_HEADER A
                                    CROSS APPLY
                                    (    SELECT REGEXP_SUBSTR (A.PRODUCT_CODE,
                                                               '[^,]+',
                                                               1,
                                                               LEVEL)
                                                   AS PRODUCTCODE
                                           FROM DUAL
                                     CONNECT BY REGEXP_SUBSTR (
                                                   A.PRODUCT_CODE,
                                                   '[^,]+',
                                                   1,
                                                   LEVEL)
                                                   IS NOT NULL));

create view IFRS9_BCA.VW_AC_PRODUCT_LIST as
SELECT ROW_NUMBER () OVER (ORDER BY DATA_SOURCE, PRD_CODE) AS "PKID",
          A."DATA_SOURCE",
          A."PRD_GROUP",
          A."PRD_TYPE",
          A."PRD_CODE",
          A."PRD_DESC",
          A."CCY"
     FROM (SELECT DATA_SOURCE,
                  PRD_GROUP,
                  PRD_TYPE,
                  PRD_CODE,
                  PRD_DESC,
                  CCY
             FROM IFRS_MASTER_PRODUCT_PARAM
           UNION
           SELECT DATA_SOURCE,
                  ' '      PRD_GROUP,
                  ' '      PRD_TYPE,
                  SEC_ID   AS PRD_CODE,
                  SEC_NAME PRD_DESC,
                  'ALL'    CCY
             FROM IFRS_MASTER_SECID) A;

create view IFRS9_BCA.VW_LAST_SL_CF_PREV_YEST as
SELECT MASTERID, DOWNLOAD_DATE, SEQ
     FROM IFRS_ACCT_SL_COST_FEE_PREV
    WHERE ID IN (  SELECT MAX (ID) ID
                     FROM IFRS_ACCT_SL_COST_FEE_PREV
                    WHERE DOWNLOAD_DATE IN (SELECT PREVDATE
                                              FROM IFRS_PRC_DATE_AMORT)
                 GROUP BY MASTERID);

create view IFRS9_BCA.VW_IFRS_MAX_BUCKET as
SELECT A.BUCKET_GROUP, MAX_BUCKET_ID
       FROM    IFRS_BUCKET_HEADER A
            JOIN
               (  SELECT BUCKET_HEADER_ID,
                         NVL (B2.BUCKET_ID, MAX (A2.BUCKET_ID)) MAX_BUCKET_ID
                    FROM    IFRS_BUCKET_DETAIL A2
                         LEFT JOIN
                            (  SELECT BUCKET_GROUP,
                                      IMPAIRMENT_BUCKET,
                                      MIN (BUCKET_ID) BUCKET_ID
                                 FROM IFRS_BUCKET_DETAIL A1
                                WHERE NOT EXISTS
                                             (SELECT 1
                                                FROM TBLM_COMMONCODEDETAIL c2
                                               WHERE c2.COMMONCODE = 'B1005'
                                                     AND A1.bucket_group =
                                                            c2.value1
                                                     AND A1.bucket_id = c2.value2)
                             GROUP BY BUCKET_GROUP, IMPAIRMENT_BUCKET
                               HAVING COUNT (*) > 1) B2
                         ON A2.BUCKET_GROUP = B2.BUCKET_GROUP
                   WHERE NOT EXISTS
                                (SELECT 1
                                   FROM TBLM_COMMONCODEDETAIL common
                                  WHERE     common.COMMONCODE = 'B1005'
                                        AND a2.bucket_group = common.value1
                                        AND a2.bucket_id = common.value2)
                GROUP BY BUCKET_HEADER_ID, B2.BUCKET_ID) B
            ON A.PKID = B.BUCKET_HEADER_ID
   ORDER BY BUCKET_GROUP;

create view IFRS9_BCA.VW_IFRS_BUCKET as
SELECT A.BUCKET_GROUP,
        A.BUCKET_DESCRIPTION,
        A.INCLUDE_CLOSE_FLAG,
        A.INCLUDE_WO_FLAG,
        A.INCLUDE_FULLYPAID_FLAG,
        A.OPTION_GROUPING,
        B.BUCKET_ID,
        B.BUCKET_NAME,
        B.RANGE_START,
        B.RANGE_END,
        B.FLAG_DEFAULT,
        B.PD_DEFAULT,
        B.IMPAIRMENT_BUCKET,
        B.MIN_VALUE,
        B.MAX_VALUE
   FROM IFRS_BUCKET_HEADER A
   JOIN IFRS_BUCKET_DETAIL B 
   ON A.PKID = B.BUCKET_HEADER_ID;

create view IFRS9_BCA.VW_R_MODEL_FILTER_PEN as
SELECT MODEL_ID,
          CORRELATION_VAL,
          VARIABLENAME,
          EXPECTED_TREND,
          VARIABLE_SELECTION,
          LOOKUPINITIAL,
          ABS_CORRELATION,
          ADJ_CORRELATION
     FROM R_MODEL_FILTER_DTL_PEN
   UNION
   SELECT MODEL_ID,
          CORRELATION_VAL,
          VARIABLENAME,
          EXPECTED_TREND,
          VARIABLE_SELECTION,
          LOOKUPINITIAL,
          ABS_CORRELATION,
          ADJ_CORRELATION
     FROM R_MODEL_FILTER_CORTEST_PEN
   UNION
   SELECT MODEL_ID,
          CORRELATION_VAL,
          VARIABLENAME,
          EXPECTED_TREND,
          VARIABLE_SELECTION,
          LOOKUPINITIAL,
          ABS_CORRELATION,
          ADJ_CORRELATION
     FROM R_MODEL_FILTER_DTL_FULL_PEN;

create view IFRS9_BCA.VW_MAPPINGRULE_SCREENGROUP as
SELECT A.MAPPINGRULEID,
          B.MAPPINGNAME,
          A.SCREENGROUP,
          C.SCREENGROUPID AS SCREENGROUPNAME
     FROM TBLM_MAP_RULE_SCREENGROUP A
          JOIN TBLM_MAPPINGRULEHEADER_NEW B ON A.MAPPINGRULEID = B.PKID
          JOIN TBLM_SCREENGROUPHEADER C ON A.SCREENGROUP = C.PKID;

create view IFRS9_BCA.VW_R_MODEL_FILTER as
SELECT MODEL_ID,
          CORRELATION_VAL,
          VARIABLENAME,
          EXPECTED_TREND,
          VARIABLE_SELECTION,
          LOOKUPINITIAL,
          ABS_CORRELATION,
          ADJ_CORRELATION
     FROM R_MODEL_FILTER_DTL
   UNION
   SELECT MODEL_ID,
          CORRELATION_VAL,
          VARIABLENAME,
          EXPECTED_TREND,
          VARIABLE_SELECTION,
          LOOKUPINITIAL,
          ABS_CORRELATION,
          ADJ_CORRELATION
     FROM R_MODEL_FILTER_CORTEST
   UNION
   SELECT MODEL_ID,
          CORRELATION_VAL,
          VARIABLENAME,
          EXPECTED_TREND,
          VARIABLE_SELECTION,
          LOOKUPINITIAL,
          ABS_CORRELATION,
          ADJ_CORRELATION
     FROM R_MODEL_FILTER_DTL_FULL;

create view IFRS9_BCA.VW_R_ME_DERIVED_TYPE as
SELECT MODEL_ID, ME_CODE AS DERIVED_TYPE
     FROM IFRS_INDEPENDENT_VARIABLE_PEN A
   UNION ALL
   SELECT MODEL_ID, ME_CODE || '_' || TRANSFORMATIONTYPE AS DERIVED_TYPE
     FROM IFRS_INDEPENDENT_VARIABLE_PEN A
          CROSS APPLY
          (    SELECT REGEXP_SUBSTR (
                         REPLACE (
                            TRANSFORMATION_TYPE,
                            'ALL',
                            'E,Inv,InvE,Ln,Sqrt,diff3,diff4,diff5,diff6,qgrw1,qgrw2,qgrw3,qgrw4'),
                         '[^,]+',
                         1,
                         LEVEL)
                         AS TRANSFORMATIONTYPE
                 FROM DUAL
           CONNECT BY REGEXP_SUBSTR (
                         REPLACE (
                            TRANSFORMATION_TYPE,
                            'ALL',
                            'E,Inv,InvE,Ln,Sqrt,diff3,diff4,diff5,diff6,qgrw1,qgrw2,qgrw3,qgrw4'),
                         '[^,]+',
                         1,
                         LEVEL)
                         IS NOT NULL)
   UNION ALL
   SELECT A.MODEL_ID, A.DERIVED_TYPE || B.DERIVED_TYPE DERIVED_TYPE
     FROM (SELECT MODEL_ID, ME_CODE AS DERIVED_TYPE
             FROM IFRS_INDEPENDENT_VARIABLE_PEN A
           UNION ALL
           SELECT MODEL_ID,
                  ME_CODE || '_' || TRANSFORMATIONTYPE AS DERIVED_TYPE
             FROM IFRS_INDEPENDENT_VARIABLE_PEN A
                  CROSS APPLY
                  (    SELECT REGEXP_SUBSTR (
                                 REPLACE (
                                    TRANSFORMATION_TYPE,
                                    'ALL',
                                    'E,Inv,InvE,Ln,Sqrt,diff3,diff4,diff5,diff6,qgrw1,qgrw2,qgrw3,qgrw4'),
                                 '[^,]+',
                                 1,
                                 LEVEL)
                                 AS TRANSFORMATIONTYPE
                         FROM DUAL
                   CONNECT BY REGEXP_SUBSTR (
                                 REPLACE (
                                    TRANSFORMATION_TYPE,
                                    'ALL',
                                    'E,Inv,InvE,Ln,Sqrt,diff3,diff4,diff5,diff6,qgrw1,qgrw2,qgrw3,qgrw4'),
                                 '[^,]+',
                                 1,
                                 LEVEL)
                                 IS NOT NULL)) A
          CROSS JOIN (SELECT '_Lg1' DERIVED_TYPE FROM DUAL
                      UNION ALL
                      SELECT '_Lg2' DERIVED_TYPE FROM DUAL
                      UNION ALL
                      SELECT '_Lg3' DERIVED_TYPE FROM DUAL
                      UNION ALL
                      SELECT '_Lg4' DERIVED_TYPE FROM DUAL) B;

create view IFRS9_BCA.VW_IFRS_NOMINATIVE_TO_FINMART as
SELECT N.REPORT_DATE,
          N.SOURCE_TYPE,
          N.DATA_SOURCE,
          N.BRANCH_CODE,
          N.LBU_FORM,
          N.NOREK_LBU,
          N.FACILITY_NUMBER,
          N.ACCOUNT_NUMBER,
          N.CUSTOMER_NUMBER,
          N.CUSTOMER_NAME,
          N.SECTOR_ECONOMIC,
          N.SECTOR_COMMODITY,
          N.GOL_DEB,
          N.PRODUCT_GROUP,
          N.PRODUCT_TYPE,
          N.PRODUCT_CODE,
          N.PRODUCT_DESC,
          N.PRODUCT_CODE_GL,
          N.INSTRUMENT,
          N.INV_TYPE,
          N.SEC_NAME,
          N.PORTFOLIO,
          N.CONTRACT_ID,
          N.START_DATE,
          N.MATURITY_DATE,
          N.SETTLE_DATE,
          N.DELINQUENCY,
          N.NEXT_PAYMENT_DATE,
          N.DAY_PAST_DUE,
          N.RATING_CODE,
          N.EXTERNAL_RATING,
          N.SWIFT_CODE,
          N.IMP_RATING,
          N.GROUP_SEGMENT,
          N.SEGMENT,
          N.SUB_SEGMENT,
          N.BUCKET_NAME,
          N.BI_COLLECTABILITY,
          N.STAGE,
          N.LIFETIME_PERIOD,
          N.ASSESSMENT_IMP,
          N.NPL_FLAG,
          N.POCI_FLAG,
          N.BTB_FLAG,
          N.REVOLVING_FLAG,
          N.COMMITMENT_FLAG,
          N.IFRS9_CLASS,
          N.CURRENCY,
          N.EXCHANGE_RATE,
          N.MARKET_RATE,
          N.INTEREST_CALCULATION_CODE,
          N.CONTRACTUAL_INTEREST_RATE,
          N.EIR,
          N.COA_BAL,
          N.PRINCIPAL_AMOUNT_CCY,
          N.PRINCIPAL_AMOUNT_LCL,
          N.INTEREST_RECEIVABLE_CCY,
          N.INTEREST_RECEIVABLE_LCL,
          N.PREMI_DISCOUNT_AMOUNT_CCY,
          N.PREMI_DISCOUNT_AMOUNT_LCL,
          CASE
             WHEN N.DATA_SOURCE = 'KTP' THEN N.PRINCIPAL_AMOUNT_CCY
             WHEN N.DATA_SOURCE = 'RKN' THEN N.OUTSTANDING_PRINCIPAL_CCY
             ELSE N.OUTSTANDING_ON_BS_CCY
          END
             OUTSTANDING_ON_BS_CCY,
          CASE
             WHEN N.DATA_SOURCE = 'KTP' THEN N.PRINCIPAL_AMOUNT_LCL
             WHEN N.DATA_SOURCE = 'RKN' THEN N.OUTSTANDING_PRINCIPAL_LCL
             ELSE N.OUTSTANDING_ON_BS_LCL
          END
             OUTSTANDING_ON_BS_LCL,
          CASE
             WHEN N.DATA_SOURCE IN ('KTP', 'RKN') THEN 0
             ELSE N.OUTSTANDING_OFF_BS_CCY
          END
             OUTSTANDING_OFF_BS_CCY,
          CASE
             WHEN N.DATA_SOURCE IN ('KTP', 'RKN') THEN 0
             ELSE N.OUTSTANDING_OFF_BS_LCL
          END
             OUTSTANDING_OFF_BS_LCL,
          N.CARRYING_AMOUNT_CCY,
          N.CARRYING_AMOUNT_LCL,
          NVL (N.MARKET_RATE, 0)                            MARKET_VALUE_CCY,
          NVL (N.MARKET_RATE, 0) * NVL (N.EXCHANGE_RATE, 1) MARKET_VALUE_LCL,
          N.SALDO_YADIT_CCY,
          N.SALDO_YADIT_LCL,
          N.INITIAL_FEE_CCY,
          N.INITIAL_FEE_LCL,
          N.INITIAL_COST_CCY,
          N.INITIAL_COST_LCL,
          N.AMORT_FEE_CCY,
          N.AMORT_FEE_LCL,
          N.AMORT_COST_CCY,
          N.AMORT_COST_LCL,
          N.UNAMORT_FEE_AMT_CCY,
          N.UNAMORT_FEE_AMT_LCL,
          N.UNAMORT_COST_AMT_CCY,
          N.UNAMORT_COST_AMT_LCL,
          N.PV_EXPECTED_CF_IA_CCY,
          N.PV_EXPECTED_CF_IA_LCL,
          N.IA_UNWINDING_INTEREST_CCY,
          N.IA_UNWINDING_INTEREST_LCL,
          N.LIMIT_AMT_CCY,
          N.CCF_RATE,
          N.CCF_AMOUNT_CCY,
          N.CCF_AMOUNT_LCL,
          N.PREPAYMENT_RATE,
          N.PREPAYMENT_AMOUNT_CCY,
          N.PREPAYMENT_AMOUNT_LCL,
          N.EAD_AMOUNT_CCY,
          N.EAD_AMOUNT_LCL,
          N.ECL_ON_BS_CCY,
          N.ECL_ON_BS_LCL,
          N.ECL_OFF_BS_CCY,
          N.ECL_OFF_BS_LCL,
          N.ECL_TOTAL_CCY,
          N.ECL_TOTAL_LCL,
          N.RESERVED_AMOUNT_2
             AS ECL_ON_BS_FINAL_CCY,
          N.RESERVED_AMOUNT_3
             AS ECL_ON_BS_FINAL_LCL,
          N.RESERVED_AMOUNT_4
             AS ECL_TOTAL_FINAL_CCY,
          N.RESERVED_AMOUNT_5
             AS ECL_TOTAL_FINAL_LCL,
          N.SPECIAL_REASON,
          N.AMORT_FEE_AMT_ILS_CCY,
          N.AMORT_FEE_AMT_ILS_LCL,
          N.UNAMORT_FEE_AMT_ILS_CCY,
          N.UNAMORT_FEE_AMT_ILS_LCL,
          A.CR_STAGE                                        STAGE_ORI,
          NVL (A.RESERVED_FLAG_4, 0)                        AS COVID_FLAG,
          NVL (A.RESTRUCTURE_FLAG, 0)
             AS RESTRUCTURE_FLAG
     FROM IFRS_NOMINATIVE N, IFRS_MASTER_ACCOUNT A
    WHERE     1 = 1
          AND N.REPORT_DATE = (SELECT MAX (REPORT_DATE) FROM IFRS_NOMINATIVE)
          --AND N.REPORT_DATE = '31-DEC-2020'
          AND A.DOWNLOAD_DATE = N.REPORT_DATE
          AND N.MASTERID = A.MASTERID
          AND (   (    N.DATA_SOURCE = 'BTRD'
                   AND N.ACCOUNT_STATUS = 'A'
                   AND NVL (N.BI_CODE, ' ') <> '0')
               OR (    N.DATA_SOURCE = 'CRD'
                   AND (N.ACCOUNT_STATUS = 'A' OR N.outstanding_on_bs_ccy > 0))
               OR (N.DATA_SOURCE = 'ILS' AND N.account_status = 'A')
               OR (N.DATA_SOURCE = 'LIMIT' AND N.account_status = 'A')
               OR (    N.DATA_SOURCE = 'KTP'
                   AND N.ACCOUNT_STATUS = 'A'
                   AND UPPER (N.PRODUCT_CODE) <> 'BORROWING')
               OR (    N.DATA_SOURCE = 'PBMM'
                   AND N.ACCOUNT_STATUS = 'A'
                   AND UPPER (N.PRODUCT_CODE) <> 'BORROWING')
               OR (    N.DATA_SOURCE = 'RKN'
                   AND N.ACCOUNT_STATUS = 'A'
                   AND NVL (N.OUTSTANDING_PRINCIPAL_CCY, 0) >= 0))
          AND NOT EXISTS
                 (SELECT 1
                    FROM IFRS_NOMINATIVE L
                   WHERE     L.REPORT_DATE = N.REPORT_DATE
                         AND L.DATA_SOURCE = 'ILS'
                         AND L.ACCOUNT_STATUS = 'A'
                         AND N.DATA_SOURCE = 'LIMIT'
                         AND N.ACCOUNT_NUMBER = L.FACILITY_NUMBER);

create view IFRS9_BCA.VW_NOMINATIVE_LBU_DIFF as
select "SOURCE","TOTAL_OUTSTANDING_ON_BS_CCY","TOTAL_OUTSTANDING_ON_BS_LCL","TOTAL_OUTSTANDING_OFF_BS_CCY","TOTAL_OUTSTANDING_OFF_BS_LCL","TOTAL_UNAMORT_FEE_AMT_CCY","TOTAL_UNAMORT_FEE_AMT_LCL","TOTAL_INTEREST_RECEIVABLE_CCY","TOTAL_INTEREST_RECEIVABLE_LCL","TOTAL_UNWINDING_INTEREST_CCY","TOTAL_UNWINDING_INTEREST_LCL","TOTAL_AMORT_FEE_CCY","TOTAL_AMORT_FEE_LCL","TOTAL_ECL_ON_BS_CCY","TOTAL_ECL_ON_BS_LCL","TOTAL_ECL_OFF_BS_CCY","TOTAL_ECL_OFF_BS_LCL"
from (
         select 'Nominatif'                    Source,
                SUM(OUTSTANDING_ON_BS_CCY)     TOTAL_OUTSTANDING_ON_BS_CCY,
                SUM(OUTSTANDING_ON_BS_LCL)     TOTAL_OUTSTANDING_ON_BS_LCL,
                SUM(OUTSTANDING_OFF_BS_CCY)    TOTAL_OUTSTANDING_OFF_BS_CCY,
                SUM(OUTSTANDING_OFF_BS_LCL)    TOTAL_OUTSTANDING_OFF_BS_LCL,
                SUM(UNAMORT_FEE_AMT_CCY)       TOTAL_UNAMORT_FEE_AMT_CCY,
                SUM(UNAMORT_FEE_AMT_LCL)       TOTAL_UNAMORT_FEE_AMT_LCL,
                SUM(INTEREST_RECEIVABLE_CCY)   TOTAL_INTEREST_RECEIVABLE_CCY,
                SUM(INTEREST_RECEIVABLE_LCL)   TOTAL_INTEREST_RECEIVABLE_LCL,
                SUM(IA_UNWINDING_INTEREST_CCY) TOTAL_UNWINDING_INTEREST_CCY,
                SUM(IA_UNWINDING_INTEREST_LCL) TOTAL_UNWINDING_INTEREST_LCL,
                SUM(AMORT_FEE_CCY)             TOTAL_AMORT_FEE_CCY,
                SUM(AMORT_FEE_LCL)             TOTAL_AMORT_FEE_LCL,
                SUM(ECL_ON_BS_CCY)             TOTAL_ECL_ON_BS_CCY,
                SUM(ECL_ON_BS_LCL)             TOTAL_ECL_ON_BS_LCL,
                SUM(ECL_OFF_BS_CCY)            TOTAL_ECL_OFF_BS_CCY,
                SUM(ECL_OFF_BS_LCL)            TOTAL_ECL_OFF_BS_LCL
         from IFRS_NOMINATIVE
         where REPORT_DATE = (select max(report_date) from IFRS_NOMINATIVE)
     ) NOMI
union
select "SOURCE","TOTAL_OUTSTANDING_ON_BS_CCY","TOTAL_OUTSTANDING_ON_BS_LCL","TOTAL_OUTSTANDING_OFF_BS_CCY","TOTAL_OUTSTANDING_OFF_BS_LCL","TOTAL_UNAMORT_FEE_AMT_CCY","TOTAL_UNAMORT_FEE_AMT_LCL","TOTAL_INTEREST_RECEIVABLE_CCY","TOTAL_INTEREST_RECEIVABLE_LCL","TOTAL_UNWINDING_INTEREST_CCY","TOTAL_UNWINDING_INTEREST_LCL","TOTAL_AMORT_FEE_CCY","TOTAL_AMORT_FEE_LCL","TOTAL_ECL_ON_BS_CCY","TOTAL_ECL_ON_BS_LCL","TOTAL_ECL_OFF_BS_CCY","TOTAL_ECL_OFF_BS_LCL"
from (
         select 'Textfile LBU'                                               Source,
                SUM(OUTSTANDING_ON_BS_CCY)                                   TOTAL_OUTSTANDING_ON_BS_CCY,
                SUM(OUTSTANDING_ON_BS_LCL)                                   TOTAL_OUTSTANDING_ON_BS_LCL,
                SUM(OUTSTANDING_OFF_BS_CCY)                                  TOTAL_OUTSTANDING_OFF_BS_CCY,
                SUM(OUTSTANDING_OFF_BS_LCL)                                  TOTAL_OUTSTANDING_OFF_BS_LCL,
                SUM(UNAMORT_FEE_CCY)                                         TOTAL_UNAMORT_FEE_AMT_CCY,
                SUM(UNAMORT_FEE_LCL)                                         TOTAL_UNAMORT_FEE_AMT_LCL,
                SUM(INTEREST_ACCRUED_CCY)                                    TOTAL_INTEREST_RECEIVABLE_CCY,
                SUM(INTEREST_ACCRUED_LCL)                                    TOTAL_INTEREST_RECEIVABLE_LCL,
                SUM(UNWINDING_INTEREST_CCY)                                  TOTAL_UNWINDING_INTEREST_CCY,
                SUM(UNWINDING_INTEREST_LCL)                                  TOTAL_UNWINDING_INTEREST_LCL,
                SUM(AMORTISASI_FEE_CCY)                                      TOTAL_AMORT_FEE_CCY,
                SUM(AMORTISASI_FEE_LCL)                                      TOTAL_AMORT_FEE_LCL,
                SUM(CADANGAN_KOLEKTIF_CCY) + SUM(CADANGAN_INDIVIDUAL_CCY)    TOTAL_ECL_ON_BS_CCY,
                SUM(CADANGAN_KOLEKTIF_LCL) + SUM(CADANGAN_INDIVIDUAL_LCL)    TOTAL_ECL_ON_BS_LCL,
                SUM(CADANGAN_KOLEKTIF_COM_CCY) + SUM(CADANGAN_INDIV_COM_CCY) TOTAL_ECL_OFF_BS_CCY,
                SUM(CADANGAN_KOLEKTIF_COM_LCL) + SUM(CADANGAN_INDIV_COM_LCL) TOTAL_ECL_OFF_BS_LCL
         from IFRS_NOMINATIVE_LBU LBU
         where REPORT_DATE = (select max(report_date) from IFRS_NOMINATIVE_LBU)
     ) LBU;

create view IFRS9_BCA.VW_IFRS_NOMI_VS_GL_AMT_LBMR as
SELECT DOWNLOAD_DATE, JOURNAL_CODE, CABANG, SEQ, KOMBINASI_COA, CURRENCY, 
       SUM(JURNAL_CCY) JURNAL_CCY, SUM(JURNAL_LCL) JURNAL_LCL,
       SUM(NOMINATIF_CCY) NOMINATIF_CCY, SUM(NOMINATIF_LCL) NOMINATIF_LCL,
       SUM(SELISIH_CEK_AMT_CCY) SELISIH_CEK_AMT_CCY, SUM(SELISIH_CEK_AMT_LCL) SELISIH_CEK_AMT_LCL
FROM (
SELECT N.REPORT_DATE DOWNLOAD_DATE, 
       N.MASTERID MASTERID, N.ACCOUNT_NUMBER ACCOUNT_NUMBER,
       REKON.JOURNAL_CODE JOURNAL_CODE, N.BRANCH_CODE CABANG, REKON.AAK_VLMKEY_SEQ SEQ, REKON.AAK_VLMKEY KOMBINASI_COA, REKON.AAK_CURRCD CURRENCY,
       ABS(REKON.AAK_AMT_VA) JURNAL_CCY, ABS(REKON.AAK_AMT_VA) * COALESCE(KURS_BLN_INI.RATE_AMOUNT, 0) JURNAL_LCL, 
       CASE WHEN REKON.JOURNAL_CODE = 'ITEMB' THEN ABS(ROUND(N.INITIAL_FEE_CCY,2)) ELSE ABS(ROUND(N.AMORT_FEE_CCY,2)) END NOMINATIF_CCY,
       CASE WHEN REKON.JOURNAL_CODE = 'ITEMB' THEN ABS(ROUND(N.INITIAL_FEE_LCL,2)) ELSE ABS(ROUND(N.AMORT_FEE_LCL,2)) END NOMINATIF_LCL,
       ABS(REKON.AAK_AMT_VA) - (CASE WHEN REKON.JOURNAL_CODE = 'ITEMB' THEN ABS(ROUND(N.INITIAL_FEE_CCY,2)) ELSE ABS(ROUND(N.AMORT_FEE_CCY,2)) END) SELISIH_CEK_AMT_CCY,
       (ABS(REKON.AAK_AMT_VA) * COALESCE(KURS_BLN_INI.RATE_AMOUNT, 0)) - (CASE WHEN REKON.JOURNAL_CODE = 'ITEMB' THEN ABS(ROUND(N.INITIAL_FEE_LCL,2)) ELSE ABS(ROUND(N.AMORT_FEE_LCL,2)) END) SELISIH_CEK_AMT_LCL
FROM IFRS_NOMINATIVE N
LEFT JOIN (
    SELECT iaarr.download_date                            DOWNLOAD_DATE,
       iaarr.journal_code                                 JOURNAL_CODE,
       iaarr.masterid                                     MASTERID,
       mid.master_account_code                            ACCOUNT_NUMBER,
       iaarr.branch_code                                  BRANCH_CODE,
       iaarr.glno                                         AAK_VLMKEY,
       iaarr.seq                                          AAK_VLMKEY_SEQ,
       iaarr.currency                                     AAK_CURRCD,
       para.journal_desc                                  AAK_DESC,
       iaarr.drcr                                         AAK_DCCD,
       CASE WHEN iaarr.DRCR = 'C' THEN iaarr.amount * -1 ELSE iaarr.amount END  AAK_AMT_VA
  FROM ifrs_acct_amort_rpt_rekon iaarr, IFRS_JOURNAL_PARAM para, IFRS_MASTERID mid
 WHERE     1 = 1
       --AND LAST_DAY (iaarr.download_date) = '30-Sep-2020'
       AND para.glno = iaarr.glno
       AND iaarr.amount_idr <> 0
       AND iaarr.reverse = 'N'
       AND iaarr.journal_code = para.journalcode
       AND iaarr.masterid = mid.pkid
       AND iaarr.journal_code IN ('ITEMB','EMPBE','EBCTE')
) REKON
ON N.MASTERID = REKON.MASTERID
AND N.REPORT_DATE = LAST_DAY(REKON.DOWNLOAD_DATE)
LEFT JOIN IFRS_MASTER_EXCHANGE_RATE KURS_BLN_INI
ON N.REPORT_DATE = KURS_BLN_INI.DOWNLOAD_DATE
AND REKON.AAK_CURRCD = KURS_BLN_INI.CURRENCY
WHERE     1 = 1
       AND N.MARKET_RATE IS NOT NULL
       AND N.DATA_SOURCE = 'ILS'
       AND N.ACCOUNT_STATUS = 'A'
       AND N.REPORT_DATE = (SELECT MAX(REPORT_DATE) FROM IFRS_NOMINATIVE)
       AND NOT EXISTS
              (SELECT 1
                 FROM IFRS_NOMINATIVE L
                WHERE     L.REPORT_DATE = N.REPORT_DATE
                      AND L.DATA_SOURCE = 'ILS'
                      AND L.ACCOUNT_STATUS = 'A'
                      AND N.DATA_SOURCE = 'LIMIT'
                      AND N.ACCOUNT_NUMBER = L.FACILITY_NUMBER))
WHERE 1 = 1
GROUP BY DOWNLOAD_DATE, JOURNAL_CODE, CABANG, SEQ, KOMBINASI_COA, CURRENCY
HAVING SUM(NOMINATIF_CCY) <> 0 AND SUM(NOMINATIF_LCL) <> 0
ORDER BY JOURNAL_CODE, CABANG, SEQ, KOMBINASI_COA, CURRENCY;

create view IFRS9_BCA.VW_IFRS_NOMI_VS_GL_AMT as
SELECT DOWNLOAD_DATE, JOURNAL_CODE, CABANG, SEQ, KOMBINASI_COA, CURRENCY, 
       SUM(JURNAL_CCY) JURNAL_CCY, SUM(JURNAL_LCL) JURNAL_LCL,
       SUM(NOMINATIF_CCY) NOMINATIF_CCY, SUM(NOMINATIF_LCL) NOMINATIF_LCL,
       SUM(SELISIH_CEK_AMT_CCY) SELISIH_CEK_AMT_CCY, SUM(SELISIH_CEK_AMT_LCL) SELISIH_CEK_AMT_LCL
FROM (
SELECT N.REPORT_DATE DOWNLOAD_DATE, 
       N.MASTERID MASTERID, N.ACCOUNT_NUMBER ACCOUNT_NUMBER,
       REKON.JOURNAL_CODE JOURNAL_CODE, N.BRANCH_CODE CABANG, REKON.AAK_VLMKEY_SEQ SEQ, REKON.AAK_VLMKEY KOMBINASI_COA, REKON.AAK_CURRCD CURRENCY,
       ABS(REKON.AAK_AMT_VA) JURNAL_CCY, ABS(REKON.AAK_AMT_VA) * COALESCE(KURS_BLN_INI.RATE_AMOUNT, 0) JURNAL_LCL, 
       CASE WHEN REKON.JOURNAL_CODE = 'RECORE' THEN ABS(ROUND(N.AMORT_FEE_AMT_ILS_CCY,2)) 
            WHEN REKON.JOURNAL_CODE = 'ITRCG' THEN ABS(ROUND(N.UNAMORT_FEE_AMT_ILS_CCY,2)) + ABS(ROUND(N.AMORT_FEE_AMT_ILS_CCY,2))
            ELSE ABS(ROUND(N.AMORT_FEE_CCY,2)) 
       END NOMINATIF_CCY,
       CASE WHEN REKON.JOURNAL_CODE = 'RECORE' THEN ABS(ROUND(N.AMORT_FEE_AMT_ILS_LCL,2)) 
            WHEN REKON.JOURNAL_CODE = 'ITRCG' THEN ABS(ROUND(N.UNAMORT_FEE_AMT_ILS_LCL,2)) + ABS(ROUND(N.AMORT_FEE_AMT_ILS_LCL,2))  
            ELSE ABS(ROUND(N.AMORT_FEE_LCL,2)) 
       END NOMINATIF_LCL,
       ABS(REKON.AAK_AMT_VA) - 
       (CASE WHEN REKON.JOURNAL_CODE = 'RECORE' THEN ABS(ROUND(N.AMORT_FEE_AMT_ILS_CCY,2)) 
            WHEN REKON.JOURNAL_CODE = 'ITRCG' THEN ABS(ROUND(N.UNAMORT_FEE_AMT_ILS_CCY,2)) + ABS(ROUND(N.AMORT_FEE_AMT_ILS_CCY,2))
            ELSE ABS(ROUND(N.AMORT_FEE_CCY,2)) 
       END) SELISIH_CEK_AMT_CCY,
       (ABS(REKON.AAK_AMT_VA) * COALESCE(KURS_BLN_INI.RATE_AMOUNT, 0)) - 
       (CASE WHEN REKON.JOURNAL_CODE = 'RECORE' THEN ABS(ROUND(N.AMORT_FEE_AMT_ILS_LCL,2)) 
            WHEN REKON.JOURNAL_CODE = 'ITRCG' THEN ABS(ROUND(N.UNAMORT_FEE_AMT_ILS_LCL,2)) + ABS(ROUND(N.AMORT_FEE_AMT_ILS_LCL,2))  
            ELSE ABS(ROUND(N.AMORT_FEE_LCL,2)) 
       END) SELISIH_CEK_AMT_LCL
FROM IFRS_NOMINATIVE N
LEFT JOIN (
    SELECT iaarr.download_date                            DOWNLOAD_DATE,
       iaarr.journal_code                                 JOURNAL_CODE,
       iaarr.masterid                                     MASTERID,
       mid.master_account_code                            ACCOUNT_NUMBER,
       iaarr.branch_code                                  BRANCH_CODE,
       iaarr.glno                                         AAK_VLMKEY,
       iaarr.seq                                          AAK_VLMKEY_SEQ,
       iaarr.currency                                     AAK_CURRCD,
       para.journal_desc                                  AAK_DESC,
       iaarr.drcr                                         AAK_DCCD,
       CASE WHEN iaarr.DRCR = 'C' THEN iaarr.amount * -1 ELSE iaarr.amount END  AAK_AMT_VA
  FROM ifrs_acct_amort_rpt_rekon iaarr, IFRS_JOURNAL_PARAM para, IFRS_MASTERID mid
 WHERE     1 = 1
       --AND LAST_DAY (iaarr.download_date) = '30-Sep-2020'
       AND para.glno = iaarr.glno
       AND iaarr.amount_idr <> 0
       AND iaarr.reverse = 'N'
       AND iaarr.journal_code = para.journalcode
       AND iaarr.masterid = mid.pkid
       AND iaarr.journal_code IN ('RECORE','ITRCG','ACCRU')
) REKON
ON N.MASTERID = REKON.MASTERID
AND N.REPORT_DATE = LAST_DAY(REKON.DOWNLOAD_DATE)
LEFT JOIN IFRS_MASTER_EXCHANGE_RATE KURS_BLN_INI
ON N.REPORT_DATE = KURS_BLN_INI.DOWNLOAD_DATE
AND REKON.AAK_CURRCD = KURS_BLN_INI.CURRENCY
WHERE     1 = 1
       AND N.DATA_SOURCE = 'ILS'
       AND N.MARKET_RATE IS NULL
       AND N.ACCOUNT_STATUS = 'A'
       AND N.REPORT_DATE = (SELECT MAX(REPORT_DATE) FROM IFRS_NOMINATIVE)
       AND NOT EXISTS
              (SELECT 1
                 FROM IFRS_NOMINATIVE L
                WHERE     L.REPORT_DATE = N.REPORT_DATE
                      AND L.DATA_SOURCE = 'ILS'
                      AND L.ACCOUNT_STATUS = 'A'
                      AND N.DATA_SOURCE = 'LIMIT'
                      AND N.ACCOUNT_NUMBER = L.FACILITY_NUMBER))
WHERE 1 = 1
GROUP BY DOWNLOAD_DATE, JOURNAL_CODE, CABANG, SEQ, KOMBINASI_COA, CURRENCY
HAVING SUM(NOMINATIF_CCY) <> 0 AND SUM(NOMINATIF_LCL) <> 0
UNION ALL
SELECT DOWNLOAD_DATE, JOURNAL_CODE, CABANG, SEQ, KOMBINASI_COA, CURRENCY, 
       SUM(JURNAL_CCY) JURNAL_CCY, SUM(JURNAL_LCL) JURNAL_LCL,
       SUM(NOMINATIF_CCY) NOMINATIF_CCY, SUM(NOMINATIF_LCL) NOMINATIF_LCL,
       SUM(SELISIH_CEK_AMT_CCY) SELISIH_CEK_AMT_CCY, SUM(SELISIH_CEK_AMT_LCL) SELISIH_CEK_AMT_LCL
FROM (
SELECT N.REPORT_DATE DOWNLOAD_DATE, 
       N.MASTERID MASTERID, N.ACCOUNT_NUMBER ACCOUNT_NUMBER,
       REKON.JOURNAL_CODE JOURNAL_CODE, N.BRANCH_CODE CABANG, REKON.AAK_VLMKEY_SEQ SEQ, REKON.AAK_VLMKEY KOMBINASI_COA, REKON.AAK_CURRCD CURRENCY,
       ABS(REKON.AAK_AMT_VA) JURNAL_CCY, ABS(REKON.AAK_AMT_VA) * COALESCE(KURS_BLN_INI.RATE_AMOUNT, 0) JURNAL_LCL, 
       ABS(ROUND(N.UNAMORT_FEE_AMT_ILS_CCY,2)) + ABS(ROUND(N.AMORT_FEE_AMT_ILS_CCY,2)) NOMINATIF_CCY,
       ABS(ROUND(N.UNAMORT_FEE_AMT_ILS_LCL,2)) + ABS(ROUND(N.AMORT_FEE_AMT_ILS_LCL,2)) NOMINATIF_LCL,
       ABS(REKON.AAK_AMT_VA) - (ABS(ROUND(N.UNAMORT_FEE_AMT_ILS_CCY,2)) + ABS(ROUND(N.AMORT_FEE_AMT_ILS_CCY,2))) SELISIH_CEK_AMT_CCY,
       (ABS(REKON.AAK_AMT_VA) * COALESCE(KURS_BLN_INI.RATE_AMOUNT, 0)) - (ABS(ROUND(N.UNAMORT_FEE_AMT_ILS_LCL,2)) + ABS(ROUND(N.AMORT_FEE_AMT_ILS_LCL,2))) SELISIH_CEK_AMT_LCL
FROM IFRS_NOMINATIVE N
LEFT JOIN (
    SELECT iaarr.download_date                            DOWNLOAD_DATE,
       iaarr.journal_code                                 JOURNAL_CODE,
       iaarr.masterid                                     MASTERID,
       mid.master_account_code                            ACCOUNT_NUMBER,
       iaarr.branch_code                                  BRANCH_CODE,
       iaarr.glno                                         AAK_VLMKEY,
       iaarr.seq                                          AAK_VLMKEY_SEQ,
       iaarr.currency                                     AAK_CURRCD,
       para.journal_desc                                  AAK_DESC,
       iaarr.drcr                                         AAK_DCCD,
       CASE WHEN iaarr.DRCR = 'C' THEN iaarr.amount * -1 ELSE iaarr.amount END  AAK_AMT_VA
  FROM ifrs_acct_amort_rpt_rekon iaarr, IFRS_JOURNAL_PARAM para, IFRS_MASTERID mid
 WHERE     1 = 1
       AND LAST_DAY (iaarr.download_date) = (SELECT MAX(REPORT_DATE) FROM IFRS_NOMINATIVE)
       AND para.glno = iaarr.glno
       AND iaarr.amount_idr <> 0
       AND iaarr.reverse = 'N'
       AND iaarr.journal_code = para.journalcode
       AND iaarr.masterid = mid.pkid
       AND iaarr.journal_code IN ('MATURE')
) REKON
ON N.MASTERID = REKON.MASTERID 
LEFT JOIN IFRS_MASTER_EXCHANGE_RATE KURS_BLN_INI
ON LAST_DAY(REKON.DOWNLOAD_DATE) = KURS_BLN_INI.DOWNLOAD_DATE
AND REKON.AAK_CURRCD = KURS_BLN_INI.CURRENCY
WHERE     1 = 1
       AND N.DATA_SOURCE = 'ILS'
       AND N.MARKET_RATE IS NULL
       AND N.ACCOUNT_STATUS = 'A'
       AND N.REPORT_DATE = (SELECT LAST_DAY(ADD_MONTHS(MAX(REPORT_DATE), -1)) FROM IFRS_NOMINATIVE)  
       AND NOT EXISTS
              (SELECT 1
                 FROM IFRS_NOMINATIVE L
                WHERE     L.REPORT_DATE = N.REPORT_DATE
                      AND L.DATA_SOURCE = 'ILS'
                      AND L.ACCOUNT_STATUS = 'A'
                      AND N.DATA_SOURCE = 'LIMIT'
                      AND N.ACCOUNT_NUMBER = L.FACILITY_NUMBER)
        AND EXISTS
              (SELECT 1
                 FROM IFRS_NOMINATIVE Z
                WHERE     Z.MASTERID = N.MASTERID
                      AND Z.REPORT_DATE = (SELECT MAX(REPORT_DATE) FROM IFRS_NOMINATIVE)
                      AND Z.DATA_SOURCE = 'ILS'
                      AND Z.ACCOUNT_STATUS <> 'A'))
WHERE 1 = 1
GROUP BY DOWNLOAD_DATE, JOURNAL_CODE, CABANG, SEQ, KOMBINASI_COA, CURRENCY
HAVING SUM(NOMINATIF_CCY) <> 0 AND SUM(NOMINATIF_LCL) <> 0
ORDER BY JOURNAL_CODE, CABANG, SEQ, KOMBINASI_COA, CURRENCY;

create view IFRS9_BCA.VW_IFRS_VLD_VS_GL_AMT as
SELECT JRN.DOWNLOAD_DATE                       DOWNLOAD_DATE,
           JRN.SEQ                                 SEQ,
           JRN.CURRENCY                            CURRENCY,
           JRN.GL_AMT_VA                           GL_AMT_VA,
           JRN.GL_AMT_RP                           GL_AMT_RP,
           VLD.VLD_GL_AMT_VA                       VLD_GL_AMT_VA,
           VLD.VLD_GL_AMT_RP                       VLD_GL_AMT_RP,
           (JRN.GL_AMT_VA - VLD.VLD_GL_AMT_VA)     SELISIH_AMT_VA,
           (JRN.GL_AMT_RP - VLD.VLD_GL_AMT_RP)     SELISIH_AMT_RP
      FROM (  SELECT GL.DOWNLOAD_DATE,
                     GL.AAK_VLMKEY_SEQ     SEQ,
                     GL.AAK_CURRCD         CURRENCY,
                     SUM (AAK_AMT_RP)      GL_AMT_RP,
                     SUM (AAK_AMT_VA)      GL_AMT_VA
                FROM IFRS_GL_OUTBOUND_AMT GL
               WHERE     1 = 1
                     AND GL.DOWNLOAD_DATE =
                         (SELECT MAX (DOWNLOAD_DATE) FROM IFRS_GL_OUTBOUND_AMT)
            GROUP BY GL.DOWNLOAD_DATE, GL.AAK_VLMKEY_SEQ, GL.AAK_CURRCD) JRN
           LEFT JOIN (  SELECT DOWNLOAD_DATE,
                               SEQ,
                               CURRENCY,
                               SUM (JURNAL_CCY)     VLD_GL_AMT_VA,
                               SUM (JURNAL_LCL)     VLD_GL_AMT_RP
                          FROM IFRS_NOMI_VS_GL_AMT_LBMR
                         WHERE 1 = 1
                      GROUP BY DOWNLOAD_DATE, SEQ, CURRENCY
                      UNION ALL
                        SELECT DOWNLOAD_DATE,
                               SEQ,
                               CURRENCY,
                               SUM (JURNAL_CCY)     VLD_GL_AMT_VA,
                               SUM (JURNAL_LCL)     VLD_GL_AMT_RP
                          FROM IFRS_NOMI_VS_GL_AMT
                         WHERE 1 = 1
                      GROUP BY DOWNLOAD_DATE, SEQ, CURRENCY) VLD
               ON JRN.SEQ = VLD.SEQ AND JRN.CURRENCY = VLD.CURRENCY;

create view IFRS9_BCA.VW_IFRS_NOMI_VS_GL_ECL as
SELECT DOWNLOAD_DATE,
            JOURNAL_CODE,
            CABANG,
            SEQ,
            KOMBINASI_COA,
            CURRENCY,
            SUM (JURNAL_CCY)        JURNAL_CCY,
            SUM (JURNAL_LCL)        JURNAL_LCL,
            SUM (NOMINATIF_CCY)     NOMINATIF_CCY,
            SUM (NOMINATIF_LCL)     NOMINATIF_LCL,
            SUM (SELISIH_CEK_AMT_CCY) SELISIH_CEK_AMT_CCY,
            SUM (SELISIH_CEK_AMT_LCL) SELISIH_CEK_AMT_LCL
       FROM (SELECT N.REPORT_DATE        DOWNLOAD_DATE,
                    N.MASTERID           MASTERID,
                    N.ACCOUNT_NUMBER     ACCOUNT_NUMBER,
                    REKON.JOURNAL_CODE   JOURNAL_CODE,
                    N.BRANCH_CODE        CABANG,
                    REKON.AAK_VLMKEY_SEQ SEQ,
                    REKON.AAK_VLMKEY     KOMBINASI_COA,
                    REKON.AAK_CURRCD     CURRENCY,
                    ABS (REKON.AAK_AMT_VA) JURNAL_CCY,
                      ABS (REKON.AAK_AMT_VA)
                    * COALESCE (KURS_BLN_INI.RATE_AMOUNT, 0)
                       JURNAL_LCL,
                    CASE
                       WHEN REKON.JOURNAL_CODE = 'BKPI'
                       THEN
                          ABS (ROUND (N.RESERVED_AMOUNT_2, 2))
                       ELSE
                          ABS (ROUND (N.ECL_OFF_BS_CCY, 2))
                    END
                       NOMINATIF_CCY,
                    CASE
                       WHEN REKON.JOURNAL_CODE = 'BKPI'
                       THEN
                          ABS (ROUND (N.RESERVED_AMOUNT_3, 2))
                       ELSE
                          ABS (ROUND (N.ECL_OFF_BS_LCL, 2))
                    END
                       NOMINATIF_LCL,
                      ABS (REKON.AAK_AMT_VA)
                    - (CASE
                          WHEN REKON.JOURNAL_CODE = 'BKPI'
                          THEN
                             ABS (ROUND (N.RESERVED_AMOUNT_2, 2))
                          ELSE
                             ABS (ROUND (N.ECL_OFF_BS_CCY, 2))
                       END)
                       SELISIH_CEK_AMT_CCY,
                      (  ABS (REKON.AAK_AMT_VA)
                       * COALESCE (KURS_BLN_INI.RATE_AMOUNT, 0))
                    - (CASE
                          WHEN REKON.JOURNAL_CODE = 'BKPI'
                          THEN
                             ABS (ROUND (N.RESERVED_AMOUNT_3, 2))
                          ELSE
                             ABS (ROUND (N.ECL_OFF_BS_LCL, 2))
                       END)
                       SELISIH_CEK_AMT_LCL
               FROM IFRS_NOMINATIVE N
                    LEFT JOIN
                    (SELECT iijd.download_date DOWNLOAD_DATE,
                            iijd.REMARKS      JOURNAL_CODE,
                            iijd.masterid     MASTERID,
                            iijd.account_number ACCOUNT_NUMBER,
                            iijd.branch_code  BRANCH_CODE,
                            iijd.gl_account   AAK_VLMKEY,
                            CASE
                               WHEN REMARKS = 'BKPI'
                               THEN
                                  CASE
                                     WHEN DATA_SOURCE = 'ILS' OR DATA_SOURCE = 'PBMM'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '001'
                                        END
                                     WHEN DATA_SOURCE = 'CRD'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '002'
                                        END
                                     WHEN DATA_SOURCE = 'KTP'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '003'
                                        END
                                     WHEN DATA_SOURCE = 'BTRD'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '004'
                                        END
                                     WHEN DATA_SOURCE = 'RKN'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '005'
                                        END
                                  END
                               WHEN REMARKS = 'BKPI2'
                               THEN
                                  CASE
                                     WHEN DATA_SOURCE = 'ILS' OR DATA_SOURCE = 'PBMM'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '006'
                                        END
                                     WHEN DATA_SOURCE = 'CRD'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '007'
                                        END
                                     WHEN DATA_SOURCE = 'BTRD'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '008'
                                        END
                                     WHEN DATA_SOURCE = 'LIMIT'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '006'
                                        END
                                  END
                               WHEN REMARKS = 'BKIUW'
                               THEN
                                  CASE
                                     WHEN DATA_SOURCE = 'ILS' OR DATA_SOURCE = 'PBMM'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'N' THEN '101'
                                           ELSE '102'
                                        END
                                     WHEN DATA_SOURCE = 'KTP'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'N' THEN '105'
                                           ELSE '106'
                                        END
                                     WHEN DATA_SOURCE = 'BTRD'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'N' THEN '107'
                                           ELSE '108'
                                        END
                                  END
                               WHEN REMARKS = 'IRBS' AND (DATA_SOURCE = 'ILS' OR DATA_SOURCE = 'PBMM')
                               THEN
                                  CASE
                                     WHEN REVERSAL_FLAG = 'N' THEN '103'
                                     ELSE '104'
                                  END
                            END
                               AAK_VLMKEY_SEQ,
                            iijd.currency     AAK_CURRCD,
                            para.journal_desc AAK_DESC,
                            CASE
                               WHEN iijd.txn_type = 'CR' THEN 'C'
                               ELSE 'D'
                            END
                               AAK_DCCD,
                            iijd.amount       AAK_AMT_VA
                       FROM IFRS_IMP_JOURNAL_DATA iijd, IFRS_JOURNAL_PARAM para
                      WHERE     1 = 1
                            --AND LAST_DAY (DOWNLOAD_DATE) = '30-SEP-2020'
                            AND iijd.gl_account = para.glno
                            AND iijd.journal_desc = para.gl_constname
                            AND iijd.REMARKS = para.journalcode
                            AND iijd.reversal_flag = 'N'
                            AND iijd.REMARKS IN ('BKPI', 'BKPI2')) REKON
                       ON     N.MASTERID = REKON.MASTERID
                          AND N.REPORT_DATE = LAST_DAY (REKON.DOWNLOAD_DATE)
                    LEFT JOIN IFRS_MASTER_EXCHANGE_RATE KURS_BLN_INI
                       ON     N.REPORT_DATE = KURS_BLN_INI.DOWNLOAD_DATE
                          AND REKON.AAK_CURRCD = KURS_BLN_INI.CURRENCY
              WHERE     1 = 1
                    AND N.REPORT_DATE =
                           (SELECT MAX (REPORT_DATE) FROM IFRS_NOMINATIVE)
                    AND (   (    N.DATA_SOURCE = 'BTRD'
                             AND N.ACCOUNT_STATUS = 'A'
                             AND NVL (N.BI_CODE, ' ') <> '0')
                         OR (    N.DATA_SOURCE = 'CRD'
                             AND (   N.ACCOUNT_STATUS = 'A'
                                  OR N.outstanding_on_bs_ccy > 0))
                         OR (N.DATA_SOURCE = 'ILS' AND N.account_status = 'A')
                         OR (N.DATA_SOURCE = 'LIMIT' AND N.account_status = 'A')
                         OR (    N.DATA_SOURCE = 'KTP'
                             AND N.ACCOUNT_STATUS = 'A'
                             AND UPPER (N.PRODUCT_CODE) <> 'BORROWING')
                         OR (    N.DATA_SOURCE = 'PBMM'
                             AND N.ACCOUNT_STATUS = 'A'
                             AND UPPER (N.PRODUCT_CODE) <> 'BORROWING')
                         OR (    N.DATA_SOURCE = 'RKN'
                             AND N.ACCOUNT_STATUS = 'A'
                             AND NVL (N.OUTSTANDING_PRINCIPAL_CCY, 0) >= 0))
                    AND NOT EXISTS
                           (SELECT 1
                              FROM IFRS_NOMINATIVE L
                             WHERE     L.REPORT_DATE = N.REPORT_DATE
                                   AND L.DATA_SOURCE = 'ILS'
                                   AND L.ACCOUNT_STATUS = 'A'
                                   AND N.DATA_SOURCE = 'LIMIT'
                                   AND N.ACCOUNT_NUMBER = L.FACILITY_NUMBER))
      WHERE 1 = 1
   GROUP BY DOWNLOAD_DATE,
            JOURNAL_CODE,
            CABANG,
            SEQ,
            KOMBINASI_COA,
            CURRENCY
     HAVING SUM (NOMINATIF_CCY) <> 0 AND SUM (NOMINATIF_LCL) <> 0
   ORDER BY JOURNAL_CODE,
            CABANG,
            SEQ,
            KOMBINASI_COA,
            CURRENCY;

create view IFRS9_BCA.VW_IFRS_NOMI_VS_GL_ECL_UWD as
SELECT DOWNLOAD_DATE,
            JOURNAL_CODE,
            CABANG,
            SEQ,
            KOMBINASI_COA,
            CURRENCY,
            SUM (JURNAL_CCY)        JURNAL_CCY,
            SUM (JURNAL_LCL)        JURNAL_LCL,
            SUM (NOMINATIF_CCY)     NOMINATIF_CCY,
            SUM (NOMINATIF_LCL)     NOMINATIF_LCL,
            SUM (SELISIH_CEK_AMT_CCY) SELISIH_CEK_AMT_CCY,
            SUM (SELISIH_CEK_AMT_LCL) SELISIH_CEK_AMT_LCL
       FROM (SELECT N.REPORT_DATE        DOWNLOAD_DATE,
                    N.MASTERID           MASTERID,
                    N.ACCOUNT_NUMBER     ACCOUNT_NUMBER,
                    REKON.JOURNAL_CODE   JOURNAL_CODE,
                    N.BRANCH_CODE        CABANG,
                    REKON.AAK_VLMKEY_SEQ SEQ,
                    REKON.AAK_VLMKEY     KOMBINASI_COA,
                    REKON.AAK_CURRCD     CURRENCY,
                    ABS (REKON.AAK_AMT_VA) JURNAL_CCY,
                      ABS (REKON.AAK_AMT_VA)
                    * COALESCE (KURS_BLN_INI.RATE_AMOUNT, 0)
                       JURNAL_LCL,
                    CASE
                       WHEN REKON.JOURNAL_CODE = 'BKIUW'
                       THEN
                          ABS (ROUND (N.IA_UNWINDING_INTEREST_CCY, 2))
                       WHEN     N.DATA_SOURCE = 'ILS'
                            AND N.GOL_DEB IN ('L', 'M')
                            AND N.BI_COLLECTABILITY IN ('3', '4', '5')
                       THEN
                          ABS (ROUND (N.SALDO_YADIT_CCY, 2))
                       ELSE
                          0
                    END
                       NOMINATIF_CCY,
                    CASE
                       WHEN REKON.JOURNAL_CODE = 'BKIUW'
                       THEN
                          ABS (ROUND (N.IA_UNWINDING_INTEREST_LCL, 2))
                       WHEN     N.DATA_SOURCE = 'ILS'
                            AND N.GOL_DEB IN ('L', 'M')
                            AND N.BI_COLLECTABILITY IN ('3', '4', '5')
                       THEN
                          ABS (ROUND (N.SALDO_YADIT_LCL, 2))
                       ELSE
                          0
                    END
                       NOMINATIF_LCL,
                      ABS (REKON.AAK_AMT_VA)
                    - (CASE
                          WHEN REKON.JOURNAL_CODE = 'BKIUW'
                          THEN
                             ABS (ROUND (N.IA_UNWINDING_INTEREST_CCY, 2))
                          WHEN     N.DATA_SOURCE = 'ILS'
                               AND N.GOL_DEB IN ('L', 'M')
                               AND N.BI_COLLECTABILITY IN ('3', '4', '5')
                          THEN
                             ABS (ROUND (N.SALDO_YADIT_CCY, 2))
                          ELSE
                             0
                       END)
                       SELISIH_CEK_AMT_CCY,
                      (  ABS (REKON.AAK_AMT_VA)
                       * COALESCE (KURS_BLN_INI.RATE_AMOUNT, 0))
                    - (CASE
                          WHEN REKON.JOURNAL_CODE = 'BKIUW'
                          THEN
                             ABS (ROUND (N.IA_UNWINDING_INTEREST_LCL, 2))
                          WHEN     N.DATA_SOURCE = 'ILS'
                               AND N.GOL_DEB IN ('L', 'M')
                               AND N.BI_COLLECTABILITY IN ('3', '4', '5')
                          THEN
                             ABS (ROUND (N.SALDO_YADIT_LCL, 2))
                          ELSE
                             0
                       END)
                       SELISIH_CEK_AMT_LCL
               FROM IFRS_NOMINATIVE N
                    LEFT JOIN
                    (SELECT iijd.download_date DOWNLOAD_DATE,
                            iijd.REMARKS      JOURNAL_CODE,
                            iijd.masterid     MASTERID,
                            iijd.account_number ACCOUNT_NUMBER,
                            iijd.branch_code  BRANCH_CODE,
                            iijd.gl_account   AAK_VLMKEY,
                            CASE
                               WHEN REMARKS = 'BKPI'
                               THEN
                                  CASE
                                     WHEN DATA_SOURCE = 'ILS' OR DATA_SOURCE = 'PBMM'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '001'
                                        END
                                     WHEN DATA_SOURCE = 'CRD'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '002'
                                        END
                                     WHEN DATA_SOURCE = 'KTP'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '003'
                                        END
                                     WHEN DATA_SOURCE = 'BTRD'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '004'
                                        END
                                     WHEN DATA_SOURCE = 'RKN'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '005'
                                        END
                                  END
                               WHEN REMARKS = 'BKPI2'
                               THEN
                                  CASE
                                     WHEN DATA_SOURCE = 'ILS' OR DATA_SOURCE = 'PBMM'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '006'
                                        END
                                     WHEN DATA_SOURCE = 'CRD'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '007'
                                        END
                                     WHEN DATA_SOURCE = 'BTRD'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '008'
                                        END
                                     WHEN DATA_SOURCE = 'LIMIT'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'Y' THEN '009'
                                           ELSE '006'
                                        END
                                  END
                               WHEN REMARKS = 'BKIUW'
                               THEN
                                  CASE
                                     WHEN DATA_SOURCE = 'ILS' OR DATA_SOURCE = 'PBMM'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'N' THEN '101'
                                           ELSE '102'
                                        END
                                     WHEN DATA_SOURCE = 'KTP'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'N' THEN '105'
                                           ELSE '106'
                                        END
                                     WHEN DATA_SOURCE = 'BTRD'
                                     THEN
                                        CASE
                                           WHEN REVERSAL_FLAG = 'N' THEN '107'
                                           ELSE '108'
                                        END
                                  END
                               WHEN REMARKS = 'IRBS' AND (DATA_SOURCE = 'ILS' OR DATA_SOURCE = 'PBMM')
                               THEN
                                  CASE
                                     WHEN REVERSAL_FLAG = 'N' THEN '103'
                                     ELSE '104'
                                  END
                            END
                               AAK_VLMKEY_SEQ,
                            iijd.currency     AAK_CURRCD,
                            para.journal_desc AAK_DESC,
                            CASE
                               WHEN iijd.txn_type = 'CR' THEN 'C'
                               ELSE 'D'
                            END
                               AAK_DCCD,
                            iijd.amount       AAK_AMT_VA
                       FROM IFRS_IMP_JOURNAL_DATA iijd, IFRS_JOURNAL_PARAM para
                      WHERE     1 = 1
                            --AND LAST_DAY (DOWNLOAD_DATE) = '30-SEP-2020'
                            AND iijd.gl_account = para.glno
                            AND iijd.journal_desc = para.gl_constname
                            AND iijd.REMARKS = para.journalcode
                            AND iijd.reversal_flag = 'N'
                            AND iijd.REMARKS IN ('BKIUW', 'IRBS')) REKON
                       ON     N.MASTERID = REKON.MASTERID
                          AND N.REPORT_DATE = LAST_DAY (REKON.DOWNLOAD_DATE)
                    LEFT JOIN IFRS_MASTER_EXCHANGE_RATE KURS_BLN_INI
                       ON     N.REPORT_DATE = KURS_BLN_INI.DOWNLOAD_DATE
                          AND REKON.AAK_CURRCD = KURS_BLN_INI.CURRENCY
              WHERE     1 = 1
                    AND N.REPORT_DATE =
                           (SELECT MAX (REPORT_DATE) FROM IFRS_NOMINATIVE)
                    AND N.ASSESSMENT_IMP = 'I'
                    AND (   (    N.DATA_SOURCE = 'BTRD'
                             AND N.ACCOUNT_STATUS = 'A'
                             AND NVL (N.BI_CODE, ' ') <> '0')
                         OR (    N.DATA_SOURCE = 'CRD'
                             AND (   N.ACCOUNT_STATUS = 'A'
                                  OR N.outstanding_on_bs_ccy > 0))
                         OR (N.DATA_SOURCE = 'ILS' AND N.account_status = 'A')
                         OR (N.DATA_SOURCE = 'LIMIT' AND N.account_status = 'A')
                         OR (    N.DATA_SOURCE = 'KTP'
                             AND N.ACCOUNT_STATUS = 'A'
                             AND UPPER (N.PRODUCT_CODE) <> 'BORROWING')
                         OR (    N.DATA_SOURCE = 'PBMM'
                             AND N.ACCOUNT_STATUS = 'A'
                             AND UPPER (N.PRODUCT_CODE) <> 'BORROWING')
                         OR (    N.DATA_SOURCE = 'RKN'
                             AND N.ACCOUNT_STATUS = 'A'
                             AND NVL (N.OUTSTANDING_PRINCIPAL_CCY, 0) >= 0))
                    AND NOT EXISTS
                           (SELECT 1
                              FROM IFRS_NOMINATIVE L
                             WHERE     L.REPORT_DATE = N.REPORT_DATE
                                   AND L.DATA_SOURCE = 'ILS'
                                   AND L.ACCOUNT_STATUS = 'A'
                                   AND N.DATA_SOURCE = 'LIMIT'
                                   AND N.ACCOUNT_NUMBER = L.FACILITY_NUMBER))
      WHERE 1 = 1
   GROUP BY DOWNLOAD_DATE,
            JOURNAL_CODE,
            CABANG,
            SEQ,
            KOMBINASI_COA,
            CURRENCY
     HAVING SUM (NOMINATIF_CCY) <> 0 AND SUM (NOMINATIF_LCL) <> 0
   ORDER BY JOURNAL_CODE,
            CABANG,
            SEQ,
            KOMBINASI_COA,
            CURRENCY;

create view IFRS9_BCA.VW_IFRS_VLD_VS_GL_ECL as
SELECT JRN.DOWNLOAD_DATE                       DOWNLOAD_DATE,
           JRN.SEQ                                 SEQ,
           JRN.CURRENCY                            CURRENCY,
           JRN.GL_AMT_VA                           GL_AMT_VA,
           JRN.GL_AMT_RP                           GL_AMT_RP,
           VLD.VLD_GL_AMT_VA                       VLD_GL_AMT_VA,
           VLD.VLD_GL_AMT_RP                       VLD_GL_AMT_RP,
           (JRN.GL_AMT_VA - VLD.VLD_GL_AMT_VA)     SELISIH_AMT_VA,
           (JRN.GL_AMT_RP - VLD.VLD_GL_AMT_RP)     SELISIH_AMT_RP
      FROM (  SELECT GL.DOWNLOAD_DATE,
                     GL.AAK_VLMKEY_SEQ     SEQ,
                     GL.AAK_CURRCD         CURRENCY,
                     SUM (AAK_AMT_RP)      GL_AMT_RP,
                     SUM (AAK_AMT_VA)      GL_AMT_VA
                FROM IFRS_GL_OUTBOUND_IMP GL
               WHERE     1 = 1
                     AND GL.DOWNLOAD_DATE =
                         (SELECT MAX (DOWNLOAD_DATE) FROM IFRS_GL_OUTBOUND_IMP)
            GROUP BY GL.DOWNLOAD_DATE, GL.AAK_VLMKEY_SEQ, GL.AAK_CURRCD) JRN
           LEFT JOIN (  SELECT DOWNLOAD_DATE,
                               SEQ,
                               CURRENCY,
                               SUM (JURNAL_CCY)     VLD_GL_AMT_VA,
                               SUM (JURNAL_LCL)     VLD_GL_AMT_RP
                          FROM IFRS_NOMI_VS_GL_ECL
                         WHERE 1 = 1
                      GROUP BY DOWNLOAD_DATE, SEQ, CURRENCY
                      UNION ALL
                        SELECT DOWNLOAD_DATE,
                               SEQ,
                               CURRENCY,
                               SUM (JURNAL_CCY)     VLD_GL_AMT_VA,
                               SUM (JURNAL_LCL)     VLD_GL_AMT_RP
                          FROM IFRS_NOMI_VS_GL_ECL_UWD
                         WHERE 1 = 1
                      GROUP BY DOWNLOAD_DATE, SEQ, CURRENCY) VLD
               ON JRN.SEQ = VLD.SEQ AND JRN.CURRENCY = VLD.CURRENCY;

create view IFRS9_BCA.VW_IFRS_REV_VS_BTK_GL_ECL as
SELECT REV_BLN_INI.DOWNLOAD_DATE DOWNLOAD_DATE,
       REV_BLN_INI.JURNAL_ID, REV_BLN_INI.COA, 
       REV_BLN_INI.MTU, REV_BLN_INI.KET, REV_BLN_INI.CYCP, 
       REV_BLN_INI.SEQ REV_BLN_INI_SEQ, REV_BLN_INI.DC REV_BLN_INI_DC, REV_BLN_INI.AMT_EQ_IDR REV_BLN_INI_EQ_IDR, REV_BLN_INI.AMT_ORI REV_BLN_INI_ORI_CURRENCY,
       BTK_BLN_LALU.SEQ BTK_BLN_LALU_SEQ, BTK_BLN_LALU.DC BTK_BLN_LALU_DC, BTK_BLN_LALU.AMT_EQ_IDR BTK_BLN_LALU_EQ_IDR, BTK_BLN_LALU.AMT_ORI BTK_BLN_LALU_ORI_CURRENCY,
       (REV_BLN_INI.AMT_EQ_IDR + BTK_BLN_LALU.AMT_EQ_IDR) SELISIH_EQ_IDR, (REV_BLN_INI.AMT_ORI + BTK_BLN_LALU.AMT_ORI) SELISIH_ORI_CURRENCY,
       COALESCE(KURS_BLN_INI.RATE_AMOUNT, 0) KURS_BULAN_INI, COALESCE(KURS_BLN_LALU.RATE_AMOUNT, 0) KURS_BLN_LALU, (COALESCE(KURS_BLN_INI.RATE_AMOUNT, 0) - COALESCE(KURS_BLN_LALU.RATE_AMOUNT, 0)) SELISIH_KURS,
       ROUND((REV_BLN_INI.AMT_ORI * (COALESCE(KURS_BLN_INI.RATE_AMOUNT, 0) - COALESCE(KURS_BLN_LALU.RATE_AMOUNT, 0))),2) REV_AMT_ORI_TMS_SLSH_KURS,
       (REV_BLN_INI.AMT_EQ_IDR + BTK_BLN_LALU.AMT_EQ_IDR) - (ROUND((REV_BLN_INI.AMT_ORI * (COALESCE(KURS_BLN_INI.RATE_AMOUNT, 0) - COALESCE(KURS_BLN_LALU.RATE_AMOUNT, 0))),2)) AMT_SELISIH_KURS
FROM (
    SELECT DOWNLOAD_DATE, JURNAL_ID, COA, MTU, KET, CYCP, SEQ, DC, SUM(AMT_EQ_IDR) AMT_EQ_IDR, SUM(AMT_ORI) AMT_ORI
    FROM (
        SELECT DOWNLOAD_DATE, AAK_JRNLID JURNAL_ID, AAK_VLMKEY COA, AAK_CURRCD MTU, AAK_DESC KET, AAK_JA || AAK_JT CYCP, AAK_VLMKEY_SEQ SEQ, AAK_DCCD DC,  
               CASE WHEN AAK_RP_SIGN = '-' THEN AAK_AMT_RP * -1 ELSE AAK_AMT_RP END AMT_EQ_IDR, CASE WHEN AAK_VA_SIGN = '-' THEN AAK_AMT_VA * -1 ELSE AAK_AMT_VA END AMT_ORI
        FROM IFRS_GL_OUTBOUND_IMP_R
        WHERE 1 = 1
        AND LAST_DAY (DOWNLOAD_DATE) = (SELECT MAX(REPORT_DATE) FROM IFRS_NOMINATIVE))
    WHERE 1 = 1
    GROUP BY DOWNLOAD_DATE, JURNAL_ID, COA, MTU, KET, CYCP, SEQ, DC
) REV_BLN_INI
INNER JOIN (
    SELECT DOWNLOAD_DATE, JURNAL_ID, COA, MTU, KET, CYCP, SEQ, DC, SUM(AMT_EQ_IDR) AMT_EQ_IDR, SUM(AMT_ORI) AMT_ORI
    FROM (
        SELECT DOWNLOAD_DATE, AAK_JRNLID JURNAL_ID, AAK_VLMKEY COA, AAK_CURRCD MTU, AAK_DESC KET, AAK_JA || AAK_JT CYCP, AAK_VLMKEY_SEQ SEQ, AAK_DCCD DC,  
               CASE WHEN AAK_RP_SIGN = '-' THEN AAK_AMT_RP * -1 ELSE AAK_AMT_RP END AMT_EQ_IDR, CASE WHEN AAK_VA_SIGN = '-' THEN AAK_AMT_VA * -1 ELSE AAK_AMT_VA END AMT_ORI
        FROM IFRS_GL_OUTBOUND_IMP
        WHERE 1 = 1
        AND LAST_DAY (DOWNLOAD_DATE) = (SELECT LAST_DAY(ADD_MONTHS(MAX(REPORT_DATE), -1)) FROM IFRS_NOMINATIVE))
    WHERE 1 = 1
    GROUP BY DOWNLOAD_DATE, JURNAL_ID, COA, MTU, KET, CYCP, SEQ, DC
) BTK_BLN_LALU
ON REV_BLN_INI.JURNAL_ID = BTK_BLN_LALU.JURNAL_ID
AND REV_BLN_INI.COA = BTK_BLN_LALU.COA
AND REV_BLN_INI.MTU = BTK_BLN_LALU.MTU
AND REV_BLN_INI.DC <> BTK_BLN_LALU.DC
LEFT JOIN IFRS_MASTER_EXCHANGE_RATE KURS_BLN_INI
ON REV_BLN_INI.DOWNLOAD_DATE = KURS_BLN_INI.DOWNLOAD_DATE
AND REV_BLN_INI.MTU = KURS_BLN_INI.CURRENCY
LEFT JOIN IFRS_MASTER_EXCHANGE_RATE KURS_BLN_LALU
ON BTK_BLN_LALU.DOWNLOAD_DATE = KURS_BLN_LALU.DOWNLOAD_DATE
AND BTK_BLN_LALU.MTU = KURS_BLN_LALU.CURRENCY
ORDER BY REV_BLN_INI.COA, REV_BLN_INI.MTU, REV_BLN_INI.DC;

create view IFRS9_BCA.VW_IFRS_REV_VS_BTK_GL_AMT as
SELECT REV_BLN_INI.DOWNLOAD_DATE DOWNLOAD_DATE,
       REV_BLN_INI.JURNAL_ID, REV_BLN_INI.COA,
       REV_BLN_INI.MTU, REV_BLN_INI.KET, REV_BLN_INI.CYCP,
       REV_BLN_INI.SEQ REV_BLN_INI_SEQ, REV_BLN_INI.DC REV_BLN_INI_DC, REV_BLN_INI.AMT_EQ_IDR REV_BLN_INI_EQ_IDR, REV_BLN_INI.AMT_ORI REV_BLN_INI_ORI_CURRENCY,
       BTK_BLN_LALU.SEQ BTK_BLN_LALU_SEQ, BTK_BLN_LALU.DC BTK_BLN_LALU_DC, BTK_BLN_LALU.AMT_EQ_IDR BTK_BLN_LALU_EQ_IDR, BTK_BLN_LALU.AMT_ORI BTK_BLN_LALU_ORI_CURRENCY,
       (REV_BLN_INI.AMT_EQ_IDR + BTK_BLN_LALU.AMT_EQ_IDR) SELISIH_EQ_IDR, (REV_BLN_INI.AMT_ORI + BTK_BLN_LALU.AMT_ORI) SELISIH_ORI_CURRENCY,
       COALESCE(KURS_BLN_INI.RATE_AMOUNT, 0) KURS_BULAN_INI, COALESCE(KURS_BLN_LALU.RATE_AMOUNT, 0) KURS_BLN_LALU, (COALESCE(KURS_BLN_INI.RATE_AMOUNT, 0) - COALESCE(KURS_BLN_LALU.RATE_AMOUNT, 0)) SELISIH_KURS,
       ROUND((REV_BLN_INI.AMT_ORI * (COALESCE(KURS_BLN_INI.RATE_AMOUNT, 0) - COALESCE(KURS_BLN_LALU.RATE_AMOUNT, 0))),2) REV_AMT_ORI_TMS_SLSH_KURS,
       (REV_BLN_INI.AMT_EQ_IDR + BTK_BLN_LALU.AMT_EQ_IDR) - (ROUND((REV_BLN_INI.AMT_ORI * (COALESCE(KURS_BLN_INI.RATE_AMOUNT, 0) - COALESCE(KURS_BLN_LALU.RATE_AMOUNT, 0))),2)) AMT_SELISIH_KURS
FROM (
    SELECT DOWNLOAD_DATE, JURNAL_ID, COA, MTU, KET, CYCP, SEQ, DC, SUM(AMT_EQ_IDR) AMT_EQ_IDR, SUM(AMT_ORI) AMT_ORI
    FROM (
        SELECT DOWNLOAD_DATE, AAK_JRNLID JURNAL_ID, AAK_VLMKEY COA, AAK_CURRCD MTU, AAK_DESC KET, AAK_JA || AAK_JT CYCP, AAK_VLMKEY_SEQ SEQ, AAK_DCCD DC,
               CASE WHEN AAK_RP_SIGN = '-' THEN AAK_AMT_RP * -1 ELSE AAK_AMT_RP END AMT_EQ_IDR, CASE WHEN AAK_VA_SIGN = '-' THEN AAK_AMT_VA * -1 ELSE AAK_AMT_VA END AMT_ORI
        FROM IFRS_GL_OUTBOUND_AMT_R
        WHERE 1 = 1
        AND AAK_VLMKEY_SEQ IN ('201','202','301','302','305','306','303','304')
        AND LAST_DAY (DOWNLOAD_DATE) = (SELECT MAX(REPORT_DATE) FROM IFRS_NOMINATIVE))
    WHERE 1 = 1
    GROUP BY DOWNLOAD_DATE, JURNAL_ID, COA, MTU, KET, CYCP, SEQ, DC
) REV_BLN_INI
INNER JOIN (
    SELECT DOWNLOAD_DATE, JURNAL_ID, COA, MTU, KET, CYCP, SEQ, DC, SUM(AMT_EQ_IDR) AMT_EQ_IDR, SUM(AMT_ORI) AMT_ORI
		FROM (
			SELECT CASE WHEN BRANCH_DESTINATION IS NULL THEN AAK_VLMKEY ELSE B.BRANCH_DESTINATION || substr(A.AAK_VLMKEY, 5)END COA,A.DOWNLOAD_DATE, CASE WHEN BRANCH_DESTINATION IS NULL THEN AAK_JRNLID ELSE B.BRANCH_DESTINATION || substr(A.AAK_JRNLID, 5) END JURNAL_ID, AAK_VLMKEY COA1, AAK_CURRCD MTU, AAK_DESC KET, AAK_JA || AAK_JT CYCP, AAK_VLMKEY_SEQ SEQ, AAK_DCCD DC,
				   CASE WHEN AAK_RP_SIGN = '-' THEN AAK_AMT_RP * -1 ELSE AAK_AMT_RP END AMT_EQ_IDR, CASE WHEN AAK_VA_SIGN = '-' THEN AAK_AMT_VA * -1 ELSE AAK_AMT_VA END AMT_ORI
			FROM IFRS_GL_OUTBOUND_AMT a
			LEFT JOIN  (SELECT * FROM TBLU_JOURNAL_BRANCH WHERE DOWNLOAD_DATE = (SELECT MAX(REPORT_DATE) FROM IFRS_NOMINATIVE))B
			ON  substr(A.AAK_JRNLID, 0, 4) = B.BRANCH_SOURCE
				  and substr(A.AAK_VLMKEY, 0, 4) = B.BRANCH_SOURCE
			WHERE 1 = 1
			AND AAK_VLMKEY_SEQ IN ('201','202','301','302','305','306','303','304')
			AND LAST_DAY (A.DOWNLOAD_DATE) = (SELECT LAST_DAY(ADD_MONTHS(MAX(REPORT_DATE), -1)) FROM IFRS_NOMINATIVE)
			)
		WHERE 1 = 1
		GROUP BY DOWNLOAD_DATE, JURNAL_ID, COA, MTU, KET, CYCP, SEQ, DC
) BTK_BLN_LALU
ON REV_BLN_INI.JURNAL_ID = BTK_BLN_LALU.JURNAL_ID
AND REV_BLN_INI.COA = BTK_BLN_LALU.COA
AND REV_BLN_INI.MTU = BTK_BLN_LALU.MTU
AND REV_BLN_INI.DC <> BTK_BLN_LALU.DC
LEFT JOIN IFRS_MASTER_EXCHANGE_RATE KURS_BLN_INI
ON REV_BLN_INI.DOWNLOAD_DATE = KURS_BLN_INI.DOWNLOAD_DATE
AND REV_BLN_INI.MTU = KURS_BLN_INI.CURRENCY
LEFT JOIN IFRS_MASTER_EXCHANGE_RATE KURS_BLN_LALU
ON BTK_BLN_LALU.DOWNLOAD_DATE = KURS_BLN_LALU.DOWNLOAD_DATE
AND BTK_BLN_LALU.MTU = KURS_BLN_LALU.CURRENCY
ORDER BY REV_BLN_INI.COA, REV_BLN_INI.MTU, REV_BLN_INI.DC;

create view IFRS9_BCA.VW_IFRS_NOMI_VS_LBU as
SELECT 'Nominatif'                  Source,
          --       DATA_SOURCE,
          SUM (OUTSTANDING_ON_BS_CCY)  TOTAL_OUTSTANDING_ON_BS_CCY,
          SUM (OUTSTANDING_ON_BS_LCL)  TOTAL_OUTSTANDING_ON_BS_LCL,
          SUM (OUTSTANDING_OFF_BS_CCY) TOTAL_OUTSTANDING_OFF_BS_CCY,
          SUM (OUTSTANDING_OFF_BS_LCL) TOTAL_OUTSTANDING_OFF_BS_LCL,
          SUM (UNAMORT_FEE_AMT_CCY)    TOTAL_UNAMORT_FEE_AMT_CCY,
          SUM (UNAMORT_FEE_AMT_LCL)    TOTAL_UNAMORT_FEE_AMT_LCL,
          SUM (INTEREST_ACCRUED_CCY)   TOTAL_INTEREST_ACCRUED_CCY,
          SUM (INTEREST_ACCRUED_LCL)   TOTAL_INTEREST_ACCRUED_LCL,
          SUM (UNWINDING_INTEREST_CCY) TOTAL_UNWINDING_INTEREST_CCY,
          SUM (UNWINDING_INTEREST_LCL) TOTAL_UNWINDING_INTEREST_LCL,
          SUM (AMORT_FEE_CCY)          TOTAL_AMORT_FEE_CCY,
          SUM (AMORT_FEE_LCL)          TOTAL_AMORT_FEE_LCL,
          SUM (ECL_ON_BS_FINAL_CCY)    TOTAL_ECL_ON_BS_FINAL_CCY,
          SUM (ECL_ON_BS_FINAL_LCL)    TOTAL_ECL_ON_BS_FINAL_LCL,
          SUM (ECL_OFF_BS_CCY)         TOTAL_ECL_OFF_BS_CCY,
          SUM (ECL_OFF_BS_LCL)         TOTAL_ECL_OFF_BS_LCL
     FROM (SELECT N.DATA_SOURCE,
                  CASE
                     --                     WHEN N.DATA_SOURCE = 'KTP' THEN N.PRINCIPAL_AMOUNT_CCY
                  WHEN N.DATA_SOURCE = 'RKN' THEN N.OUTSTANDING_PRINCIPAL_CCY
                     ELSE N.OUTSTANDING_ON_BS_CCY
                  END
                     OUTSTANDING_ON_BS_CCY,
                  CASE
                     --                     WHEN N.DATA_SOURCE = 'KTP' THEN N.PRINCIPAL_AMOUNT_LCL
                  WHEN N.DATA_SOURCE = 'RKN' THEN N.OUTSTANDING_PRINCIPAL_LCL
                     ELSE N.OUTSTANDING_ON_BS_LCL
                  END
                     OUTSTANDING_ON_BS_LCL,
                  CASE
                     WHEN N.DATA_SOURCE IN ('KTP', 'RKN') THEN 0
                     ELSE N.OUTSTANDING_OFF_BS_CCY
                  END
                     OUTSTANDING_OFF_BS_CCY,
                  CASE
                     WHEN N.DATA_SOURCE IN ('KTP', 'RKN') THEN 0
                     ELSE N.OUTSTANDING_OFF_BS_LCL
                  END
                     OUTSTANDING_OFF_BS_LCL,
                  UNAMORT_FEE_AMT_CCY       UNAMORT_FEE_AMT_CCY,
                  UNAMORT_FEE_AMT_LCL       UNAMORT_FEE_AMT_LCL,
                  SALDO_YADIT_CCY           INTEREST_ACCRUED_CCY,
                  SALDO_YADIT_LCL           INTEREST_ACCRUED_LCL,
                  IA_UNWINDING_INTEREST_CCY UNWINDING_INTEREST_CCY,
                  IA_UNWINDING_INTEREST_LCL UNWINDING_INTEREST_LCL,
                  AMORT_FEE_CCY             AMORT_FEE_CCY,
                  AMORT_FEE_LCL             AMORT_FEE_LCL,
                  RESERVED_AMOUNT_2         ECL_ON_BS_FINAL_CCY,
                  RESERVED_AMOUNT_3         ECL_ON_BS_FINAL_LCL,
                  ECL_OFF_BS_CCY            ECL_OFF_BS_CCY,
                  ECL_OFF_BS_LCL            ECL_OFF_BS_LCL
             FROM IFRS_NOMINATIVE N
                  JOIN
                  (SELECT MASTERID,
                          IS_IMPAIRED,
                          SPPI_RESULT,
                          ACCOUNT_STATUS,
                          ECL_AMOUNT
                     FROM IFRS_MASTER_ACCOUNT
                    WHERE DOWNLOAD_DATE =
                             (SELECT MAX (REPORT_DATE) FROM IFRS_NOMINATIVE))
                  B
                     ON (N.MASTERID = B.MASTERID)
            WHERE     N.REPORT_DATE =
                         (SELECT MAX (REPORT_DATE) FROM IFRS_NOMINATIVE)
                  AND (   (    N.DATA_SOURCE = 'BTRD'
                           AND B.IS_IMPAIRED = 1
                           AND N.ACCOUNT_STATUS = 'A'
                           -- minta di uncomment
                           AND NVL (N.BI_CODE, ' ') <> '0')
                       OR (    N.DATA_SOURCE = 'CRD'
                           AND IS_IMPAIRED = 1
                           AND STAGE IS NOT NULL
                           AND (   N.ACCOUNT_STATUS = 'A'
                                OR N.outstanding_on_bs_ccy > 0))
                       OR (    N.DATA_SOURCE = 'ILS'
                           AND N.account_status = 'A'
                           AND IFRS9_CLASS IN ('AMORT', 'FVTOCI')
                           AND B.SPPI_RESULT IS NOT NULL)
                       OR (    N.DATA_SOURCE = 'LIMIT'
                           AND N.account_status = 'A'
                           AND IS_IMPAIRED = 1
                           AND ECL_AMOUNT > 0)
                       OR (    N.DATA_SOURCE = 'KTP'
                           AND IS_IMPAIRED = 1
                           AND N.ACCOUNT_STATUS = 'A'
                           -- minta di uncomment
                           AND UPPER (N.PRODUCT_CODE) <> 'BORROWING')
                       OR (    N.DATA_SOURCE = 'PBMM'
                           AND IS_IMPAIRED = 1
                           AND N.ACCOUNT_STATUS = 'A'
                           -- minta di uncomment
                           AND UPPER (N.PRODUCT_CODE) <> 'BORROWING')
                       OR (    N.DATA_SOURCE = 'RKN'
                           AND IS_IMPAIRED = 1
                           AND N.ACCOUNT_STATUS = 'A'
                           -- minta di uncomment
                           AND NVL (N.OUTSTANDING_PRINCIPAL_CCY, 0) >= 0))
                  AND NOT EXISTS
                         (SELECT 1
                            FROM IFRS_NOMINATIVE L
                           WHERE     L.REPORT_DATE = N.REPORT_DATE
                                 AND L.DATA_SOURCE = 'ILS'
                                 AND L.ACCOUNT_STATUS = 'A'
                                 AND N.DATA_SOURCE = 'LIMIT'
                                 AND N.ACCOUNT_NUMBER = L.FACILITY_NUMBER))
          NOMI
   -- group by DATA_SOURCE
   UNION
   SELECT "SOURCE",
          "TOTAL_OUTSTANDING_ON_BS_CCY",
          "TOTAL_OUTSTANDING_ON_BS_LCL",
          "TOTAL_OUTSTANDING_OFF_BS_CCY",
          "TOTAL_OUTSTANDING_OFF_BS_LCL",
          "TOTAL_UNAMORT_FEE_AMT_CCY",
          "TOTAL_UNAMORT_FEE_AMT_LCL",
          "TOTAL_INTEREST_RECEIVABLE_CCY",
          "TOTAL_INTEREST_RECEIVABLE_LCL",
          "TOTAL_UNWINDING_INTEREST_CCY",
          "TOTAL_UNWINDING_INTEREST_LCL",
          "TOTAL_AMORT_FEE_CCY",
          "TOTAL_AMORT_FEE_LCL",
          "TOTAL_ECL_ON_BS_CCY",
          "TOTAL_ECL_ON_BS_LCL",
          "TOTAL_ECL_OFF_BS_CCY",
          "TOTAL_ECL_OFF_BS_LCL"
     FROM (SELECT 'Textfile LBU'               Source,
                  --               APLIKASI                                                     DATA_SOURCE,
                  SUM (OUTSTANDING_ON_BS_CCY)  TOTAL_OUTSTANDING_ON_BS_CCY,
                  SUM (OUTSTANDING_ON_BS_LCL)  TOTAL_OUTSTANDING_ON_BS_LCL,
                  SUM (OUTSTANDING_OFF_BS_CCY) TOTAL_OUTSTANDING_OFF_BS_CCY,
                  SUM (OUTSTANDING_OFF_BS_LCL) TOTAL_OUTSTANDING_OFF_BS_LCL,
                  SUM (UNAMORT_FEE_CCY)        TOTAL_UNAMORT_FEE_AMT_CCY,
                  SUM (UNAMORT_FEE_LCL)        TOTAL_UNAMORT_FEE_AMT_LCL,
                  SUM (INTEREST_ACCRUED_CCY)   TOTAL_INTEREST_RECEIVABLE_CCY,
                  SUM (INTEREST_ACCRUED_LCL)   TOTAL_INTEREST_RECEIVABLE_LCL,
                  SUM (UNWINDING_INTEREST_CCY) TOTAL_UNWINDING_INTEREST_CCY,
                  SUM (UNWINDING_INTEREST_LCL) TOTAL_UNWINDING_INTEREST_LCL,
                  SUM (AMORTISASI_FEE_CCY)     TOTAL_AMORT_FEE_CCY,
                  SUM (AMORTISASI_FEE_LCL)     TOTAL_AMORT_FEE_LCL,
                  SUM (CADANGAN_KOLEKTIF_CCY) + SUM (CADANGAN_INDIVIDUAL_CCY)
                     TOTAL_ECL_ON_BS_CCY,
                  SUM (CADANGAN_KOLEKTIF_LCL) + SUM (CADANGAN_INDIVIDUAL_LCL)
                     TOTAL_ECL_ON_BS_LCL,
                    SUM (CADANGAN_KOLEKTIF_COM_CCY)
                  + SUM (CADANGAN_INDIV_COM_CCY)
                     TOTAL_ECL_OFF_BS_CCY,
                    SUM (CADANGAN_KOLEKTIF_COM_LCL)
                  + SUM (CADANGAN_INDIV_COM_LCL)
                     TOTAL_ECL_OFF_BS_LCL
             FROM (SELECT a.REPORT_DATE,
                          a.APLIKASI,
                          CASE
                             WHEN OUTSTANDING_ON_BS_CCY_SIGN = '-'
                             THEN
                                OUTSTANDING_ON_BS_CCY * -1
                             ELSE
                                OUTSTANDING_ON_BS_CCY
                          END
                             OUTSTANDING_ON_BS_CCY,
                          CASE
                             WHEN OUTSTANDING_ON_BS_LCL_SIGN = '-'
                             THEN
                                OUTSTANDING_ON_BS_LCL * -1
                             ELSE
                                OUTSTANDING_ON_BS_LCL
                          END
                             OUTSTANDING_ON_BS_LCL,
                          CASE
                             WHEN OUTSTANDING_OFF_BS_CCY_SIGN = '-'
                             THEN
                                OUTSTANDING_OFF_BS_CCY * -1
                             ELSE
                                OUTSTANDING_OFF_BS_CCY
                          END
                             OUTSTANDING_OFF_BS_CCY,
                          CASE
                             WHEN OUTSTANDING_OFF_BS_LCL_SIGN = '-'
                             THEN
                                OUTSTANDING_OFF_BS_LCL * -1
                             ELSE
                                OUTSTANDING_OFF_BS_LCL
                          END
                             OUTSTANDING_OFF_BS_LCL,
                          CASE
                             WHEN UNAMORT_FEE_CCY_SIGN = '-'
                             THEN
                                UNAMORT_FEE_CCY * -1
                             ELSE
                                UNAMORT_FEE_CCY
                          END
                             UNAMORT_FEE_CCY,
                          CASE
                             WHEN UNAMORT_FEE_LCL_SIGN = '-'
                             THEN
                                UNAMORT_FEE_LCL * -1
                             ELSE
                                UNAMORT_FEE_LCL
                          END
                             UNAMORT_FEE_LCL,
                          CASE
                             WHEN INTEREST_ACCRUED_CCY_SIGN = '-'
                             THEN
                                INTEREST_ACCRUED_CCY * -1
                             ELSE
                                INTEREST_ACCRUED_CCY
                          END
                             INTEREST_ACCRUED_CCY,
                          CASE
                             WHEN INTEREST_ACCRUED_LCL_SIGN = '-'
                             THEN
                                INTEREST_ACCRUED_LCL * -1
                             ELSE
                                INTEREST_ACCRUED_LCL
                          END
                             INTEREST_ACCRUED_LCL,
                          CASE
                             WHEN UNWINDING_INTEREST_CCY_SIGN = '-'
                             THEN
                                UNWINDING_INTEREST_CCY * -1
                             ELSE
                                UNWINDING_INTEREST_CCY
                          END
                             UNWINDING_INTEREST_CCY,
                          CASE
                             WHEN UNWINDING_INTEREST_LCL_SIGN = '-'
                             THEN
                                UNWINDING_INTEREST_LCL * -1
                             ELSE
                                UNWINDING_INTEREST_LCL
                          END
                             UNWINDING_INTEREST_LCL,
                          CASE
                             WHEN AMORTISASI_FEE_CCY_SIGN = '-'
                             THEN
                                AMORTISASI_FEE_CCY * -1
                             ELSE
                                AMORTISASI_FEE_CCY
                          END
                             AMORTISASI_FEE_CCY,
                          CASE
                             WHEN AMORTISASI_FEE_LCL_SIGN = '-'
                             THEN
                                AMORTISASI_FEE_LCL * -1
                             ELSE
                                AMORTISASI_FEE_LCL
                          END
                             AMORTISASI_FEE_LCL,
                          CASE
                             WHEN CADANGAN_KOLEKTIF_CCY_SIGN = '-'
                             THEN
                                CADANGAN_KOLEKTIF_CCY * -1
                             ELSE
                                CADANGAN_KOLEKTIF_CCY
                          END
                             CADANGAN_KOLEKTIF_CCY,
                          CASE
                             WHEN CADANGAN_KOLEKTIF_LCL_SIGN = '-'
                             THEN
                                CADANGAN_KOLEKTIF_LCL * -1
                             ELSE
                                CADANGAN_KOLEKTIF_LCL
                          END
                             CADANGAN_KOLEKTIF_LCL,
                          CASE
                             WHEN CADANGAN_INDIVIDUAL_CCY_SIGN = '-'
                             THEN
                                CADANGAN_INDIVIDUAL_CCY * -1
                             ELSE
                                CADANGAN_INDIVIDUAL_CCY
                          END
                             CADANGAN_INDIVIDUAL_CCY,
                          CASE
                             WHEN CADANGAN_INDIVIDUAL_LCL_SIGN = '-'
                             THEN
                                CADANGAN_INDIVIDUAL_LCL * -1
                             ELSE
                                CADANGAN_INDIVIDUAL_LCL
                          END
                             CADANGAN_INDIVIDUAL_LCL,
                          CASE
                             WHEN CADANGAN_KOLEKTIF_COM_CCY_SIGN = '-'
                             THEN
                                CADANGAN_KOLEKTIF_COM_CCY * -1
                             ELSE
                                CADANGAN_KOLEKTIF_COM_CCY
                          END
                             CADANGAN_KOLEKTIF_COM_CCY,
                          CASE
                             WHEN CADANGAN_KOLEKTIF_COM_LCL_SIGN = '-'
                             THEN
                                CADANGAN_KOLEKTIF_COM_LCL * -1
                             ELSE
                                CADANGAN_KOLEKTIF_COM_LCL
                          END
                             CADANGAN_KOLEKTIF_COM_LCL,
                          CASE
                             WHEN CADANGAN_INDIV_COM_CCY_SIGN = '-'
                             THEN
                                CADANGAN_INDIV_COM_CCY * -1
                             ELSE
                                CADANGAN_INDIV_COM_CCY
                          END
                             CADANGAN_INDIV_COM_CCY,
                          CASE
                             WHEN CADANGAN_INDIV_COM_LCL_SIGN = '-'
                             THEN
                                CADANGAN_INDIV_COM_LCL * -1
                             ELSE
                                CADANGAN_INDIV_COM_LCL
                          END
                             CADANGAN_INDIV_COM_LCL
                     FROM IFRS_NOMINATIVE_LBU a)
            WHERE REPORT_DATE =
                     (SELECT MAX (report_date) FROM IFRS_NOMINATIVE_LBU) --    group by APLIKASI
                                                                        ) LBU;

create view IFRS9_BCA.VW_IFRS_REV_VS_BTK_GL_FS_AMT as
SELECT REV_BLN_INI.DOWNLOAD_DATE                        DOWNLOAD_DATE,
            REV_BLN_INI.JURNAL_ID,
            REV_BLN_INI.COA,
            REV_BLN_INI.MTU,
            REV_BLN_INI.KET,
            REV_BLN_INI.CYCP,
            REV_BLN_INI.SEQ                                  REV_BLN_INI_SEQ,
            REV_BLN_INI.DC                                   REV_BLN_INI_DC,
            REV_BLN_INI.AMT_EQ_IDR                           REV_BLN_INI_EQ_IDR,
            REV_BLN_INI.AMT_ORI                              REV_BLN_INI_ORI_CURRENCY,
            BTK_BLN_LALU.SEQ                                 BTK_BLN_LALU_SEQ,
            BTK_BLN_LALU.DC                                  BTK_BLN_LALU_DC,
            BTK_BLN_LALU.AMT_EQ_IDR                          BTK_BLN_LALU_EQ_IDR,
            BTK_BLN_LALU.AMT_ORI                             BTK_BLN_LALU_ORI_CURRENCY,
            (REV_BLN_INI.AMT_EQ_IDR + BTK_BLN_LALU.AMT_EQ_IDR) SELISIH_EQ_IDR,
            (REV_BLN_INI.AMT_ORI + BTK_BLN_LALU.AMT_ORI)
               SELISIH_ORI_CURRENCY,
            COALESCE (KURS_BLN_INI.RATE_AMOUNT, 0)           KURS_BULAN_INI,
            COALESCE (KURS_BLN_LALU.RATE_AMOUNT, 0)          KURS_BLN_LALU,
            (  COALESCE (KURS_BLN_INI.RATE_AMOUNT, 0)
             - COALESCE (KURS_BLN_LALU.RATE_AMOUNT, 0))
               SELISIH_KURS,
            ROUND (
               (  REV_BLN_INI.AMT_ORI
                * (  COALESCE (KURS_BLN_INI.RATE_AMOUNT, 0)
                   - COALESCE (KURS_BLN_LALU.RATE_AMOUNT, 0))),
               2)
               REV_AMT_ORI_TMS_SLSH_KURS,
              (REV_BLN_INI.AMT_EQ_IDR + BTK_BLN_LALU.AMT_EQ_IDR)
            - (ROUND (
                  (  REV_BLN_INI.AMT_ORI
                   * (  COALESCE (KURS_BLN_INI.RATE_AMOUNT, 0)
                      - COALESCE (KURS_BLN_LALU.RATE_AMOUNT, 0))),
                  2))
               AMT_SELISIH_KURS
       FROM (  SELECT DOWNLOAD_DATE,
                      JURNAL_ID,
                      COA,
                      MTU,
                      KET,
                      CYCP,
                      SEQ,
                      DC,
                      SUM (AMT_EQ_IDR) AMT_EQ_IDR,
                      SUM (AMT_ORI) AMT_ORI
                 FROM (SELECT DOWNLOAD_DATE,
                              AAK_JRNLID   JURNAL_ID,
                              AAK_VLMKEY   COA,
                              AAK_CURRCD   MTU,
                              AAK_DESC     KET,
                              AAK_JA || AAK_JT CYCP,
                              AAK_VLMKEY_SEQ SEQ,
                              AAK_DCCD     DC,
                              CASE
                                 WHEN AAK_RP_SIGN = '-' THEN AAK_AMT_RP * -1
                                 ELSE AAK_AMT_RP
                              END
                                 AMT_EQ_IDR,
                              CASE
                                 WHEN AAK_VA_SIGN = '-' THEN AAK_AMT_VA * -1
                                 ELSE AAK_AMT_VA
                              END
                                 AMT_ORI
                         FROM IFRS_GL_OUTBOUND_FS_AMT_R
                        WHERE     1 = 1
                              AND AAK_VLMKEY_SEQ IN ('308', '309')
                              AND LAST_DAY (DOWNLOAD_DATE) = (SELECT MAX (REPORT_DATE) FROM IFRS_NOMINATIVE))
                WHERE 1 = 1
             GROUP BY DOWNLOAD_DATE,
                      JURNAL_ID,
                      COA,
                      MTU,
                      KET,
                      CYCP,
                      SEQ,
                      DC) REV_BLN_INI
            INNER JOIN
            (  SELECT DOWNLOAD_DATE,
                      JURNAL_ID,
                      COA,
                      MTU,
                      KET,
                      CYCP,
                      SEQ,
                      DC,
                      SUM (AMT_EQ_IDR) AMT_EQ_IDR,
                      SUM (AMT_ORI) AMT_ORI
                 FROM (SELECT A.DOWNLOAD_DATE,
                              CASE WHEN BRANCH_DESTINATION IS NULL THEN AAK_VLMKEY ELSE B.BRANCH_DESTINATION || substr(A.AAK_VLMKEY, 5)END COA,
                              CASE WHEN BRANCH_DESTINATION IS NULL THEN AAK_JRNLID ELSE B.BRANCH_DESTINATION || substr(A.AAK_JRNLID, 5) END JURNAL_ID,
                              AAK_CURRCD   MTU,
                              AAK_DESC     KET,
                              AAK_JA || AAK_JT CYCP,
                              AAK_VLMKEY_SEQ SEQ,
                              AAK_DCCD     DC,
                              CASE
                                 WHEN AAK_RP_SIGN = '-' THEN AAK_AMT_RP * -1
                                 ELSE AAK_AMT_RP
                              END
                                 AMT_EQ_IDR,
                              CASE
                                 WHEN AAK_VA_SIGN = '-' THEN AAK_AMT_VA * -1
                                 ELSE AAK_AMT_VA
                              END
                                 AMT_ORI
                         FROM IFRS_GL_OUTBOUND_FS_AMT a
                         LEFT JOIN (SELECT * FROM TBLU_JOURNAL_BRANCH WHERE DOWNLOAD_DATE = (SELECT MAX(REPORT_DATE) FROM IFRS_NOMINATIVE)) B
        ON substr(A.AAK_JRNLID, 0, 4) = B.BRANCH_SOURCE
              and substr(A.AAK_VLMKEY, 0, 4) = B.BRANCH_SOURCE
                        WHERE     1 = 1
                              AND AAK_VLMKEY_SEQ IN ('308', '309')
                              AND LAST_DAY (A.DOWNLOAD_DATE) = (SELECT LAST_DAY(ADD_MONTHS(MAX(REPORT_DATE), -1)) FROM IFRS_NOMINATIVE)
                              )
                WHERE 1 = 1
             GROUP BY DOWNLOAD_DATE,
                      JURNAL_ID,
                      COA,
                      MTU,
                      KET,
                      CYCP,
                      SEQ,
                      DC) BTK_BLN_LALU
               ON     REV_BLN_INI.JURNAL_ID = BTK_BLN_LALU.JURNAL_ID
                  AND REV_BLN_INI.COA = BTK_BLN_LALU.COA
                  AND REV_BLN_INI.MTU = BTK_BLN_LALU.MTU
                  AND REV_BLN_INI.DC <> BTK_BLN_LALU.DC
            LEFT JOIN IFRS_MASTER_EXCHANGE_RATE KURS_BLN_INI
               ON     REV_BLN_INI.DOWNLOAD_DATE = KURS_BLN_INI.DOWNLOAD_DATE
                  AND REV_BLN_INI.MTU = KURS_BLN_INI.CURRENCY
            LEFT JOIN IFRS_MASTER_EXCHANGE_RATE KURS_BLN_LALU
               ON     BTK_BLN_LALU.DOWNLOAD_DATE = KURS_BLN_LALU.DOWNLOAD_DATE
                  AND BTK_BLN_LALU.MTU = KURS_BLN_LALU.CURRENCY
   ORDER BY REV_BLN_INI.COA, REV_BLN_INI.MTU, REV_BLN_INI.DC;

create view IFRS9_BCA.VW_IFRS_NOMI_VS_GL_FS_AMT as
SELECT DOWNLOAD_DATE,
            JOURNAL_CODE,
            CABANG,
            SEQ,
            KOMBINASI_COA,
            CURRENCY,
            SUM (JURNAL_CCY)        JURNAL_ORI_CCY,
            SUM (JURNAL_LCL)        JURNAL_EQ_IDR,
            SUM (NOMINATIF_CCY)     AMORT99_ORI_CCY,
            SUM (NOMINATIF_LCL)     AMORT99_EQ_IDR,
            SUM (SELISIH_CEK_AMT_CCY) SELISIH_CEK_AMT_CCY,
            SUM (SELISIH_CEK_AMT_LCL) SELISIH_CEK_AMT_LCL
       FROM (SELECT LAST_DAY (REKON.DOWNLOAD_DATE)        DOWNLOAD_DATE,
                    N.MASTER_ID                           MASTERID,
                    N.DEAL_ID                             ACCOUNT_NUMBER,
                    REKON.JOURNAL_CODE                    JOURNAL_CODE,
                    REKON.BRANCH_CODE                     CABANG,
                    REKON.AAK_VLMKEY_SEQ                  SEQ,
                    REKON.AAK_VLMKEY                      KOMBINASI_COA,
                    REKON.AAK_CURRCD                      CURRENCY,
                    ABS (REKON.AAK_AMT_VA)                JURNAL_CCY,
                      ABS (REKON.AAK_AMT_VA)
                    * COALESCE (KURS_BLN_INI.RATE_AMOUNT, 0)
                       JURNAL_LCL,
                    NVL (N.AMORTISATION_99_FILTERED_CCY, 0) NOMINATIF_CCY,
                      NVL (N.AMORTISATION_99_FILTERED_CCY, 0)
                    * COALESCE (KURS_BLN_INI.RATE_AMOUNT, 0)
                       NOMINATIF_LCL,
                      ABS (REKON.AAK_AMT_VA)
                    - (NVL (N.AMORTISATION_99_FILTERED_CCY, 0))
                       SELISIH_CEK_AMT_CCY,
                      (  ABS (REKON.AAK_AMT_VA)
                       * COALESCE (KURS_BLN_INI.RATE_AMOUNT, 0))
                    - (  NVL (N.AMORTISATION_99_FILTERED_CCY, 0)
                       * COALESCE (KURS_BLN_INI.RATE_AMOUNT, 0))
                       SELISIH_CEK_AMT_LCL
               FROM IFRS_AMORT99_FS N
                    LEFT JOIN
                    (SELECT iaarr.download_date   DOWNLOAD_DATE,
                            iaarr.journal_code    JOURNAL_CODE,
                            iaarr.masterid        MASTERID,
                            mid.master_account_code ACCOUNT_NUMBER,
                            iaarr.branch_code     BRANCH_CODE,
                            iaarr.glno            AAK_VLMKEY,
                            iaarr.seq             AAK_VLMKEY_SEQ,
                            iaarr.currency        AAK_CURRCD,
                            para.journal_desc     AAK_DESC,
                            iaarr.drcr            AAK_DCCD,
                            CASE
                               WHEN iaarr.DRCR = 'C' THEN iaarr.amount_ccy * -1
                               ELSE iaarr.amount_ccy
                            END
                               AAK_AMT_VA
                       FROM IFRS_FS_ACCT_AMORT_RPT_REKON iaarr,
                            IFRS_JOURNAL_PARAM         para,
                            IFRS_MASTERID              mid
                      WHERE     1 = 1
                            AND para.glno = iaarr.glno
                            AND iaarr.amount_ccy <> 0
                            AND iaarr.reverse = 'N'
                            AND iaarr.journal_code = para.journalcode
                            AND iaarr.masterid = mid.pkid
                            AND iaarr.journal_code IN
                                   ('RECORE', 'ITRCG', 'ACCRU')
                            AND LAST_DAY (iaarr.DOWNLOAD_DATE) = (SELECT MAX (REPORT_DATE) FROM IFRS_NOMINATIVE)) REKON
                       ON     N.MASTER_ID = REKON.MASTERID 
                    LEFT JOIN IFRS_MASTER_EXCHANGE_RATE KURS_BLN_INI
                       ON     REKON.AAK_CURRCD = KURS_BLN_INI.CURRENCY 
                          AND KURS_BLN_INI.DOWNLOAD_DATE = REKON.DOWNLOAD_DATE
              WHERE 1 = 1 
              AND REKON.MASTERID IS NOT NULL)
      WHERE 1 = 1
   GROUP BY DOWNLOAD_DATE,
            JOURNAL_CODE,
            CABANG,
            SEQ,
            KOMBINASI_COA,
            CURRENCY
     HAVING SUM (NOMINATIF_CCY) <> 0 AND SUM (NOMINATIF_LCL) <> 0
   ORDER BY JOURNAL_CODE,
            CABANG,
            SEQ,
            KOMBINASI_COA,
            CURRENCY;

create view IFRS9_BCA.VW_IFRS_NOMI_TO_FINMART_TEST as
SELECT N.REPORT_DATE,
          N.SOURCE_TYPE,
          N.DATA_SOURCE,
          N.BRANCH_CODE,
          N.LBU_FORM,
          N.NOREK_LBU,
          N.FACILITY_NUMBER,
          N.ACCOUNT_NUMBER,
          N.CUSTOMER_NUMBER,
          N.CUSTOMER_NAME,
          N.SECTOR_ECONOMIC,
          N.SECTOR_COMMODITY,
          N.GOL_DEB,
          N.PRODUCT_GROUP,
          N.PRODUCT_TYPE,
          N.PRODUCT_CODE,
          N.PRODUCT_DESC,
          N.PRODUCT_CODE_GL,
          N.INSTRUMENT,
          N.INV_TYPE,
          N.SEC_NAME,
          N.PORTFOLIO,
          N.CONTRACT_ID,
          N.START_DATE,
          N.MATURITY_DATE,
          N.SETTLE_DATE,
          N.DELINQUENCY,
          N.NEXT_PAYMENT_DATE,
          N.DAY_PAST_DUE,
          N.RATING_CODE,
          N.EXTERNAL_RATING,
          N.SWIFT_CODE,
          N.IMP_RATING,
          N.GROUP_SEGMENT,
          N.SEGMENT,
          N.SUB_SEGMENT,
          N.BUCKET_NAME,
          N.BI_COLLECTABILITY,
          N.STAGE,
          N.LIFETIME_PERIOD,
          N.ASSESSMENT_IMP,
          N.NPL_FLAG,
          N.POCI_FLAG,
          N.BTB_FLAG,
          N.REVOLVING_FLAG,
          N.COMMITMENT_FLAG,
          N.IFRS9_CLASS,
          N.CURRENCY,
          N.EXCHANGE_RATE,
          N.MARKET_RATE,
          N.INTEREST_CALCULATION_CODE,
          N.CONTRACTUAL_INTEREST_RATE,
          N.EIR,
          N.COA_BAL,
          N.PRINCIPAL_AMOUNT_CCY,
          N.PRINCIPAL_AMOUNT_LCL,
          N.INTEREST_RECEIVABLE_CCY,
          N.INTEREST_RECEIVABLE_LCL,
          N.PREMI_DISCOUNT_AMOUNT_CCY,
          N.PREMI_DISCOUNT_AMOUNT_LCL,
          CASE
             WHEN N.DATA_SOURCE = 'KTP' THEN N.PRINCIPAL_AMOUNT_CCY
             WHEN N.DATA_SOURCE = 'RKN' THEN N.OUTSTANDING_PRINCIPAL_CCY
             ELSE N.OUTSTANDING_ON_BS_CCY
          END
             OUTSTANDING_ON_BS_CCY,
          CASE
             WHEN N.DATA_SOURCE = 'KTP' THEN N.PRINCIPAL_AMOUNT_LCL
             WHEN N.DATA_SOURCE = 'RKN' THEN N.OUTSTANDING_PRINCIPAL_LCL
             ELSE N.OUTSTANDING_ON_BS_LCL
          END
             OUTSTANDING_ON_BS_LCL,
          CASE
             WHEN N.DATA_SOURCE IN ('KTP', 'RKN') THEN 0
             ELSE N.OUTSTANDING_OFF_BS_CCY
          END
             OUTSTANDING_OFF_BS_CCY,
          CASE
             WHEN N.DATA_SOURCE IN ('KTP', 'RKN') THEN 0
             ELSE N.OUTSTANDING_OFF_BS_LCL
          END
             OUTSTANDING_OFF_BS_LCL,
          N.CARRYING_AMOUNT_CCY,
          N.CARRYING_AMOUNT_LCL,
          NVL (N.MARKET_RATE, 0)                            MARKET_VALUE_CCY,
          NVL (N.MARKET_RATE, 0) * NVL (N.EXCHANGE_RATE, 1) MARKET_VALUE_LCL,
          N.SALDO_YADIT_CCY,
          N.SALDO_YADIT_LCL,
          N.INITIAL_FEE_CCY,
          N.INITIAL_FEE_LCL,
          N.INITIAL_COST_CCY,
          N.INITIAL_COST_LCL,
          N.AMORT_FEE_CCY,
          N.AMORT_FEE_LCL,
          N.AMORT_COST_CCY,
          N.AMORT_COST_LCL,
          N.UNAMORT_FEE_AMT_CCY,
          N.UNAMORT_FEE_AMT_LCL,
          N.UNAMORT_COST_AMT_CCY,
          N.UNAMORT_COST_AMT_LCL,
          N.PV_EXPECTED_CF_IA_CCY,
          N.PV_EXPECTED_CF_IA_LCL,
          N.IA_UNWINDING_INTEREST_CCY,
          N.IA_UNWINDING_INTEREST_LCL,
          N.LIMIT_AMT_CCY,
          N.CCF_RATE,
          N.CCF_AMOUNT_CCY,
          N.CCF_AMOUNT_LCL,
          N.PREPAYMENT_RATE,
          N.PREPAYMENT_AMOUNT_CCY,
          N.PREPAYMENT_AMOUNT_LCL,
          N.EAD_AMOUNT_CCY,
          N.EAD_AMOUNT_LCL,
          N.ECL_ON_BS_CCY,
          N.ECL_ON_BS_LCL,
          N.ECL_OFF_BS_CCY,
          N.ECL_OFF_BS_LCL,
          N.ECL_TOTAL_CCY,
          N.ECL_TOTAL_LCL,
          N.RESERVED_AMOUNT_2
             AS ECL_ON_BS_FINAL_CCY,
          N.RESERVED_AMOUNT_3
             AS ECL_ON_BS_FINAL_LCL,
          N.RESERVED_AMOUNT_4
             AS ECL_TOTAL_FINAL_CCY,
          N.RESERVED_AMOUNT_5
             AS ECL_TOTAL_FINAL_LCL,
          N.SPECIAL_REASON,
          N.AMORT_FEE_AMT_ILS_CCY,
          N.AMORT_FEE_AMT_ILS_LCL,
          N.UNAMORT_FEE_AMT_ILS_CCY,
          N.UNAMORT_FEE_AMT_ILS_LCL,
          A.CR_STAGE                                        STAGE_ORI,
          NVL (A.RESERVED_FLAG_4, 0)                        AS COVID_FLAG,
          NVL (A.RESTRUCTURE_FLAG, 0)
             AS RESTRUCTURE_FLAG,
          NVL (A.RESERVED_FLAG_1, -1)                       AS FLAG_IMP,
          N.RESERVED_AMOUNT_6
             AS NILAI_TERCATAT_ON,
          N.RESERVED_AMOUNT_7
             AS NILAI_TERCATAT_OFF,
          N.RESERVED_VARCHAR_2                              AS TRA,
          N.RESERVED_VARCHAR_5                              AS ASET_KEUANGAN,
          NVL (N.BI_CODE, ' ')                              AS BI_CODE
     FROM IFRS_NOMINATIVE N, IFRS_MASTER_ACCOUNT_MONTHLY A
    WHERE     1 = 1
          --AND N.REPORT_DATE = (SELECT MAX (REPORT_DATE) FROM IFRS_NOMINATIVE)
          AND N.REPORT_DATE = '31-AUG-2021'
          AND A.DOWNLOAD_DATE = N.REPORT_DATE
          AND N.MASTERID = A.MASTERID
          AND (   (    N.DATA_SOURCE = 'BTRD'
                   AND N.ACCOUNT_STATUS = 'A'
                   AND NVL (N.BI_CODE, ' ') <> '0')
               OR (    N.DATA_SOURCE = 'CRD'
                   AND (N.ACCOUNT_STATUS = 'A' OR N.outstanding_on_bs_ccy > 0))
               OR (N.DATA_SOURCE = 'ILS' AND N.account_status = 'A')
               OR (N.DATA_SOURCE = 'LIMIT' AND N.account_status = 'A')
               OR (    N.DATA_SOURCE = 'KTP'
                   AND N.ACCOUNT_STATUS = 'A'
                   AND UPPER (N.PRODUCT_CODE) <> 'BORROWING')
               OR (    N.DATA_SOURCE = 'PBMM'
                   AND N.ACCOUNT_STATUS = 'A'
                   AND UPPER (N.PRODUCT_CODE) <> 'BORROWING')
               OR (    N.DATA_SOURCE = 'RKN'
                   AND N.ACCOUNT_STATUS = 'A'
                   AND NVL (N.OUTSTANDING_PRINCIPAL_CCY, 0) >= 0))
          AND NOT EXISTS
                 (SELECT 1
                    FROM IFRS_NOMINATIVE L
                   WHERE     L.REPORT_DATE = N.REPORT_DATE
                         AND L.DATA_SOURCE = 'ILS'
                         AND L.ACCOUNT_STATUS = 'A'
                         AND N.DATA_SOURCE = 'LIMIT'
                         AND N.ACCOUNT_NUMBER = L.FACILITY_NUMBER);

create view IFRS9_BCA.VW_IFRS_AMORT_UNAMORT as
SELECT  CURRDATE as  REPORT_DATE, download_date as TGL_AMORT, 
           sum(AMORT_FEE_LCL) as AMORT_FEE_LCL, sum(UNAMORT_FEE_AMT_LCL) as UNAMORT_FEE_AMT_LCL,
           sum(AMORT_FEE_ILS_LCL) as AMORT_FEE_ILS_LCL, sum(UNAMORT_FEE_ILS_LCL) as UNAMORT_FEE_ILS_LCL
    FROM (
        SELECT B.CURRDATE CURRDATE,
               DOWNLOAD_DATE, 
               Account_number,
               CASE WHEN (NVL(A.INITIAL_UNAMORT_ORG_FEE, 0) - NVL(UNAMORT_FEE_AMT,0)) > 0 
               THEN 0 
               ELSE NVL(A.INITIAL_UNAMORT_ORG_FEE, 0) - NVL(UNAMORT_FEE_AMT,0) 
               END * NVL(A.EXCHANGE_RATE, 1) AS AMORT_FEE_LCL,
               NVL(UNAMORT_FEE_AMT,0) * NVL(A.EXCHANGE_RATE, 1) AS UNAMORT_FEE_AMT_LCL,
               NVL(A.RESERVED_AMOUNT_5, 0) * NVL(A.EXCHANGE_RATE, 1) AS AMORT_FEE_ILS_LCL,
               NVL(A.RESERVED_AMOUNT_6, 0) * NVL(A.EXCHANGE_RATE, 1) AS UNAMORT_FEE_ILS_LCL
        FROM IFRS_MASTER_ACCOUNT A, (SELECT CURRDATE FROM IFRS_PRC_DATE) B
        WHERE 1 = 1
        AND A.download_date BETWEEN TRUNC(B.CURRDATE, 'MM') AND B.CURRDATE
        AND A.data_source = 'ILS'
        AND A.account_status = 'A'
        AND NVL(A.REVOLVING_FLAG,0) = 0 
        AND ((NVL(A.PRODUCT_CODE, ' ') NOT LIKE  ('3%')  AND  NVL(A.PRODUCT_CODE, ' ') NOT IN  ('610','510','520','525','530','540','545','550','560','570','600','601','602','620','630','640','641')  AND  NVL(A.RATING_CODE, ' ') IN  ('X','AAA','AA+','AA','AA-','A+','A','A-','BBB+','BBB','BBB-','BB+','BB','BB-','B+','B','B-','CCC+','CCC','CCC-','CC+','CC','CC-','C+','C','C-','D','Aaa','Aa1','Aa2','Aa3','A1','A2','A3','Baa1','Baa2','Baa3','Ba1','Ba2','Ba3','B1','B2','B3','Caa1','Caa2','Caa3','Ca1','Ca2','Ca3','C1','C2','C3')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')) AND (NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.CURRENCY, ' ') NOT IN  ('IDR'))
            OR (NVL(A.PRODUCT_CODE, ' ') NOT LIKE  ('3%')  AND  NVL(A.PRODUCT_CODE, ' ') NOT IN  ('610','510','520','525','530','540','545','550','560','570','600','601','602','620','630','640','641')  AND  NVL(A.PRODUCT_CODE, ' ') NOT LIKE  ('B%')  AND  NVL(A.RATING_CODE, ' ') IN  ('BR9','BR8','BR7','BR6','BR5','BR4','BR3','BR2','BR10','BR1')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')) AND (NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.CURRENCY, ' ') IN  ('IDR')) OR (NVL(A.DATA_SOURCE, ' ') IN  ('ILS')  AND  NVL(A.RESERVED_VARCHAR_10, ' ') IN  ('848611','848612','848613','848614')  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('L','M')  AND  NVL(A.CURRENCY, ' ') IN  ('IDR')  AND  NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.RATING_CODE, ' ') IN  ('UNK')) OR (NVL(A.DATA_SOURCE, ' ') IN  ('LIMIT')  AND  NVL(A.PRODUCT_CODE, ' ') IN  ('KTB','KLB','KIB')  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('L','M')  AND  NVL(A.CURRENCY, ' ') IN  ('IDR')  AND  NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.RATING_CODE, ' ') IN  ('UNK'))
            OR (NVL(A.PRODUCT_CODE, ' ') NOT LIKE  ('3%')  AND  NVL(A.PRODUCT_CODE, ' ') NOT IN  ('610','510','520','525','530','540','545','550','560','570','600','601','602','620','630','640','641')  AND  NVL(A.PRODUCT_CODE, ' ') NOT LIKE  ('B%')  AND  NVL(A.RATING_CODE, ' ') IN  ('BR9','BR8','BR7','BR6','BR5','BR4','BR3','BR2','BR10','BR1')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')) AND (NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.CURRENCY, ' ') NOT IN  ('IDR')) OR (NVL(A.DATA_SOURCE, ' ') IN  ('ILS')  AND  NVL(A.RESERVED_VARCHAR_10, ' ') IN  ('848611','848612','848613','848614')  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('L','M')  AND  NVL(A.CURRENCY, ' ') NOT IN  ('IDR')  AND  NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.RATING_CODE, ' ') IN  ('UNK')) OR (NVL(A.DATA_SOURCE, ' ') IN  ('LIMIT')  AND  NVL(A.PRODUCT_CODE, ' ') IN  ('KTB','KLB','KIB')  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('M','L')  AND  NVL(A.CURRENCY, ' ') NOT IN  ('IDR')  AND  NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.RATING_CODE, ' ') IN  ('UNK'))
            OR (NVL(A.PRODUCT_CODE, ' ') NOT LIKE  ('3%')  AND  NVL(A.PRODUCT_CODE, ' ') NOT IN  ('610','510','520','525','530','540','545','550','560','570','600','601','602','620','630','640','641')  AND  NVL(A.RATING_CODE, ' ') IN  ('X','AAA','AA+','AA','AA-','A+','A','A-','BBB+','BBB','BBB-','BB+','BB','BB-','B+','B','B-','CCC+','CCC','CCC-','CC+','CC','CC-','C+','C','C-','D','Aaa','Aa1','Aa2','Aa3','A1','A2','A3','Baa1','Baa2','Baa3','Ba1','Ba2','Ba3','B1','B2','B3','Caa1','Caa2','Caa3','Ca1','Ca2','Ca3','C1','C2','C3')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')) AND (NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.CURRENCY, ' ') IN  ('IDR'))
            OR (NVL(A.PRODUCT_CODE, ' ') NOT LIKE  ('3%')  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('M')  AND  NVL(A.PRODUCT_CODE, ' ') NOT IN  ('610','510','520','525','530','540','545','550','560','570','600','601','602','620','630','640','641')) AND (NVL(A.RATING_CODE, ' ') LIKE  ('R%')  OR  NVL(A.RATING_CODE, ' ') LIKE  ('%Loss%')  OR  NVL(A.RATING_CODE, ' ') LIKE  ('%LOSS%')) AND (NVL(A.REVOLVING_FLAG,0) = 0) AND (NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')) AND (NVL(A.PRODUCT_CODE, ' ') NOT IN  ('BSL','BPC','BGR','BGP','BGL','BGB')) AND (NVL(A.PRODUCT_CODE, ' ') NOT IN  ('KLG','KFX','KBR','KXT')) OR (NVL(A.PRODUCT_CODE, ' ') NOT LIKE  ('3%')  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('M')  AND  NVL(A.PRODUCT_CODE, ' ') NOT IN  ('610','510','520','525','530','540','545','550','560','570','600','601','620','630','640','641')) AND (NVL(A.RATING_CODE, ' ') IN  ('UNK')) AND (NVL(A.REVOLVING_FLAG,0) = 0) AND (NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')) AND (NVL(A.PRODUCT_CODE, ' ') NOT IN  ('BGP','BGL','BGB','BPC','BSL','BGR','KLG','KXT','KBR','SLC','SLI','SLL','ULL','ULI','KLB','KIB','KTB','KFX')) AND (NVL(A.RESERVED_VARCHAR_10, ' ') NOT IN  ('848611','848612','848613','848614'))
            OR (NVL(A.PRODUCT_CODE, ' ') NOT LIKE  ('3%')  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('L')  AND  NVL(A.PRODUCT_CODE, ' ') NOT IN  ('610','510','520','530','540','550','560','570','600','601','602','620','630','640','641')) AND (NVL(A.RATING_CODE, ' ') LIKE  ('R%')  OR  NVL(A.RATING_CODE, ' ') LIKE  ('%Loss%')  OR  NVL(A.RATING_CODE, ' ') LIKE  ('%LOSS%')) AND (NVL(A.REVOLVING_FLAG,0) = 0) AND (NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')) AND (NVL(A.PRODUCT_CODE, ' ') NOT IN  ('BSL','BPC','BGR','BGP','BGL','BGB')) AND (NVL(A.PRODUCT_CODE, ' ') NOT IN  ('KLG','KFX','KBR','KXT')) OR (NVL(A.PRODUCT_CODE, ' ') NOT LIKE  ('3%')  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('L')  AND  NVL(A.PRODUCT_CODE, ' ') NOT IN  ('610','510','540','530','525','520','570','560','550','545','601','600','641','640','630','620')) AND (NVL(A.RATING_CODE, ' ') IN  ('UNK')) AND (NVL(A.REVOLVING_FLAG,0) = 0) AND (NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')) AND (NVL(A.PRODUCT_CODE, ' ') NOT IN  ('BGB','BGL','BGP','BPC','BSL','BGR','KBR','KLG','KXT','SLC','SLI','SLL','ULL','ULI','KIB','KTB','KLB','KFX')) AND (NVL(A.RESERVED_VARCHAR_10, ' ') NOT IN  ('848611','848612','848613','848614'))
            OR (NVL(A.PRODUCT_CODE, ' ') IN  ('322','330')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')  AND  NVL(A.REVOLVING_FLAG,0) = 1  AND  NVL(A.RESERVED_VARCHAR_2, ' ') NOT IN  ('X')) OR (NVL(A.PRODUCT_CODE, ' ') IN  ('322')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')  AND  NVL(A.REVOLVING_FLAG,0) = 1  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('X'))
            OR (NVL(A.PRODUCT_CODE, ' ') IN  ('300','301','302','305','306','610','KBR','KXT')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')  AND  NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('X'))
            OR (NVL(A.PRODUCT_CODE, ' ') IN  ('301','300','302','305','306','303','610','KBR','KXT')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')  AND  NVL(A.REVOLVING_FLAG,0) = 1  AND  NVL(A.RESERVED_VARCHAR_2, ' ') NOT IN  ('X')) OR (NVL(A.PRODUCT_CODE, ' ') IN  ('303')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')  AND  NVL(A.REVOLVING_FLAG,0) = 1  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('X'))
            OR (NVL(A.PRODUCT_CODE, ' ') IN  ('300','301','302','305','306','610','KBR','KXT')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('LIMIT','ILS')  AND  NVL(A.REVOLVING_FLAG,0) = 1  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('X'))
            OR (NVL(A.PRODUCT_CODE, ' ') IN  ('330')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')  AND  NVL(A.REVOLVING_FLAG,0) = 1  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('X'))
            OR (NVL(A.PRODUCT_CODE, ' ') IN  ('330')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')  AND  NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('X'))
            OR (NVL(A.PRODUCT_CODE, ' ') IN  ('322','330')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')  AND  NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.RESERVED_VARCHAR_2, ' ') NOT IN  ('X')) OR (NVL(A.PRODUCT_CODE, ' ') IN  ('322')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')  AND  NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('X'))
            OR (NVL(A.PRODUCT_CODE, ' ') IN  ('300','302','303','305','306','301','610','KBR','KXT')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')  AND  NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.RESERVED_VARCHAR_2, ' ') NOT IN  ('X')) OR (NVL(A.PRODUCT_CODE, ' ') IN  ('303')  AND  NVL(A.DATA_SOURCE, ' ') IN  ('ILS','LIMIT')  AND  NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('X'))
            OR (NVL(A.DATA_SOURCE, ' ') IN  ('ILS')  AND  NVL(A.PRODUCT_CODE, ' ') IN  ('630','620')  AND  NVL(A.REVOLVING_FLAG,0) = 0) OR (NVL(A.DATA_SOURCE, ' ') IN  ('ILS')  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('K')  AND  NVL(A.BRANCH_CODE, ' ') NOT LIKE  ('%0960%')  AND  NVL(A.PRODUCT_CODE, ' ') NOT LIKE  ('3%')  AND  NVL(A.PRODUCT_CODE, ' ') NOT LIKE  ('B%')  AND  NVL(A.PRODUCT_CODE, ' ') NOT IN  ('610','510','520','525','530','540','545','550','560','570','600','601','602','640','641')  AND  NVL(A.REVOLVING_FLAG,0) = 0) OR (NVL(A.DATA_SOURCE, ' ') IN  ('LIMIT')  AND  NVL(A.PRODUCT_CODE, ' ') NOT IN  ('KLG','KFX','KBR','KXT')  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('K')  AND  NVL(A.REVOLVING_FLAG,0) = 0) AND (NVL(A.PRODUCT_CODE, ' ') NOT IN  ('BSL','BPC','BGR','BGP','BGL','BGB')) OR (NVL(A.DATA_SOURCE, ' ') IN  ('ILS')  AND  NVL(A.RATING_CODE, ' ') IN  ('UNK')  AND  NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('K')  AND  NVL(A.PRODUCT_CODE, ' ') IN  ('200')  AND  NVL(A.BRANCH_CODE, ' ') IN  ('0960'))
            OR (NVL(A.PRODUCT_CODE, ' ') IN  ('320','321')  AND  NVL(A.BRANCH_CODE, ' ') NOT LIKE  ('0960')) AND (NVL(A.REVOLVING_FLAG,0) = 0) AND (NVL(A.DATA_SOURCE, ' ') IN  ('ILS'))
            OR (NVL(A.PRODUCT_CODE, ' ') IN  ('320','230')  AND  NVL(A.BRANCH_CODE, ' ') LIKE  ('0960')) AND (NVL(A.REVOLVING_FLAG,0) = 0) AND (NVL(A.DATA_SOURCE, ' ') IN  ('ILS'))
            OR (NVL(A.DATA_SOURCE, ' ') IN  ('ILS')  AND  NVL(A.PRODUCT_CODE, ' ') IN  ('510','520','530','525','641','640','602','601','600','570','560','550','545','540')  AND  NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.RATING_CODE, ' ') IN  ('RR1','RR2','RR3','RR4','RR5','RR6','RR7','RR8','RR9','RR10','LOSS')) OR (NVL(A.DATA_SOURCE, ' ') IN  ('ILS')  AND  NVL(A.PRODUCT_CODE, ' ') NOT LIKE  ('3%')  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('S')  AND  NVL(A.PRODUCT_CODE, ' ') NOT IN  ('610','BSL','BPC','BGR','BGP','BGL','BGB','620','630')  AND  NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.RATING_CODE, ' ') IN  ('RR1','RR2','RR3','RR4','RR5','RR6','RR7','RR8','RR9','RR10','LOSS')) OR (NVL(A.DATA_SOURCE, ' ') IN  ('LIMIT')  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('S')  AND  NVL(A.PRODUCT_CODE, ' ') NOT IN  ('KLG','KFX','KBR','KXT')  AND  NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.RATING_CODE, ' ') IN  ('RR1','RR2','RR3','RR4','RR5','RR6','RR7','RR8','RR9','RR10','LOSS')) OR (NVL(A.DATA_SOURCE, ' ') IN  ('LIMIT')  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('S')  AND  NVL(A.PRODUCT_CODE, ' ') NOT IN  ('SLC','SLI','SLL','ULI','ULL','BGL','BGB','BGP','BPC','BSL','BGR','303','302','301','300','306','305','322','330','610','KBR','KXT','KFX')  AND  NVL(A.REVOLVING_FLAG,0) = 0  AND  NVL(A.RATING_CODE, ' ') IN  ('UNK')) OR (NVL(A.DATA_SOURCE, ' ') IN  ('ILS')  AND  NVL(A.RATING_CODE, ' ') IN  ('UNK')  AND  NVL(A.RESERVED_VARCHAR_2, ' ') IN  ('S')  AND  NVL(A.PRODUCT_CODE, ' ') IN  ('101','106','200','222','230','500','641')  AND  NVL(A.REVOLVING_FLAG,0) = 0))
    )
    GROUP BY CURRDATE, download_date
    ORDER BY download_date;

create view IFRS9_BCA.VW_IFRS_ECL_REPORT_HDR_EMAIL as
select CASE
           WHEN substr(DATA_SOURCE_CURRENT, 1, 3) = 'AAA' then substr(DATA_SOURCE_CURRENT, 4, length(DATA_SOURCE_CURRENT) - 3)
           WHEN substr(DATA_SOURCE_CURRENT, 1, 3) = 'AAB' then substr(DATA_SOURCE_CURRENT, 4, length(DATA_SOURCE_CURRENT) - 3)
           WHEN DATA_SOURCE_CURRENT = 'ZZZGRAND TOTAL' then substr(DATA_SOURCE_CURRENT, 4, 11)
           else DATA_SOURCE_CURRENT end DATA_SOURCE_CURRENT,
       SEGMENT_CURRENT,
       STAGE_1_CURRENT,
       STAGE_2_CURRENT,
       STAGE_3_CURRENT,
       TOTAL_ECL_CURRENT,
       null SPACE1,
       CASE
           WHEN DATA_SOURCE_PAST = 'ZZZGRAND TOTAL' then substr(DATA_SOURCE_PAST, 4, 11)
           else DATA_SOURCE_PAST end    DATA_SOURCE_PAST,
       SEGMENT_PAST,
       STAGE_1_PAST,
       STAGE_2_PAST,
       STAGE_3_PAST,
       TOTAL_ECL_PAST,
       null SPACE2,
       SELISIH_STAGE_1                  MOVEMENT_STAGE_1,
       SELISIH_STAGE_2                  MOVEMENT_STAGE_2,
       SELISIH_STAGE_3                  MOVEMENT_STAGE_3,
       SELISIH_TOTAL_ECL                MOVEMENT_TOTAL_ECL
from (select * from (select jenis_stage,
             download_date_current,
             data_source_current DATA_SOURCE_CURRENT,
             segment_current segment_current,
             stage_1_current stage_1_current,
             stage_2_current stage_2_current,
             stage_3_current stage_3_current,
             total_ecl_current total_ecl_current,
             data_source_past data_source_past,
             segment_past segment_past,
             stage_1_past stage_1_past,
             stage_2_past stage_2_past,
             stage_3_past stage_3_past,
             total_ecl_past total_ecl_past,
             SELISIH_STAGE_1  SELISIH_STAGE_1,
             selisih_stage_2 selisih_stage_2,
             selisih_stage_3 selisih_stage_3,
             selisih_total_ecl selisih_total_ecl
      from IFRS_ECL_REPORT_HDR
      )
      order by DATA_SOURCE_CURRENT, SEGMENT_CURRENT)
WHERE JENIS_STAGE = 'STAGE PELAPORAN'
  and DOWNLOAD_DATE_CURRENT = (select CURRDATE from IFRS_PRC_DATE);

create view IFRS9_BCA.VW_IFRS_REV_VS_BTK_GL_ADJ as
select REVBTK."DOWNLOAD_DATE",REVBTK."JURNAL_ID",REVBTK."COA",REVBTK."MTU",REVBTK."KET",REVBTK."CYCP",REVBTK."REV_BLN_INI_ADJ_SEQ",REVBTK."REV_BLN_INI_ADJ_DC",REVBTK."REV_BLN_INI_ADJ_EQ_IDR",REVBTK."REV_BLN_INI_ADJ_ORI_CURRENCY",REVBTK."BTK_BLN_INI_SEQ",REVBTK."BTK_BLN_INI_DC",REVBTK."BTK_BLN_INI_EQ_IDR",REVBTK."BTK_BLN_INI_ORI_CURRENCY",
       abs(REV_BLN_INI_ADJ_EQ_IDR) - abs(BTK_BLN_INI_EQ_IDR)                    SELISIH_EQ_IDR,
       abs(REV_BLN_INI_ADJ_ORI_CURRENCY) - abs(BTK_BLN_INI_ORI_CURRENCY)                    SELISIH_ORI_CURRENCY
from (select to_date('01-jan-1900') + BTK.EFFDT - 1                      DOWNLOAD_DATE,
       trim(BTK.JRNL_BRANCH || BTK.JRNL_ID)                                                 JURNAL_ID,
       BTK.JRNL_BRANCH || BTK.COA                                                           COA,
       BTK.CCY                                                                              MTU,
       trim(BTK.DESCRIPTION)                                                                      KET,
       BTK.CY || BTK.CP                                                                     CYCP,
       REV.SEQ                                                                              REV_BLN_INI_ADJ_SEQ,
       trim(REV.DC)                                                                               REV_BLN_INI_ADJ_DC,
       case when trim(REV.DC) = 'D' then 1 * nvl(REV.AMT_1, 0)/100 else -1 * nvl(REV.AMT_1, 0)/100 end  REV_BLN_INI_ADJ_EQ_IDR,
       case when trim(REV.DC) = 'D' then 1 * nvl(REV.AMT_3, 0)/100 else -1 * nvl(REV.AMT_3, 0)/100 end  REV_BLN_INI_ADJ_ORI_CURRENCY,
       BTK.SEQ                                                                              BTK_BLN_INI_SEQ,
       trim(BTK.DC)                                                                               BTK_BLN_INI_DC,
       case when trim(BTK.DC) = 'D' then 1 * nvl(BTK.AMT_1, 0)/100 else -1 * nvl(BTK.AMT_1, 0)/100 end  BTK_BLN_INI_EQ_IDR,
       case when trim(BTK.DC) = 'D' then 1 * nvl(BTK.AMT_3, 0)/100 else -1 * nvl(BTK.AMT_3, 0)/100 end  BTK_BLN_INI_ORI_CURRENCY
from IFRS_GL_OUTBOUND_ALL_R REV
        left join
      IFRS_GL_OUTBOUND_ALL BTK
              on BTK.JRNL_ID = REV.JRNL_ID
                  and BTK.JRNL_BRANCH = REV.JRNL_BRANCH
                  and BTK.COA = REV.COA
                  and BTK.CCY = REV.CCY
                  and BTK.SEQ = REV.SEQ
                  and BTK.EFFDT=REV.EFFDT
                  and BTK.AMT_1=REV.AMT_1) REVBTK;

create view IFRS9_BCA.VW_IFRS_REPORT_BIAYA_CKPN_SUMM as
select
    b.VALUE AS REASON,
    nvl("CORPORATE", 0) AS "CORPORATE",nvl("COMMERCIAL", 0) AS "COMMERCIAL",nvl("SME", 0) AS "SME",nvl("KUK", 0) AS "KUK",nvl("CONSUMER_KPR_DAN_LAINNYA", 0) AS "CONSUMER_KPR_DAN_LAINNYA",nvl("CREDIT_CARD", 0) AS "CREDIT_CARD",nvl("CONSUMER_KKB_MOTOR", 0) AS "CONSUMER_KKB_MOTOR",nvl("CONSUMER_KKB_MOBIL", 0) AS "CONSUMER_KKB_MOBIL"
  from (
    select *
    from (
      select REPORT_SEGMENT, REASON, BIAYA_CADANGAN_BULAN_INI
      from IFRS_REPORT_BIAYA_CKPN_SUMM
      where REPORT_DATE = (select currdate from IFRS_PRC_DATE)
    )
    pivot (
      max(BIAYA_CADANGAN_BULAN_INI)
      for REPORT_SEGMENT IN ('CORPORATE' AS "CORPORATE",'COMMERCIAL' AS "COMMERCIAL",'SME' AS "SME",'KUK' AS "KUK",'CONSUMER - KPR & LAINNYA' AS "CONSUMER_KPR_DAN_LAINNYA",'CREDIT CARD' AS "CREDIT_CARD",'CONSUMER - KKB MOTOR' AS "CONSUMER_KKB_MOTOR",'CONSUMER - KKB MOBIL' AS "CONSUMER_KKB_MOBIL")
    )
  ) a
  right join IFRS_PRIORITY b on a.REASON = b.VALUE
  where b.TYPE = 'REASON'
  order by b.PRIORITY asc;