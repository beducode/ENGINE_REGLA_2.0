WITH TABLE_STATS AS (
    SELECT 
        SCHEMANAME,
        RELNAME AS TABLE_NAME,
        N_TUP_INS AS INSERTS,
        N_TUP_UPD AS UPDATES,
        N_TUP_DEL AS DELETES,
        N_TUP_HOT_UPD AS HOT_UPDATES,
        (N_TUP_INS + N_TUP_UPD + N_TUP_DEL) AS TOTAL_WRITES,
        SEQ_SCAN,
        IDX_SCAN,
        N_LIVE_TUP AS LIVE_ROWS,
        N_DEAD_TUP AS DEAD_ROWS
    FROM PG_STAT_USER_TABLES
)
SELECT 
    SCHEMANAME,
    TABLE_NAME,
    INSERTS,
    UPDATES,
    DELETES,
    HOT_UPDATES,
    TOTAL_WRITES,
    LIVE_ROWS,
    DEAD_ROWS,
    CASE 
        WHEN TOTAL_WRITES > 1000000 THEN '‚ö° KANDIDAT UNTUK PARTITIONING ATAU SHARDING'
        WHEN UPDATES > INSERTS*0.5 THEN 'üìå PERTIMBANGKAN INDEX TAMBAHAN UNTUK KOLOM FILTER UPDATE'
        WHEN DELETES > INSERTS*0.2 THEN 'üßπ PERLU VACUUM LEBIH SERING (DEAD TUPLES TINGGI)'
        WHEN SEQ_SCAN > IDX_SCAN*2 THEN 'üîç TAMBAHKAN INDEX DI KOLOM FILTER/JOIN'
        ELSE '‚úÖ SEHAT / NORMAL'
    END AS RECOMMENDATION
FROM TABLE_STATS
ORDER BY TOTAL_WRITES DESC
